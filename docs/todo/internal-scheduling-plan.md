# 内部日程調整機能 実装プラン

> 応募者が自分で面接日程を予約できる、Calendly風の内部スケジューリング機能

---

## 目次

1. [概要](#概要)
2. [目的・メリット](#目的メリット)
3. [機能一覧](#機能一覧)
4. [画面設計](#画面設計)
5. [データ設計](#データ設計)
6. [実装ステップ](#実装ステップ)
7. [既存機能との比較](#既存機能との比較)
8. [次のアクション](#次のアクション)

---

## 概要

現在のGoogleカレンダー連携に加えて、外部サービスに依存しない**内部日程調整機能**を実装する。
応募者が空き枠を見て自分で予約できるようにすることで、企業側の日程調整の手間を大幅に削減する。

### 想定ユースケース

```
1. 企業が空き時間を登録（週単位 or 個別）
2. 応募者が応募完了後、予約ページにアクセス
3. 空いている日時を選択して予約
4. 双方にメール通知
5. 応募者ステータスが自動更新
```

---

## 目的・メリット

### 企業側のメリット

| 課題 | 解決方法 |
|------|---------|
| 日程調整のメールが多い | 応募者が自分で予約するので不要に |
| ダブルブッキングのリスク | システムが自動で空き管理 |
| ステータス更新忘れ | 予約確定で自動更新 |
| 担当者ごとの空き管理が煩雑 | 担当者別に空き時間を設定可能 |

### 応募者側のメリット

| 課題 | 解決方法 |
|------|---------|
| 企業からの連絡待ちがストレス | 自分のタイミングで予約できる |
| 候補日を複数出すのが面倒 | 空いている枠から選ぶだけ |
| 予約確定までのやり取りが長い | ワンクリックで確定 |

### 既存のGoogleカレンダー連携との比較

| 項目 | Googleカレンダー連携 | 内部日程調整 |
|------|---------------------|-------------|
| 外部依存 | Google APIに依存 | なし |
| セットアップ | OAuth連携が必要 | 不要 |
| 応募者操作 | 企業からの連絡待ち | **自分で予約可能** |
| ステータス連動 | 手動更新 | **自動更新** |
| コスト | 無料（API制限あり） | 無料 |

**結論**: 両方を選択肢として提供し、企業が選べるようにする。

---

## 機能一覧

### 1. 空き時間管理（企業側）

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 週間スケジュール設定 | 毎週繰り返しの空き時間（月〜金 10:00-18:00 など） | 高 |
| 個別日時追加 | 特定の日時を空きとして追加 | 中 |
| 除外日設定 | 休暇・祝日などを除外 | 中 |
| 担当者別設定 | 担当者ごとに異なる空き時間 | 中 |
| 面談時間設定 | 1枠あたりの時間（30分/60分/90分） | 高 |
| バッファ時間 | 面談と面談の間の休憩時間 | 低 |

### 2. 予約機能（応募者側）

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 空き枠表示 | カレンダー形式で空き時間を表示 | 高 |
| 日時選択 | クリックで予約確定 | 高 |
| 予約確認画面 | 予約内容の確認 | 高 |
| 予約変更 | 予約済み日時の変更 | 中 |
| 予約キャンセル | 予約のキャンセル | 中 |

### 3. 通知機能

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 予約確定メール | 応募者・企業双方に送信 | 高 |
| リマインダー | 面談前日・1時間前に通知 | 中 |
| 変更・キャンセル通知 | 予約変更時に通知 | 中 |
| LINE通知（オプション） | LINE経由での通知 | 低 |

### 4. ステータス連動

| トリガー | ステータス変更 |
|---------|---------------|
| 予約確定 | `new` → `interviewing`（面接調整中） |
| 面談日時到来 | `interviewing` → `interviewed`（面接済み）※手動 |
| キャンセル | `interviewing` → `contacted`（連絡済み） |

---

## 画面設計

### 企業側：空き時間設定画面

```
┌─────────────────────────────────────────────────────────┐
│ 面接可能時間の設定                                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 【基本設定】                                             │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 面談時間: [60分 ▼]  バッファ: [15分 ▼]              │ │
│ │ 面談形式: ☑対面  ☑オンライン  ☑電話               │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 【週間スケジュール】                                     │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 月曜日  ☑ [10:00] 〜 [18:00]  休憩 [12:00-13:00]   │ │
│ │ 火曜日  ☑ [10:00] 〜 [18:00]  休憩 [12:00-13:00]   │ │
│ │ 水曜日  ☑ [10:00] 〜 [18:00]  休憩 [12:00-13:00]   │ │
│ │ 木曜日  ☑ [10:00] 〜 [18:00]  休憩 [12:00-13:00]   │ │
│ │ 金曜日  ☑ [10:00] 〜 [18:00]  休憩 [12:00-13:00]   │ │
│ │ 土曜日  ☐                                          │ │
│ │ 日曜日  ☐                                          │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 【除外日】                                               │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 2025/02/24 (月) - 祝日                    [削除]    │ │
│ │ 2025/03/20 (木) - 祝日                    [削除]    │ │
│ │ [+ 除外日を追加]                                    │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│                              [キャンセル] [保存する]     │
└─────────────────────────────────────────────────────────┘
```

### 応募者側：予約画面

```
┌─────────────────────────────────────────────────────────┐
│ 面接日程を予約する                                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 【求人】製造スタッフ / 株式会社〇〇                       │
│                                                         │
│ ───────────────────────────────────────────────         │
│                                                         │
│     ◀ 2025年2月            ▶                           │
│                                                         │
│  日   月   火   水   木   金   土                        │
│                          1                              │
│  2    3    4    5    6    7    8                        │
│  9   10   11   12   13   14   15                        │
│      ●    ●    ●    ●    ●                             │
│ 16   17   18   19   20   21   22                        │
│      ●    ●    ●    ●    ●                             │
│ 23   24   25   26   27   28                             │
│      -    ●    ●    ●    ●                             │
│                                                         │
│ ● = 空きあり  - = 空きなし                              │
│                                                         │
│ ───────────────────────────────────────────────         │
│                                                         │
│ 【2月12日(水)の空き時間】                                │
│                                                         │
│  [10:00]  [11:00]  [14:00]  [15:00]  [16:00]  [17:00]  │
│                                                         │
│ ───────────────────────────────────────────────         │
│                                                         │
│ 選択中: 2025年2月12日(水) 14:00〜                        │
│ 面談形式: ◉対面  ○オンライン  ○電話                    │
│                                                         │
│                                        [予約を確定する]  │
└─────────────────────────────────────────────────────────┘
```

### 予約確定後の表示

```
┌─────────────────────────────────────────────────────────┐
│ ✅ 予約が完了しました                                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 【面接日時】                                             │
│ 2025年2月12日(水) 14:00〜15:00                           │
│                                                         │
│ 【面談形式】                                             │
│ 対面                                                    │
│                                                         │
│ 【場所】                                                 │
│ 〒123-4567 東京都千代田区〇〇1-2-3                       │
│                                                         │
│ 【持ち物】                                               │
│ ・履歴書（写真貼付）                                     │
│ ・筆記用具                                               │
│                                                         │
│ ───────────────────────────────────────────────         │
│                                                         │
│ 確認メールを送信しました。                               │
│ ご不明な点があれば、メールでお問い合わせください。        │
│                                                         │
│ [予約を変更する]  [予約をキャンセルする]                 │
└─────────────────────────────────────────────────────────┘
```

---

## データ設計

### Firestoreコレクション

#### 1. `scheduling_settings`（空き時間設定）

```javascript
// companies/{companyDomain}/scheduling_settings/{settingsId}
{
  // 基本設定
  isEnabled: true,                    // 機能の有効/無効
  slotDuration: 60,                   // 1枠の時間（分）
  bufferTime: 15,                     // バッファ時間（分）
  allowedTypes: ['in_person', 'online', 'phone'],  // 許可する面談形式
  maxDaysAhead: 30,                   // 何日先まで予約可能か

  // 週間スケジュール
  weeklySchedule: {
    monday: { enabled: true, start: '10:00', end: '18:00', breaks: [{ start: '12:00', end: '13:00' }] },
    tuesday: { enabled: true, start: '10:00', end: '18:00', breaks: [] },
    wednesday: { enabled: true, start: '10:00', end: '18:00', breaks: [] },
    thursday: { enabled: true, start: '10:00', end: '18:00', breaks: [] },
    friday: { enabled: true, start: '10:00', end: '18:00', breaks: [] },
    saturday: { enabled: false },
    sunday: { enabled: false }
  },

  // 除外日
  excludedDates: [
    { date: '2025-02-24', reason: '祝日' },
    { date: '2025-03-20', reason: '祝日' }
  ],

  // 担当者（オプション）
  assignedStaff: ['staff_id_1', 'staff_id_2'],

  // 場所設定
  locations: {
    in_person: {
      address: '〒123-4567 東京都千代田区〇〇1-2-3',
      notes: '本社ビル3F 受付にお声がけください'
    },
    online: {
      platform: 'Google Meet',
      notes: '面談URLは予約確定後にメールでお送りします'
    },
    phone: {
      notes: '担当者からお電話いたします'
    }
  },

  // 持ち物・注意事項
  requirements: '履歴書（写真貼付）、筆記用具',
  notes: '',

  updatedAt: Timestamp,
  createdAt: Timestamp
}
```

#### 2. `interview_slots`（予約枠）

```javascript
// companies/{companyDomain}/interview_slots/{slotId}
{
  date: '2025-02-12',                 // 日付
  startTime: '14:00',                 // 開始時刻
  endTime: '15:00',                   // 終了時刻
  status: 'available',                // available | booked | blocked

  // 予約情報（予約済みの場合）
  booking: {
    applicationId: 'app_xxx',         // 応募ID
    applicantName: '山田太郎',
    applicantEmail: 'yamada@example.com',
    applicantPhone: '090-xxxx-xxxx',
    meetingType: 'in_person',         // in_person | online | phone
    bookedAt: Timestamp
  },

  // 担当者（オプション）
  staffId: 'staff_id_1',
  staffName: '田中',

  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### 3. `interviews`（面談記録）※既存コレクション拡張

```javascript
// interviews/{interviewId}
{
  companyDomain: 'company-a',
  applicationId: 'app_xxx',
  slotId: 'slot_xxx',                 // 予約枠ID

  // 面談情報
  scheduledAt: Timestamp,
  durationMinutes: 60,
  meetingType: 'in_person',
  location: '〒123-4567 東京都千代田区〇〇1-2-3',

  // ステータス
  status: 'scheduled',                // scheduled | completed | cancelled | no_show

  // 担当者
  staffId: 'staff_id_1',
  staffName: '田中',

  // 通知
  reminders: [
    { type: '1day', sentAt: Timestamp },
    { type: '1hour', sentAt: Timestamp }
  ],

  // 結果（面談後に記録）
  result: {
    notes: '非常に意欲的。経験は浅いが育成枠で採用検討。',
    nextStep: 'offer',                // offer | second_interview | rejection | pending
    recordedBy: 'staff_id_1',
    recordedAt: Timestamp
  },

  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

---

## 実装ステップ

### Phase 1: 基本機能（MVP）

| タスク | 内容 | 工数目安 |
|--------|------|---------|
| 1-1 | Firestoreスキーマ作成・セキュリティルール | - |
| 1-2 | 空き時間設定UI（企業側） | - |
| 1-3 | 空き時間保存API | - |
| 1-4 | 予約カレンダーUI（応募者側） | - |
| 1-5 | 予約確定処理・ステータス更新 | - |
| 1-6 | 確認メール送信 | - |

### Phase 2: 通知・リマインダー

| タスク | 内容 | 工数目安 |
|--------|------|---------|
| 2-1 | 予約確定メール（テンプレート） | - |
| 2-2 | リマインダー（Cloud Scheduler） | - |
| 2-3 | 変更・キャンセル通知 | - |

### Phase 3: 拡張機能

| タスク | 内容 | 工数目安 |
|--------|------|---------|
| 3-1 | 担当者別空き時間 | - |
| 3-2 | 予約変更・キャンセル機能 | - |
| 3-3 | Googleカレンダー同期（オプション） | - |
| 3-4 | LINE通知連携 | - |

---

## 既存機能との比較

### 現在の流れ（Googleカレンダー連携）

```
1. 応募が入る
2. 企業が応募者詳細を確認
3. 「面談設定」ボタンをクリック
4. 担当者を選択
5. 担当者のGoogleカレンダーから空き時間を取得
6. 日時を選択して登録
7. 応募者にメールで連絡
```

**課題**: 企業側の操作が必要、応募者は待つだけ

### 新しい流れ（内部日程調整）

```
1. 応募が入る
2. 応募完了画面に「面接日程を予約する」ボタン表示
3. 応募者が空きカレンダーを見て日時を選択
4. 予約確定、双方にメール送信
5. ステータス自動更新
```

**メリット**: 企業の操作不要、応募者が主体的に動ける

### 両方を選択可能に

企業の設定で選べるようにする:

```javascript
// 企業設定
{
  schedulingMode: 'self_booking',  // 'self_booking' | 'manual' | 'google_calendar'
  // self_booking: 応募者が自分で予約
  // manual: 従来通り企業が手動で設定
  // google_calendar: Googleカレンダー連携
}
```

---

## 次のアクション

### 準備

- [ ] 既存の `interviews` コレクションとの整合性確認
- [ ] UIモックアップ作成
- [ ] Firestoreセキュリティルール設計

### Phase 1 実装

- [ ] `scheduling_settings` コレクション作成
- [ ] 空き時間設定画面（admin.html内のセクション）
- [ ] `interview_slots` コレクション作成
- [ ] 予約カレンダーコンポーネント
- [ ] 予約確定API
- [ ] ステータス自動更新ロジック
- [ ] 確認メール送信（既存のemail-service.js拡張）

### Phase 2 実装

- [ ] Cloud Scheduler でリマインダー設定
- [ ] メールテンプレート追加
- [ ] 変更・キャンセル処理

---

## 参考

- Calendly: https://calendly.com/
- TimeRex: https://timerex.net/
- YouCanBook.me: https://youcanbook.me/

---

*作成日: 2025-02-12*
