<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>メール送受信システム実装計画 - L-SET ドキュメント</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
      background: #fafafa;
    }
    .nav { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .nav a { color: #0066cc; text-decoration: none; }
    .nav a:hover { text-decoration: underline; }
    h1 { color: #1a1a1a; border-bottom: 2px solid #0066cc; padding-bottom: 10px; }
    h2 { color: #333; margin-top: 2em; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    h3 { color: #444; margin-top: 1.5em; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace; }
    pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace; line-height: 1.4; }
    pre code { background: none; color: inherit; padding: 0; white-space: pre; }
    table { border-collapse: collapse; width: 100%; margin: 1em 0; }
    th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
    th { background: #f5f5f5; font-weight: 600; }
    tr:nth-child(even) { background: #fafafa; }
    a { color: #0066cc; }
    ul, ol { padding-left: 1.5em; }
    li { margin: 0.3em 0; }
    blockquote { border-left: 4px solid #0066cc; margin: 1em 0; padding-left: 1em; color: #666; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em; }
    .mermaid { background: white; padding: 20px; border-radius: 8px; margin: 1em 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose' });
    });
  </script>
</head>
<body>
  <nav class="nav">
    <a href="../index.html">← 目次に戻る</a>
  </nav>
  <h1>メール送受信システム実装計画</h1><h2>概要</h2>
SendGridを使用して、企業と応募者間のメール送受信をシステム内で完結させる機能を実装する。</p><h2>アーキテクチャ</h2><pre><code class="language-">┌─────────────────────────────────────────────────────────────┐
│                    フロントエンド                            │
│  job-manage.html / applicants.html / mypage.html            │
│  → 統合タイムライン（メッセージ + メール）                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Cloud Functions                           │
│  ・sendEmail      - メール送信                              │
│  ・inboundParse   - メール受信（Webhook）                   │
│  ・getEmails      - メール一覧取得                          │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│    SendGrid     │  │    Firestore    │  │  Cloud Storage  │
│  Mail Send API  │  │  emails collection│ │   (添付ファイル) │
│  Inbound Parse  │  │                 │  │                 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
</code></pre><p>---</p><h2>Phase 1: メール送信機能（基盤）</h2><h3>1.1 Cloud Functions - sendEmail</h3>
<strong>ファイル:</strong> <code>functions/index.js</code></p><pre><code class="language-javascript">// 追加するエンドポイント
exports.sendEmail = functions.https.onRequest(async (req, res) => {
  // 1. 認証チェック（Firebase Auth）
  // 2. companyDomain で権限確認
  // 3. SendGrid API でメール送信
  // 4. Firestore emails コレクションに保存
});
</code></pre><h3>1.2 Firestore - emails コレクション</h3>
<pre><code class="language-javascript">{
  companyDomain: string,        // 企業識別（セキュリティ用）
  applicationId: string,        // 応募データへの紐付け
  direction: "outbound" | "inbound",
  from: { email, name },
  to: { email, name },
  replyTo: string,              // 返信用アドレス（トークン付き）
  subject: string,
  bodyText: string,
  bodyHtml: string,
  status: "sent" <table><tr><td>"delivered"</td><td>"failed"</td></tr></table> "received",
  readByCompany: boolean,
  createdAt: timestamp,
  sentAt: timestamp
}
</code></pre><h3>1.3 依存パッケージ追加</h3>
<strong>ファイル:</strong> <code>functions/package.json</code>
<pre><code class="language-json">{
  "dependencies": {
    "@sendgrid/mail": "^8.0.0",
    "busboy": "^1.6.0"
  }
}
</code></pre><p>---</p><h2>Phase 2: メール受信機能</h2><h3>2.1 SendGrid Inbound Parse 設定</h3>
<li>ドメインのMXレコード設定（例: <code>parse.yourdomain.com</code>）</li>
<li>SendGrid Dashboard で Webhook URL を設定</li>
<li>Cloud Functions <code>inboundParse</code> エンドポイント作成</li></p><h3>2.2 Reply-To トークン機構</h3>
<ul><li>送信時: <code>reply-{暗号化トークン}@parse.yourdomain.com</code> を生成</li>
<li>受信時: トークンから <code>applicationId</code> と <code>companyDomain</code> を復元</li>
<li>暗号化: AES-256-GCM で安全に</li>
</ul>
<h3>2.3 Cloud Functions - inboundParse</h3>
<strong>ファイル:</strong> <code>functions/index.js</code>
<pre><code class="language-javascript">exports.inboundParse = functions.https.onRequest(async (req, res) => {
  // 1. multipart/form-data をパース（busboy使用）
  // 2. Reply-To からトークン抽出・復号
  // 3. Firestore emails コレクションに保存
  // 4. 添付ファイルは Cloud Storage へ
});
</code></pre><p>---</p><h2>Phase 3: フロントエンド統合</h2><h3>3.1 統合タイムラインUI</h3>
<strong>ファイル:</strong> <code>src/features/applicants/index.js</code></p><p>既存の <code>messages-container</code> を拡張し、メッセージとメールを時系列で統合表示：</p><pre><code class="language-html"><div class="communication-timeline">
  <!-- メッセージ（アプリ内）-->
  <div class="timeline-item message">...</div></p><p>  <!-- メール（送信）-->
  <div class="timeline-item email outbound">
    <span class="badge">メール送信</span>
    ...
  </div></p><p>  <!-- メール（受信）-->
  <div class="timeline-item email inbound">
    <span class="badge">メール受信</span>
    ...
  </div>
</div>
</code></pre><h3>3.2 メール作成モーダル</h3>
<ul><li>テンプレート選択</li>
<li>件名・本文入力</li>
<li>プレビュー機能</li>
<li>送信ボタン</li>
</ul>
<h3>3.3 マイページ側（応募者向け）</h3>
<strong>ファイル:</strong> <code>src/features/mypage/index.js</code></p><p>メールも統合タイムラインに表示（読み取り専用）</p><p>---</p><h2>Phase 4: セキュリティ</h2><h3>4.1 Firestore ルール</h3>
<strong>ファイル:</strong> <code>firestore.rules</code>
<pre><code class="language-javascript">match /emails/{emailId} {
  // 企業ユーザーは自社のメールのみ
  allow read: if request.auth != null
    && get(/databases/$(database)/documents/company_users/$(request.auth.uid))
       .data.companyDomain == resource.data.companyDomain;</p><p>  // 書き込みはCloud Functionsのみ
  allow write: if false;
}
</code></pre><h3>4.2 インデックス追加</h3>
<strong>ファイル:</strong> <code>firestore.indexes.json</code>
<pre><code class="language-json">{
  "collectionGroup": "emails",
  "fields": [
    { "fieldPath": "companyDomain", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
</code></pre><p>---</p><h2>修正対象ファイル</h2><table><tr><td>ファイル</td><td>変更内容</td></tr>
</table>
<table><tr><td><code>functions/index.js</code></td><td>sendEmail, inboundParse, getEmails 追加</td></tr>
<tr><td><code>functions/package.json</code></td><td>@sendgrid/mail, busboy 追加</td></tr>
<tr><td><code>src/features/applicants/index.js</code></td><td>統合タイムライン、メール送信UI</td></tr>
<tr><td><code>src/features/mypage/index.js</code></td><td>メール表示追加</td></tr>
<tr><td><code>firestore.rules</code></td><td>emails コレクションのルール</td></tr>
<tr><td><code>firestore.indexes.json</code></td><td>emails 用インデックス</td></tr>
</table>
---</p><h2>SendGrid 設定手順（実装時に実施）</h2><h3>1. API Key 作成</h3>
<ul><li>SendGrid Dashboard → Settings → API Keys</li>
<li>「Create API Key」→ Full Access で作成</li>
<li>キーを安全に保存（一度しか表示されない）</li>
</ul>
<h3>2. 送信ドメイン認証（お名前.com）</h3><p><strong>SendGrid側:</strong>
<li>Settings → Sender Authentication → Authenticate Your Domain</li>
<li>DNS Host: 「Other」を選択</li>
<li>ドメイン名を入力 → CNAMEレコード3つが生成される</li></p><p><strong>お名前.com側:</strong>
<li><a href="https://navi.onamae.com/">お名前.com Navi</a> にログイン</li>
<li>ドメイン → DNS設定 → DNSレコード設定</li></p><p>追加するCNAMEレコード（例）:
<table><tr><td>ホスト名</td><td>TYPE</td><td>VALUE</td></tr>
</table>
<table><tr><td><code>em1234</code></td><td>CNAME</td><td><code>u12345678.wl.sendgrid.net</code></td></tr>
<tr><td><code>s1._domainkey</code></td><td>CNAME</td><td><code>s1.domainkey.u12345678.wl.sendgrid.net</code></td></tr>
<tr><td><code>s2._domainkey</code></td><td>CNAME</td><td><code>s2.domainkey.u12345678.wl.sendgrid.net</code></td></tr>
</table>
<h3>3. Inbound Parse設定（メール受信用）</h3><p><strong>お名前.com側 - MXレコード追加:</strong>
<table><tr><td>ホスト名</td><td>TYPE</td><td>VALUE</td><td>優先度</td></tr>
</table>
<table><tr><td><code>parse</code></td><td>MX</td><td><code>mx.sendgrid.net</code></td><td>10</td></tr>
</table>
<strong>SendGrid側:</strong>
<li>Settings → Inbound Parse → Add Host & URL</li>
<li>Receiving Domain: <code>parse.yourcompany.com</code></li>
<li>Destination URL: <code>https://asia-northeast1-{PROJECT_ID}.cloudfunctions.net/inboundParse</code></li></p><h3>推奨プラン</h3>
<ul><li><strong>開発時</strong>: Free（100通/日）</li>
<li><strong>本番運用</strong>: Essentials（$19.95/月）またはPro（$89.95/月・専用IP付き）</li>
</ul>
---</p><h2>検証方法</h2><p><li><strong>送信テスト</strong></li>
   - 管理画面からメール作成・送信
   - 応募者のメールアドレスに届くことを確認
   - Firestore に保存されることを確認</p><p><li><strong>受信テスト</strong></li>
   - 応募者から返信メールを送信
   - Cloud Functions のログで受信確認
   - Firestore に保存されることを確認
   - 管理画面に表示されることを確認</p><p><li><strong>セキュリティテスト</strong></li>
   - 他社のメールが見えないことを確認
   - 認証なしでAPIアクセスできないことを確認
</p>
  <div class="footer">
    <p>Generated from Markdown - L-SET Documentation</p>
  </div>
</body>
</html>