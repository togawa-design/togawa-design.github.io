<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twilio SMS連絡機能 実装計画 - L-SET ドキュメント</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
      background: #fafafa;
    }
    .nav { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .nav a { color: #0066cc; text-decoration: none; }
    .nav a:hover { text-decoration: underline; }
    h1 { color: #1a1a1a; border-bottom: 2px solid #0066cc; padding-bottom: 10px; }
    h2 { color: #333; margin-top: 2em; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    h3 { color: #444; margin-top: 1.5em; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace; }
    pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace; line-height: 1.4; }
    pre code { background: none; color: inherit; padding: 0; white-space: pre; }
    table { border-collapse: collapse; width: 100%; margin: 1em 0; }
    th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
    th { background: #f5f5f5; font-weight: 600; }
    tr:nth-child(even) { background: #fafafa; }
    a { color: #0066cc; }
    ul, ol { padding-left: 1.5em; }
    li { margin: 0.3em 0; }
    blockquote { border-left: 4px solid #0066cc; margin: 1em 0; padding-left: 1em; color: #666; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em; }
    .mermaid { background: white; padding: 20px; border-radius: 8px; margin: 1em 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose' });
    });
  </script>
</head>
<body>
  <nav class="nav">
    <a href="../index.html">← 目次に戻る</a>
  </nav>
  <h1>Twilio SMS連絡機能 実装計画</h1><h2>概要</h2><p>応募者とSMSで連絡を取れる双方向SMS機能をTwilioを使って実装します。</p><h3>機能要件</h3><ul><li>応募受付確認の自動SMS送信</li>
<li>面接日程通知</li>
<li>管理画面からの手動SMS送信</li>
<li>応募者からの返信SMS受信</li>
</ul>
---</p><h2>データモデル設計</h2><h3>既存の<code>messages</code>コレクションを拡張（新規コレクション作成不要）</h3><pre><code class="language-javascript">{
  // 既存フィールド
  applicationId: string,
  companyDomain: string,
  from: 'company' | 'applicant',
  content: string,
  read: boolean,
  createdAt: timestamp,</p><p>  // 新規フィールド（SMS対応）
  channel: 'app' <table><tr><td>'sms'</td></tr></table> 'email',  // デフォルト: 'app'
  smsStatus: 'pending' <table><tr><td>'sent'</td><td>'delivered'</td><td>'failed'</td></tr></table> 'received',
  twilioSid: string,
  phoneNumber: string,  // E.164形式
  errorCode: string,
  errorMessage: string
}
</code></pre><p>---</p><h2>実装フェーズ</h2><h3>Phase 1: インフラストラクチャ設定</h3><p><strong>変更ファイル:</strong></p><ul><li><code>/functions/package.json</code> - Twilio SDK追加</li>
</ul>
<strong>作業内容:</strong></p><p><li>Twilioアカウント設定・日本の電話番号購入（+81）</li>
<li><code>twilio</code> パッケージをfunctionsに追加</li>
<li>環境変数設定（TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, TWILIO_PHONE_NUMBER）</li></p><p>---</p><h3>Phase 2: SMS送信Cloud Function</h3><p><strong>変更ファイル:</strong></p><ul><li><code>/functions/index.js</code></li>
</ul>
<strong>実装するエンドポイント:</strong></p><p><li><strong><code>sendSms</code></strong> - SMS送信API</li>
   - 認証チェック
   - 電話番号をE.164形式に変換
   - Twilio経由で送信
   - Firestoreにメッセージ保存</p><p><li><strong><code>smsStatusCallback</code></strong> - 配信ステータス更新Webhook</li>
   - Twilioからの署名検証
   - メッセージステータス更新</p><pre><code class="language-javascript">// 電話番号変換ユーティリティ
function formatJapanesePhoneToE164(phone) {
  let cleaned = phone.replace(/[^\d+]/g, '');
  if (cleaned.startsWith('+81')) return cleaned;
  if (cleaned.startsWith('81')) return '+' + cleaned;
  if (cleaned.startsWith('0')) return '+81' + cleaned.slice(1);
  return '+81' + cleaned;
}
</code></pre><p>---</p><h3>Phase 3: SMS受信Cloud Function</h3><p><strong>変更ファイル:</strong></p><ul><li><code>/functions/index.js</code></li>
</ul>
<strong>実装するエンドポイント:</strong></p><p><strong><code>twilioWebhook</code></strong> - 着信SMS受信</p><ul><li>Twilioリクエスト署名検証</li>
<li>送信元電話番号から応募者を特定</li>
<li>Firestoreにメッセージ保存</li>
<li>未知の番号は<code>unknown_sms</code>コレクションに保存</li>
</ul>
---</p><h3>Phase 4: 自動SMSトリガー</h3><p><strong>変更ファイル:</strong></p><ul><li><code>/functions/index.js</code></li>
</ul>
<strong>Firestoreトリガー:</strong></p><p><li><strong><code>onApplicationCreated</code></strong> - 応募作成時</li>
   - 応募受付確認SMSを自動送信
   - 会社設定で無効化可能</p><p><li><strong><code>onApplicationStatusChange</code></strong> - ステータス変更時</li>
   - <code>interviewing</code>ステータスへの変更で面接調整SMS送信</p><p>---</p><h3>Phase 5: フロントエンド統合</h3><p><strong>変更ファイル:</strong></p><ul><li><code>/src/features/applicants/index.js</code></li>
<li><code>/job-manage.html</code></li>
</ul>
<strong>実装内容:</strong></p><p><li><strong>SMSテンプレート追加</strong></li></p><pre><code class="language-javascript">const smsTemplates = {
  application_confirmation: {
    subject: '応募受付確認',
    body: <code>【{companyName}】\n{applicantName}様\n\nご応募ありがとうございます。担当者より改めてご連絡いたします。</code>
  },
  interview_schedule: {
    subject: '面接日程',
    body: <code>【{companyName}】\n{applicantName}様\n\n面接日程のご連絡です。\n日時: ◯月◯日 ◯◯:00\n場所: {address}\n\nご確認お願いいたします。</code>
  },
  interview_reminder: {
    subject: '面接リマインダー',
    body: <code>【{companyName}】\n{applicantName}様\n\n明日の面接のリマインドです。\n日時: ◯月◯日 ◯◯:00\n持ち物: 履歴書、筆記用具</code>
  }
};
</code></pre><p><li><strong>SMS送信UI</strong></li>
   - チャネル切り替えタブ（アプリ内/SMS）
   - 送信先電話番号表示
   - テンプレート選択
   - 文字数カウント（70文字/1通、最大670文字）</p><p><li><strong>統合タイムライン表示</strong></li>
   - チャネルバッジ（SMS/アプリ）
   - 配信ステータスバッジ</p><p>---</p><h3>Phase 6: セキュリティ設定</h3><p><strong>変更ファイル:</strong></p><ul><li><code>/firestore.rules</code></li>
<li><code>/firestore.indexes.json</code></li>
</ul>
<strong>Firestoreルール:</strong></p><pre><code class="language-javascript">match /messages/{messageId} {
  // 企業ユーザーは自社のメッセージのみ読み取り可能
  allow read: if request.auth != null && (
    get(/databases/$(database)/documents/company_users/$(request.auth.uid))
      .data.companyDomain == resource.data.companyDomain
  );</p><p>  // SMS/メールの作成はCloud Functionsからのみ
  allow create: if request.auth != null &&
    request.resource.data.channel == 'app';
}
</code></pre><p><strong>インデックス追加:</strong></p><pre><code class="language-json">{
  "collectionGroup": "messages",
  "fields": [
    { "fieldPath": "twilioSid", "order": "ASCENDING" }
  ]
},
{
  "collectionGroup": "applications",
  "fields": [
    { "fieldPath": "applicantPhone", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
</code></pre><p>---</p><h3>Phase 7: 会社設定UI</h3><p><strong>変更ファイル:</strong></p><ul><li><code>/job-manage.html</code></li>
<li><code>/src/features/job-manage/index.js</code></li>
</ul>
<strong>設定項目:</strong></p><ul><li>応募受付確認SMS自動送信ON/OFF</li>
<li>面接調整SMS自動送信ON/OFF</li>
<li>SMS署名設定</li>
</ul>
---</p><h2>修正が必要なファイル一覧</h2><table><tr><td>ファイル</td><td>変更内容</td></tr>
</table>
<table><tr><td><code>/functions/package.json</code></td><td>twilio SDK追加</td></tr>
<tr><td><code>/functions/index.js</code></td><td>sendSms, twilioWebhook, smsStatusCallback, Firestoreトリガー追加</td></tr>
<tr><td><code>/src/features/applicants/index.js</code></td><td>SMS送信UI、テンプレート、タイムライン表示</td></tr>
<tr><td><code>/job-manage.html</code></td><td>SMS送信フォーム、設定パネルUI</td></tr>
<tr><td><code>/firestore.rules</code></td><td>messagesコレクションのルール更新</td></tr>
<tr><td><code>/firestore.indexes.json</code></td><td>SMS用インデックス追加</td></tr>
</table>
---</p><h2>検証方法</h2><h3>1. 機能テスト</h3><ul><li>[ ] 管理画面からSMS送信 → 自分の携帯で受信確認</li>
<li>[ ] 携帯からTwilio番号に返信 → 管理画面に表示確認</li>
<li>[ ] 新規応募 → 自動確認SMS受信確認</li>
<li>[ ] ステータス変更 → 自動面接SMSの確認</li>
</ul>
<h3>2. 設定確認</h3><ul><li>[ ] Twilio ConsoleでWebhook URLが正しく設定されているか</li>
<li>[ ] Cloud Functionsがデプロイされているか</li>
<li>[ ] Firestoreルールとインデックスがデプロイされているか</li>
</ul>
<h3>3. セキュリティテスト</h3><ul><li>[ ] 他社のSMSが見えないことを確認</li>
<li>[ ] Twilioの署名検証が機能していることを確認</li>
</ul>
---</p><h2>デプロイ手順</h2><h3>1. Twilio設定</h3><pre><code class="language-bash"><h1>環境変数設定</h1>
gcloud secrets create TWILIO_ACCOUNT_SID --data-file=-
gcloud secrets create TWILIO_AUTH_TOKEN --data-file=-
gcloud secrets create TWILIO_PHONE_NUMBER --data-file=-
</code></pre><h3>2. Cloud Functionsデプロイ</h3><pre><code class="language-bash">cd functions
npm install
gcloud functions deploy sendSms --trigger-http --runtime nodejs20 --region asia-northeast1
gcloud functions deploy twilioWebhook --trigger-http --runtime nodejs20 --region asia-northeast1
gcloud functions deploy smsStatusCallback --trigger-http --runtime nodejs20 --region asia-northeast1
</code></pre><h3>3. Firestore設定</h3><pre><code class="language-bash">firebase deploy --only firestore:rules
firebase deploy --only firestore:indexes
</code></pre><h3>4. Twilio Webhook設定</h3><pre><code class="language-">Twilio Console > Phone Numbers > 購入した番号 > Messaging
Webhook URL: https://asia-northeast1-{PROJECT_ID}.cloudfunctions.net/twilioWebhook
</code></pre><p>---</p><h2>コスト見積もり</h2><table><tr><td>項目</td><td>費用</td></tr>
</table>
<table><tr><td>Twilio日本電話番号</td><td>約$15/月</td></tr>
<tr><td>送信SMS（日本）</td><td>約$0.09/通</td></tr>
<tr><td>受信SMS（日本）</td><td>無料</td></tr>
</table>
<strong>月間見積もり（100応募、各3通SMS）:</strong></p><ul><li>電話番号: $15</li>
<li>送信SMS: $0.09 × 300 = $27</li>
<li><strong>合計: 約$42/月（約6,000円）</strong></li>
</ul>
  <div class="footer">
    <p>Generated from Markdown - L-SET Documentation</p>
  </div>
</body>
</html>