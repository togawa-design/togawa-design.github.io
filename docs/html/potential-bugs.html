<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>潜在的な不具合・修正推奨箇所 - L-SET ドキュメント</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
      background: #fafafa;
    }
    .nav { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .nav a { color: #0066cc; text-decoration: none; }
    .nav a:hover { text-decoration: underline; }
    h1 { color: #1a1a1a; border-bottom: 2px solid #0066cc; padding-bottom: 10px; }
    h2 { color: #333; margin-top: 2em; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    h3 { color: #444; margin-top: 1.5em; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace; }
    pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace; line-height: 1.4; }
    pre code { background: none; color: inherit; padding: 0; white-space: pre; }
    table { border-collapse: collapse; width: 100%; margin: 1em 0; }
    th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
    th { background: #f5f5f5; font-weight: 600; }
    tr:nth-child(even) { background: #fafafa; }
    a { color: #0066cc; }
    ul, ol { padding-left: 1.5em; }
    li { margin: 0.3em 0; }
    blockquote { border-left: 4px solid #0066cc; margin: 1em 0; padding-left: 1em; color: #666; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em; }
    .mermaid { background: white; padding: 20px; border-radius: 8px; margin: 1em 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose' });
    });
  </script>
</head>
<body>
  <nav class="nav">
    <a href="index.html">← 目次に戻る</a>
  </nav>
  <h1>潜在的な不具合・修正推奨箇所</h1><h2>1. エラーハンドリング</h2><h3>1-1. Promise.all()の部分的なエラーハンドリング</h3><p><strong>優先度</strong>: 高</p><p><strong>該当箇所</strong>: <code>functions/index.js</code> 1255-1261行目</p><p><strong>問題</strong>: Promise.all()で複数のAPI呼び出しを並列実行しているが、一部のみ<code>.catch()</code>で保護されている。</p><pre><code class="language-javascript">const [companyViews, applyClicks, lineClicks, formSubmits, recentAppsResult, jobPerformance] = await Promise.all([
  getEventCount('view_company_page'),  // エラーハンドリングなし
  getEventCount('click_apply'),        // エラーハンドリングなし
  getEventCount('click_line'),         // エラーハンドリングなし
  getEventCount('form_submit'),        // エラーハンドリングなし
  getRecentApplications(companyDomain, 50).catch(e => {...}),  // あり
  getJobPerformanceData(client, days, companyDomain).catch(e => {...})  // あり
]);
</code></pre><p><strong>対策案</strong>:
<ul><li>全てのPromiseに<code>.catch()</code>を追加</li>
<li>または<code>Promise.allSettled()</code>を使用</li>
</ul>
---</p><h3>1-2. multipart/form-dataパース処理が簡易実装</h3><p><strong>優先度</strong>: 高</p><p><strong>該当箇所</strong>: <code>functions/email.js</code> 435-464行目</p><p><strong>問題</strong>: コメントに「本番ではbusboyを使用」と記載されているが、簡易的な実装のまま。大容量ファイルやバウンダリ処理が不完全。</p><p><strong>対策案</strong>: package.jsonにbusboyは既に含まれているので、実装を更新</p><p>---</p><h2>2. 非同期処理の問題</h2><h3>2-1. fetchタイムアウト未設定</h3><p><strong>優先度</strong>: 中</p><p><strong>該当箇所</strong>: <code>src/shared/email-service.js</code> 93-94行目</p><p><strong>問題</strong>: fetch()がタイムアウトなしで実行される。ネットワークが遅い場合、無期限待機する。</p><pre><code class="language-javascript">const response = await fetch(url, options);
const data = await response.json();
</code></pre><p><strong>対策案</strong>:
<pre><code class="language-javascript">const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000);
try {
  const response = await fetch(url, { ...options, signal: controller.signal });
  clearTimeout(timeoutId);
  // ...
} catch (error) {
  if (error.name === 'AbortError') {
    throw new Error('リクエストがタイムアウトしました');
  }
  throw error;
}
</code></pre><p>---</p><h3>2-2. Firebase onAuthStateChanged()の重複実行</h3><p><strong>優先度</strong>: 中</p><p><strong>該当箇所</strong>: <code>src/features/admin/auth.js</code> 24-49行目</p><p><strong>問題</strong>: onAuthStateChanged()内でloadUserRole()をawaitしているが、並列実行時に同じuserのロード処理が複数実行される可能性がある。</p><p><strong>対策案</strong>: フラグやPromiseキャッシュで重複実行を防止</p><p>---</p><h2>3. 競合状態（Race Condition）</h2><h3>3-1. 自動保存と手動保存の競合</h3><p><strong>優先度</strong>: 高</p><p><strong>該当箇所</strong>: <code>src/shared/auto-save.js</code> 164-293行目</p><p><strong>問題</strong>: ユーザーが手動保存中に自動保存が実行される可能性がある。両方がFirestoreに同時に書き込みを試みるとデータ競合が発生する。</p><p><strong>対策案</strong>:
<pre><code class="language-javascript">let isSaving = false;</p><p>const save = async () => {
  if (isSaving) return;
  isSaving = true;
  try {
    await actualSave();
  } finally {
    isSaving = false;
  }
};
</code></pre><p>---</p><h2>4. メモリリーク</h2><h3>4-1. Firebase onAuthStateChanged()の未unsubscribe</h3><p><strong>優先度</strong>: 高</p><p><strong>該当箇所</strong>: <code>src/features/user-auth/auth-service.js</code> 39-60行目</p><p><strong>問題</strong>: onAuthStateChanged()の戻り値（unsubscribe関数）が保存されていない。ページ離脱時にリスナーが残る。</p><pre><code class="language-javascript">firebaseAuth.onAuthStateChanged(async (user) => {
  // ... リスナーが永続的に登録されたまま
}); // unsubscribe関数が保存されていない
</code></pre><p><strong>対策案</strong>:
<pre><code class="language-javascript">let unsubscribeAuth = null;</p><p>export function initAuth() {
  unsubscribeAuth = firebaseAuth.onAuthStateChanged(async (user) => {
    // ...
  });
}</p><p>export function cleanupAuth() {
  if (unsubscribeAuth) {
    unsubscribeAuth();
    unsubscribeAuth = null;
  }
}
</code></pre><p>---</p><h3>4-2. イベントリスナーの未クリーンアップ</h3><p><strong>優先度</strong>: 中</p><p><strong>該当箇所</strong>: <code>src/features/admin/index.js</code> 186-205行目</p><p><strong>問題</strong>: changeイベントリスナーが登録されるが、ページ遷移時にクリーンアップされない。複数回登録される可能性がある。</p><p>---</p><h3>4-3. Chart.jsインスタンスの未破棄</h3><p><strong>優先度</strong>: 低〜中</p><p><strong>該当箇所</strong>: <code>src/features/admin/analytics.js</code> 15-21行目</p><p><strong>問題</strong>: グローバルなChart.jsインスタンス(dailyChart, dayOfWeekChart等)が破棄されずに再作成される可能性がある。</p><p><strong>対策案</strong>:
<pre><code class="language-javascript">if (dailyChart) {
  dailyChart.destroy();
}
dailyChart = new Chart(ctx, config);
</code></pre><p>---</p><h3>4-4. AutoSaveインスタンスの不完全なクリーンアップ</h3><p><strong>優先度</strong>: 中</p><p><strong>該当箇所</strong>: <code>src/shared/auto-save.js</code> 178-180, 327-330行目</p><p><strong>問題</strong>: cleanupAllAutoSave()が呼び出されない場合、setInterval()が実行され続ける。</p><p>---</p><h2>5. データ整合性</h2><h3>5-1. トランザクション未使用の複数更新</h3><p><strong>優先度</strong>: 中</p><p><strong>該当箇所</strong>: <code>functions/email.js</code> 135-154行目</p><p><strong>問題</strong>: メール送信時にメタデータとメール本体が別々に保存される。途中で失敗するとデータ不整合が生じる。</p><p><strong>対策案</strong>: Firestoreトランザクションを使用</p><p>---</p><h3>5-2. 複数タブでのキャッシュ不整合</h3><p><strong>優先度</strong>: 中</p><p><strong>該当箇所</strong>: <code>src/features/job-manage/state.js</code> 11-19行目</p><p><strong>問題</strong>: グローバルステート変数(jobsCache等)が手動で更新される。複数タブで開かれた場合の同期メカニズムがない。</p><p>---</p><h2>6. nullチェック漏れ</h2><h3>6-1. Firestoreドキュメントの存在確認不足</h3><p><strong>優先度</strong>: 低</p><p><strong>該当箇所</strong>: <code>functions/email.js</code> 368-380行目</p><p><strong>問題</strong>: getCompanyInfo()で取得したドキュメントがnullの場合、fromNameが「null」文字列になる可能性。</p><p>---</p><h2>修正優先度サマリー</h2><table><tr><td>優先度</td><td>項目</td><td>ファイル</td></tr>
</table>
<table><tr><td>高</td><td>Promise.allエラーハンドリング</td><td>functions/index.js</td></tr>
<tr><td>高</td><td>自動保存競合</td><td>src/shared/auto-save.js</td></tr>
<tr><td>高</td><td>Firebase unsubscribe漏れ</td><td>src/features/user-auth/auth-service.js</td></tr>
<tr><td>高</td><td>multipartパーサー</td><td>functions/email.js</td></tr>
<tr><td>中</td><td>fetchタイムアウト</td><td>src/shared/email-service.js</td></tr>
<tr><td>中</td><td>重複実行防止</td><td>src/features/admin/auth.js</td></tr>
<tr><td>中</td><td>イベントリスナー</td><td>src/features/admin/index.js</td></tr>
<tr><td>中</td><td>Chart.js破棄</td><td>src/features/admin/analytics.js</td></tr>
<tr><td>中</td><td>トランザクション</td><td>functions/email.js</td></tr>
<tr><td>低</td><td>nullチェック</td><td>functions/email.js</td></tr>
</table>
  <div class="footer">
    <p>Generated from Markdown - L-SET Documentation</p>
  </div>
</body>
</html>