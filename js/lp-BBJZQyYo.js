import"./modulepreload-polyfill-YP0FEG5d.js";import{L as t,a as e}from"./LPEditor-D-J8qyX8.js";import{hasUrlParam as o,getUrlParam as n,trackEvent as i}from"./utils-BNVq905i.js";import{l as a}from"./api-DapBkB8R.js";import{r as s,a as l,i as r,t as c}from"./page-analytics-Dnh2KkE5.js";import"./jobs-loader-ujpdJS3I.js";import{i as d,g as m,a as p}from"./firestore-service-qEqRY9xZ.js";import{c as u}from"./notification-service-CeuV9oX0.js";import"./modal-BOD5e818.js";import"./image-uploader-DhILrmx3.js";import"./env-config-Bna8zKOp.js";const g="rikueko_utm_data",y="rikueko_first_visit";function h(){const t=new URLSearchParams(window.location.search);return{utm_source:t.get("utm_source")||"",utm_medium:t.get("utm_medium")||"",utm_campaign:t.get("utm_campaign")||"",utm_content:t.get("utm_content")||"",utm_term:t.get("utm_term")||""}}function b(){return localStorage.getItem(y)}function f(){const t=b();if(!t)return null;const e=new Date(t),o=new Date,n=Math.abs(o-e);return Math.floor(n/864e5)}function w(t=""){const e=function(){const t=localStorage.getItem(g);if(!t)return null;try{return JSON.parse(t)}catch{return null}}(),o=h(),n=b(),i=Object.values(o).some(t=>t);return{utm_source:(null==e?void 0:e.utm_source)||o.utm_source||"",utm_medium:(null==e?void 0:e.utm_medium)||o.utm_medium||"",utm_campaign:(null==e?void 0:e.utm_campaign)||o.utm_campaign||"",utm_content:(null==e?void 0:e.utm_content)||o.utm_content||"",utm_term:(null==e?void 0:e.utm_term)||o.utm_term||"",lastTouchSource:i&&e?o.utm_source:null,lastTouchMedium:i&&e?o.utm_medium:null,landingPage:(null==e?void 0:e.landingPage)||window.location.pathname,lpDesignPattern:t,firstVisitAt:n||(new Date).toISOString(),daysToConversion:f()||0}}function v(){localStorage.getItem(y)||localStorage.setItem(y,(new Date).toISOString()),function(){if(localStorage.getItem(g))return;const t=h();if(Object.values(t).some(t=>t)){const e={...t,landingPage:window.location.pathname+window.location.search,savedAt:(new Date).toISOString()};localStorage.setItem(g,JSON.stringify(e))}}()}const _=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"];class P{constructor(){this.renderer=new t,this.editor=new e,this.isEditMode=o("edit"),this.jobId=null,this.companyDomain=null,this.utmParams={},this.lpSettings=null,this.company=null,this.mainJob=null,this.recruitSettings=null}async init(){var t,e,o;if(this.jobId=this.getJobId(),this.companyDomain=this.getCompanyDomain(),this.jobId||this.companyDomain){this.captureUTMParams();try{await this.waitForJobsLoader(),await window.JobsLoader.initFirestoreLoader();const i=await window.JobsLoader.fetchCompanies();if(this.jobId){const[t,e]=this.jobId.split("_");if(this.company=null==i?void 0:i.find(e=>{var o;return(null==(o=e.companyDomain)?void 0:o.trim())===t&&window.JobsLoader.isCompanyVisible(e)}),console.log("[LP] 会社データ:",this.company),console.log("[LP] 会社データのキー:",this.company?Object.keys(this.company):[]),!this.company)return void this.showError("指定された会社は見つかりませんでした。");const o=await this.fetchJobs(this.company);if(this.mainJob=o.find(o=>{const n=o.jobId||o["求人ID"]||o.id||"";if(n===e||`${t}_${n}`===this.jobId)return!0;if(e.startsWith("job-")){if(n===e.replace("job-",""))return!0}return!1}),!this.mainJob)return void this.showError("指定された求人は見つかりませんでした。");this.lpSettings=await this.fetchLPSettings(this.jobId)||{},this.lpSettings=this.loadPreviewSettings(this.jobId,this.lpSettings)}else{if(this.company=null==i?void 0:i.find(t=>{var e;return(null==(e=t.companyDomain)?void 0:e.trim())===this.companyDomain&&window.JobsLoader.isCompanyVisible(t)}),!this.company)return void this.showError("指定された会社は見つかりませんでした。");this.lpSettings=await this.fetchLPSettingsLegacy(this.companyDomain)||{},this.lpSettings=this.loadPreviewSettings(this.companyDomain,this.lpSettings)}await this.inheritCompanyRecruitSettings();const a=n("layoutStyle");a&&(this.lpSettings.layoutStyle=a);const s=await this.fetchJobs(this.company);this.setupAdTracking(this.lpSettings),this.hideLoading();const l=document.getElementById("lp-content");if(l){if(this.isEditMode){document.body.classList.add("lp-preview-mode-mobile");const t=document.querySelector(".lp-header"),e=document.querySelector(".lp-footer");t&&(t.style.display="none"),e&&(e.style.display="none")}const t=this.mainJob?[this.mainJob,...s.filter(t=>t.id!==this.mainJob.id)]:s;this.renderer.render(this.company,t,this.lpSettings,l),this.isEditMode||this.renderLayoutComponents(l),this.setupEventListeners(this.company),this.setupApplyModal(),this.updateFooterLinks()}if(this.isEditMode){const n={company:(null==(t=this.company)?void 0:t.company)||"",companyDomain:(null==(e=this.company)?void 0:e.companyDomain)||"",title:(null==(o=this.mainJob)?void 0:o.title)||""};this.editor.enable(this.lpSettings,this.jobId||this.companyDomain,n,this.company,this.mainJob)}this.updateSEO(this.company,this.mainJob?[this.mainJob]:s,this.lpSettings),this.isEditMode||this.trackPageView(this.company)}catch(i){console.error("LP読み込みエラー:",i),this.showError("ページの読み込みに失敗しました。")}}else this.showError("求人または会社が指定されていません。")}getJobId(){return n("j")||n("job")||null}getCompanyDomain(){return n("c")||n("id")||null}async waitForJobsLoader(t=1e4){return void 0!==window.JobsLoader?window.JobsLoader:new Promise((e,o)=>{const n=Date.now(),i=setInterval(()=>{void 0!==window.JobsLoader?(clearInterval(i),e(window.JobsLoader)):Date.now()-n>t&&(clearInterval(i),o(new Error("JobsLoader timeout")))},100)})}async fetchJobs(t){var e;const o=null==(e=t.jobsSheet)?void 0:e.trim();if(!o)return[];const n=await window.JobsLoader.fetchCompanyJobs(o);return(null==n?void 0:n.length)?n.filter(t=>"false"!==t.visible&&"FALSE"!==t.visible).filter(t=>window.JobsLoader.isJobInPublishPeriod(t)).sort((t,e)=>(parseInt(t.order)||999)-(parseInt(e.order)||999)).map(e=>({...e,company:t.company,companyDomain:t.companyDomain})):[]}async inheritCompanyRecruitSettings(){var t,e,o;const n=(null==(t=this.lpSettings)?void 0:t.layoutStyle)&&"modern"!==this.lpSettings.layoutStyle,i=(null==(e=this.lpSettings)?void 0:e.designPattern)&&"modern"!==this.lpSettings.designPattern,s=null==(o=this.company)?void 0:o.companyDomain;if(s)try{const t=await a(s);if(!t)return void console.log("[LP] 会社の採用ページ設定がありません");if(this.recruitSettings=t,n&&i)return void console.log("[LP] LP固有のlayoutStyle/designPatternを使用");const e={};!n&&t.layoutStyle&&(console.log("[LP] 会社の採用ページ設定からlayoutStyleを継承:",t.layoutStyle),e.layoutStyle=t.layoutStyle),!i&&t.designPattern&&(console.log("[LP] 会社の採用ページ設定からdesignPatternを継承:",t.designPattern),e.designPattern=t.designPattern),Object.keys(e).length>0&&(this.lpSettings={...this.lpSettings,...e})}catch(l){console.log("[LP] 採用ページ設定の取得エラー:",l.message)}else console.log("[LP] 会社ドメインが見つかりません")}async fetchLPSettings(t){try{d();const e=t.split("_"),o=e[0];console.log("[LP] Firestore LP設定取得 (フルID):",o,t);let n=await m(o,t);if(n.success&&n.settings&&Object.keys(n.settings).length>0)return console.log("[LP] Firestore LP設定を発見 (フルID):",n.settings),n.settings;const i=e.slice(1).join("_");return i&&i!==t&&(console.log("[LP] Firestore LP設定取得 (フォールバック):",o,i),n=await m(o,i),n.success&&n.settings&&Object.keys(n.settings).length>0)?(console.log("[LP] Firestore LP設定を発見 (フォールバック):",n.settings),n.settings):(console.log("[LP] Firestore LP設定が見つかりません（デフォルト設定を使用）"),null)}catch(e){return console.log("[LP] Firestore LP設定取得エラー:",e.message),null}}async fetchLPSettingsLegacy(t){try{d();const e=await p(t);if(e.success&&e.jobs&&e.jobs.length>0){const o=e.jobs[0];console.log("[LP Legacy] Firestore 最初の求人ID:",o.id);const n=await m(t,o.id);if(n.success&&n.settings&&Object.keys(n.settings).length>0)return console.log("[LP Legacy] Firestore LP設定を発見:",n.settings),n.settings}return console.log("[LP Legacy] Firestore LP設定が見つかりません（デフォルト設定を使用）"),null}catch(e){return console.log("[LP Legacy] Firestore LP設定取得エラー:",e.message),null}}parseLPSettingsRow(t){return{heroTitle:t.heroTitle||t["ヒーロータイトル"]||"",heroSubtitle:t.heroSubtitle||t["ヒーローサブタイトル"]||"",heroImage:t.heroImage||t["ヒーロー画像"]||"",ctaText:t.ctaText||t["CTAテキスト"]||"この求人に応募する",pointTitle1:t.pointTitle1||t["ポイント1タイトル"]||"",pointDesc1:t.pointDesc1||t["ポイント1説明"]||"",pointTitle2:t.pointTitle2||t["ポイント2タイトル"]||"",pointDesc2:t.pointDesc2||t["ポイント2説明"]||"",pointTitle3:t.pointTitle3||t["ポイント3タイトル"]||"",pointDesc3:t.pointDesc3||t["ポイント3説明"]||"",pointTitle4:t.pointTitle4||t["ポイント4タイトル"]||"",pointDesc4:t.pointDesc4||t["ポイント4説明"]||"",pointTitle5:t.pointTitle5||t["ポイント5タイトル"]||"",pointDesc5:t.pointDesc5||t["ポイント5説明"]||"",pointTitle6:t.pointTitle6||t["ポイント6タイトル"]||"",pointDesc6:t.pointDesc6||t["ポイント6説明"]||"",faq:t.faq||t.FAQ||"",designPattern:t.designPattern||t["デザインパターン"]||"modern",layoutStyle:t.layoutStyle||t["レイアウトスタイル"]||"modern",sectionOrder:t.sectionOrder||t["セクション順序"]||"",sectionVisibility:t.sectionVisibility||t["セクション表示"]||"",tiktokPixelId:t.tiktokPixelId||t["TikTok Pixel ID"]||"",googleAdsId:t.googleAdsId||t["Google Ads ID"]||"",googleAdsLabel:t.googleAdsLabel||t["Google Ads ラベル"]||"",metaPixelId:t.metaPixelId||t["Meta Pixel ID"]||"",lineTagId:t.lineTagId||t["LINE Tag ID"]||"",clarityProjectId:t.clarityProjectId||t["Clarity Project ID"]||"",ogpTitle:t.ogpTitle||t["OGPタイトル"]||"",ogpDescription:t.ogpDescription||t["OGP説明文"]||"",ogpImage:t.ogpImage||t["OGP画像"]||"",showVideoButton:t.showVideoButton||t["動画ボタン表示"]||"",videoUrl:t.videoUrl||t["動画URL"]||"",lpContent:t.lpContent||t["LP構成"]||""}}loadPreviewSettings(t,e){if(!o("preview"))return e;const n=`lp_preview_${t}`,i=sessionStorage.getItem(n);if(!i)return console.log("[LP] プレビューデータが見つかりません"),e;try{const t=JSON.parse(i),o=3e5;return Date.now()-t.timestamp>o?(console.log("[LP] プレビューデータが古いため破棄"),sessionStorage.removeItem(n),e):(console.log("[LP] プレビューモード: 編集中のデータを使用",t.lpSettings),this.showPreviewBanner(),t.lpSettings)}catch(a){return console.error("[LP] プレビューデータの読み込みエラー:",a),e}}showPreviewBanner(){const t=document.createElement("div");t.className="lp-preview-banner",t.innerHTML='\n      <span>プレビューモード - 保存されていない変更を表示中</span>\n      <button type="button" onclick="this.parentElement.remove()">✕</button>\n    ',document.body.insertBefore(t,document.body.firstChild)}renderLayoutComponents(t){var e,o,n,i;const a=this.recruitSettings||{},r=(null==(e=this.lpSettings)?void 0:e.layoutStyle)||"modern",c=r,d=(null==(o=this.company)?void 0:o.companyDomain)||"",m=!(!a.logoUrl&&!a.companyNameDisplay),p=!(!a.phoneNumber&&!a.ctaButtonText);if(m)document.body.classList.add("has-fixed-header");else{const t=document.querySelector(".lp-header");t&&(t.style.display="block"),document.body.classList.add("has-fixed-header")}if(p&&document.body.classList.add("has-fixed-cta-bar"),document.body.setAttribute("data-layout-style",r),m&&!document.querySelector(".site-header")){const t=`company-recruit.html?id=${encodeURIComponent(d)}`,e=s({logoUrl:a.logoUrl||"",companyName:a.companyNameDisplay||(null==(n=this.company)?void 0:n.company)||"",recruitPageUrl:t,showBackLink:!0,designPattern:c});document.body.insertAdjacentHTML("afterbegin",e)}const u=a.companyNameDisplay||(null==(i=this.company)?void 0:i.company)||"",g=(new Date).getFullYear(),y=document.querySelector(".lp-footer");if(y){const t=y.querySelector(".lp-footer-copyright");t&&u&&(t.innerHTML=`<small>&copy; ${g} ${u} All Rights Reserved.</small>`),y.classList.add(`lp-layout-${r}`)}if(p){const t=l({phoneNumber:a.phoneNumber||"",ctaButtonText:a.ctaButtonText||"今すぐ応募する",ctaUrl:"#apply",designPattern:c});document.body.insertAdjacentHTML("beforeend",t)}}hideLoading(){const t=document.getElementById("lp-loading");t&&(t.style.display="none")}showError(t){this.hideLoading();const e=document.getElementById("lp-content");e&&(e.innerHTML=`\n        <div class="lp-error">\n          <p>${t}</p>\n          <a href="/" class="lp-btn-back">トップページへ戻る</a>\n        </div>\n      `)}setupEventListeners(t){document.querySelectorAll(".lp-faq-question").forEach(t=>{t.addEventListener("click",()=>{const e="true"===t.getAttribute("aria-expanded");t.setAttribute("aria-expanded",!e);const o=t.getAttribute("aria-controls"),n=document.getElementById(o);n&&n.classList.toggle("open",!e)})}),document.querySelectorAll('a[href^="#"]').forEach(t=>{t.addEventListener("click",e=>{const o=t.getAttribute("href");if("#"===o)return;const n=document.querySelector(o);n&&(e.preventDefault(),n.scrollIntoView({behavior:"smooth",block:"start"}))})}),document.querySelectorAll(".lp-btn-apply-hero, .lp-btn-apply-main, .lp-btn-apply-footer, .lp-btn-apply-header, .lp-hero-cta-btn--apply").forEach(e=>{e.addEventListener("click",o=>{var n,a,s;o.preventDefault();const l=e.classList.contains("lp-btn-apply-hero")?"hero":e.classList.contains("lp-hero-cta-btn--apply")?"hero_cta":e.classList.contains("lp-btn-apply-main")?"main":e.classList.contains("lp-btn-apply-header")?"header":"footer";i("lp_apply_click",{company_domain:t.companyDomain,company_name:t.company,button_location:l,...this.utmParams});const r={company_domain:t.companyDomain,company_name:t.company,job_id:(null==(n=this.mainJob)?void 0:n.id)||(null==(a=this.mainJob)?void 0:a.jobId)||this.jobId||"",job_title:(null==(s=this.mainJob)?void 0:s.title)||""};this.showApplyModal(r)})}),document.querySelectorAll(".lp-btn-tel-header, .lp-btn-tel-footer").forEach(e=>{e.addEventListener("click",()=>{const o=e.classList.contains("lp-btn-tel-header")?"header":"footer";i("lp_tel_click",{company_domain:t.companyDomain,company_name:t.company,button_location:o,...this.utmParams}),this.trackConversion("Contact",{content_name:t.company,content_category:"phone_call",button_location:o,...this.utmParams})})})}updateFooterLinks(){var t;const e=document.querySelector(".lp-footer-links"),o=null==(t=this.company)?void 0:t.companyDomain;if(!e||!o)return;const n=`company-recruit.html?id=${encodeURIComponent(o)}`,i=e.querySelector('a[href="./"]');i&&(i.href=n,i.textContent="採用サイトTOP");const a=e.querySelector('a[href="./#jobs"]');a&&(a.href=`${n}#jobs`)}updateSEO(t,e,o={}){const n=o.ogpTitle||o.heroTitle||"",i=o.ogpDescription||"",a=o.ogpImage||o.heroImage||"",s=n?`${n} | ${t.company}`:`${t.company} 求人情報 | L-SET`,l=i||(e.length>0?`${t.company}の求人情報。${e[0].title}など${e.length}件の募集中。`:`${t.company}の求人情報ページです。`);document.title=s;const r=document.querySelector('meta[name="description"]');r&&(r.content=l);const c=document.querySelector('meta[property="og:title"]');c&&(c.content=s);const d=document.querySelector('meta[property="og:description"]');if(d&&(d.content=l),a){let t=document.querySelector('meta[property="og:image"]');t||(t=document.createElement("meta"),t.setAttribute("property","og:image"),document.head.appendChild(t)),t.content=a;let e=document.querySelector('meta[name="twitter:image"]');e||(e=document.createElement("meta"),e.setAttribute("name","twitter:image"),document.head.appendChild(e)),e.content=a}let m=document.querySelector('meta[property="og:url"]');m||(m=document.createElement("meta"),m.setAttribute("property","og:url"),document.head.appendChild(m)),m.content=`${window.location.origin}${window.location.pathname}?c=${this.companyDomain}`;let p=document.querySelector('meta[name="twitter:card"]');p||(p=document.createElement("meta"),p.setAttribute("name","twitter:card"),document.head.appendChild(p)),p.content="summary_large_image"}captureUTMParams(){v();const t=new URLSearchParams(window.location.search);_.forEach(e=>{const o=t.get(e);o&&(this.utmParams[e]=o)});const e=this.jobId?`utm_params_job_${this.jobId}`:`utm_params_${this.companyDomain}`;if(Object.keys(this.utmParams).length>0)sessionStorage.setItem(e,JSON.stringify(this.utmParams)),console.log("[LP] UTM params captured:",this.utmParams);else{const t=sessionStorage.getItem(e);if(t)try{this.utmParams=JSON.parse(t)}catch(o){}}}setupAdTracking(t){t.tiktokPixelId&&this.initTikTokPixel(t.tiktokPixelId),t.googleAdsId&&this.initGoogleAds(t.googleAdsId),t.metaPixelId&&this.initMetaPixel(t.metaPixelId),t.lineTagId&&this.initLineTag(t.lineTagId),t.clarityProjectId&&this.initClarity(t.clarityProjectId)}initTikTokPixel(t){t&&!window.ttq&&(!function(e,o,n){e.TiktokAnalyticsObject=n;var i=e[n]=e[n]||[];i.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],i.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var a=0;a<i.methods.length;a++)i.setAndDefer(i,i.methods[a]);i.instance=function(t){for(var e=i._i[t]||[],o=0;o<i.methods.length;o++)i.setAndDefer(e,i.methods[o]);return e},i.load=function(t,e){var o="https://analytics.tiktok.com/i18n/pixel/events.js";i._i=i._i||{},i._i[t]=[],i._i[t]._u=o,i._t=i._t||{},i._t[t]=+new Date,i._o=i._o||{},i._o[t]=e||{};var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=o+"?sdkid="+t+"&lib="+n;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(a,s)},i.load(t),i.page()}(window,document,"ttq"),console.log("[LP] TikTok Pixel initialized:",t))}initGoogleAds(t){if(!t)return;if("function"==typeof gtag)return gtag("config",t),void console.log("[LP] Google Ads configured:",t);const e=document.createElement("script");e.async=!0,e.src=`https://www.googletagmanager.com/gtag/js?id=${t}`,document.head.appendChild(e),e.onload=()=>{function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],window.gtag=e,e("js",new Date),e("config",t),console.log("[LP] Google Ads initialized:",t)}}initMetaPixel(t){var e,o,n,i,a,s;t&&!window.fbq&&(e=window,o=document,n="script",e.fbq||(i=e.fbq=function(){i.callMethod?i.callMethod.apply(i,arguments):i.queue.push(arguments)},e._fbq||(e._fbq=i),i.push=i,i.loaded=!0,i.version="2.0",i.queue=[],(a=o.createElement(n)).async=!0,a.src="https://connect.facebook.net/en_US/fbevents.js",(s=o.getElementsByTagName(n)[0]).parentNode.insertBefore(a,s)),window.fbq("init",t),window.fbq("track","PageView"),console.log("[LP] Meta Pixel initialized:",t))}initLineTag(t){t&&!window._lt&&(!function(t,e){t._ltq=t._ltq||[],t._lt=t._lt||function(){t._ltq.push(arguments)};var o=e.getElementsByTagName("head")[0],n=e.createElement("script");n.async=1,n.src="https://s.yjtag.jp/tag.js",o.appendChild(n)}(window,document),window._lt("init",{customerType:"lap",tagId:t}),window._lt("send","pv",[t]),console.log("[LP] LINE Tag initialized:",t))}initClarity(t){var e,o,n,i,a,s,l;t&&!window.clarity&&(e=window,o=document,i="script",a=t,e[n="clarity"]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},(s=o.createElement(i)).async=1,s.src="https://www.clarity.ms/tag/"+a,(l=o.getElementsByTagName(i)[0]).parentNode.insertBefore(s,l),console.log("[LP] Microsoft Clarity initialized:",t))}trackConversion(t,e={}){var o,n,i;if(window.ttq&&(window.ttq.track(t,e),console.log("[LP] TikTok event tracked:",t,e)),(null==(o=this.lpSettings)?void 0:o.googleAdsId)&&(null==(n=this.lpSettings)?void 0:n.googleAdsLabel)&&"function"==typeof gtag&&(gtag("event","conversion",{send_to:`${this.lpSettings.googleAdsId}/${this.lpSettings.googleAdsLabel}`,...e}),console.log("[LP] Google Ads conversion tracked:",this.lpSettings.googleAdsId)),window.fbq){const o={SubmitForm:"Lead",Contact:"Contact"}[t]||t;window.fbq("track",o,e),console.log("[LP] Meta Pixel event tracked:",o,e)}window._lt&&(null==(i=this.lpSettings)?void 0:i.lineTagId)&&(window._lt("send","cv",{type:"SubmitForm"===t?"Conversion":t},[this.lpSettings.lineTagId]),console.log("[LP] LINE Tag conversion tracked:",t))}trackPageView(t){var e,o,n;i("lp_view",{company_domain:t.companyDomain,company_name:t.company,...this.utmParams}),r({pageType:"lp",companyDomain:t.companyDomain,jobId:(null==(e=this.mainJob)?void 0:e.id)||(null==(o=this.mainJob)?void 0:o.jobId)||null,companyName:t.company,jobTitle:(null==(n=this.mainJob)?void 0:n.title)||null}),window.ttq&&window.ttq.track("ViewContent",{content_name:t.company,content_category:"company_lp"}),window.fbq&&window.fbq("track","ViewContent",{content_name:t.company,content_category:"company_lp"})}trackCTAButtonClick(t,e=null){var o,n,i;c({pageType:"lp",companyDomain:null==(o=this.company)?void 0:o.companyDomain,buttonType:t,jobId:(null==(n=this.mainJob)?void 0:n.id)||(null==(i=this.mainJob)?void 0:i.jobId)||null,buttonText:e})}initFirestore(){if("undefined"==typeof firebase)return console.warn("[Firestore] Firebase not loaded"),!1;const t={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"};return firebase.apps.length||firebase.initializeApp(t),window.firebaseDb=firebase.firestore(),!0}calculateAge(t){if(!t)return"";const e=new Date,o=new Date(t);let n=e.getFullYear()-o.getFullYear();const i=e.getMonth()-o.getMonth();return(i<0||0===i&&e.getDate()<o.getDate())&&n--,n}showApplyModal(t){this.currentJobData=t;const e=document.getElementById("apply-modal");if(!e)return;const o=document.getElementById("apply-job-info");o&&(o.textContent=`${t.company_name} - ${t.job_title}`);const n=document.getElementById("apply-form");n&&n.reset(),this.showApplyStep("form"),e.style.display="flex",document.body.style.overflow="hidden"}hideApplyModal(){const t=document.getElementById("apply-modal");t&&(t.style.display="none"),document.body.style.overflow="",this.currentJobData=null}showApplyStep(t){["form","complete"].forEach(e=>{const o=document.getElementById(`apply-step-${e}`);o&&(o.style.display=e===t?"block":"none")})}showFormError(t,e){const o=document.getElementById(t);o&&(o.textContent=e,o.style.display="block")}hideFormError(t){const e=document.getElementById(t);e&&(e.style.display="none")}setupApplyModal(){var t,e;this.initFirestore(),this.currentJobData=null;const o=document.getElementById("apply-modal");o&&(o.querySelectorAll(".modal-close, .modal-close-btn").forEach(t=>{t.addEventListener("click",()=>this.hideApplyModal())}),null==(t=o.querySelector(".modal-backdrop"))||t.addEventListener("click",()=>this.hideApplyModal()),null==(e=document.getElementById("apply-form"))||e.addEventListener("submit",t=>this.handleApplySubmit(t)))}async saveApplicationToFirestore(t){var e;try{if(!window.firebaseDb)return console.warn("[Application] Firestore not initialized"),null;const o=w((null==(e=this.lpSettings)?void 0:e.designPattern)||"standard"),n={companyDomain:t.company_domain,companyName:t.company_name,jobId:t.job_id,jobTitle:t.job_title,applicantName:t.name,applicantNameKana:t.nameKana,applicantBirthdate:t.birthdate,applicantAge:t.age,applicantGender:t.gender||"",applicantPhone:t.phone,applicantEmail:t.email,applicantAddress:t.address,applicantMessage:t.message||"",userId:null,status:"new",type:"apply",source:document.referrer||"direct",userAgent:navigator.userAgent,timestamp:new Date,createdAt:firebase.firestore.FieldValue.serverTimestamp(),utm_source:o.utm_source,utm_medium:o.utm_medium,utm_campaign:o.utm_campaign,utm_content:o.utm_content,utm_term:o.utm_term,landingPage:o.landingPage,lpDesignPattern:o.lpDesignPattern,firstVisitAt:o.firstVisitAt,daysToConversion:o.daysToConversion},i=await window.firebaseDb.collection("applications").add(n);return console.log("[Application] Saved to Firestore:",i.id),console.log("[Application] Tracking data:",{utm_source:o.utm_source,utm_medium:o.utm_medium,utm_campaign:o.utm_campaign,daysToConversion:o.daysToConversion}),i.id}catch(o){return console.error("[Application] Failed to save:",o),null}}async handleApplySubmit(t){var e,o,n,a,s,l,r,c,d,m,p,g,y,h;t.preventDefault();const b=null==(o=null==(e=document.getElementById("apply-name"))?void 0:e.value)?void 0:o.trim(),f=null==(a=null==(n=document.getElementById("apply-name-kana"))?void 0:n.value)?void 0:a.trim(),w=null==(s=document.getElementById("apply-birthdate"))?void 0:s.value,v=null==(l=document.getElementById("apply-gender"))?void 0:l.value,_=null==(c=null==(r=document.getElementById("apply-phone"))?void 0:r.value)?void 0:c.trim(),P=null==(m=null==(d=document.getElementById("apply-email"))?void 0:d.value)?void 0:m.trim(),L=null==(g=null==(p=document.getElementById("apply-address"))?void 0:p.value)?void 0:g.trim(),S=null==(h=null==(y=document.getElementById("apply-message"))?void 0:y.value)?void 0:h.trim();if(this.hideFormError("apply-form-error"),!(b&&f&&w&&_&&P&&L))return void this.showFormError("apply-form-error","必須項目を入力してください");if(!this.currentJobData)return void this.showFormError("apply-form-error","エラーが発生しました。再度お試しください");const I=this.calculateAge(w);try{const t=await this.saveApplicationToFirestore({...this.currentJobData,name:b,nameKana:f,birthdate:w,age:I,gender:v,phone:_,email:P,address:L,message:S});if(!t)throw new Error("Failed to save application");try{await u({companyDomain:this.currentJobData.company_domain,applicationId:t,jobId:this.currentJobData.job_id,jobTitle:this.currentJobData.job_title,applicantName:b,applicantEmail:P}),console.log("[Application] Notification created for company:",this.currentJobData.company_domain)}catch(D){console.warn("[Application] Failed to create notification:",D)}i("submit_application",this.currentJobData),this.trackConversion("SubmitForm",{content_name:this.currentJobData.company_name,content_category:"job_application",...this.utmParams}),this.showApplyStep("complete")}catch(E){console.error("[Apply] Submit error:",E),this.showFormError("apply-form-error","応募の送信に失敗しました。もう一度お試しください")}}}document.addEventListener("DOMContentLoaded",()=>{(new P).init()});
