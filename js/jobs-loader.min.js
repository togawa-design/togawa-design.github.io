const JobsLoader={SHEET_ID:"1NVIDV3OiXbNrVI7EFdRrU2Ggn8dx7Q0rSnvJ6uaWvX0",SHEET_NAME:"会社一覧",STATS_SHEET_NAME:"Stats",DEFAULT_IMAGE:"images/default-job.svg",get csvUrl(){return`https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${this.SHEET_NAME}`},get statsUrl(){return`https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${this.STATS_SHEET_NAME}`},getSheetUrl(e){return`https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(e)}`},async fetchCompanies(){try{const e=await fetch(this.csvUrl);if(!e.ok)throw new Error("会社一覧の取得に失敗しました");const t=await e.text();return this.parseCSV(t)}catch(e){return console.error("会社一覧の取得エラー:",e),null}},async fetchCompanyJobs(e){if(!e)return null;try{const t=this.extractSpreadsheetId(e.trim());if(!t)return console.error("スプレッドシートIDを取得できませんでした:",e),null;const n=`https://docs.google.com/spreadsheets/d/${t}/gviz/tq?tqx=out:csv`,a=await fetch(n);if(!a.ok)throw new Error("求人データの取得に失敗しました");const s=await a.text();console.log("[DEBUG] 求人シートCSV取得:",t),console.log("[DEBUG] CSV行数:",s.split("\n").length),console.log("[DEBUG] 1行目(ヘッダー):",s.split("\n")[0]),console.log("[DEBUG] 3行目(データ):",s.split("\n")[2]);const o=this.parseCSV(s,0,2);return console.log("[DEBUG] パース結果:",o.length,"件",o),o}catch(e){return console.error("求人データの取得エラー:",e),null}},extractSpreadsheetId(e){const t=e.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);return t?t[1]:/^[a-zA-Z0-9_-]+$/.test(e)?e:null},async fetchJobs(){return this.fetchCompanies()},parseCSV(e,t=0,n=1){const a=e.split("\n"),s=this.parseCSVLine(a[t]||""),o=[];for(let e=n;e<a.length;e++){if(!a[e].trim())continue;const t=this.parseCSVLine(a[e]),n={};s.forEach((e,a)=>{const s=this.normalizeHeader(e);n[s]=t[a]||""}),n.features&&(n.features=n.features.split(",").map(e=>e.trim()).filter(e=>e)),o.push(n)}return o},parseCSVLine(e){const t=[];let n="",a=!1;for(let s=0;s<e.length;s++){const o=e[s];'"'===o?a&&'"'===e[s+1]?(n+='"',s++):a=!a:","!==o||a?n+=o:(t.push(n.trim()),n="")}return t.push(n.trim()),t},normalizeHeader(e){const t={id:"id",ID:"id","会社名":"company",company:"company","タイトル":"title",title:"title","勤務地":"location",location:"companyAddress","特典総額":"totalBonus",totalBonus:"totalBonus","月収例":"monthlySalary",monthlySalary:"monthlySalary","特徴":"features",features:"features","バッジ":"badges",badges:"badges","画像URL":"imageUrl",imageUrl:"imageUrl","詳細URL":"detailUrl",detailUrl:"detailUrl","表示":"visible",visible:"visible","表示する":"showCompany","並び順":"order",order:"order","会社ドメイン":"companyDomain",companyDomain:"companyDomain",company_domain:"companyDomain","会社住所":"companyAddress",companyAddress:"companyAddress","説明":"description",description:"description","お仕事内容":"jobContent",jobContent:"jobContent","仕事内容":"jobDescription",jobDescription:"jobDescription","応募資格":"requirements",requirements:"requirements","待遇":"benefits",benefits:"benefits","勤務時間":"workingHours",workingHours:"workingHours","休日":"holidays",holidays:"holidays","デザインパターン":"designPattern",designPattern:"designPattern",design_pattern:"designPattern","パターン":"designPattern",pattern:"designPattern","管理シート":"jobsSheet",jobsSheet:"jobsSheet",jobs_sheet:"jobsSheet","掲載開始日":"publishStartDate",publishStartDate:"publishStartDate",publish_start_date:"publishStartDate","掲載終了日":"publishEndDate",publishEndDate:"publishEndDate",publish_end_date:"publishEndDate","職種名":"jobType",jobType:"jobType",job_type:"jobType","給与":"salary",salary:"salary","雇用形態":"employmentType",employmentType:"employmentType",employment_type:"employmentType","資格・スキル":"skills",skills:"skills","資格":"skills","スキル":"skills"},n=e.replace(/"/g,"").trim();if(t[n])return t[n];const a=n.split(/\s+/);return a.length>1&&t[a[0]]?t[a[0]]:a[0]||n},isCompanyVisible:e=>!(!e.jobsSheet||!e.jobsSheet.trim())&&("○"===e.showCompany||"◯"===e.showCompany),isJobInPublishPeriod(e){const t=new Date;if(t.setHours(0,0,0,0),e.publishStartDate&&e.publishStartDate.trim()){const n=this.parseDate(e.publishStartDate);if(n&&t<n)return!1}if(e.publishEndDate&&e.publishEndDate.trim()){const n=this.parseDate(e.publishEndDate);if(n&&t>n)return!1}return!0},parseDate(e){if(!e)return null;const t=e.trim().replace(/\//g,"-"),n=new Date(t);return isNaN(n.getTime())?null:(n.setHours(0,0,0,0),n)},renderJobCard(e){const t=e.badges?e.badges.split(",").map(e=>e.trim()):[],n=Array.isArray(e.features)?e.features:[];let a="";(t.includes("NEW")||t.includes("new"))&&(a+='<span class="job-badge new">NEW</span>'),(t.includes("人気")||t.includes("hot"))&&(a+='<span class="job-badge hot">人気</span>');const s=n.map(e=>`<li>${this.escapeHtml(e)}</li>`).join(""),o=e.imageUrl&&e.imageUrl.trim()?e.imageUrl:this.DEFAULT_IMAGE,i=`<img src="${this.escapeHtml(o)}" alt="${this.escapeHtml(e.company)}" onerror="this.parentElement.innerHTML='<div class=\\'job-image-placeholder\\'>${this.escapeHtml(e.company)}</div>'">`,r=e._displayTotalBonus||e.totalBonus||"",l=e._displayMonthlySalary||e.monthlySalary||"",c=r?`\n            <div class="benefit-item highlight">\n              <span class="benefit-label">特典総額</span>\n              <span class="benefit-value">${this.escapeHtml(r)}</span>\n            </div>`:"";return`\n      <article class="job-card" data-job-id="${this.escapeHtml(e.id||"")}">\n        ${a?`<div class="job-card-header">${a}</div>`:""}\n        <div class="job-card-image">\n          ${i}\n        </div>\n        <div class="job-card-body">\n          <h3 class="job-title">${this.escapeHtml(e.title)}</h3>\n          <p class="job-location">${this.escapeHtml(e.companyAddress||e.location||"")}</p>\n          <div class="job-benefits">${c}\n            <div class="benefit-item">\n              <span class="benefit-label">月収例</span>\n              <span class="benefit-value">${this.escapeHtml(l)}</span>\n            </div>\n          </div>\n          ${s?`<ul class="job-features">${s}</ul>`:""}\n          <a href="${this.getDetailUrl(e)}" class="btn-apply">詳細を見る</a>\n        </div>\n      </article>\n    `},escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML},sanitizeHtml(e){if(!e||"<br>"===e||"<div><br></div>"===e)return"";const t=["b","strong","i","em","u","ul","ol","li","br","div","p"],n=document.createElement("div");n.innerHTML=e;return n.querySelectorAll("*").forEach(e=>{if(t.includes(e.tagName.toLowerCase()))for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name);else e.replaceWith(...e.childNodes)}),n.innerHTML},getDetailUrl(e){return e.companyDomain&&e.companyDomain.trim()?`company.html?id=${encodeURIComponent(e.companyDomain.trim())}`:this.escapeHtml(e.detailUrl||"#")},getCompanyDomainFromUrl:()=>new URLSearchParams(window.location.search).get("id"),async renderJobDetail(){const e=document.getElementById("job-detail-container");if(!e)return;const t=this.getCompanyDomainFromUrl();if(!t)return void(e.innerHTML='\n        <div class="jobs-error">\n          <p>求人が見つかりませんでした。</p>\n          <a href="/" class="btn-more">トップページに戻る</a>\n        </div>\n      ');const n=await this.fetchCompanies();if(!n)return void(e.innerHTML='\n        <div class="jobs-error">\n          <p>会社情報を取得できませんでした。</p>\n          <button onclick="JobsLoader.renderJobDetail()">再読み込み</button>\n        </div>\n      ');const a=n.find(e=>e.companyDomain&&e.companyDomain.trim()===t&&this.isCompanyVisible(e));if(!a)return void(e.innerHTML='\n        <div class="jobs-error">\n          <p>会社が見つかりませんでした。</p>\n          <a href="/" class="btn-more">トップページに戻る</a>\n        </div>\n      ');let s=[];if(a.jobsSheet&&a.jobsSheet.trim()){const e=await this.fetchCompanyJobs(a.jobsSheet.trim());e&&e.length>0&&(s=e.filter(e=>"false"!==e.visible&&"FALSE"!==e.visible).filter(e=>this.isJobInPublishPeriod(e)).sort((e,t)=>(parseInt(e.order)||999)-(parseInt(t.order)||999)).map(e=>({...e,company:a.company,companyDomain:a.companyDomain})))}0===s.length&&(s=[a]),document.title=`${a.company}の求人一覧 | リクエコ求人ナビ`;const o=document.querySelector('meta[name="description"]');o&&(o.content=`${a.company}の期間工・期間従業員求人一覧。${s.length}件の求人を掲載中。`);const i=document.getElementById("breadcrumb-current");i&&(i.textContent=a.company),e.innerHTML=this.renderCompanyPageContent(a,s),this.trackCompanyPageView(a),this.setupApplyTracking(),this.renderRelatedJobs(n,t)},getDesignPatternClass(e){const t=e?e.toLowerCase().trim():"";return["modern","classic","minimal","colorful"].includes(t)?`pattern-${t}`:""},renderCompanyPageContent(e,t){const n=e.imageUrl&&e.imageUrl.trim()?e.imageUrl:this.DEFAULT_IMAGE;return`\n      <div class="company-page ${this.getDesignPatternClass(e.designPattern)}">\n        <div class="company-header">\n          <div class="company-header-image">\n            <img src="${this.escapeHtml(n)}" alt="${this.escapeHtml(e.company)}" onerror="this.style.display='none'">\n          </div>\n          <div class="company-header-info">\n            <h1 class="company-name">${this.escapeHtml(e.company)}</h1>\n            <p class="company-job-count">${t.length}件の求人を掲載中</p>\n          </div>\n        </div>\n\n        ${e.description?`\n        <div class="company-description">\n          <h2>会社について</h2>\n          <div class="company-description-content">${this.sanitizeHtml(e.description)}</div>\n        </div>\n        `:""}\n\n        <div class="company-jobs">\n          <h2>募集中の求人</h2>\n          <div class="company-jobs-list">\n            ${t.map(e=>this.renderCompanyJobCard(e)).join("")}\n          </div>\n        </div>\n\n        <div class="company-cta">\n          <p>お仕事選びでお困りですか？</p>\n          <div class="company-cta-buttons">\n            <a href="#" class="btn-apply-large">無料で相談する</a>\n            <a href="#" class="btn-line-large">LINEで相談する</a>\n          </div>\n        </div>\n      </div>\n    `},renderCompanyJobCard(e){const t=Array.isArray(e.features)?e.features:[];let n="";return e.jobDescription&&(n=e.jobDescription.length>100?e.jobDescription.substring(0,100)+"...":e.jobDescription),`\n      <div class="job-list-card">\n        <div class="job-list-card-header">\n          <h3 class="job-list-title">\n            <a href="job-detail.html?company=${this.escapeHtml(e.companyDomain||"")}&job=${this.escapeHtml(e.id||"")}">${this.escapeHtml(e.title)}</a>\n          </h3>\n        </div>\n        <div class="job-list-card-body">\n          <ul class="job-list-info">\n            <li><span class="info-label">勤務地</span><span class="info-value">${this.escapeHtml(e.location)}</span></li>\n            <li><span class="info-label">給与</span><span class="info-value">${this.escapeHtml(e.monthlySalary||e.salary||"")}</span></li>\n            <li><span class="info-label">雇用形態</span><span class="info-value">${this.escapeHtml(e.employmentType||"")}</span></li>\n            ${e.totalBonus?`<li><span class="info-label">特典総額</span><span class="info-value highlight">${this.escapeHtml(e.totalBonus)}</span></li>`:""}\n          </ul>\n          ${t.length>0?`\n          <div class="job-list-tags">\n            ${t.map(e=>`<span class="job-tag">${this.escapeHtml(e)}</span>`).join("")}\n          </div>\n          `:""}\n          ${n?`\n          <p class="job-list-desc">${this.escapeHtml(n)}</p>\n          `:""}\n        </div>\n        <div class="job-list-card-footer">\n          <a href="job-detail.html?company=${this.escapeHtml(e.companyDomain||"")}&job=${this.escapeHtml(e.id||"")}" class="btn-detail">詳細を見る</a>\n        </div>\n      </div>\n    `},async renderRelatedJobs(e,t){const n=document.getElementById("related-jobs-container");if(!n)return;const a=e.filter(e=>e.companyDomain!==t&&this.isCompanyVisible(e)).sort((e,t)=>(parseInt(e.order)||999)-(parseInt(t.order)||999)).slice(0,3);0!==a.length?n.innerHTML=a.map(e=>this.renderJobCard(e)).join(""):n.innerHTML="<p>他の求人がありません。</p>"},async renderJobs(e="jobs-container"){const t=document.getElementById(e);if(!t)return void console.error(`Container #${e} not found`);const n=new URLSearchParams(window.location.search).get("location");if(t.innerHTML=`\n      <div class="jobs-loading">\n        <div class="loading-spinner"></div>\n        <p>${n?`${n}の求人を読み込んでいます...`:"求人情報を読み込んでいます..."}</p>\n      </div>\n    `,n){const e=await this.getJobsByLocation(n);if(!e||0===e.length)return void(t.innerHTML=`\n          <div class="jobs-error">\n            <p>${n}の求人が見つかりませんでした。</p>\n            <a href="/" class="btn-more">すべての求人を見る</a>\n          </div>\n        `);const a=document.createElement("div");return a.className="location-filter-header",a.innerHTML=`\n        <div class="filter-info">\n          <span class="filter-label">${n}の求人</span>\n          <span class="filter-count">${e.length}件</span>\n        </div>\n        <a href="/" class="btn-clear-filter">フィルターを解除</a>\n      `,t.before(a),void(t.innerHTML=e.map(e=>this.renderJobCardForSearch(e)).join(""))}const a=await this.fetchCompanies();if(!a||0===a.length)return void(t.innerHTML=`\n        <div class="jobs-error">\n          <p>求人情報を取得できませんでした。</p>\n          <button onclick="JobsLoader.renderJobs('${e}')">再読み込み</button>\n        </div>\n      `);const s=a.filter(e=>this.isCompanyVisible(e)).sort((e,t)=>(parseInt(e.order)||999)-(parseInt(t.order)||999)),o=await Promise.all(s.map(async e=>{if(console.log("[DEBUG] 会社データ:",e.company,Object.keys(e),e),e._displayTotalBonus="",e._displayMonthlySalary=e.monthlySalary||"",e.jobsSheet&&e.jobsSheet.trim()){const t=await this.fetchCompanyJobs(e.jobsSheet.trim());if(console.log("[DEBUG] 求人シートデータ:",e.company,t),t&&t.length>0){const n=t.filter(e=>"false"!==e.visible&&"FALSE"!==e.visible).filter(e=>this.isJobInPublishPeriod(e)).sort((e,t)=>(parseInt(e.order)||999)-(parseInt(t.order)||999));if(console.log("[DEBUG] ソート後の求人:",e.company,n),n.length>0){const t=n[0];console.log("[DEBUG] 表示順1の求人:",t,"totalBonus:",t.totalBonus,"monthlySalary:",t.monthlySalary),e._displayTotalBonus=t.totalBonus||"";const a=this.getMaxMonthlySalary(n);console.log("[DEBUG] 最高月収例:",a),a&&(e._displayMonthlySalary=a)}}}return e}));t.innerHTML=o.map(e=>this.renderJobCard(e)).join("")},getMaxMonthlySalary(e){let t=0,n="";return e.forEach(e=>{if(!e.monthlySalary)return;const a=e.monthlySalary;let s=0;const o=a.match(/(\d+(?:\.\d+)?)\s*万/);if(o)s=1e4*parseFloat(o[1]);else{const e=a.match(/(\d{1,3}(?:,\d{3})*)\s*円/);if(e)s=parseInt(e[1].replace(/,/g,""));else{const e=a.match(/[¥￥]\s*(\d{1,3}(?:,\d{3})*|\d+)/);if(e)s=parseInt(e[1].replace(/,/g,""));else{const e=a.match(/(\d{1,3}(?:,\d{3})*|\d+)/);e&&(s=parseInt(e[1].replace(/,/g,"")))}}}s>t&&(t=s,n=a)}),n},renderJobCardForSearch(e){const t=(Array.isArray(e.features)?e.features:[]).slice(0,3).map(e=>`<li>${this.escapeHtml(e)}</li>`).join("");return`\n      <article class="job-card" data-job-id="${this.escapeHtml(e.id||"")}">\n        <div class="job-card-body">\n          <p class="job-company-name">${this.escapeHtml(e.company||"")}</p>\n          <h3 class="job-title">${this.escapeHtml(e.title||"")}</h3>\n          <p class="job-location">${this.escapeHtml(e.location||"")}</p>\n          <div class="job-benefits">\n            <div class="benefit-item highlight">\n              <span class="benefit-label">特典総額</span>\n              <span class="benefit-value">${this.escapeHtml(e.totalBonus||"")}</span>\n            </div>\n            <div class="benefit-item">\n              <span class="benefit-label">月収例</span>\n              <span class="benefit-value">${this.escapeHtml(e.monthlySalary||"")}</span>\n            </div>\n          </div>\n          ${t?`<ul class="job-features">${t}</ul>`:""}\n        </div>\n        <div class="job-card-footer">\n          <a href="company.html?id=${this.escapeHtml(e.companyDomain||"")}" class="btn-detail">詳細を見る</a>\n        </div>\n      </article>\n    `},async fetchStats(){try{const e=await fetch(this.statsUrl);if(!e.ok)throw new Error("実績データの取得に失敗しました");const t=await e.text();return this.parseStatsCSV(t)}catch(e){return console.error("実績データの取得エラー:",e),null}},parseStatsCSV(e){const t=e.split("\n"),n={};for(let e=1;e<t.length;e++){if(!t[e].trim())continue;const a=this.parseCSVLine(t[e]),s=a[0]?a[0].replace(/"/g,"").trim():"",o=a[1]?a[1].replace(/"/g,"").trim():"",i=a[2]?a[2].replace(/"/g,"").trim():"";s&&(n[s]={value:o,label:i})}return n},async fetchAllJobs(){const e=await this.fetchCompanies();if(!e)return[];const t=[];for(const n of e){if(!this.isCompanyVisible(n))continue;const e=await this.fetchCompanyJobs(n.jobsSheet);e&&e.forEach(e=>{e.company=n.company,e.companyDomain=n.companyDomain,t.push(e)})}return t},async getLocationList(){const e=await this.fetchAllJobs(),t={};return e.forEach(e=>{if(!e.location)return;const n=e.location.match(/^(.+?[都道府県])/),a=n?n[1]:e.location;t[a]||(t[a]={prefecture:a,jobs:[],count:0}),t[a].jobs.push(e),t[a].count++}),Object.values(t).sort((e,t)=>t.count-e.count)},async getJobsByLocation(e){return(await this.fetchAllJobs()).filter(t=>!!t.location&&t.location.includes(e))},async renderStats(){const e=await this.fetchStats();if(!e)return;const t=document.querySelector(".hero-stats");if(!t)return;const n=Object.keys(e).map(t=>{const n=e[t];return`\n        <div class="stat-item">\n          <span class="stat-number">${this.escapeHtml(n.value)}</span>\n          <span class="stat-label">${this.escapeHtml(n.label)}</span>\n        </div>\n      `}).join("");t.innerHTML=n},trackEvent(e,t={}){var n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||new URLSearchParams(window.location.search).has("debug_mode");n&&console.log("[Analytics]",e,t),"function"==typeof gtag?(gtag("event",e,t),n&&console.log("[Analytics] gtag sent successfully")):console.warn("[Analytics] gtag is not defined, event not sent:",e)},trackCompanyPageView(e){this.trackEvent("view_company_page",{company_domain:e.companyDomain||"",company_name:e.company||"",design_pattern:e.designPattern||"standard",page_location:window.location.href,page_title:document.title})},trackJobView(e){this.trackEvent("view_job",{job_id:e.id||"",job_title:e.title||"",company_domain:e.companyDomain||"",company_name:e.company||"",location:e.location||""})},trackApplyClick(e,t="apply"){this.trackEvent("click_apply",{job_id:e.id||"",job_title:e.title||"",company_domain:e.companyDomain||"",company_name:e.company||"",button_type:t,location:e.location||""})},trackJobCardClick(e){this.trackEvent("click_job_card",{job_id:e.id||"",job_title:e.title||"",company_domain:e.companyDomain||"",company_name:e.company||"",source_page:window.location.pathname})},setupApplyTracking(){document.querySelectorAll(".btn-apply-job, .btn-apply-large").forEach(e=>{e.addEventListener("click",e=>{const t=this.getCompanyDomainFromUrl();this.trackApplyClick({companyDomain:t},"apply")})}),document.querySelectorAll(".btn-line-large").forEach(e=>{e.addEventListener("click",e=>{const t=this.getCompanyDomainFromUrl();this.trackApplyClick({companyDomain:t},"line")})})},async renderFooterLocations(){const e=document.getElementById("footer-locations");if(e)try{const t=(await this.getLocationList()).slice(0,4);if(0===t.length)return void(e.innerHTML='<li><a href="location.html">すべてのエリア</a></li>');e.innerHTML=t.map(e=>`<li><a href="location.html?prefecture=${encodeURIComponent(e.prefecture)}">${this.escapeHtml(e.prefecture)}の求人</a></li>`).join("")+'<li><a href="location.html">すべてのエリア</a></li>'}catch(e){console.error("フッター勤務地の取得エラー:",e)}}};document.addEventListener("DOMContentLoaded",()=>{document.getElementById("job-detail-container")&&JobsLoader.renderJobDetail(),document.getElementById("jobs-container")&&JobsLoader.renderJobs(),document.querySelector(".hero-stats")&&JobsLoader.renderStats(),document.getElementById("footer-locations")&&JobsLoader.renderFooterLocations()}),window.JobsLoader=JobsLoader;