const JobsLoader={SHEET_ID:"1NVIDV3OiXbNrVI7EFdRrU2Ggn8dx7Q0rSnvJ6uaWvX0",SHEET_NAME:"会社一覧",STATS_SHEET_NAME:"Stats",DEFAULT_IMAGE:"images/default-job.svg",get csvUrl(){return`https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${this.SHEET_NAME}`},get statsUrl(){return`https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${this.STATS_SHEET_NAME}`},getSheetUrl(e){return`https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(e)}`},async fetchCompanies(){try{const e=await fetch(this.csvUrl);if(!e.ok)throw new Error("会社一覧の取得に失敗しました");const n=await e.text();return this.parseCSV(n)}catch(e){return console.error("会社一覧の取得エラー:",e),null}},async fetchCompanyJobs(e){if(!e)return null;try{const n=this.extractSpreadsheetId(e.trim());if(!n)return console.error("スプレッドシートIDを取得できませんでした:",e),null;const t=`https://docs.google.com/spreadsheets/d/${n}/gviz/tq?tqx=out:csv`,a=await fetch(t);if(!a.ok)throw new Error("求人データの取得に失敗しました");const s=await a.text();return this.parseCSV(s)}catch(e){return console.error("求人データの取得エラー:",e),null}},extractSpreadsheetId(e){const n=e.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);return n?n[1]:/^[a-zA-Z0-9_-]+$/.test(e)?e:null},async fetchJobs(){return this.fetchCompanies()},parseCSV(e){const n=e.split("\n"),t=this.parseCSVLine(n[0]),a=[];for(let e=1;e<n.length;e++){if(!n[e].trim())continue;const s=this.parseCSVLine(n[e]),o={};t.forEach((e,n)=>{const t=this.normalizeHeader(e);o[t]=s[n]||""}),o.features&&(o.features=o.features.split(",").map(e=>e.trim()).filter(e=>e)),a.push(o)}return a},parseCSVLine(e){const n=[];let t="",a=!1;for(let s=0;s<e.length;s++){const o=e[s];'"'===o?a&&'"'===e[s+1]?(t+='"',s++):a=!a:","!==o||a?t+=o:(n.push(t.trim()),t="")}return n.push(t.trim()),n},normalizeHeader:e=>({id:"id",ID:"id","会社名":"company",company:"company","タイトル":"title",title:"title","勤務地":"location",location:"location","特典総額":"totalBonus",totalBonus:"totalBonus","月収例":"monthlySalary",monthlySalary:"monthlySalary","特徴":"features",features:"features","バッジ":"badges",badges:"badges","画像URL":"imageUrl",imageUrl:"imageUrl","詳細URL":"detailUrl",detailUrl:"detailUrl","表示":"visible",visible:"visible","表示する":"showCompany","並び順":"order",order:"order","会社ドメイン":"companyDomain",companyDomain:"companyDomain",company_domain:"companyDomain","説明":"description",description:"description","仕事内容":"jobDescription",jobDescription:"jobDescription","応募資格":"requirements",requirements:"requirements","待遇":"benefits",benefits:"benefits","勤務時間":"workingHours",workingHours:"workingHours","休日":"holidays",holidays:"holidays","デザインパターン":"designPattern",designPattern:"designPattern",design_pattern:"designPattern","パターン":"designPattern",pattern:"designPattern","管理シート":"jobsSheet",jobsSheet:"jobsSheet",jobs_sheet:"jobsSheet"}[e.replace(/"/g,"").trim()]||e.replace(/"/g,"").trim()),isCompanyVisible:e=>!(!e.jobsSheet||!e.jobsSheet.trim())&&("○"===e.showCompany||"◯"===e.showCompany),renderJobCard(e){const n=e.badges?e.badges.split(",").map(e=>e.trim()):[],t=Array.isArray(e.features)?e.features:[];let a="";(n.includes("NEW")||n.includes("new"))&&(a+='<span class="job-badge new">NEW</span>'),(n.includes("人気")||n.includes("hot"))&&(a+='<span class="job-badge hot">人気</span>');const s=t.map(e=>`<li>${this.escapeHtml(e)}</li>`).join(""),o=e.imageUrl&&e.imageUrl.trim()?e.imageUrl:this.DEFAULT_IMAGE,i=`<img src="${this.escapeHtml(o)}" alt="${this.escapeHtml(e.company)}" onerror="this.parentElement.innerHTML='<div class=\\'job-image-placeholder\\'>${this.escapeHtml(e.company)}</div>'">`;return`\n      <article class="job-card" data-job-id="${this.escapeHtml(e.id||"")}">\n        ${a?`<div class="job-card-header">${a}</div>`:""}\n        <div class="job-card-image">\n          ${i}\n        </div>\n        <div class="job-card-body">\n          <h3 class="job-title">${this.escapeHtml(e.title)}</h3>\n          <p class="job-location">${this.escapeHtml(e.location)}</p>\n          <div class="job-benefits">\n            <div class="benefit-item highlight">\n              <span class="benefit-label">特典総額</span>\n              <span class="benefit-value">${this.escapeHtml(e.totalBonus)}</span>\n            </div>\n            <div class="benefit-item">\n              <span class="benefit-label">月収例</span>\n              <span class="benefit-value">${this.escapeHtml(e.monthlySalary)}</span>\n            </div>\n          </div>\n          ${s?`<ul class="job-features">${s}</ul>`:""}\n          <a href="${this.getDetailUrl(e)}" class="btn-apply">詳細を見る</a>\n        </div>\n      </article>\n    `},escapeHtml(e){if(!e)return"";const n=document.createElement("div");return n.textContent=e,n.innerHTML},getDetailUrl(e){return e.companyDomain&&e.companyDomain.trim()?`company.html?id=${encodeURIComponent(e.companyDomain.trim())}`:this.escapeHtml(e.detailUrl||"#")},getCompanyDomainFromUrl:()=>new URLSearchParams(window.location.search).get("id"),async renderJobDetail(){const e=document.getElementById("job-detail-container");if(!e)return;const n=this.getCompanyDomainFromUrl();if(!n)return void(e.innerHTML='\n        <div class="jobs-error">\n          <p>求人が見つかりませんでした。</p>\n          <a href="/" class="btn-more">トップページに戻る</a>\n        </div>\n      ');const t=await this.fetchCompanies();if(!t)return void(e.innerHTML='\n        <div class="jobs-error">\n          <p>会社情報を取得できませんでした。</p>\n          <button onclick="JobsLoader.renderJobDetail()">再読み込み</button>\n        </div>\n      ');const a=t.find(e=>e.companyDomain&&e.companyDomain.trim()===n&&this.isCompanyVisible(e));if(!a)return void(e.innerHTML='\n        <div class="jobs-error">\n          <p>会社が見つかりませんでした。</p>\n          <a href="/" class="btn-more">トップページに戻る</a>\n        </div>\n      ');let s=[];if(a.jobsSheet&&a.jobsSheet.trim()){const e=await this.fetchCompanyJobs(a.jobsSheet.trim());e&&e.length>0&&(s=e.filter(e=>"false"!==e.visible&&"FALSE"!==e.visible).sort((e,n)=>(parseInt(e.order)||999)-(parseInt(n.order)||999)))}0===s.length&&(s=[a]),document.title=`${a.company}の求人一覧 | リクエコ求人ナビ`;const o=document.querySelector('meta[name="description"]');o&&(o.content=`${a.company}の期間工・期間従業員求人一覧。${s.length}件の求人を掲載中。`);const i=document.getElementById("breadcrumb-current");i&&(i.textContent=a.company),e.innerHTML=this.renderCompanyPageContent(a,s),this.trackCompanyPageView(a),this.setupApplyTracking(),this.renderRelatedJobs(t,n)},getDesignPatternClass(e){const n=e?e.toLowerCase().trim():"";return["modern","classic","minimal","colorful"].includes(n)?`pattern-${n}`:""},renderCompanyPageContent(e,n){const t=e.imageUrl&&e.imageUrl.trim()?e.imageUrl:this.DEFAULT_IMAGE;return`\n      <div class="company-page ${this.getDesignPatternClass(e.designPattern)}">\n        <div class="company-header">\n          <div class="company-header-image">\n            <img src="${this.escapeHtml(t)}" alt="${this.escapeHtml(e.company)}" onerror="this.style.display='none'">\n          </div>\n          <div class="company-header-info">\n            <h1 class="company-name">${this.escapeHtml(e.company)}</h1>\n            <p class="company-job-count">${n.length}件の求人を掲載中</p>\n          </div>\n        </div>\n\n        ${e.description?`\n        <div class="company-description">\n          <h2>会社について</h2>\n          <p>${this.escapeHtml(e.description).replace(/\n/g,"<br>")}</p>\n        </div>\n        `:""}\n\n        <div class="company-jobs">\n          <h2>募集中の求人</h2>\n          <div class="company-jobs-list">\n            ${n.map(e=>this.renderCompanyJobCard(e)).join("")}\n          </div>\n        </div>\n\n        <div class="company-cta">\n          <p>お仕事選びでお困りですか？</p>\n          <div class="company-cta-buttons">\n            <a href="#" class="btn-apply-large">無料で相談する</a>\n            <a href="#" class="btn-line-large">LINEで相談する</a>\n          </div>\n        </div>\n      </div>\n    `},renderCompanyJobCard(e){const n=e.badges?e.badges.split(",").map(e=>e.trim()):[],t=Array.isArray(e.features)?e.features:[];let a="";return(n.includes("NEW")||n.includes("new"))&&(a+='<span class="job-badge new">NEW</span>'),(n.includes("人気")||n.includes("hot"))&&(a+='<span class="job-badge hot">人気</span>'),`\n      <div class="company-job-card">\n        <div class="company-job-card-header">\n          ${a}\n          <h3 class="company-job-title">${this.escapeHtml(e.title)}</h3>\n          <p class="company-job-location">${this.escapeHtml(e.location)}</p>\n        </div>\n        <div class="company-job-card-body">\n          <div class="company-job-benefits">\n            <div class="company-job-benefit highlight">\n              <span class="label">特典総額</span>\n              <span class="value">${this.escapeHtml(e.totalBonus)}</span>\n            </div>\n            <div class="company-job-benefit">\n              <span class="label">月収例</span>\n              <span class="value">${this.escapeHtml(e.monthlySalary)}</span>\n            </div>\n          </div>\n          ${t.length>0?`\n          <ul class="company-job-features">\n            ${t.map(e=>`<li>${this.escapeHtml(e)}</li>`).join("")}\n          </ul>\n          `:""}\n\n          ${e.jobDescription?`\n          <div class="company-job-description">\n            <h4>仕事内容</h4>\n            <p>${this.escapeHtml(e.jobDescription).replace(/\n/g,"<br>")}</p>\n          </div>\n          `:""}\n\n          ${e.requirements?`\n          <div class="company-job-description">\n            <h4>応募資格</h4>\n            <p>${this.escapeHtml(e.requirements).replace(/\n/g,"<br>")}</p>\n          </div>\n          `:""}\n\n          ${e.benefits?`\n          <div class="company-job-description">\n            <h4>待遇・福利厚生</h4>\n            <p>${this.escapeHtml(e.benefits).replace(/\n/g,"<br>")}</p>\n          </div>\n          `:""}\n\n          ${e.workingHours?`\n          <div class="company-job-description">\n            <h4>勤務時間</h4>\n            <p>${this.escapeHtml(e.workingHours).replace(/\n/g,"<br>")}</p>\n          </div>\n          `:""}\n\n          ${e.holidays?`\n          <div class="company-job-description">\n            <h4>休日・休暇</h4>\n            <p>${this.escapeHtml(e.holidays).replace(/\n/g,"<br>")}</p>\n          </div>\n          `:""}\n\n          <a href="#" class="btn-apply-job">この求人に応募する</a>\n        </div>\n      </div>\n    `},async renderRelatedJobs(e,n){const t=document.getElementById("related-jobs-container");if(!t)return;const a=e.filter(e=>e.companyDomain!==n&&this.isCompanyVisible(e)).sort((e,n)=>(parseInt(e.order)||999)-(parseInt(n.order)||999)).slice(0,3);0!==a.length?t.innerHTML=a.map(e=>this.renderJobCard(e)).join(""):t.innerHTML="<p>他の求人がありません。</p>"},async renderJobs(e="jobs-container"){const n=document.getElementById(e);if(!n)return void console.error(`Container #${e} not found`);n.innerHTML='\n      <div class="jobs-loading">\n        <div class="loading-spinner"></div>\n        <p>求人情報を読み込んでいます...</p>\n      </div>\n    ';const t=await this.fetchJobs();if(!t||0===t.length)return void(n.innerHTML=`\n        <div class="jobs-error">\n          <p>求人情報を取得できませんでした。</p>\n          <button onclick="JobsLoader.renderJobs('${e}')">再読み込み</button>\n        </div>\n      `);const a=t.filter(e=>this.isCompanyVisible(e)).sort((e,n)=>(parseInt(e.order)||999)-(parseInt(n.order)||999));n.innerHTML=a.map(e=>this.renderJobCard(e)).join("")},async fetchStats(){try{const e=await fetch(this.statsUrl);if(!e.ok)throw new Error("実績データの取得に失敗しました");const n=await e.text();return this.parseStatsCSV(n)}catch(e){return console.error("実績データの取得エラー:",e),null}},parseStatsCSV(e){const n=e.split("\n"),t={};for(let e=1;e<n.length;e++){if(!n[e].trim())continue;const a=this.parseCSVLine(n[e]),s=a[0]?a[0].replace(/"/g,"").trim():"",o=a[1]?a[1].replace(/"/g,"").trim():"",i=a[2]?a[2].replace(/"/g,"").trim():"";s&&(t[s]={value:o,label:i})}return t},async renderStats(){const e=await this.fetchStats();if(!e)return;const n=document.querySelector(".hero-stats");if(!n)return;const t=Object.keys(e).map(n=>{const t=e[n];return`\n        <div class="stat-item">\n          <span class="stat-number">${this.escapeHtml(t.value)}</span>\n          <span class="stat-label">${this.escapeHtml(t.label)}</span>\n        </div>\n      `}).join("");n.innerHTML=t},trackEvent(e,n={}){"function"==typeof gtag&&gtag("event",e,n),"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||console.log("[Analytics]",e,n)},trackCompanyPageView(e){this.trackEvent("view_company_page",{company_domain:e.companyDomain||"",company_name:e.company||"",design_pattern:e.designPattern||"standard",page_location:window.location.href,page_title:document.title})},trackJobView(e){this.trackEvent("view_job",{job_id:e.id||"",job_title:e.title||"",company_domain:e.companyDomain||"",company_name:e.company||"",location:e.location||""})},trackApplyClick(e,n="apply"){this.trackEvent("click_apply",{job_id:e.id||"",job_title:e.title||"",company_domain:e.companyDomain||"",company_name:e.company||"",button_type:n,location:e.location||""})},trackJobCardClick(e){this.trackEvent("click_job_card",{job_id:e.id||"",job_title:e.title||"",company_domain:e.companyDomain||"",company_name:e.company||"",source_page:window.location.pathname})},setupApplyTracking(){document.querySelectorAll(".btn-apply-job, .btn-apply-large").forEach(e=>{e.addEventListener("click",e=>{const n=this.getCompanyDomainFromUrl();this.trackApplyClick({companyDomain:n},"apply")})}),document.querySelectorAll(".btn-line-large").forEach(e=>{e.addEventListener("click",e=>{const n=this.getCompanyDomainFromUrl();this.trackApplyClick({companyDomain:n},"line")})})}};document.addEventListener("DOMContentLoaded",()=>{document.getElementById("job-detail-container")&&JobsLoader.renderJobDetail(),document.getElementById("jobs-container")&&JobsLoader.renderJobs(),document.querySelector(".hero-stats")&&JobsLoader.renderStats()});