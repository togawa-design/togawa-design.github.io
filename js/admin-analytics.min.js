const AdminAnalytics={companyData:[],async loadDashboardData(){const t=document.getElementById("date-range")?.value||7,a=localStorage.getItem("api_endpoint")||AdminDashboard.config.apiEndpoint;if(a&&AdminDashboard.idToken)await this.fetchGAData(t,a);else if(a&&!AdminDashboard.idToken)try{await this.fetchGAData(t,a)}catch(a){this.loadMockData(t)}else this.loadMockData(t)},async fetchGAData(t,a){try{this.showLoading(!0),this.showSectionLoading(!0);const e={};AdminDashboard.idToken&&(e.Authorization=`Bearer ${AdminDashboard.idToken}`);const n=await fetch(`${a}?days=${t}`,{headers:e});if(!n.ok)throw new Error(`API Error: ${n.status}`);const s=await n.json();if(!s.success)throw new Error(s.error||"Unknown error");const o=s.data;o.overview&&(document.getElementById("total-pageviews").textContent=Utils.formatNumber(o.overview.pageViews),document.getElementById("total-users").textContent=Utils.formatNumber(o.overview.users),document.getElementById("company-views").textContent=Utils.formatNumber(o.overview.companyViews),document.getElementById("apply-clicks").textContent=Utils.formatNumber(o.overview.applyClicks)),o.daily&&this.renderDailyChartFromAPI(o.daily),o.companies&&(this.companyData=o.companies.filter(t=>t.domain&&"(not set)"!==t.domain&&t.name&&"(not set)"!==t.name).map(t=>({name:t.name,domain:t.domain,views:t.views,clicks:t.clicks,pattern:"standard"})),this.renderOverviewTable(),this.renderCompanyCards()),o.applications&&this.renderApplicationsDataFromAPI(o.applications),this.showLoading(!1)}catch(a){console.error("[Admin] API fetch error:",a),this.showLoading(!1),this.loadMockData(t)}},showLoading(t){const a=document.getElementById("refresh-btn");a&&(a.textContent=t?"読み込み中...":"更新",a.disabled=t)},showSectionLoading(t){const a='<div class="section-loading"><div class="loading-spinner"></div><span>データを読み込み中...</span></div>';document.querySelectorAll(".stat-value").forEach(a=>{t&&(a.dataset.originalText=a.textContent,a.innerHTML='<span class="loading-dots">...</span>')});const e=document.getElementById("daily-chart");e&&t&&(e.innerHTML=a);const n=document.querySelector(".data-table tbody");n&&t&&(n.innerHTML=`<tr><td colspan="5" style="text-align:center;padding:2rem;">${a}</td></tr>`);const s=document.getElementById("company-cards");s&&t&&(s.innerHTML=a);const o=document.querySelector("#applications-section .data-table tbody");o&&t&&(o.innerHTML=`<tr><td colspan="4" style="text-align:center;padding:2rem;">${a}</td></tr>`)},renderDailyChartFromAPI(t){const a=document.getElementById("daily-chart");if(!t||0===t.length)return void(a.innerHTML="<p>データがありません</p>");const e=Math.max(...t.map(t=>t.views));let n='<div class="simple-chart">';n+='<div class="chart-bars">';(t.length>30?t.filter((t,a)=>a%3==0):t).forEach(t=>{const a=e>0?t.views/e*100:0;n+=`\n        <div class="chart-bar-wrapper">\n          <div class="chart-bar" style="height: ${a}%">\n            <span class="bar-value">${t.views}</span>\n          </div>\n          <span class="bar-label">${t.date}</span>\n        </div>\n      `}),n+="</div></div>",a.innerHTML=n},renderApplicationsDataFromAPI(t){const a=document.querySelector("#applications-table tbody"),e={apply:"応募ボタン",line:"LINE相談",consult:"相談フォーム"};t&&0!==t.length?a.innerHTML=t.map(t=>`\n      <tr>\n        <td>${t.date}</td>\n        <td>${Utils.escapeHtml(t.company)}</td>\n        <td><span class="type-badge ${t.type}">${e[t.type]||t.type}</span></td>\n        <td>${t.source}</td>\n      </tr>\n    `).join(""):a.innerHTML='<tr><td colspan="4" class="loading-cell">応募データがありません</td></tr>'},loadMockData(t){const a=150*t,e=80*t,n=45*t,s=12*t;document.getElementById("total-pageviews").textContent=Utils.formatNumber(a+Math.floor(500*Math.random())),document.getElementById("total-users").textContent=Utils.formatNumber(e+Math.floor(200*Math.random())),document.getElementById("company-views").textContent=Utils.formatNumber(n+Math.floor(100*Math.random())),document.getElementById("apply-clicks").textContent=Utils.formatNumber(s+Math.floor(30*Math.random())),this.renderDailyChart(t),this.renderCompanyData(),this.renderApplicationsData()},renderDailyChart(t){const a=document.getElementById("daily-chart"),e=[],n=new Date;for(let a=t-1;a>=0;a--){const t=new Date(n);t.setDate(t.getDate()-a),e.push({date:`${t.getMonth()+1}/${t.getDate()}`,views:Math.floor(100+200*Math.random()),clicks:Math.floor(5+20*Math.random())})}const s=Math.max(...e.map(t=>t.views));let o='<div class="simple-chart">';o+='<div class="chart-bars">';(t>30?e.filter((t,a)=>a%3==0):e).forEach(t=>{const a=t.views/s*100;o+=`\n        <div class="chart-bar-wrapper">\n          <div class="chart-bar" style="height: ${a}%">\n            <span class="bar-value">${t.views}</span>\n          </div>\n          <span class="bar-label">${t.date}</span>\n        </div>\n      `}),o+="</div></div>",a.innerHTML=o},renderCompanyData(){this.companyData=[{name:"トヨタ自動車",domain:"toyota",views:1250,clicks:89,pattern:"modern"},{name:"日産自動車",domain:"nissan",views:980,clicks:67,pattern:"classic"},{name:"本田技研工業",domain:"honda",views:856,clicks:54,pattern:"colorful"},{name:"スバル",domain:"subaru",views:654,clicks:43,pattern:"minimal"},{name:"マツダ",domain:"mazda",views:523,clicks:32,pattern:"standard"},{name:"スズキ",domain:"suzuki",views:412,clicks:28,pattern:"modern"},{name:"ダイハツ",domain:"daihatsu",views:387,clicks:24,pattern:"classic"},{name:"三菱自動車",domain:"mitsubishi",views:298,clicks:18,pattern:"standard"}],this.renderOverviewTable(),this.renderCompanyCards()},renderOverviewTable(){const t=document.querySelector("#overview-company-table tbody");if(!t)return;const a=[...this.companyData].sort((t,a)=>a.views-t.views);t.innerHTML=a.slice(0,5).map((t,a)=>{const e=(t.clicks/t.views*100).toFixed(1);return`\n        <tr>\n          <td>${a+1}</td>\n          <td>${Utils.escapeHtml(t.name)}</td>\n          <td>${Utils.formatNumber(t.views)}</td>\n          <td>${t.clicks}</td>\n          <td>${e}%</td>\n        </tr>\n      `}).join("")},renderCompanyCards(){const t=document.getElementById("company-cards");t&&(t.innerHTML=this.companyData.map(t=>{const a=(t.clicks/t.views*100).toFixed(1),e=AdminCompany.getPatternLabel(t.pattern);return`\n        <div class="company-card" data-domain="${t.domain}" data-name="${t.name}" data-views="${t.views}" data-clicks="${t.clicks}">\n          <div class="company-card-header">\n            <h4>${Utils.escapeHtml(t.name)}</h4>\n            <span class="pattern-badge ${t.pattern}">${e}</span>\n          </div>\n          <div class="company-card-stats">\n            <div class="card-stat">\n              <span class="stat-value">${Utils.formatNumber(t.views)}</span>\n              <span class="stat-label">ページビュー</span>\n            </div>\n            <div class="card-stat">\n              <span class="stat-value">${t.clicks}</span>\n              <span class="stat-label">応募クリック</span>\n            </div>\n            <div class="card-stat">\n              <span class="stat-value">${a}%</span>\n              <span class="stat-label">CVR</span>\n            </div>\n          </div>\n          <a href="company.html?c=${t.domain}" target="_blank" class="btn-view-page">ページを確認</a>\n        </div>\n      `}).join(""))},filterCompanies(t){const a=document.querySelectorAll(".company-card"),e=t.toLowerCase();a.forEach(t=>{const a=t.dataset.name.toLowerCase(),n=t.dataset.domain.toLowerCase();a.includes(e)||n.includes(e)?t.style.display="":t.style.display="none"})},sortCompanies(){const t=document.getElementById("sort-by").value,a=document.getElementById("company-cards"),e=Array.from(a.querySelectorAll(".company-card"));e.sort((a,e)=>{switch(t){case"views":return parseInt(e.dataset.views)-parseInt(a.dataset.views);case"clicks":return parseInt(e.dataset.clicks)-parseInt(a.dataset.clicks);case"cvr":const t=parseInt(a.dataset.clicks)/parseInt(a.dataset.views);return parseInt(e.dataset.clicks)/parseInt(e.dataset.views)-t;case"name":return a.dataset.name.localeCompare(e.dataset.name,"ja");default:return 0}}),e.forEach(t=>a.appendChild(t))},renderApplicationsData(){const t=document.querySelector("#applications-table tbody");if(!t)return;const a={apply:"応募ボタン",line:"LINE相談",consult:"相談フォーム"};t.innerHTML=[{date:"2025/01/17 14:32",company:"トヨタ自動車",type:"apply",source:"Google検索"},{date:"2025/01/17 13:15",company:"日産自動車",type:"line",source:"直接アクセス"},{date:"2025/01/17 11:48",company:"トヨタ自動車",type:"apply",source:"Yahoo検索"},{date:"2025/01/17 10:22",company:"本田技研工業",type:"apply",source:"直接アクセス"},{date:"2025/01/16 18:45",company:"スバル",type:"line",source:"Google検索"},{date:"2025/01/16 16:30",company:"トヨタ自動車",type:"apply",source:"SNS"},{date:"2025/01/16 14:12",company:"マツダ",type:"apply",source:"Google検索"},{date:"2025/01/16 11:55",company:"日産自動車",type:"apply",source:"直接アクセス"}].map(t=>`\n      <tr>\n        <td>${t.date}</td>\n        <td>${Utils.escapeHtml(t.company)}</td>\n        <td><span class="type-badge ${t.type}">${a[t.type]}</span></td>\n        <td>${t.source}</td>\n      </tr>\n    `).join("")}};window.AdminAnalytics=AdminAnalytics;