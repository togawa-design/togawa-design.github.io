import"./modulepreload-polyfill-YP0FEG5d.js";import{e}from"./utils-BE8OECDH.js";import{g as t,e as n,f as a,h as o,i as s}from"./job-feed-generator-BbzggbON.js";import"./jobs-loader-CErzUEmq.js";const l={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"};let d=null,i=[],c=[],r=1;let u=null,m=[];const p={new:"新規",contacted:"連絡済み",interviewing:"面接調整中",interviewed:"面接済み",hired:"採用",rejected:"不採用",withdrawn:"辞退"},g={apply:"応募",line:"LINE相談",consult:"お問い合わせ"},y={immediate:"すぐにでも","within-week":"1週間以内","within-month":"1ヶ月以内","within-2months":"2ヶ月以内",undecided:"未定・相談したい"},b={first_contact:{subject:"初回連絡",body:"{applicantName}様\n\nこの度は「{jobTitle}」にご応募いただき、誠にありがとうございます。\n\nご応募内容を確認させていただきました。\nつきましては、一度お電話にてお話をさせていただければと思います。\n\nご都合の良い日時をいくつかお知らせいただけますでしょうか。\n（平日10:00〜18:00の間でお願いできますと幸いです）\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n何卒よろしくお願いいたします。"},schedule_interview:{subject:"面接日程調整",body:"{applicantName}様\n\nお世話になっております。\n\n面接の日程調整についてご連絡いたします。\n\n下記の日程でご都合の良い日時はございますでしょうか。\n\n【候補日】\n・◯月◯日（◯）◯◯:00〜\n・◯月◯日（◯）◯◯:00〜\n・◯月◯日（◯）◯◯:00〜\n\n上記以外でもご調整可能ですので、ご希望の日時がございましたらお知らせください。\n\n何卒よろしくお願いいたします。"},interview_reminder:{subject:"面接リマインダー",body:"{applicantName}様\n\nお世話になっております。\n\n面接日程のリマインドをお送りいたします。\n\n【面接日時】◯月◯日（◯）◯◯:00〜\n【場所】〒◯◯◯-◯◯◯◯ ◯◯県◯◯市◯◯\n【持ち物】履歴書、筆記用具\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n当日お会いできることを楽しみにしております。"},document_request:{subject:"書類提出依頼",body:"{applicantName}様\n\nお世話になっております。\n\n選考を進めるにあたり、下記の書類をご提出いただけますでしょうか。\n\n【提出書類】\n・履歴書（写真貼付）\n・職務経歴書\n\n【提出方法】\nマイページからアップロード、またはメールにてご送付ください。\n\n【提出期限】\n◯月◯日（◯）まで\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n何卒よろしくお願いいたします。"},result_pending:{subject:"選考結果待ち",body:"{applicantName}様\n\nお世話になっております。\n\n先日は面接にお越しいただき、誠にありがとうございました。\n\n現在、社内にて選考を進めております。\n結果につきましては、◯月◯日頃までにご連絡させていただく予定です。\n\n今しばらくお待ちいただけますようお願い申し上げます。"},offer:{subject:"内定通知",body:"{applicantName}様\n\nお世話になっております。\n\nこの度は「{jobTitle}」の選考にご参加いただき、誠にありがとうございました。\n\n慎重に検討させていただいた結果、{applicantName}様を採用させていただくことになりました。\n\nつきましては、入社に関する詳細についてご説明させていただきたく、\nお電話にてご連絡させていただきます。\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n{applicantName}様と一緒に働けることを楽しみにしております。"},rejection:{subject:"不採用通知",body:"{applicantName}様\n\nお世話になっております。\n\nこの度は「{jobTitle}」にご応募いただき、誠にありがとうございました。\n\n慎重に検討させていただきましたが、誠に残念ながら今回はご期待に沿えない結果となりました。\n\nご応募いただいたことに心より感謝申し上げますとともに、\n{applicantName}様の今後のご活躍をお祈り申し上げます。"}};function f(){return firebase.apps.length||firebase.initializeApp(l),firebase.firestore()}function v(){const t=document.getElementById("detail-assignee");if(t){const n=t.value;t.innerHTML='<option value="">未割当</option>'+m.map(t=>`<option value="${e(t)}">${e(t)}</option>`).join(""),t.value=n}}async function h(){var e;const t=document.getElementById("new-assignee-name"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(n)if(m.includes(n))alert("この担当者は既に登録されています");else try{const e=f().collection("settings").doc(d||"global");m.push(n),await e.set({assignees:m,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),v(),I();const t=document.getElementById("detail-assignee");t&&(t.value=n)}catch(a){console.error("Failed to add assignee:",a),alert("担当者の追加に失敗しました: "+a.message)}else alert("担当者名を入力してください")}function E(){const e=document.getElementById("assignee-modal"),t=document.getElementById("new-assignee-name");e&&(e.style.display="flex"),t&&(t.value="",t.focus())}function I(){const e=document.getElementById("assignee-modal");e&&(e.style.display="none")}async function w(){const e=document.getElementById("applicants-list");e&&(e.innerHTML='<div class="loading-message">データを読み込み中...</div>');try{let e=f().collection("applications");d&&(e=e.where("companyDomain","==",d)),e=e.orderBy("createdAt","desc");const t=await e.get();i=[],t.forEach(e=>{i.push({id:e.id,...e.data()})}),j(),B()}catch(t){console.error("Failed to load applicants:",t),e&&(e.innerHTML='<div class="empty-message">データの読み込みに失敗しました</div>')}}function j(){var e,t,n,a;const o=(null==(e=document.getElementById("filter-status"))?void 0:e.value)||"",s=(null==(t=document.getElementById("filter-type"))?void 0:t.value)||"",l=(null==(a=null==(n=document.getElementById("filter-search"))?void 0:n.value)?void 0:a.toLowerCase())||"";c=i.filter(e=>{var t;if(o&&(e.status||"new")!==o)return!1;if(s&&e.type!==s)return!1;if(l){const n=(e.jobTitle||"").toLowerCase(),a=(e.applicantName||(null==(t=e.applicant)?void 0:t.name)||"").toLowerCase();if(!n.includes(l)&&!a.includes(l))return!1}return!0}),r=1,L(),$()}function B(){const e=i.length,t=i.filter(e=>!e.status||"new"===e.status).length,n=i.filter(e=>["contacted","interviewing","interviewed"].includes(e.status)).length,a=i.filter(e=>["hired","rejected","withdrawn"].includes(e.status)).length,o=document.getElementById("stat-total"),s=document.getElementById("stat-new"),l=document.getElementById("stat-progress"),d=document.getElementById("stat-complete");o&&(o.textContent=e),s&&(s.textContent=t),l&&(l.textContent=n),d&&(d.textContent=a)}function L(){const t=document.getElementById("applicants-list");if(!t)return;if(0===c.length)return void(t.innerHTML='<div class="empty-message">応募データがありません</div>');const n=20*(r-1),a=n+20,o=c.slice(n,a);t.innerHTML=o.map(t=>{var n,a;const o=C((null==(n=t.createdAt)?void 0:n.toDate)?t.createdAt.toDate():new Date(t.timestamp||t.createdAt)),s=t.status||"new",l=g[t.type]||t.type||"-",d=p[s]||s,i=t.applicantName||(null==(a=t.applicant)?void 0:a.name)||"-",c=u===t.id;let r="type-apply";return"line"===t.type&&(r="type-line"),"consult"===t.type&&(r="type-consult"),`\n      <div class="applicant-card ${c?"selected":""}" data-id="${e(t.id)}">\n        <div class="applicant-card-main">\n          <div class="applicant-card-header">\n            <span class="applicant-card-name">${e(i)}</span>\n            <span class="applicant-card-type ${r}">${e(l)}</span>\n          </div>\n          <div class="applicant-card-job">${e(t.jobTitle||"-")}</div>\n          <div class="applicant-card-meta">\n            <span>${e(o)}</span>\n            ${t.assignee?`<span>担当: ${e(t.assignee)}</span>`:""}\n          </div>\n        </div>\n        <div class="applicant-card-status">\n          <span class="status-badge status-${e(s)}">${e(d)}</span>\n        </div>\n      </div>\n    `}).join(""),t.querySelectorAll(".applicant-card").forEach(e=>{e.addEventListener("click",()=>{!function(e){var t,n,a,o,s,l,d;const c=i.find(t=>t.id===e);if(!c)return;u=e,document.querySelectorAll(".applicant-card").forEach(t=>{t.classList.toggle("selected",t.dataset.id===e)});const r=document.getElementById("detail-empty"),m=document.getElementById("detail-content");r&&(r.style.display="none");m&&(m.style.display="flex");const p=c.applicantName||(null==(t=c.applicant)?void 0:t.name)||"-",b=c.applicantPhone||(null==(n=c.applicant)?void 0:n.phone)||"-",f=c.applicantEmail||(null==(a=c.applicant)?void 0:a.email)||"-",v=(null==(o=c.applicant)?void 0:o.age)||"-",h=(null==(s=c.applicant)?void 0:s.address)||"-",E=(null==(l=c.applicant)?void 0:l.startDate)||"-";document.getElementById("detail-name").textContent=p,document.getElementById("detail-job-title").textContent=c.jobTitle||"-",document.getElementById("detail-phone").textContent=b,document.getElementById("detail-email").textContent=f,document.getElementById("detail-age").textContent=v,document.getElementById("detail-address").textContent=h,document.getElementById("detail-start-date").textContent=y[E]||E;const I=(null==(d=c.createdAt)?void 0:d.toDate)?c.createdAt.toDate():new Date(c.timestamp||c.createdAt);document.getElementById("detail-datetime").textContent=C(I,!0),document.getElementById("detail-type").textContent=g[c.type]||c.type||"-",document.getElementById("detail-source").textContent=H(c.source);const w=c.status||"new";document.querySelectorAll(".status-btn").forEach(e=>{e.classList.toggle("active",e.dataset.status===w)});const j=document.getElementById("detail-assignee");j&&(j.value=c.assignee||"");const B=document.getElementById("detail-notes");B&&(B.value=c.notes||"");T(c.history||[]),D(e)}(e.dataset.id)})})}function $(){const e=document.getElementById("pagination");if(!e)return;const t=Math.ceil(c.length/20);if(t<=1)return void(e.innerHTML="");let n="";n+=`<button class="page-btn" ${1===r?"disabled":""} data-page="${r-1}">前へ</button>`;for(let a=1;a<=t;a++)1===a||a===t||a>=r-2&&a<=r+2?n+=`<button class="page-btn ${a===r?"active":""}" data-page="${a}">${a}</button>`:a!==r-3&&a!==r+3||(n+='<span class="page-ellipsis">...</span>');n+=`<button class="page-btn" ${r===t?"disabled":""} data-page="${r+1}">次へ</button>`,e.innerHTML=n,e.querySelectorAll(".page-btn").forEach(e=>{e.addEventListener("click",()=>{e.disabled||(r=parseInt(e.dataset.page),L(),$())})})}function x(){u=null,document.querySelectorAll(".applicant-card").forEach(e=>{e.classList.remove("selected")});const e=document.getElementById("detail-empty"),t=document.getElementById("detail-content");e&&(e.style.display="flex"),t&&(t.style.display="none")}async function D(t){const n=document.getElementById("messages-container");if(n){n.innerHTML='<p class="no-data">読み込み中...</p>';try{const n=f(),a=await n.collection("messages").where("applicationId","==",t).orderBy("createdAt","asc").get(),o=[];a.forEach(e=>{o.push({id:e.id,...e.data()})}),function(t){const n=document.getElementById("messages-container");if(!n)return;if(!t||0===t.length)return void(n.innerHTML='<p class="no-data">メッセージはありません</p>');n.innerHTML=t.map(t=>{var n;const a=(null==(n=t.createdAt)?void 0:n.toDate)?t.createdAt.toDate():new Date(t.createdAt),o="company"===t.from;return`\n      <div class="message-item ${o?"message-company":"message-applicant"}">\n        <div class="message-header">\n          <span class="message-sender">${e(o?"会社":"応募者")}</span>\n          <span class="message-date">${C(a,!0)}</span>\n        </div>\n        <div class="message-content">${e(t.content).replace(/\n/g,"<br>")}</div>\n      </div>\n    `}).join(""),n.scrollTop=n.scrollHeight}(o)}catch(a){console.error("Failed to load messages:",a),n.innerHTML='<p class="no-data">メッセージの読み込みに失敗しました</p>'}}}async function S(){var e;if(!u)return;const t=document.getElementById("new-message-text"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(!n)return void alert("メッセージを入力してください");const a=document.getElementById("btn-send-message");a&&(a.disabled=!0,a.textContent="送信中...");try{const e=f(),a=i.find(e=>e.id===u);await e.collection("messages").add({applicationId:u,companyDomain:(null==a?void 0:a.companyDomain)||d,from:"company",content:n,read:!1,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),t.value="",await D(u)}catch(o){console.error("Failed to send message:",o),alert("メッセージの送信に失敗しました: "+o.message)}finally{a&&(a.disabled=!1,a.textContent="送信")}}function T(t){const n=document.getElementById("detail-history");n&&(t&&0!==t.length?n.innerHTML=t.map(t=>{var n;return`\n      <div class="history-item">\n        <div class="history-date">${C((null==(n=t.date)?void 0:n.toDate)?t.date.toDate():new Date(t.date),!0)}</div>\n        <div class="history-text">${e(t.text)}</div>\n      </div>\n    `}).join(""):n.innerHTML='<p class="no-data">対応履歴はありません</p>')}async function k(){var e,t;if(!u)return;const n=(null==(e=document.getElementById("detail-notes"))?void 0:e.value)||"",a=(null==(t=document.getElementById("detail-assignee"))?void 0:t.value)||"",o=document.getElementById("btn-save-notes");o&&(o.disabled=!0,o.textContent="保存中...");try{const e=f();await e.collection("applications").doc(u).update({notes:n,assignee:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const t=i.findIndex(e=>e.id===u);-1!==t&&(i[t].notes=n,i[t].assignee=a),L()}catch(s){console.error("Failed to save notes:",s),alert("保存に失敗しました")}finally{o&&(o.disabled=!1,o.textContent="保存")}}async function M(){var e;if(!u)return;const t=document.getElementById("new-history-text"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(n)try{const e=f(),a=i.find(e=>e.id===u),o=(null==a?void 0:a.history)||[];o.push({date:new Date,text:n}),await e.collection("applications").doc(u).update({history:o,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const s=i.findIndex(e=>e.id===u);-1!==s&&(i[s].history=o),T(o),t.value=""}catch(a){console.error("Failed to add history:",a),alert("履歴の追加に失敗しました: "+a.message)}else alert("対応内容を入力してください")}function A(){if(0===c.length)return void alert("エクスポートするデータがありません");const e=c.map(e=>{var t,n,a,o,s,l,d;const i=(null==(t=e.createdAt)?void 0:t.toDate)?e.createdAt.toDate():new Date(e.timestamp||e.createdAt),c=e.applicantName||(null==(n=e.applicant)?void 0:n.name)||"",r=e.applicantPhone||(null==(a=e.applicant)?void 0:a.phone)||"",u=e.applicantEmail||(null==(o=e.applicant)?void 0:o.email)||"",m=(null==(s=e.applicant)?void 0:s.age)||"",b=(null==(l=e.applicant)?void 0:l.address)||"",f=(null==(d=e.applicant)?void 0:d.startDate)||"";return[C(i,!0),g[e.type]||e.type||"",c,r,u,m,b,y[f]||f,e.jobTitle||"",H(e.source),p[e.status||"new"],e.assignee||"",(e.notes||"").replace(/"/g,'""')]}),t=[["日時","種別","応募者名","電話番号","メール","年齢","現住所","希望勤務開始日","求人タイトル","流入元","ステータス","担当者","メモ"].join(","),...e.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),n=new Blob(["\ufeff"+t],{type:"text/csv;charset=utf-8"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`applicants-${d||"all"}-${function(e){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}${n}${a}`}(new Date)}.csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function C(e,t=!1){if(!e||isNaN(e.getTime()))return"-";const n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");if(!t)return`${n}/${a}/${o}`;return`${n}/${a}/${o} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}function H(e){if(!e||"direct"===e)return"直接アクセス";try{const t=new URL(e).hostname;return t.includes("google")?"Google検索":t.includes("yahoo")?"Yahoo!検索":t.includes("tiktok")?"TikTok広告":t.includes("instagram")||t.includes("fb")||t.includes("facebook")?"Meta広告":t.includes("twitter")||t.includes("x.com")?"X(Twitter)":t.includes("line")?"LINE":t}catch{return e||"不明"}}function _(){var e,t,n,a,o,s,l,d,c,r,m,p,g,y,v,L,$,D,T;let C;null==(e=document.getElementById("btn-refresh"))||e.addEventListener("click",w),null==(t=document.getElementById("btn-refresh-applicants"))||t.addEventListener("click",w),null==(n=document.getElementById("btn-export-csv"))||n.addEventListener("click",A),null==(a=document.getElementById("filter-status"))||a.addEventListener("change",j),null==(o=document.getElementById("filter-type"))||o.addEventListener("change",j),null==(s=document.getElementById("filter-search"))||s.addEventListener("input",()=>{clearTimeout(C),C=setTimeout(j,300)}),null==(l=document.getElementById("btn-close-detail"))||l.addEventListener("click",x),document.querySelectorAll(".status-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.status;t&&async function(e){if(u)try{const t=f();await t.collection("applications").doc(u).update({status:e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const n=i.findIndex(e=>e.id===u);-1!==n&&(i[n].status=e),document.querySelectorAll(".status-btn").forEach(t=>{t.classList.toggle("active",t.dataset.status===e)}),j(),B()}catch(t){console.error("Failed to update status:",t),alert("ステータスの更新に失敗しました")}}(t)})}),null==(d=document.getElementById("btn-save-notes"))||d.addEventListener("click",k),null==(c=document.getElementById("btn-add-history"))||c.addEventListener("click",M),null==(r=document.getElementById("new-history-text"))||r.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),M())}),null==(m=document.getElementById("btn-send-message"))||m.addEventListener("click",S),null==(p=document.getElementById("new-message-text"))||p.addEventListener("keydown",e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),S())}),null==(g=document.getElementById("message-template-select"))||g.addEventListener("change",e=>{!function(e){var t;if(!e)return;const n=b[e];if(!n)return;const a=i.find(e=>e.id===u);if(!a)return;const o=a.applicantName||(null==(t=a.applicant)?void 0:t.name)||"お客様",s=a.jobTitle||"求人";let l=n.body.replace(/{applicantName}/g,o).replace(/{jobTitle}/g,s);const d=document.getElementById("new-message-text");d&&(d.value=l,d.focus());const c=document.getElementById("message-template-select");c&&(c.value="")}(e.target.value)}),null==(y=document.getElementById("btn-add-assignee"))||y.addEventListener("click",E),null==(v=document.getElementById("assignee-modal-close"))||v.addEventListener("click",I),null==(L=document.getElementById("assignee-modal-cancel"))||L.addEventListener("click",I),null==($=document.getElementById("assignee-modal-save"))||$.addEventListener("click",h),null==(D=document.getElementById("assignee-modal"))||D.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&I()}),null==(T=document.getElementById("new-assignee-name"))||T.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),h())})}async function N(e,t){d=e,_(),await async function(){try{const e=f().collection("settings").doc(d||"global"),t=await e.get();m=t.exists&&t.data().assignees?t.data().assignees:[],v()}catch(e){console.error("Failed to load assignees:",e),m=[]}}(),await w()}const X="https://script.google.com/macros/s/AKfycbxj6CqSfY7jq04uDXURhewD_BAKx3csLKBpl1hdRBdNg-R-E6IuoaZGje22Gr9WYWY2/exec",F={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"};let O=null,q=null,R=null,J=[],U=null,G=!1,K=[],P=null,Y=null;function V(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async function Z(){const t=document.getElementById("jobs-tbody");if(!t)return;t.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';const n=X;try{const a=`${n}?action=getJobs&domain=${encodeURIComponent(O)}`,o=await fetch(a);if(!o.ok)throw new Error("データの取得に失敗しました");const s=await o.json();if(!s.success)throw new Error(s.error||"求人データの取得に失敗しました");if(J=s.jobs||[],0===J.length)return void(t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>');!function(){const t=document.getElementById("jobs-tbody");if(!t)return;const n=J||[];0!==n.length?(t.innerHTML=n.map(t=>{const n=t.monthlySalary?`¥${Number(t.monthlySalary).toLocaleString()}`:"-",a="true"===t.visible||"TRUE"===t.visible||!0===t.visible;return`\n      <tr data-row="${t._rowIndex}">\n        <td>${e(t.id||"-")}</td>\n        <td>${e(t.title||"-")}</td>\n        <td>${e(t.location||"-")}</td>\n        <td>${n}</td>\n        <td>${a?'<span class="badge success">公開</span>':'<span class="badge">非公開</span>'}</td>\n        <td>\n          <div class="action-buttons">\n            <button class="btn-small btn-edit" data-row="${t._rowIndex}">編集</button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),t.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{W(parseInt(e.dataset.row,10))})})):t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>'}()}catch(a){console.error("求人データの読み込みエラー:",a),t.innerHTML=`<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました: ${e(a.message)}</td></tr>`}}function z(){U=null,G=!0;const e=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t)};document.getElementById("job-modal-title").textContent="新規求人作成",e("edit-job-title",""),e("edit-job-location",""),e("edit-job-salary",""),e("edit-job-bonus",""),e("edit-job-order",""),e("edit-job-features",""),e("edit-job-badges",""),e("edit-job-description",""),e("edit-job-requirements",""),e("edit-job-benefits",""),e("edit-job-hours",""),e("edit-job-holidays",""),e("edit-job-start-date",""),e("edit-job-end-date","");const t=document.getElementById("edit-job-visible");t&&(t.checked=!0);const n=document.getElementById("job-modal-delete");n&&(n.style.display="none");const a=document.getElementById("job-modal");a&&(a.style.display="flex")}function W(e){const t=null==J?void 0:J.find(t=>t._rowIndex===e);if(!t)return void alert("求人データが見つかりません");U=t,G=!1;const n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};document.getElementById("job-modal-title").textContent="求人情報の編集",n("edit-job-title",t.title),n("edit-job-location",t.location),n("edit-job-salary",t.monthlySalary),n("edit-job-bonus",t.totalBonus),n("edit-job-order",t.order),n("edit-job-features",t.features),n("edit-job-badges",t.badges),n("edit-job-description",t.jobDescription),n("edit-job-requirements",t.requirements),n("edit-job-benefits",t.benefits),n("edit-job-hours",t.workingHours),n("edit-job-holidays",t.holidays),t.publishStartDate?n("edit-job-start-date",V(t.publishStartDate)):n("edit-job-start-date",""),t.publishEndDate?n("edit-job-end-date",V(t.publishEndDate)):n("edit-job-end-date","");const a=document.getElementById("edit-job-visible");a&&(a.checked="true"===t.visible||"TRUE"===t.visible||!0===t.visible);const o=document.getElementById("job-modal-delete");o&&(o.style.display="");const s=document.getElementById("job-modal");s&&(s.style.display="flex")}function Q(){const e=document.getElementById("job-modal");e&&(e.style.display="none"),U=null,G=!1}async function ee(){var e;if(!O)return void alert("会社が選択されていません");const t=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},n={title:t("edit-job-title"),location:t("edit-job-location"),monthlySalary:t("edit-job-salary"),totalBonus:t("edit-job-bonus"),order:t("edit-job-order"),features:t("edit-job-features"),badges:t("edit-job-badges"),jobDescription:t("edit-job-description"),requirements:t("edit-job-requirements"),benefits:t("edit-job-benefits"),workingHours:t("edit-job-hours"),holidays:t("edit-job-holidays"),publishStartDate:t("edit-job-start-date"),publishEndDate:t("edit-job-end-date"),visible:(null==(e=document.getElementById("edit-job-visible"))?void 0:e.checked)?"true":"false"};if(!n.title||!n.location)return void alert("募集タイトルと勤務地は必須です");const a=X,o=document.getElementById("job-modal-save");try{o&&(o.disabled=!0,o.textContent="保存中...");const e=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveJob",companyDomain:O,job:n,rowIndex:G?null:U._rowIndex})))),t=`${a}?action=post&data=${encodeURIComponent(e)}`,l=await fetch(t,{method:"GET",redirect:"follow"}),d=await l.text();let i;try{i=JSON.parse(d)}catch(s){throw console.error("JSON parse error:",s),new Error(`GASからの応答が不正です: ${d.substring(0,200)}`)}if(!i.success)return void alert("保存に失敗しました: "+(i.error||"不明なエラー"));Q(),await Z(),alert(G?"求人を作成しました":"求人情報を更新しました")}catch(l){console.error("求人保存エラー:",l),alert("保存中にエラーが発生しました: "+l.message)}finally{o&&(o.disabled=!1,o.textContent="保存")}}async function te(){if(!U||!O)return void alert("削除対象が選択されていません");if(!confirm("この求人を削除してもよろしいですか？"))return;const e=X,t=document.getElementById("job-modal-delete");try{t&&(t.disabled=!0,t.textContent="削除中...");const a=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteJob",companyDomain:O,rowIndex:U._rowIndex})))),o=`${e}?action=post&data=${encodeURIComponent(a)}`,s=await fetch(o,{method:"GET",redirect:"follow"}),l=await s.text();let d;try{d=JSON.parse(l)}catch(n){throw console.error("JSON parse error:",n),new Error("GASからの応答が不正です")}if(!d.success)return void alert("削除に失敗しました: "+(d.error||"不明なエラー"));Q(),await Z(),alert("求人を削除しました")}catch(a){console.error("求人削除エラー:",a),alert("削除中にエラーが発生しました: "+a.message)}finally{t&&(t.disabled=!1,t.textContent="削除")}}function ne(){return J.filter(e=>("true"===e.visible||"TRUE"===e.visible||!0===e.visible)&&e.title).map(e=>({...e,company:q,companyDomain:O,companyAddress:e.location||""}))}function ae(){const e=document.getElementById("feed-status");e&&(e.style.display="flex")}function oe(){const e=document.getElementById("feed-status");e&&(e.style.display="none")}async function se(){const e=ne();if(0!==e.length)try{ae();const a=t(e);n(a,`indeed-${O}.xml`,"application/xml")}catch(a){alert("フィード生成に失敗しました: "+a.message)}finally{oe()}else alert("ダウンロードできる求人がありません")}async function le(){const e=ne();if(0!==e.length)try{ae();const t=a(e);n(t,`google-jobs-${O}.json`,"application/json")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{oe()}else alert("ダウンロードできる求人がありません")}async function de(){const e=ne();if(0!==e.length)try{ae();const t=o(e);n(t,`jobbox-${O}.xml`,"application/xml")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{oe()}else alert("ダウンロードできる求人がありません")}async function ie(){const e=ne();if(0!==e.length)try{ae();const t=s(e);n(t,`jobs-${O}.csv`,"text/csv;charset=utf-8")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{oe()}else alert("ダウンロードできる求人がありません")}async function ce(){const t=document.getElementById("analytics-period");let n=7;switch((null==t?void 0:t.value)||"7days"){case"7days":n=7;break;case"30days":case"last-month":n=30;break;case"month":n=(new Date).getDate();break}const a=document.getElementById("job-analytics-tbody"),o=document.getElementById("source-analytics-tbody"),s=document.getElementById("device-analytics-tbody");a&&(a.innerHTML='<tr><td colspan="5" class="loading-cell">データを読み込み中...</td></tr>'),o&&(o.innerHTML='<tr><td colspan="3" class="loading-cell">読み込み中...</td></tr>'),s&&(s.innerHTML='<tr><td colspan="3" class="loading-cell">読み込み中...</td></tr>');try{const t="https://asia-northeast1-generated-area-484613-e3.cloudfunctions.net/getAnalyticsData",a=await fetch(`${t}?type=overview&days=${n}`),o=await a.json(),s=await fetch(`${t}?type=traffic&days=${n}`),l=await s.json();let d=null;if(O){const e=await fetch(`${t}?type=company-detail&days=${n}&domain=${encodeURIComponent(O)}`);d=await e.json()}if(!o.success)throw new Error(o.error||"データ取得エラー");Y={overview:o.data,traffic:l.data,companyDetail:null==d?void 0:d.data},function(t){const{overview:n,traffic:a,companyDetail:o}=t;document.getElementById("analytics-pv").textContent=((null==n?void 0:n.pageViews)||0).toLocaleString(),document.getElementById("analytics-users").textContent=((null==n?void 0:n.users)||0).toLocaleString();const s=(null==n?void 0:n.sessions)||0,l=(null==n?void 0:n.pageViews)||0,d=s>0?(l/s).toFixed(1):"-";document.getElementById("analytics-pages-per-session").textContent=d,document.getElementById("analytics-avg-time").textContent="-";const i=document.getElementById("job-analytics-tbody");i&&((null==o?void 0:o.jobs)&&o.jobs.length>0?i.innerHTML=o.jobs.map(t=>`\n        <tr>\n          <td>${e(t.jobTitle||t.pagePath||"不明")}</td>\n          <td>${t.views||0}</td>\n          <td>${t.users||"-"}</td>\n          <td>-</td>\n          <td>-</td>\n        </tr>\n      `).join(""):i.innerHTML='\n        <tr>\n          <td colspan="5" class="loading-cell">\n            この会社の求人別データはまだありません。<br>\n            <small>※ GA4でカスタムイベント（view_job_detail）の設定が必要です</small>\n          </td>\n        </tr>\n      ');const c=document.getElementById("source-analytics-tbody");if(c){const t=(null==a?void 0:a.sources)||[];if(t.length>0){const n=t.reduce((e,t)=>e+(t.sessions||0),0);c.innerHTML=t.slice(0,10).map(t=>{const a=n>0?Math.round(t.sessions/n*100):0;return`\n          <tr>\n            <td>${e(t.source||"(direct)")}</td>\n            <td>${t.sessions||0}</td>\n            <td>${a}%</td>\n          </tr>\n        `}).join("")}else if((null==a?void 0:a.channels)&&a.channels.length>0){const t=a.channels.reduce((e,t)=>e+(t.sessions||0),0);c.innerHTML=a.channels.map(n=>{const a=t>0?Math.round(n.sessions/t*100):0;return`\n          <tr>\n            <td>${e(n.channel||"不明")}</td>\n            <td>${n.sessions||0}</td>\n            <td>${a}%</td>\n          </tr>\n        `}).join("")}else c.innerHTML='<tr><td colspan="3" class="loading-cell">データがありません</td></tr>'}const r=document.getElementById("device-analytics-tbody");if(r){const t=(null==a?void 0:a.devices)||[];if(t.length>0){const n=t.reduce((e,t)=>e+(t.sessions||0),0);r.innerHTML=t.map(t=>{const a="mobile"===t.device?"モバイル":"desktop"===t.device?"デスクトップ":"tablet"===t.device?"タブレット":t.device,o=n>0?Math.round(t.sessions/n*100):0;return`\n          <tr>\n            <td>${e(a)}</td>\n            <td>${t.sessions||0}</td>\n            <td>${o}%</td>\n          </tr>\n        `}).join("")}else r.innerHTML='<tr><td colspan="3" class="loading-cell">データがありません</td></tr>'}}(Y)}catch(l){console.error("アクセス解析データ取得エラー:",l),function(){document.getElementById("analytics-pv").textContent="- (未連携)",document.getElementById("analytics-users").textContent="-",document.getElementById("analytics-pages-per-session").textContent="-",document.getElementById("analytics-avg-time").textContent="-";const e=document.getElementById("job-analytics-tbody");e&&(e.innerHTML='\n      <tr>\n        <td colspan="5" class="loading-cell">\n          アクセス解析データがありません。<br>\n          Google Analyticsとの連携を設定すると、詳細なアクセスデータを確認できます。\n        </td>\n      </tr>\n    ');const t=document.getElementById("source-analytics-tbody");t&&(t.innerHTML='<tr><td colspan="3" class="loading-cell">データなし</td></tr>');const n=document.getElementById("device-analytics-tbody");n&&(n.innerHTML='<tr><td colspan="3" class="loading-cell">データなし</td></tr>')}()}}async function re(e,t){if(!O)return[];try{const n=firebase.firestore();return(await n.collection("applications").where("companyDomain","==",O).where("createdAt",">=",e).where("createdAt","<=",t).orderBy("createdAt","desc").get()).docs.map(e=>{var t,n;return{id:e.id,...e.data(),createdAt:(null==(n=null==(t=e.data().createdAt)?void 0:t.toDate)?void 0:n.call(t))||new Date(e.data().createdAt)}})}catch(n){return console.error("応募データ取得エラー:",n),[]}}async function ue(e,t){const n=t.getTime()-e.getTime(),a=new Date(e.getTime()-1),o=new Date(a.getTime()-n);return await re(o,a)}function me(e){const t={new:"新規",contacted:"連絡済",interviewing:"面接中",hired:"採用",rejected:"不採用",withdrawn:"辞退"},n={};Object.values(t).forEach(e=>{n[e]=0}),e.forEach(e=>{const a=e.status||"new",o=t[a]||"新規";n[o]=(n[o]||0)+1});const a=e.length;return Object.entries(n).map(([e,t])=>({status:e,count:t,percentage:a>0?Math.round(t/a*100):0}))}function pe(e){const t={google:"Google検索",indeed:"Indeed",jobbox:"求人ボックス",direct:"直接流入",line:"LINE",other:"その他"},n={};e.forEach(e=>{let a=e.source||e.utmSource||"other";a=a.includes("google")?"google":a.includes("indeed")?"indeed":a.includes("jobbox")||a.includes("stanby")?"jobbox":a.includes("line")?"line":"direct"===a||"(direct)"===a?"direct":"other";const o=t[a]||"その他";n[o]=(n[o]||0)+1});const a=e.length;return Object.entries(n).map(([e,t])=>({source:e,count:t,percentage:a>0?Math.round(t/a*100):0})).sort((e,t)=>t.count-e.count)}function ge(e){const t={};return e.forEach(e=>{const n=e.assignee||"未割当";t[n]||(t[n]={assignee:n,handled:0,pending:0});"new"===(e.status||"new")?t[n].pending++:t[n].handled++}),Object.values(t).sort((e,t)=>t.handled-e.handled)}function ye(t){const{applications:n,comparison:a,period:o}=t,s=n.length,l=a.length,d=l>0?Math.round((s-l)/l*100):0,i=d>=0?`+${d}%`:`${d}%`,c=n.filter(e=>"hired"===e.status).length,r=n.filter(e=>"new"===e.status||"contacted"===e.status).length;document.getElementById("summary-total").textContent=s,document.getElementById("summary-change").textContent=i,document.getElementById("summary-change").className="summary-value "+(d>=0?"positive":"negative"),document.getElementById("summary-hired").textContent=c,document.getElementById("summary-pending").textContent=r;const u=me(n);document.getElementById("status-breakdown").innerHTML=u.map(t=>`\n    <tr>\n      <td>${e(t.status)}</td>\n      <td>${t.count}</td>\n      <td>${t.percentage}%</td>\n    </tr>\n  `).join("");const m=function(e){const t={};return e.forEach(e=>{const n=e.jobId||"unknown",a=e.jobTitle||"不明な求人";t[n]||(t[n]={jobId:n,jobTitle:a,count:0}),t[n].count++}),Object.values(t).sort((e,t)=>t.count-e.count).slice(0,5)}(n),p=document.getElementById("job-performance");0===m.length?p.innerHTML='<tr><td colspan="4">データがありません</td></tr>':p.innerHTML=m.map(t=>{const n=J.find(e=>e.id===t.jobId),a=(null==n?void 0:n.pageViews)||"-",o="-"!==a&&a>0?(t.count/a*100).toFixed(1)+"%":"-";return`\n        <tr>\n          <td>${e(t.jobTitle)}</td>\n          <td>${t.count}</td>\n          <td>${a}</td>\n          <td>${o}</td>\n        </tr>\n      `}).join("");const g=pe(n),y=document.getElementById("source-breakdown");0===g.length?y.innerHTML='<tr><td colspan="3">データがありません</td></tr>':y.innerHTML=g.map(t=>`\n      <tr>\n        <td>${e(t.source)}</td>\n        <td>${t.count}</td>\n        <td>${t.percentage}%</td>\n      </tr>\n    `).join("");const b=ge(n),f=document.getElementById("assignee-breakdown");0===b.length?f.innerHTML='<tr><td colspan="3">データがありません</td></tr>':f.innerHTML=b.map(t=>`\n      <tr>\n        <td>${e(t.assignee)}</td>\n        <td>${t.handled}</td>\n        <td>${t.pending}</td>\n      </tr>\n    `).join(""),document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="block",document.getElementById("report-actions").style.display="flex"}async function be(){const e=document.getElementById("report-period").value;let t,n;if("custom"===e){const e=document.getElementById("report-from"),a=document.getElementById("report-to");if(!e.value||!a.value)return void alert("開始日と終了日を指定してください");t=new Date(e.value),t.setHours(0,0,0,0),n=new Date(a.value),n.setHours(23,59,59,999)}else{const a=function(e){const t=new Date;let n,a;switch(e){case"week":{const e=t.getDay();n=new Date(t),n.setDate(t.getDate()-e),n.setHours(0,0,0,0),a=new Date(t),a.setHours(23,59,59,999);break}case"last-week":{const e=t.getDay();a=new Date(t),a.setDate(t.getDate()-e-1),a.setHours(23,59,59,999),n=new Date(a),n.setDate(a.getDate()-6),n.setHours(0,0,0,0);break}case"month":n=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t),a.setHours(23,59,59,999);break;case"last-month":n=new Date(t.getFullYear(),t.getMonth()-1,1),a=new Date(t.getFullYear(),t.getMonth(),0,23,59,59,999);break;default:n=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t)}return{start:n,end:a}}(e);t=a.start,n=a.end}document.getElementById("report-loading").style.display="flex",document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="none",document.getElementById("report-actions").style.display="none";try{const[e,a]=await Promise.all([re(t,n),ue(t,n)]);K=e,P={applications:e,comparison:a,period:{start:t,end:n}},ye(P)}catch(a){console.error("レポート生成エラー:",a),alert("レポートの生成に失敗しました: "+a.message)}finally{document.getElementById("report-loading").style.display="none"}}function fe(){if(!P||!P.applications.length)return void alert("レポートデータがありません");const{applications:e,period:t}=P,n=[["応募日時","求人タイトル","氏名","ステータス","流入元","担当者"],...e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""])].map(e=>e.map(e=>`"${String(e).replace(/"/g,'""')}"`).join(",")).join("\n"),a=new Blob(["\ufeff"+n],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o;const l=t.start.toISOString().split("T")[0],d=t.end.toISOString().split("T")[0];s.download=`report-${O}-${l}-${d}.csv`,s.click(),URL.revokeObjectURL(o)}function ve(){if(!P||!P.applications.length)return void alert("レポートデータがありません");if("undefined"==typeof XLSX)return void alert("Excelライブラリが読み込まれていません");const{applications:e,period:t}=P,n=XLSX.utils.book_new(),a=[["レポート期間",`${t.start.toLocaleDateString("ja-JP")} 〜 ${t.end.toLocaleDateString("ja-JP")}`],["会社",q],[""],["総応募数",e.length],["採用数",e.filter(e=>"hired"===e.status).length],["対応中",e.filter(e=>"new"===e.status||"contacted"===e.status).length]],o=XLSX.utils.aoa_to_sheet(a);XLSX.utils.book_append_sheet(n,o,"サマリー");const s=e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.phone||"",e.email||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""]),l=XLSX.utils.aoa_to_sheet([["応募日時","求人タイトル","氏名","電話番号","メール","ステータス","流入元","担当者"],...s]);XLSX.utils.book_append_sheet(n,l,"応募一覧");const d=me(e).map(e=>[e.status,e.count,`${e.percentage}%`]),i=XLSX.utils.aoa_to_sheet([["ステータス","件数","割合"],...d]);XLSX.utils.book_append_sheet(n,i,"ステータス別");const c=pe(e).map(e=>[e.source,e.count,`${e.percentage}%`]),r=XLSX.utils.aoa_to_sheet([["流入元","件数","割合"],...c]);XLSX.utils.book_append_sheet(n,r,"流入元別");const u=ge(e).map(e=>[e.assignee,e.handled,e.pending]),m=XLSX.utils.aoa_to_sheet([["担当者","対応済","未対応"],...u]);XLSX.utils.book_append_sheet(n,m,"担当者別");const p=t.start.toISOString().split("T")[0],g=t.end.toISOString().split("T")[0];XLSX.writeFile(n,`report-${O}-${p}-${g}.xlsx`)}function he(e){document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".sidebar-nav li").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(`section-${e}`);t&&t.classList.add("active"),document.querySelectorAll(".sidebar-nav a").forEach(t=>{t.dataset.section===e&&t.closest("li").classList.add("active")});const n=document.getElementById("page-title"),a=document.querySelector(".header-actions");"jobs"===e?(n&&(n.textContent=`${q} の求人一覧`),a&&(a.style.display="flex")):"analytics"===e?(n&&(n.textContent="アクセス解析"),a&&(a.style.display="none")):"reports"===e?(n&&(n.textContent="応募レポート"),a&&(a.style.display="none")):"applicants"===e&&(n&&(n.textContent="応募者管理"),a&&(a.style.display="none"),Ee||(Ee=!0,N(O)))}let Ee=!1;async function Ie(){"undefined"==typeof firebase?console.warn("[JobManager] Firebase not loaded"):firebase.apps.length||firebase.initializeApp(F);const e=new URLSearchParams(window.location.search);O=e.get("domain"),q=e.get("company")||O,R=e.get("sheetUrl");const t=e.get("section");if(t&&["analytics","reports","applicants"].includes(t)&&he(t),!O)return alert("会社ドメインが指定されていません"),void(window.location.href="admin.html");const n=document.getElementById("page-title");n&&!t&&(n.textContent=`${q} の求人一覧`);const a=document.getElementById("company-name");a&&(a.textContent=q);const o=document.getElementById("btn-open-sheet");var s,l,d,i,c,r,u,m,p,g,y,b,f,v,h,E;R&&o?(o.href=R,o.style.display=""):o&&(o.style.display="none"),null==(s=document.getElementById("btn-add-job"))||s.addEventListener("click",z),null==(l=document.getElementById("btn-refresh"))||l.addEventListener("click",Z),null==(d=document.getElementById("job-modal-close"))||d.addEventListener("click",Q),null==(i=document.getElementById("job-modal-cancel"))||i.addEventListener("click",Q),null==(c=document.getElementById("job-modal-delete"))||c.addEventListener("click",te),null==(r=document.getElementById("job-edit-form"))||r.addEventListener("submit",e=>{e.preventDefault(),ee()}),null==(u=document.getElementById("job-modal"))||u.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&Q()}),null==(m=document.getElementById("btn-download-indeed"))||m.addEventListener("click",se),null==(p=document.getElementById("btn-download-google"))||p.addEventListener("click",le),null==(g=document.getElementById("btn-download-jobbox"))||g.addEventListener("click",de),null==(y=document.getElementById("btn-download-csv"))||y.addEventListener("click",ie),document.querySelectorAll(".sidebar-nav a[data-section]").forEach(e=>{e.addEventListener("click",t=>{const n=e.dataset.section;n&&"back"!==n&&(t.preventDefault(),he(n))})}),null==(b=document.getElementById("report-period"))||b.addEventListener("change",e=>{const t=document.getElementById("report-custom-dates");t&&(t.style.display="custom"===e.target.value?"flex":"none")}),null==(f=document.getElementById("btn-generate-report"))||f.addEventListener("click",be),null==(v=document.getElementById("btn-report-csv"))||v.addEventListener("click",fe),null==(h=document.getElementById("btn-report-excel"))||h.addEventListener("click",ve),null==(E=document.getElementById("btn-load-analytics"))||E.addEventListener("click",ce),await Z()}"undefined"!=typeof window&&(window.JobManager={init:Ie,loadJobsData:Z,showJobModal:z,editJob:W,closeJobModal:Q,saveJobData:ee,deleteJob:te}),document.addEventListener("DOMContentLoaded",()=>{Ie()});
