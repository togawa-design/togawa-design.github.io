const CompanyEditor={config:{gasApiUrl:localStorage.getItem("gas_api_url")||""},isNewMode:!0,companyDomain:null,originalData:null,async init(){const e=new URLSearchParams(window.location.search);this.companyDomain=e.get("domain"),this.isNewMode=!this.companyDomain,this.updateUIForMode(),this.setupEventListeners(),this.initRichEditors(),this.isNewMode||await this.loadCompanyData()},updateUIForMode(){const e=document.getElementById("page-title"),t=document.getElementById("edit-mode-badge"),n=document.getElementById("btn-delete"),o=document.getElementById("company-domain");this.isNewMode?(e.textContent="新規会社登録",t.textContent="新規作成",t.classList.remove("edit"),n.style.display="none"):(e.textContent="会社情報の編集",t.textContent="編集中",t.classList.add("edit"),n.style.display="",o.readOnly=!0,o.classList.add("readonly"))},setupEventListeners(){document.getElementById("company-edit-form")?.addEventListener("submit",e=>{e.preventDefault(),this.saveCompany()}),document.getElementById("btn-delete")?.addEventListener("click",()=>{this.showDeleteConfirm()}),document.getElementById("delete-modal-close")?.addEventListener("click",()=>{this.hideDeleteConfirm()}),document.getElementById("delete-cancel")?.addEventListener("click",()=>{this.hideDeleteConfirm()}),document.getElementById("delete-confirm")?.addEventListener("click",()=>{this.deleteCompany()}),document.getElementById("delete-confirm-modal")?.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&this.hideDeleteConfirm()}),document.getElementById("company-domain")?.addEventListener("input",e=>{this.isNewMode&&(e.target.value=e.target.value.toLowerCase().replace(/[^a-z0-9-]/g,""))})},initRichEditors(){document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=t.querySelector(".rich-editor-toolbar"),o=t.querySelector('input[type="hidden"]');n.querySelectorAll(".toolbar-btn").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const a=t.dataset.command;document.execCommand(a,!1,null),e.focus(),this.updateHiddenInput(e,o)})}),e.addEventListener("input",()=>{this.updateHiddenInput(e,o)}),e.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)}),e.addEventListener("keydown",t=>{if(t.ctrlKey||t.metaKey){switch(t.key.toLowerCase()){case"b":t.preventDefault(),document.execCommand("bold",!1,null);break;case"i":t.preventDefault(),document.execCommand("italic",!1,null);break;case"u":t.preventDefault(),document.execCommand("underline",!1,null)}this.updateHiddenInput(e,o)}})})},updateHiddenInput(e,t){if(t){const n=this.sanitizeHtml(e.innerHTML);t.value=n}},sanitizeHtml(e){if(!e||"<br>"===e||"<div><br></div>"===e)return"";const t=["b","strong","i","em","u","ul","ol","li","br","div","p"],n=document.createElement("div");n.innerHTML=e;return n.querySelectorAll("*").forEach(e=>{if(t.includes(e.tagName.toLowerCase()))for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name);else e.replaceWith(...e.childNodes)}),n.innerHTML},setEditorContent(e,t){const n=document.getElementById(e),o=n?.closest(".rich-editor-container"),a=o?.querySelector('input[type="hidden"]');n&&(n.innerHTML=t||"",a&&(a.value=t||""))},async loadCompanyData(){const e=this.config.gasApiUrl;if(!e){const e=localStorage.getItem(`company_data_${this.companyDomain}`);return void(e?this.populateForm(JSON.parse(e)):(alert("会社データが見つかりません"),window.location.href="admin.html"))}try{const t=`${e}?action=getCompanies`,n=await fetch(t),o=await n.json();if(!o.success)throw new Error(o.error||"会社データの取得に失敗しました");const a=o.companies?.find(e=>e.companyDomain===this.companyDomain||e.company_domain===this.companyDomain);if(!a){const e=localStorage.getItem(`company_data_${this.companyDomain}`);return void(e?this.populateForm(JSON.parse(e)):(alert("会社データが見つかりません"),window.location.href="admin.html"))}this.originalData=a,this.populateForm(a)}catch(e){console.error("会社データ読み込みエラー:",e);const t=localStorage.getItem(`company_data_${this.companyDomain}`);t?this.populateForm(JSON.parse(t)):alert("データの読み込みに失敗しました: "+e.message)}},populateForm(e){document.getElementById("company-name").value=e.company||"",document.getElementById("company-domain").value=e.companyDomain||e.company_domain||"",document.getElementById("design-pattern").value=e.designPattern||"standard",document.getElementById("image-url").value=e.imageUrl||"",document.getElementById("order").value=e.order||"",document.getElementById("show-company").checked="○"===e.showCompany||!0===e.showCompany||"true"===e.showCompany||!0===e.visible,this.setEditorContent("description-editor",e.description||""),this.setEditorContent("job-content-editor",e.jobContent||""),this.setEditorContent("working-hours-editor",e.workingHours||""),e.company&&(document.getElementById("page-title").textContent=`${e.company} の編集`)},async saveCompany(){this.syncRichEditors();const e={company:document.getElementById("company-name").value.trim(),companyDomain:document.getElementById("company-domain").value.trim(),designPattern:document.getElementById("design-pattern").value,imageUrl:document.getElementById("image-url").value.trim(),order:document.getElementById("order").value,description:document.getElementById("description").value,jobContent:document.getElementById("job-content").value,workingHours:document.getElementById("working-hours").value,showCompany:document.getElementById("show-company").checked?"○":"",visible:document.getElementById("show-company").checked};if(!e.company||!e.companyDomain)return void alert("会社名と会社ドメインは必須です");if(!/^[a-z0-9-]+$/.test(e.companyDomain))return void alert("会社ドメインは半角英小文字・数字・ハイフンのみ使用できます");const t=document.getElementById("btn-save");t&&(t.disabled=!0,t.innerHTML='<span class="loading-spinner-small"></span> 保存中...');const n=this.config.gasApiUrl;try{if(n){const t=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveCompany",company:e})))),o=`${n}?action=post&data=${encodeURIComponent(t)}`,a=await fetch(o),i=await a.json();if(!i.success)throw new Error(i.error||"保存に失敗しました")}localStorage.setItem(`company_data_${e.companyDomain}`,JSON.stringify(e)),alert(this.isNewMode?"会社を登録しました":"会社情報を更新しました"),window.location.href="admin.html"}catch(e){console.error("保存エラー:",e),alert("保存中にエラーが発生しました: "+e.message)}finally{t&&(t.disabled=!1,t.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> 保存')}},syncRichEditors(){document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=t?.querySelector('input[type="hidden"]');n&&(n.value=this.sanitizeHtml(e.innerHTML))})},showDeleteConfirm(){const e=document.getElementById("delete-confirm-modal"),t=document.getElementById("company-name").value;document.getElementById("delete-company-name").textContent=t,e.style.display="flex"},hideDeleteConfirm(){document.getElementById("delete-confirm-modal").style.display="none"},async deleteCompany(){const e=this.config.gasApiUrl,t=document.getElementById("delete-confirm");t&&(t.disabled=!0,t.textContent="削除中...");try{if(e){const t=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteCompany",domain:this.companyDomain})))),n=`${e}?action=post&data=${encodeURIComponent(t)}`,o=await fetch(n),a=await o.json();if(!a.success)throw new Error(a.error||"削除に失敗しました")}localStorage.removeItem(`company_data_${this.companyDomain}`),alert("会社を削除しました"),window.location.href="admin.html"}catch(e){console.error("削除エラー:",e),alert("削除中にエラーが発生しました: "+e.message)}finally{t&&(t.disabled=!1,t.textContent="削除する")}}};document.addEventListener("DOMContentLoaded",()=>{CompanyEditor.init()});