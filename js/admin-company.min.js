const AdminCompany={heroImagePresets:[{id:"teamwork-1",name:"チームミーティング",url:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=400&q=60"},{id:"teamwork-2",name:"オフィスワーク",url:"https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=400&q=60"},{id:"teamwork-3",name:"コラボレーション",url:"https://images.unsplash.com/photo-1600880292203-757bb62b4baf?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1600880292203-757bb62b4baf?w=400&q=60"},{id:"teamwork-4",name:"ビジネス握手",url:"https://images.unsplash.com/photo-1521791136064-7986c2920216?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1521791136064-7986c2920216?w=400&q=60"},{id:"teamwork-5",name:"ワークショップ",url:"https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=400&q=60"},{id:"work-1",name:"製造ライン",url:"https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=400&q=60"},{id:"work-2",name:"倉庫作業",url:"https://images.unsplash.com/photo-1553413077-190dd305871c?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1553413077-190dd305871c?w=400&q=60"},{id:"work-3",name:"建設現場",url:"https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=400&q=60"},{id:"work-4",name:"工場作業",url:"https://images.unsplash.com/photo-1573164713988-8665fc963095?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1573164713988-8665fc963095?w=400&q=60"},{id:"work-5",name:"チームワーク",url:"https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=400&q=60"}],companiesCache:[],currentEditingCompany:null,isNewCompany:!1,currentJobCompanyDomain:null,currentJobSheetUrl:null,jobsCache:[],currentEditingJob:null,isNewJob:!1,previewUpdateTimer:null,getPatternLabel:e=>({standard:"スタンダード",modern:"モダン",classic:"クラシック",minimal:"ミニマル",colorful:"カラフル"}[e]||"スタンダード"),async loadCompanyManageData(){const e=document.getElementById("company-manage-tbody");if(e){e.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';try{const t=`https://docs.google.com/spreadsheets/d/${AdminDashboard.spreadsheetConfig.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(AdminDashboard.spreadsheetConfig.companySheetName)}`,n=await fetch(t);if(!n.ok)throw new Error("データの取得に失敗しました");const o=await n.text();let a=this.parseCompanyCSV(o);if(a=a.map(e=>{if(e.companyDomain){const t=localStorage.getItem(`company_data_${e.companyDomain}`);if(t)try{const n=JSON.parse(t);return{...e,...n}}catch(e){console.error("ローカルストレージのパースエラー:",e)}}return e}),0===a.length)return void(e.innerHTML='<tr><td colspan="6" class="loading-cell">会社データがありません</td></tr>');this.companiesCache=a,this.renderCompanyTable()}catch(t){console.error("会社データの読み込みエラー:",t),e.innerHTML='<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました</td></tr>'}}},parseCompanyCSV(e){const t=e.split("\n"),n=this.parseCSVLine(t[0]||""),o=[];for(let e=1;e<t.length;e++){if(!t[e].trim())continue;const a=this.parseCSVLine(t[e]),i={};n.forEach((e,t)=>{const n=this.normalizeHeader(e);i[n]=a[t]||""}),o.push(i)}return o},parseCSVLine(e){const t=[];let n="",o=!1;for(let a=0;a<e.length;a++){const i=e[a];'"'===i?o&&'"'===e[a+1]?(n+='"',a++):o=!o:","!==i||o?n+=i:(t.push(n.trim()),n="")}return t.push(n.trim()),t},normalizeHeader(e){const t=e.replace(/"/g,"").trim();return{"会社名":"company",company:"company","会社ドメイン":"companyDomain",companyDomain:"companyDomain",company_domain:"companyDomain","デザインパターン":"designPattern",designPattern:"designPattern",design_pattern:"designPattern","表示する":"showCompany",showCompany:"showCompany",visible:"showCompany","画像URL":"imageUrl",imageUrl:"imageUrl",image_url:"imageUrl","説明":"description",description:"description","並び順":"order",order:"order","管理シート":"manageSheetUrl","管理シートURL":"manageSheetUrl",manageSheetUrl:"manageSheetUrl"}[t]||t},editCompany(e){window.location.href=`company-edit.html?domain=${encodeURIComponent(e)}`},showCompanyModal(){window.location.href="company-edit.html"},closeCompanyModal(){const e=document.getElementById("company-modal");e&&(e.style.display="none"),this.currentEditingCompany=null,this.isNewCompany=!1},async saveCompanyData(){const e=document.getElementById("edit-company-domain").value.trim().toLowerCase(),t={company:document.getElementById("edit-company-name").value.trim(),company_domain:e,companyDomain:e,designPattern:document.getElementById("edit-design-pattern").value,imageUrl:document.getElementById("edit-image-url").value.trim(),order:document.getElementById("edit-order").value||"",description:document.getElementById("edit-description").value.trim(),showCompany:document.getElementById("edit-show-company").checked?"○":"",visible:document.getElementById("edit-show-company").checked?"○":""};if(!t.company||!t.companyDomain)return void alert("会社名と会社ドメインは必須です");if(!/^[a-z0-9-]+$/.test(t.companyDomain))return void alert("会社ドメインは半角英数字とハイフンのみ使用できます");if(this.isNewCompany){const e=this.companiesCache?.find(e=>e.companyDomain===t.companyDomain);if(e)return void alert("このドメインは既に使用されています")}const n=AdminDashboard.spreadsheetConfig.gasApiUrl;if(n)try{const e=document.getElementById("company-modal-save");e&&(e.disabled=!0,e.textContent="保存中...");const o=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveCompany",company:t})))),a=`${n}?action=post&data=${encodeURIComponent(o)}`,i=await fetch(a,{method:"GET",redirect:"follow"}),s=await i.json();if(e&&(e.disabled=!1,e.textContent="保存"),!s.success)return void alert("スプレッドシートへの保存に失敗しました: "+(s.error||"不明なエラー"));if(localStorage.removeItem(`company_data_${t.companyDomain}`),this.isNewCompany)this.companiesCache||(this.companiesCache=[]),this.companiesCache.push(t);else{const e=this.companiesCache?.findIndex(e=>e.companyDomain===t.companyDomain);-1!==e&&(this.companiesCache[e]=t)}this.closeCompanyModal(),this.renderCompanyTable(),alert(`会社情報をスプレッドシートに保存しました。\n\n会社名: ${t.company}\nドメイン: ${t.companyDomain}`)}catch(e){console.error("GAS API呼び出しエラー:",e),alert("スプレッドシートへの保存中にエラーが発生しました。ローカルに保存します。"),this.saveCompanyDataLocal(t)}else this.saveCompanyDataLocal(t)},saveCompanyDataLocal(e){const t=`company_data_${e.companyDomain}`;if(localStorage.setItem(t,JSON.stringify(e)),this.isNewCompany)this.companiesCache||(this.companiesCache=[]),this.companiesCache.push(e);else{const t=this.companiesCache?.findIndex(t=>t.companyDomain===e.companyDomain);-1!==t&&(this.companiesCache[t]=e)}this.closeCompanyModal(),this.renderCompanyTable(),alert(`会社情報をローカルに保存しました。\n\n注意: スプレッドシートに自動保存するには、設定画面でGAS API URLを設定してください。\n\n会社名: ${e.company}\nドメイン: ${e.companyDomain}`)},renderCompanyTable(){const e=document.getElementById("company-manage-tbody");if(!e)return;const t=this.companiesCache||[];0!==t.length?e.innerHTML=t.map(e=>`\n      <tr data-domain="${Utils.escapeHtml(e.companyDomain||"")}">\n        <td>${Utils.escapeHtml(e.company||"")}</td>\n        <td><code>${Utils.escapeHtml(e.companyDomain||"")}</code></td>\n        <td><span class="badge ${e.designPattern||"standard"}">${this.getPatternLabel(e.designPattern||"standard")}</span></td>\n        <td>${"○"===e.showCompany||"◯"===e.showCompany?'<span class="badge success">表示</span>':'<span class="badge">非表示</span>'}</td>\n        <td>\n          <div class="action-buttons">\n            <button class="btn-small btn-edit" onclick="AdminCompany.editCompany('${Utils.escapeHtml(e.companyDomain||"")}')">編集</button>\n            <button class="btn-small btn-primary" onclick="AdminCompany.openJobsArea('${Utils.escapeHtml(e.companyDomain||"")}')">求人管理</button>\n            <a href="lp.html?c=${Utils.escapeHtml(e.companyDomain||"")}" target="_blank" class="btn-small btn-view">LP確認</a>\n          </div>\n        </td>\n      </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="5" class="loading-cell">会社データがありません</td></tr>'},async loadCompanyListForLP(){const e=document.getElementById("lp-company-select");if(!e)return;this.companiesCache&&0!==this.companiesCache.length||await this.loadCompanyManageData();const t=(this.companiesCache||[]).filter(e=>e.companyDomain&&("○"===e.showCompany||"◯"===e.showCompany));e.innerHTML='<option value="">-- 会社を選択 --</option>'+t.map(e=>`<option value="${Utils.escapeHtml(e.companyDomain)}">${Utils.escapeHtml(e.company)}</option>`).join("")},async loadLPSettings(e){const t=document.getElementById("lp-editor"),n=document.getElementById("lp-preview-btn"),o=document.getElementById("lp-edit-mode-btn");if(!e)return void(t&&(t.style.display="none"));t&&(t.style.display="block"),n&&(n.href=`lp.html?c=${encodeURIComponent(e)}`),o&&(o.href=`lp.html?c=${encodeURIComponent(e)}&edit`),this.renderHeroImagePresets();const a=this.companiesCache?.find(t=>t.companyDomain===e);if(a){const e=document.querySelector(`input[name="design-pattern"][value="${a.designPattern||"standard"}"]`);e&&(e.checked=!0)}try{const t=`https://docs.google.com/spreadsheets/d/${AdminDashboard.spreadsheetConfig.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(AdminDashboard.spreadsheetConfig.lpSettingsSheetName)}`,n=await fetch(t);if(n.ok){const t=await n.text(),o=this.parseLPSettingsCSV(t,e);if(o){if(document.getElementById("lp-hero-title").value=o.heroTitle||"",document.getElementById("lp-hero-subtitle").value=o.heroSubtitle||"",document.getElementById("lp-hero-image").value=o.heroImage||"",document.getElementById("lp-point-title-1").value=o.pointTitle1||"",document.getElementById("lp-point-desc-1").value=o.pointDesc1||"",document.getElementById("lp-point-title-2").value=o.pointTitle2||"",document.getElementById("lp-point-desc-2").value=o.pointDesc2||"",document.getElementById("lp-point-title-3").value=o.pointTitle3||"",document.getElementById("lp-point-desc-3").value=o.pointDesc3||"",document.getElementById("lp-cta-text").value=o.ctaText||"今すぐ応募する",document.getElementById("lp-faq").value=o.faq||"",o.designPattern){const e=document.querySelector(`input[name="design-pattern"][value="${o.designPattern}"]`);e&&(e.checked=!0)}return void this.updateHeroImagePresetSelection(o.heroImage||"")}}}catch(e){console.log("LP設定シートが見つかりません")}this.clearLPForm()},parseLPSettingsCSV(e,t){const n=e.split("\n"),o=this.parseCSVLine(n[0]||"");for(let e=1;e<n.length;e++){if(!n[e].trim())continue;const a=this.parseCSVLine(n[e]),i={};if(o.forEach((e,t)=>{const n=e.replace(/"/g,"").trim();i[n]=a[t]||""}),i.companyDomain===t||i["会社ドメイン"]===t)return{heroTitle:i.heroTitle||i["ヒーロータイトル"]||"",heroSubtitle:i.heroSubtitle||i["ヒーローサブタイトル"]||"",heroImage:i.heroImage||i["ヒーロー画像"]||"",pointTitle1:i.pointTitle1||i["ポイント1タイトル"]||"",pointDesc1:i.pointDesc1||i["ポイント1説明"]||"",pointTitle2:i.pointTitle2||i["ポイント2タイトル"]||"",pointDesc2:i.pointDesc2||i["ポイント2説明"]||"",pointTitle3:i.pointTitle3||i["ポイント3タイトル"]||"",pointDesc3:i.pointDesc3||i["ポイント3説明"]||"",ctaText:i.ctaText||i["CTAテキスト"]||"",faq:i.faq||i.FAQ||"",designPattern:i.designPattern||i["デザインパターン"]||""}}return null},clearLPForm(){["lp-hero-title","lp-hero-subtitle","lp-hero-image","lp-point-title-1","lp-point-desc-1","lp-point-title-2","lp-point-desc-2","lp-point-title-3","lp-point-desc-3","lp-faq"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="")});const e=document.getElementById("lp-cta-text");e&&(e.value="今すぐ応募する");const t=document.querySelector('input[name="design-pattern"][value="standard"]');t&&(t.checked=!0),this.updateHeroImagePresetSelection("")},renderHeroImagePresets(){const e=document.getElementById("hero-image-presets");e&&(e.innerHTML=this.heroImagePresets.map(e=>`\n      <div class="hero-image-preset" data-url="${Utils.escapeHtml(e.url)}" title="${Utils.escapeHtml(e.name)}">\n        <img src="${Utils.escapeHtml(e.thumbnail)}" alt="${Utils.escapeHtml(e.name)}" loading="lazy">\n        <span class="preset-name">${Utils.escapeHtml(e.name)}</span>\n        <span class="preset-check">✓</span>\n      </div>\n    `).join(""),e.querySelectorAll(".hero-image-preset").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.url;this.selectHeroImagePreset(t)})}))},selectHeroImagePreset(e){const t=document.getElementById("lp-hero-image");t&&(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0}))),this.updateHeroImagePresetSelection(e)},updateHeroImagePresetSelection(e){const t=document.getElementById("hero-image-presets");t&&t.querySelectorAll(".hero-image-preset").forEach(t=>{const n=t.dataset.url,o=e?.split("?")[0]||"",a=n?.split("?")[0]||"";o&&a&&o===a?t.classList.add("selected"):t.classList.remove("selected")})},async saveLPSettings(){const e=document.getElementById("lp-company-select").value;if(!e)return void alert("会社を選択してください");const t={companyDomain:e,designPattern:document.querySelector('input[name="design-pattern"]:checked')?.value||"standard",heroTitle:document.getElementById("lp-hero-title").value,heroSubtitle:document.getElementById("lp-hero-subtitle").value,heroImage:document.getElementById("lp-hero-image").value,pointTitle1:document.getElementById("lp-point-title-1").value,pointDesc1:document.getElementById("lp-point-desc-1").value,pointTitle2:document.getElementById("lp-point-title-2").value,pointDesc2:document.getElementById("lp-point-desc-2").value,pointTitle3:document.getElementById("lp-point-title-3").value,pointDesc3:document.getElementById("lp-point-desc-3").value,ctaText:document.getElementById("lp-cta-text").value,faq:document.getElementById("lp-faq").value},n=AdminDashboard.spreadsheetConfig.gasApiUrl;if(n)try{const o=document.getElementById("btn-save-lp-settings");o&&(o.disabled=!0,o.textContent="保存中...");const a=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveLPSettings",settings:t})))),i=`${n}?action=post&data=${encodeURIComponent(a)}`,s=await fetch(i,{method:"GET",redirect:"follow"}),l=await s.text();let c;try{c=JSON.parse(l)}catch(e){throw console.error("[LP Save] JSON parse error:",e),o&&(o.disabled=!1,o.textContent="LP設定を保存"),new Error(`GASからの応答が不正です: ${l.substring(0,200)}`)}if(o&&(o.disabled=!1,o.textContent="LP設定を保存"),!c.success)return void alert("スプレッドシートへの保存に失敗しました: "+(c.error||"不明なエラー"));localStorage.removeItem(`lp_settings_${e}`),alert(`LP設定をスプレッドシートに保存しました。\n\n会社: ${e}\nデザインパターン: ${t.designPattern}`)}catch(n){console.error("GAS API呼び出しエラー:",n),alert("スプレッドシートへの保存中にエラーが発生しました。ローカルに保存します。"),this.saveLPSettingsLocal(t,e)}else this.saveLPSettingsLocal(t,e)},saveLPSettingsLocal(e,t){const n=`lp_settings_${t}`;localStorage.setItem(n,JSON.stringify(e)),alert(`LP設定をローカルに保存しました。\n\n注意: スプレッドシートに自動保存するには、設定画面でGAS API URLを設定してください。\n\n会社: ${t}\nデザインパターン: ${e.designPattern}`)},debouncedUpdatePreview(){this.previewUpdateTimer&&clearTimeout(this.previewUpdateTimer),this.previewUpdateTimer=setTimeout(()=>{this.updateLPPreview()},300)},toggleLPPreview(){const e=document.getElementById("lp-preview-container"),t=document.getElementById("btn-toggle-preview");e&&("none"===e.style.display?(e.style.display="flex",t&&(t.textContent="プレビューを隠す"),this.updateLPPreview()):(e.style.display="none",t&&(t.textContent="プレビュー表示")))},closeLPPreview(){const e=document.getElementById("lp-preview-container"),t=document.getElementById("btn-toggle-preview");e&&(e.style.display="none"),t&&(t.textContent="プレビュー表示")},switchPreviewDevice(e){const t=document.querySelector(".lp-preview-frame-wrapper");document.querySelectorAll(".preview-device-btn").forEach(t=>{t.classList.toggle("active",t.dataset.device===e)}),t&&t.setAttribute("data-device",e)},updateLPPreview(){const e=document.getElementById("lp-preview-container"),t=document.getElementById("lp-preview-frame"),n=document.getElementById("lp-company-select")?.value;if(!e||"none"===e.style.display||!t||!n)return;const o=this.getCurrentLPSettings(),a=this.companiesCache?.find(e=>e.companyDomain===n)||{company:n,companyDomain:n},i=this.generatePreviewHTML(a,o),s=t.contentDocument||t.contentWindow.document;s.open(),s.write(i),s.close()},getCurrentLPSettings:()=>({designPattern:document.querySelector('input[name="design-pattern"]:checked')?.value||"standard",heroTitle:document.getElementById("lp-hero-title")?.value||"",heroSubtitle:document.getElementById("lp-hero-subtitle")?.value||"",heroImage:document.getElementById("lp-hero-image")?.value||"",pointTitle1:document.getElementById("lp-point-title-1")?.value||"",pointDesc1:document.getElementById("lp-point-desc-1")?.value||"",pointTitle2:document.getElementById("lp-point-title-2")?.value||"",pointDesc2:document.getElementById("lp-point-desc-2")?.value||"",pointTitle3:document.getElementById("lp-point-title-3")?.value||"",pointDesc3:document.getElementById("lp-point-desc-3")?.value||"",ctaText:document.getElementById("lp-cta-text")?.value||"今すぐ応募する",faq:document.getElementById("lp-faq")?.value||""}),generatePreviewHTML(e,t){const n=t.designPattern||"standard",o=t.heroTitle||`${e.company}で働こう`,a=t.heroSubtitle||"",i=t.heroImage||"",s=t.ctaText||"今すぐ応募する",l=document.getElementById("preview-edit-mode")?.checked||!1,c=[];t.pointTitle1&&c.push({title:t.pointTitle1,desc:t.pointDesc1||""}),t.pointTitle2&&c.push({title:t.pointTitle2,desc:t.pointDesc2||""}),t.pointTitle3&&c.push({title:t.pointTitle3,desc:t.pointDesc3||""});const d=t.faq?t.faq.split("||").map(e=>{const t=e.split("|");return{q:t.find(e=>e.startsWith("Q:"))?.replace("Q:","").trim()||"",a:t.find(e=>e.startsWith("A:"))?.replace("A:","").trim()||""}}).filter(e=>e.q&&e.a):[],r=this.getSectionOrder(),m=this.getSectionVisibility(),p={hero:`\n        <section class="lp-hero preview-section" data-section="hero">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">ヒーロー</span></div>':""}\n          ${i?`<div class="lp-hero-bg" style="background-image: url('${Utils.escapeHtml(i)}')"></div>`:'<div class="lp-hero-bg"></div>'}\n          <div class="lp-hero-overlay"></div>\n          <div class="lp-hero-content">\n            <p class="lp-hero-company">${Utils.escapeHtml(e.company)}</p>\n            <h1 class="lp-hero-title">${Utils.escapeHtml(o)}</h1>\n            ${a?`<p class="lp-hero-subtitle">${Utils.escapeHtml(a)}</p>`:""}\n            <div class="lp-hero-cta">\n              <a href="#" class="lp-btn-apply-hero">${Utils.escapeHtml(s)}</a>\n            </div>\n          </div>\n        </section>`,points:c.length>0&&m.points?`\n        <section class="lp-points preview-section" data-section="points">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">ポイント</span></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">この求人のポイント</h2>\n            <div class="lp-points-grid">\n              ${c.map((e,t)=>`\n                <div class="lp-point-card">\n                  <div class="lp-point-number">${t+1}</div>\n                  <h3 class="lp-point-title">${Utils.escapeHtml(e.title)}</h3>\n                  <p class="lp-point-desc">${Utils.escapeHtml(e.desc)}</p>\n                </div>\n              `).join("")}\n            </div>\n          </div>\n        </section>`:"",jobs:m.jobs?`\n        <section class="lp-jobs preview-section" data-section="jobs">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">求人一覧</span></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">募集中の求人</h2>\n            <div class="lp-jobs-list">\n              <div class="lp-job-card" style="opacity: 0.5;">\n                <p>求人データはスプレッドシートから読み込まれます</p>\n              </div>\n            </div>\n          </div>\n        </section>`:"",details:m.details?`\n        <section class="lp-details preview-section" data-section="details">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">募集要項</span></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">募集要項</h2>\n            <div class="lp-details-table">\n              <div class="lp-detail-row"><div class="lp-detail-label">仕事内容</div><div class="lp-detail-value" style="opacity: 0.5;">スプレッドシートから読み込み</div></div>\n            </div>\n          </div>\n        </section>`:"",faq:d.length>0&&m.faq?`\n        <section class="lp-faq preview-section" data-section="faq">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">FAQ</span></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">よくある質問</h2>\n            <div class="lp-faq-list">\n              ${d.map(e=>`\n                <div class="lp-faq-item">\n                  <div class="lp-faq-question"><span class="lp-faq-icon">Q</span><span>${Utils.escapeHtml(e.q)}</span></div>\n                  <div class="lp-faq-answer"><span class="lp-faq-icon">A</span><span>${Utils.escapeHtml(e.a)}</span></div>\n                </div>\n              `).join("")}\n            </div>\n          </div>\n        </section>`:"",apply:`\n        <section class="lp-apply preview-section" id="lp-apply" data-section="apply">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">応募</span></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-apply-title">まずはお気軽にご応募ください</h2>\n            <p class="lp-apply-text">経験・学歴不問！${Utils.escapeHtml(e.company)}であなたのご応募をお待ちしています。</p>\n            <div class="lp-apply-buttons">\n              <a href="#" class="lp-btn-apply-main">${Utils.escapeHtml(s)}</a>\n            </div>\n          </div>\n        </section>`},u=r.map(e=>p[e]||"").join("");return`<!DOCTYPE html>\n<html lang="ja">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>プレビュー</title>\n  <link rel="stylesheet" href="css/style.min.css">\n  <link rel="stylesheet" href="css/lp.css">\n  <style>\n    body { margin: 0; padding: 0; }\n    .lp-hero { min-height: 50vh; }\n    .preview-note { background: #fef3c7; color: #92400e; padding: 8px 16px; text-align: center; font-size: 12px; position: sticky; top: 0; z-index: 1000; }\n  </style>\n</head>\n<body class="lp-body lp-pattern-${Utils.escapeHtml(n)}${l?" edit-mode":""}">\n  <div class="preview-note">${l?"編集モード":"プレビューモード"}</div>\n  ${u}\n</body>\n</html>`},getSectionOrder(){const e=document.getElementById("lp-section-order");return e?Array.from(e.querySelectorAll("li")).map(e=>e.dataset.section):["hero","points","jobs","details","faq","apply"]},getSectionVisibility:()=>({points:document.getElementById("section-points-visible")?.checked??!0,jobs:document.getElementById("section-jobs-visible")?.checked??!0,details:document.getElementById("section-details-visible")?.checked??!0,faq:document.getElementById("section-faq-visible")?.checked??!0}),initSectionSortable(){const e=document.getElementById("lp-section-order");if(!e)return;let t=null;e.querySelectorAll(".section-order-item").forEach(n=>{n.setAttribute("draggable","true"),n.addEventListener("dragstart",e=>{t=n,n.classList.add("dragging"),e.dataTransfer.effectAllowed="move"}),n.addEventListener("dragend",()=>{n.classList.remove("dragging"),t=null,this.updateLPPreview()}),n.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="move";const o=this.getDragAfterElement(e,n.clientY);null==o?e.appendChild(t):e.insertBefore(t,o)})})},getDragAfterElement:(e,t)=>[...e.querySelectorAll(".section-order-item:not(.dragging)")].reduce((e,n)=>{const o=n.getBoundingClientRect(),a=t-o.top-o.height/2;return a<0&&a>e.offset?{offset:a,element:n}:e},{offset:Number.NEGATIVE_INFINITY}).element,togglePreviewEditMode(e){this.updateLPPreview()},focusSection(e){const t={points:"lp-point-title-1",faq:"lp-faq",cta:"lp-cta-text",hero:"lp-hero-title"}[e];if(t){const e=document.getElementById(t);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus())}},openJobsArea(e){const t=this.companiesCache?.find(t=>t.companyDomain===e);if(!t)return void alert("会社情報が見つかりません");const n=new URLSearchParams;n.set("domain",e),n.set("company",t.company||e),t.manageSheetUrl&&n.set("sheetUrl",t.manageSheetUrl),window.location.href=`job-manage.html?${n.toString()}`},closeJobsArea(){const e=document.getElementById("jobs-manage-area");e&&(e.style.display="none"),this.currentJobCompanyDomain=null,this.currentJobSheetUrl=null,this.jobsCache=[]},async loadJobsData(e){const t=document.getElementById("jobs-tbody");if(!t)return;t.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';const n=this.companiesCache?.find(t=>t.companyDomain===e);if(n&&n.manageSheetUrl)try{const n=AdminDashboard.spreadsheetConfig.gasApiUrl;if(!n)throw new Error("GAS API URLが設定されていません");const o=`${n}?action=getJobs&domain=${encodeURIComponent(e)}`,a=await fetch(o);if(!a.ok)throw new Error("データの取得に失敗しました");const i=await a.json();if(!i.success)throw new Error(i.error||"求人データの取得に失敗しました");if(this.jobsCache=i.jobs||[],0===this.jobsCache.length)return void(t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>');this.renderJobsTable()}catch(e){console.error("求人データの読み込みエラー:",e),t.innerHTML=`<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました: ${Utils.escapeHtml(e.message)}</td></tr>`}else t.innerHTML='<tr><td colspan="6" class="loading-cell">管理シートが設定されていません</td></tr>'},renderJobsTable(){const e=document.getElementById("jobs-tbody");if(!e)return;const t=this.jobsCache||[];0!==t.length?e.innerHTML=t.map(e=>{const t=e.monthlySalary?`¥${Number(e.monthlySalary).toLocaleString()}`:"-",n="true"===e.visible||"TRUE"===e.visible||!0===e.visible;return`\n        <tr data-row="${e._rowIndex}">\n          <td>${Utils.escapeHtml(e.id||"-")}</td>\n          <td>${Utils.escapeHtml(e.title||"-")}</td>\n          <td>${Utils.escapeHtml(e.location||"-")}</td>\n          <td>${t}</td>\n          <td>${n?'<span class="badge success">公開</span>':'<span class="badge">非公開</span>'}</td>\n          <td>\n            <div class="action-buttons">\n              <button class="btn-small btn-edit" onclick="AdminCompany.editJob(${e._rowIndex})">編集</button>\n            </div>\n          </td>\n        </tr>\n      `}).join(""):e.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>'},showJobModal(){this.currentEditingJob=null,this.isNewJob=!0,document.getElementById("job-modal-title").textContent="新規求人作成";["edit-job-title","edit-job-location","edit-job-salary","edit-job-bonus","edit-job-order","edit-job-features","edit-job-badges","edit-job-description","edit-job-requirements","edit-job-benefits","edit-job-hours","edit-job-holidays","edit-job-start-date","edit-job-end-date"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="")}),document.getElementById("edit-job-visible").checked=!0,document.getElementById("job-modal-delete").style.display="none",document.getElementById("job-modal").style.display="flex"},editJob(e){const t=this.jobsCache?.find(t=>t._rowIndex===e);t?(this.currentEditingJob=t,this.isNewJob=!1,document.getElementById("job-modal-title").textContent="求人情報の編集",document.getElementById("edit-job-title").value=t.title||"",document.getElementById("edit-job-location").value=t.location||"",document.getElementById("edit-job-salary").value=t.monthlySalary||"",document.getElementById("edit-job-bonus").value=t.totalBonus||"",document.getElementById("edit-job-order").value=t.order||"",document.getElementById("edit-job-features").value=t.features||"",document.getElementById("edit-job-badges").value=t.badges||"",document.getElementById("edit-job-description").value=t.jobDescription||"",document.getElementById("edit-job-requirements").value=t.requirements||"",document.getElementById("edit-job-benefits").value=t.benefits||"",document.getElementById("edit-job-hours").value=t.workingHours||"",document.getElementById("edit-job-holidays").value=t.holidays||"",t.publishStartDate?document.getElementById("edit-job-start-date").value=this.formatDateForInput(t.publishStartDate):document.getElementById("edit-job-start-date").value="",t.publishEndDate?document.getElementById("edit-job-end-date").value=this.formatDateForInput(t.publishEndDate):document.getElementById("edit-job-end-date").value="",document.getElementById("edit-job-visible").checked="true"===t.visible||"TRUE"===t.visible||!0===t.visible,document.getElementById("job-modal-delete").style.display="",document.getElementById("job-modal").style.display="flex"):alert("求人データが見つかりません")},formatDateForInput(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},closeJobModal(){document.getElementById("job-modal").style.display="none",this.currentEditingJob=null,this.isNewJob=!1},async saveJobData(){if(!this.currentJobCompanyDomain)return void alert("会社が選択されていません");const e={title:document.getElementById("edit-job-title").value.trim(),location:document.getElementById("edit-job-location").value.trim(),monthlySalary:document.getElementById("edit-job-salary").value||"",totalBonus:document.getElementById("edit-job-bonus").value||"",order:document.getElementById("edit-job-order").value||"",features:document.getElementById("edit-job-features").value.trim(),badges:document.getElementById("edit-job-badges").value.trim(),jobDescription:document.getElementById("edit-job-description").value.trim(),requirements:document.getElementById("edit-job-requirements").value.trim(),benefits:document.getElementById("edit-job-benefits").value.trim(),workingHours:document.getElementById("edit-job-hours").value.trim(),holidays:document.getElementById("edit-job-holidays").value.trim(),publishStartDate:document.getElementById("edit-job-start-date").value||"",publishEndDate:document.getElementById("edit-job-end-date").value||"",visible:document.getElementById("edit-job-visible").checked?"true":"false"};if(!e.title||!e.location)return void alert("募集タイトルと勤務地は必須です");const t=AdminDashboard.spreadsheetConfig.gasApiUrl;if(t)try{const n=document.getElementById("job-modal-save");n&&(n.disabled=!0,n.textContent="保存中...");const o=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveJob",companyDomain:this.currentJobCompanyDomain,job:e,rowIndex:this.isNewJob?null:this.currentEditingJob._rowIndex})))),a=`${t}?action=post&data=${encodeURIComponent(o)}`,i=await fetch(a,{method:"GET",redirect:"follow"}),s=await i.text();let l;try{l=JSON.parse(s)}catch(e){throw n&&(n.disabled=!1,n.textContent="保存"),new Error("GASからの応答が不正です")}if(n&&(n.disabled=!1,n.textContent="保存"),!l.success)return void alert("保存に失敗しました: "+(l.error||"不明なエラー"));this.closeJobModal(),await this.loadJobsData(this.currentJobCompanyDomain),alert(this.isNewJob?"求人を作成しました":"求人情報を更新しました")}catch(e){console.error("求人保存エラー:",e),alert("保存中にエラーが発生しました: "+e.message)}else alert("GAS API URLが設定されていません。設定画面でURLを設定してください。")},async deleteJob(){if(!this.currentEditingJob||!this.currentJobCompanyDomain)return void alert("削除対象が選択されていません");if(!confirm("この求人を削除してもよろしいですか？"))return;const e=AdminDashboard.spreadsheetConfig.gasApiUrl;if(e)try{const t=document.getElementById("job-modal-delete");t&&(t.disabled=!0,t.textContent="削除中...");const n=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteJob",companyDomain:this.currentJobCompanyDomain,rowIndex:this.currentEditingJob._rowIndex})))),o=`${e}?action=post&data=${encodeURIComponent(n)}`,a=await fetch(o,{method:"GET",redirect:"follow"}),i=await a.text();let s;try{s=JSON.parse(i)}catch(e){throw t&&(t.disabled=!1,t.textContent="削除"),new Error("GASからの応答が不正です")}if(t&&(t.disabled=!1,t.textContent="削除"),!s.success)return void alert("削除に失敗しました: "+(s.error||"不明なエラー"));this.closeJobModal(),await this.loadJobsData(this.currentJobCompanyDomain),alert("求人を削除しました")}catch(e){console.error("求人削除エラー:",e),alert("削除中にエラーが発生しました: "+e.message)}else alert("GAS API URLが設定されていません")},bindEvents(){const e=document.getElementById("btn-add-company");e&&e.addEventListener("click",()=>{window.location.href="company-edit.html"});const t=document.getElementById("lp-company-select");t&&t.addEventListener("change",e=>{this.loadLPSettings(e.target.value)});const n=document.getElementById("btn-save-lp-settings");n&&n.addEventListener("click",()=>this.saveLPSettings());const o=document.getElementById("btn-reset-lp-settings");o&&o.addEventListener("click",()=>{const e=document.getElementById("lp-company-select").value;e&&this.loadLPSettings(e)});const a=document.getElementById("btn-toggle-preview");a&&a.addEventListener("click",()=>this.toggleLPPreview());const i=document.getElementById("btn-close-preview");i&&i.addEventListener("click",()=>this.closeLPPreview()),document.querySelectorAll(".preview-device-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.device;this.switchPreviewDevice(t)})});document.querySelectorAll("#lp-editor input, #lp-editor textarea").forEach(e=>{e.addEventListener("input",()=>this.debouncedUpdatePreview())}),document.querySelectorAll('input[name="design-pattern"]').forEach(e=>{e.addEventListener("change",()=>this.updateLPPreview())}),this.initSectionSortable(),document.querySelectorAll('#lp-section-order input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>this.updateLPPreview())});const s=document.getElementById("preview-edit-mode");s&&s.addEventListener("change",e=>this.togglePreviewEditMode(e.target.checked));const l=document.getElementById("company-modal-close");l&&l.addEventListener("click",()=>this.closeCompanyModal());const c=document.getElementById("company-modal-cancel");c&&c.addEventListener("click",()=>this.closeCompanyModal());const d=document.getElementById("company-edit-form");d&&d.addEventListener("submit",e=>{e.preventDefault(),this.saveCompanyData()});const r=document.getElementById("company-modal");r&&r.addEventListener("click",e=>{e.target===r&&this.closeCompanyModal()});const m=document.getElementById("btn-add-job");m&&m.addEventListener("click",()=>this.showJobModal());const p=document.getElementById("btn-close-jobs");p&&p.addEventListener("click",()=>this.closeJobsArea());const u=document.getElementById("job-modal-close");u&&u.addEventListener("click",()=>this.closeJobModal());const h=document.getElementById("job-modal-cancel");h&&h.addEventListener("click",()=>this.closeJobModal());const g=document.getElementById("job-modal-delete");g&&g.addEventListener("click",()=>this.deleteJob());const y=document.getElementById("job-edit-form");y&&y.addEventListener("submit",e=>{e.preventDefault(),this.saveJobData()});const b=document.getElementById("job-modal");b&&b.addEventListener("click",e=>{e.target===b&&this.closeJobModal()})}};window.AdminCompany=AdminCompany;