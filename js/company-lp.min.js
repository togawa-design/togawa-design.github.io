const CompanyLP={config:{patterns:{standard:{name:"スタンダード",heroStyle:"gradient",accentColor:"#6366f1"},modern:{name:"モダン",heroStyle:"image-overlay",accentColor:"#3b82f6"},classic:{name:"クラシック",heroStyle:"solid",accentColor:"#dc2626"},minimal:{name:"ミニマル",heroStyle:"white",accentColor:"#1f2937"},colorful:{name:"カラフル",heroStyle:"gradient-multi",accentColor:"#f59e0b"}}},isEditMode:!1,editedData:{},currentCompanyDomain:null,draggedSection:null,async init(){const e=this.getCompanyDomain();this.currentCompanyDomain=e;const t=new URLSearchParams(window.location.search);if(this.isEditMode=t.has("edit"),e)try{const t=await JobsLoader.fetchCompanies(),n=t?.find(t=>t.companyDomain?.trim()===e&&JobsLoader.isCompanyVisible(t));if(!n)return void this.showError("指定された会社は見つかりませんでした。");let l=[];if(n.jobsSheet?.trim()){const e=await JobsLoader.fetchCompanyJobs(n.jobsSheet.trim());e?.length>0&&(l=e.filter(e=>"false"!==e.visible&&"FALSE"!==e.visible).filter(e=>JobsLoader.isJobInPublishPeriod(e)).sort((e,t)=>(parseInt(e.order)||999)-(parseInt(t.order)||999)).map(e=>({...e,company:n.company,companyDomain:n.companyDomain})))}const i=await this.fetchLPSettings(e)||{};this.renderLP(n,l,i),this.isEditMode&&this.enableEditMode(i),this.updateSEO(n,l),this.isEditMode||this.trackPageView(n)}catch(e){console.error("LP読み込みエラー:",e),this.showError("ページの読み込みに失敗しました。")}else this.showError("会社が指定されていません。")},getCompanyDomain(){const e=new URLSearchParams(window.location.search);return e.get("c")||e.get("id")||null},async fetchLPSettings(e){try{const t=`https://docs.google.com/spreadsheets/d/${JobsLoader.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LP設定`,n=await fetch(t);if(!n.ok)return null;const l=(await n.text()).split("\n"),i=JobsLoader.parseCSVLine(l[0]||"");for(let t=1;t<l.length;t++){if(!l[t].trim())continue;const n=JobsLoader.parseCSVLine(l[t]),a={};if(i.forEach((e,t)=>{a[e.replace(/"/g,"").trim()]=n[t]||""}),a.companyDomain===e||a["会社ドメイン"]===e)return{heroTitle:a.heroTitle||a["ヒーロータイトル"]||"",heroSubtitle:a.heroSubtitle||a["ヒーローサブタイトル"]||"",heroImage:a.heroImage||a["ヒーロー画像"]||"",ctaText:a.ctaText||a["CTAテキスト"]||"この求人に応募する",pointTitle1:a.pointTitle1||a["ポイント1タイトル"]||"",pointDesc1:a.pointDesc1||a["ポイント1説明"]||"",pointTitle2:a.pointTitle2||a["ポイント2タイトル"]||"",pointDesc2:a.pointDesc2||a["ポイント2説明"]||"",pointTitle3:a.pointTitle3||a["ポイント3タイトル"]||"",pointDesc3:a.pointDesc3||a["ポイント3説明"]||"",faq:a.faq||a.FAQ||"",designPattern:a.designPattern||a["デザインパターン"]||"standard",sectionOrder:a.sectionOrder||a["セクション順序"]||"",sectionVisibility:a.sectionVisibility||a["セクション表示"]||""}}}catch(e){console.log("LP設定シートが見つかりません（デフォルト設定を使用）")}return null},renderLP(e,t,n){const l=document.getElementById("lp-loading"),i=document.getElementById("lp-content");if(l&&(l.style.display="none"),!i)return;const a=`lp-pattern-${n.designPattern||e.designPattern||"standard"}`;document.body.classList.add(a);const s=t.length>0?t[0]:e;let o={points:!0,jobs:!0,details:!0,faq:!0};if(n.sectionVisibility)try{o={...o,...JSON.parse(n.sectionVisibility)}}catch(e){console.error("セクション表示設定のパースエラー:",e)}const c={hero:()=>this.renderHeroSection(e,s,n),points:()=>o.points?this.renderPointsSection(e,s,n):"",jobs:()=>o.jobs?this.renderJobsSection(e,t):"",details:()=>o.details?this.renderDetailsSection(e,s):"",faq:()=>o.faq&&n.faq?this.renderFAQSection(n.faq):"",apply:()=>this.renderApplySection(e,n)},r=["hero","points","jobs","details","faq","apply"];let d=r;if(n.sectionOrder){const e=n.sectionOrder.split(",").map(e=>e.trim()).filter(e=>e);if(e.length>0){const t=r.filter(t=>!e.includes(t));d=[...e,...t]}}i.innerHTML=d.map(e=>c[e]?c[e]():"").join(""),this.setupEventListeners(e)},renderHeroSection(e,t,n){const l=n.heroTitle||t.title||`${e.company}で働こう`,i=n.heroSubtitle||"",a=n.heroImage||e.imageUrl||"",s=[];return t.totalBonus&&s.push({label:"特典総額",value:t.totalBonus,icon:"bonus"}),t.monthlySalary&&s.push({label:"月収例",value:t.monthlySalary,icon:"salary"}),`\n      <section class="lp-hero">\n        <div class="lp-hero-bg lp-editable-image" data-field="heroImage" data-label="ヒーロー画像" style="${a?`background-image: url('${this.escapeHtml(a)}')`:""}"></div>\n        <div class="lp-hero-overlay"></div>\n        <div class="lp-hero-content">\n          <p class="lp-hero-company">${this.escapeHtml(e.company)}</p>\n          <h1 class="lp-hero-title lp-editable" data-field="heroTitle" data-label="メインタイトル">${this.escapeHtml(l)}</h1>\n          ${i?`<p class="lp-hero-subtitle lp-editable" data-field="heroSubtitle" data-label="サブタイトル">${this.escapeHtml(i)}</p>`:'<p class="lp-hero-subtitle lp-editable lp-placeholder" data-field="heroSubtitle" data-label="サブタイトル">サブタイトルを追加</p>'}\n\n          ${s.length>0?`\n          <div class="lp-hero-highlights">\n            ${s.map(e=>`\n              <div class="lp-highlight-item ${e.icon}">\n                <span class="lp-highlight-label">${this.escapeHtml(e.label)}</span>\n                <span class="lp-highlight-value">${this.escapeHtml(e.value)}</span>\n              </div>\n            `).join("")}\n          </div>\n          `:""}\n\n          <div class="lp-hero-cta">\n            <a href="#lp-apply" class="lp-btn-apply-hero">今すぐ応募する</a>\n          </div>\n        </div>\n      </section>\n    `},renderPointsSection(e,t,n){const l=[];return n.pointTitle1&&l.push({title:n.pointTitle1,desc:n.pointDesc1||"",idx:1}),n.pointTitle2&&l.push({title:n.pointTitle2,desc:n.pointDesc2||"",idx:2}),n.pointTitle3&&l.push({title:n.pointTitle3,desc:n.pointDesc3||"",idx:3}),0===l.length&&(t.totalBonus&&l.push({title:"入社特典",desc:`特典総額${t.totalBonus}！入社祝い金やその他特典が充実。`,idx:1}),t.monthlySalary&&l.push({title:"高収入",desc:`月収例${t.monthlySalary}可能！安定した収入を実現。`,idx:2}),t.benefits&&l.push({title:"充実の待遇",desc:"社会保険完備、寮完備など福利厚生が充実。",idx:3})),0===l.length?"":`\n      <section class="lp-points">\n        <div class="lp-section-inner">\n          <h2 class="lp-section-title">この求人のポイント</h2>\n          <div class="lp-points-grid">\n            ${l.map((e,t)=>`\n              <div class="lp-point-card">\n                <div class="lp-point-number">${t+1}</div>\n                <h3 class="lp-point-title lp-editable" data-field="pointTitle${e.idx}" data-label="ポイント${e.idx}タイトル">${this.escapeHtml(e.title)}</h3>\n                <p class="lp-point-desc lp-editable" data-field="pointDesc${e.idx}" data-label="ポイント${e.idx}説明">${this.escapeHtml(e.desc)}</p>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      </section>\n    `},renderJobsSection(e,t){return 0===t.length?"":`\n      <section class="lp-jobs">\n        <div class="lp-section-inner">\n          <h2 class="lp-section-title">募集中の求人</h2>\n          <div class="lp-jobs-list">\n            ${t.map(t=>`\n              <div class="lp-job-card">\n                <div class="lp-job-card-header">\n                  <h3 class="lp-job-title">${this.escapeHtml(t.title)}</h3>\n                  ${t.employmentType?`<span class="lp-job-type">${this.escapeHtml(t.employmentType)}</span>`:""}\n                </div>\n                <div class="lp-job-card-body">\n                  <ul class="lp-job-info">\n                    <li>\n                      <span class="lp-info-icon">\n                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>\n                      </span>\n                      ${this.escapeHtml(t.location)}\n                    </li>\n                    ${t.monthlySalary?`\n                    <li>\n                      <span class="lp-info-icon">\n                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>\n                      </span>\n                      ${this.escapeHtml(t.monthlySalary)}\n                    </li>\n                    `:""}\n                    ${t.totalBonus?`\n                    <li class="highlight">\n                      <span class="lp-info-icon">\n                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>\n                      </span>\n                      特典総額 ${this.escapeHtml(t.totalBonus)}\n                    </li>\n                    `:""}\n                  </ul>\n                  ${t.features?.length>0?`\n                  <div class="lp-job-tags">\n                    ${(Array.isArray(t.features)?t.features:t.features.split(",")).slice(0,5).map(e=>`<span class="lp-job-tag">${this.escapeHtml(e.trim())}</span>`).join("")}\n                  </div>\n                  `:""}\n                </div>\n                <div class="lp-job-card-footer">\n                  <a href="job-detail.html?company=${this.escapeHtml(t.companyDomain||e.companyDomain)}&job=${this.escapeHtml(t.id||"")}" class="lp-btn-detail">詳細を見る</a>\n                </div>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      </section>\n    `},renderDetailsSection(e,t){const n=[];return e.description&&n.push({label:"会社概要",value:e.description,isHtml:!0}),e.jobDescription&&n.push({label:"お仕事内容",value:e.jobDescription,isHtml:!0}),e.workingHours&&n.push({label:"勤務時間",value:e.workingHours,isHtml:!0}),e.workLocation&&n.push({label:"勤務地",value:e.workLocation,isHtml:!0}),!e.jobDescription&&t.jobDescription&&n.push({label:"仕事内容",value:t.jobDescription,isHtml:!1}),t.salary&&n.push({label:"給与",value:t.salary,isHtml:!1}),!e.workingHours&&t.workingHours&&n.push({label:"勤務時間",value:t.workingHours,isHtml:!1}),t.holidays&&n.push({label:"休日・休暇",value:t.holidays,isHtml:!1}),t.benefits&&n.push({label:"待遇・福利厚生",value:t.benefits,isHtml:!1}),!e.workLocation&&t.location&&n.push({label:"勤務地",value:t.location,isHtml:!1}),0===n.length?"":`\n      <section class="lp-details">\n        <div class="lp-section-inner">\n          <h2 class="lp-section-title">募集要項</h2>\n          <div class="lp-details-table">\n            ${n.map(e=>`\n              <div class="lp-detail-row">\n                <div class="lp-detail-label">${this.escapeHtml(e.label)}</div>\n                <div class="lp-detail-value">${e.isHtml?this.sanitizeHtml(e.value):this.escapeHtml(e.value).replace(/\n/g,"<br>")}</div>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      </section>\n    `},renderFAQSection(e){const t=e.split("||").map(e=>{const t=e.split("|");return{q:t.find(e=>e.startsWith("Q:"))?.replace("Q:","").trim()||"",a:t.find(e=>e.startsWith("A:"))?.replace("A:","").trim()||""}}).filter(e=>e.q&&e.a);return 0===t.length?"":`\n      <section class="lp-faq">\n        <div class="lp-section-inner">\n          <h2 class="lp-section-title">よくある質問</h2>\n          <div class="lp-faq-list">\n            ${t.map(e=>`\n              <div class="lp-faq-item">\n                <div class="lp-faq-question">\n                  <span class="lp-faq-icon">Q</span>\n                  <span>${this.escapeHtml(e.q)}</span>\n                </div>\n                <div class="lp-faq-answer">\n                  <span class="lp-faq-icon">A</span>\n                  <span>${this.escapeHtml(e.a)}</span>\n                </div>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      </section>\n    `},renderApplySection(e,t){const n=t.ctaText||"今すぐ応募する";return`\n      <section class="lp-apply" id="lp-apply">\n        <div class="lp-section-inner">\n          <h2 class="lp-apply-title">まずはお気軽にご応募ください</h2>\n          <p class="lp-apply-text">経験・学歴不問！${e.company}であなたのご応募をお待ちしています。</p>\n          <div class="lp-apply-buttons">\n            <a href="#" class="lp-btn-apply-main lp-editable-btn" data-company="${this.escapeHtml(e.companyDomain)}" data-field="ctaText" data-label="応募ボタンテキスト">${this.escapeHtml(n)}</a>\n            <a href="tel:0120-000-000" class="lp-btn-tel-main">\n              <span class="tel-number">0120-000-000</span>\n              <span class="tel-note">（平日9:00〜18:00）</span>\n            </a>\n          </div>\n          <div class="lp-apply-line">\n            <p>LINEでも相談受付中！</p>\n            <a href="#" class="lp-btn-line">LINEで相談する</a>\n          </div>\n        </div>\n      </section>\n    `},updateSEO(e,t){const n=t.length>0?t[0]:e;document.title=`${e.company}の求人 | リクエコ求人ナビ`;const l=document.querySelector('meta[name="description"]');if(l){const i=n.totalBonus?`${e.company}の期間工・期間従業員募集。特典総額${n.totalBonus}。${t.length}件の求人を掲載中。`:`${e.company}の期間工・期間従業員募集。${t.length}件の求人を掲載中。`;l.content=i}const i=document.querySelector('meta[property="og:title"]');i&&(i.content=`${e.company}の求人 | リクエコ求人ナビ`);const a=document.querySelector('meta[property="og:description"]');a&&(a.content=l?.content||"")},setupEventListeners(e){document.querySelectorAll(".lp-btn-apply-main, .lp-btn-apply-hero, .lp-btn-apply-header, .lp-btn-apply-footer").forEach(t=>{t.addEventListener("click",t=>{t.preventDefault(),this.trackApplyClick(e,"apply"),alert("応募フォームは準備中です。お電話またはLINEからお問い合わせください。")})}),document.querySelectorAll(".lp-btn-tel-main, .lp-btn-tel-header, .lp-btn-tel-footer").forEach(t=>{t.addEventListener("click",()=>{this.trackApplyClick(e,"tel")})}),document.querySelectorAll(".lp-btn-line").forEach(t=>{t.addEventListener("click",t=>{t.preventDefault(),this.trackApplyClick(e,"line"),alert("LINE相談は準備中です。お電話からお問い合わせください。")})}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if("#"===n||"#lp-apply"===n){t.preventDefault();const e=document.getElementById("lp-apply");e&&e.scrollIntoView({behavior:"smooth"})}})})},trackPageView(e){"undefined"!=typeof JobsLoader&&JobsLoader.trackEvent&&JobsLoader.trackEvent("view_company_lp",{company_domain:e.companyDomain||"",company_name:e.company||"",design_pattern:e.designPattern||"standard",page_location:window.location.href})},trackApplyClick(e,t){"undefined"!=typeof JobsLoader&&JobsLoader.trackEvent&&JobsLoader.trackEvent("click_apply_lp",{company_domain:e.companyDomain||"",company_name:e.company||"",button_type:t,page_location:window.location.href})},showError(e){const t=document.getElementById("lp-loading"),n=document.getElementById("lp-content");t&&(t.style.display="none"),n&&(n.innerHTML=`\n        <div class="lp-error">\n          <h2>エラー</h2>\n          <p>${this.escapeHtml(e)}</p>\n          <a href="/" class="lp-btn-back">トップページへ戻る</a>\n        </div>\n      `)},enableEditMode(e){this.editedData={...e},document.body.classList.add("lp-edit-mode"),this.renderEditToolbar(),this.setupEditableElements(),this.setupSectionSortable()},renderEditToolbar(){const e=document.createElement("div");e.className="lp-edit-toolbar",e.innerHTML='\n      <div class="lp-edit-toolbar-inner">\n        <div class="lp-edit-toolbar-left">\n          <span class="lp-edit-mode-badge">編集モード</span>\n          <span class="lp-edit-hint">クリックして文字を編集できます</span>\n        </div>\n        <div class="lp-edit-toolbar-right">\n          <button class="lp-edit-btn-cancel" id="lp-edit-cancel">キャンセル</button>\n          <button class="lp-edit-btn-save" id="lp-edit-save">変更を保存</button>\n        </div>\n      </div>\n    ',document.body.appendChild(e),document.getElementById("lp-edit-cancel")?.addEventListener("click",()=>{if(confirm("変更を破棄してプレビューモードに戻りますか？")){const e=new URL(window.location.href);e.searchParams.delete("edit"),window.location.href=e.toString()}}),document.getElementById("lp-edit-save")?.addEventListener("click",()=>{this.saveEditedData()})},setupEditableElements(){document.querySelectorAll(".lp-editable, .lp-editable-btn").forEach(e=>{const t=e.dataset.field,n=e.dataset.label||t;e.addEventListener("mouseenter",()=>{this.showEditLabel(e,n)}),e.addEventListener("mouseleave",()=>{this.hideEditLabel()}),e.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.startEditing(e,t,n)})});document.querySelectorAll(".lp-editable-image").forEach(e=>{const t=e.dataset.field,n=e.dataset.label||t;e.addEventListener("mouseenter",()=>{this.showEditLabel(e,n)}),e.addEventListener("mouseleave",()=>{this.hideEditLabel()}),e.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.startImageEditing(e,t,n)})})},setupSectionSortable(){const e=document.getElementById("lp-content");if(!e)return;const t=e.querySelectorAll("section");0!==t.length&&t.forEach((t,n)=>{let l="unknown";t.classList.contains("lp-hero")?l="hero":t.classList.contains("lp-points")?l="points":t.classList.contains("lp-jobs")?l="jobs":t.classList.contains("lp-details")?l="details":t.classList.contains("lp-faq")?l="faq":t.classList.contains("lp-apply")&&(l="apply"),t.dataset.section=l,t.classList.add("lp-sortable-section");const i=document.createElement("div");i.className="lp-section-drag-handle",i.innerHTML=`\n        <span class="lp-section-label">${this.getSectionLabel(l)}</span>\n        <span class="lp-section-drag-icon">⋮⋮</span>\n      `,t.insertBefore(i,t.firstChild),t.setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{this.draggedSection=t,t.classList.add("lp-section-dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setDragImage(t,50,30)}),t.addEventListener("dragend",()=>{t.classList.remove("lp-section-dragging"),this.draggedSection=null,this.saveSectionOrder()}),t.addEventListener("dragover",n=>{if(n.preventDefault(),n.dataTransfer.dropEffect="move",this.draggedSection&&this.draggedSection!==t){const n=[...e.querySelectorAll("section")];n.indexOf(this.draggedSection)<n.indexOf(t)?t.parentNode.insertBefore(this.draggedSection,t.nextSibling):t.parentNode.insertBefore(this.draggedSection,t)}})})},getSectionLabel:e=>({hero:"ヒーロー",points:"ポイント",jobs:"求人一覧",details:"募集要項",faq:"FAQ",apply:"応募"}[e]||"セクション"),saveSectionOrder(){const e=document.getElementById("lp-content");if(!e)return;const t=e.querySelectorAll("section"),n=Array.from(t).map(e=>e.dataset.section);this.editedData.sectionOrder=n.join(",")},showEditLabel(e,t){this.hideEditLabel();const n=document.createElement("div");n.className="lp-edit-label",n.textContent=`${t}を編集`,n.id="lp-edit-label-tooltip";const l=e.getBoundingClientRect();n.style.position="fixed",n.style.top=l.top-30+"px",n.style.left=`${l.left}px`,document.body.appendChild(n)},hideEditLabel(){const e=document.getElementById("lp-edit-label-tooltip");e&&e.remove()},startEditing(e,t,n){const l=document.querySelector(".lp-inline-editor");l&&l.remove();const i=e.classList.contains("lp-placeholder")?"":e.textContent,a=document.createElement("div");a.className="lp-inline-editor";const s=t.includes("Desc");a.innerHTML=s?`\n        <label class="lp-inline-editor-label">${this.escapeHtml(n)}</label>\n        <textarea class="lp-inline-editor-textarea" rows="3">${this.escapeHtml(i)}</textarea>\n        <div class="lp-inline-editor-actions">\n          <button class="lp-inline-editor-cancel">キャンセル</button>\n          <button class="lp-inline-editor-apply">適用</button>\n        </div>\n      `:`\n        <label class="lp-inline-editor-label">${this.escapeHtml(n)}</label>\n        <input type="text" class="lp-inline-editor-input" value="${this.escapeHtml(i)}">\n        <div class="lp-inline-editor-actions">\n          <button class="lp-inline-editor-cancel">キャンセル</button>\n          <button class="lp-inline-editor-apply">適用</button>\n        </div>\n      `;const o=e.getBoundingClientRect();a.style.position="fixed",a.style.top=`${Math.max(60,o.top-10)}px`,a.style.left=`${Math.max(10,o.left)}px`,a.style.minWidth=`${Math.min(400,o.width+40)}px`,document.body.appendChild(a);const c=a.querySelector("input, textarea");c?.focus(),c?.select(),a.querySelector(".lp-inline-editor-cancel")?.addEventListener("click",()=>{a.remove()}),a.querySelector(".lp-inline-editor-apply")?.addEventListener("click",()=>{const n=c?.value||"";this.applyEdit(e,t,n),a.remove()}),c?.addEventListener("keydown",n=>{if("Enter"!==n.key||s)"Escape"===n.key&&a.remove();else{const n=c?.value||"";this.applyEdit(e,t,n),a.remove()}})},startImageEditing(e,t,n){const l=document.querySelector(".lp-inline-editor");l&&l.remove();const i=e.style.backgroundImage,a=i?i.replace(/^url\(['"]?/,"").replace(/['"]?\)$/,""):"",s=document.createElement("div");s.className="lp-inline-editor lp-image-editor",s.innerHTML=`\n      <label class="lp-inline-editor-label">${this.escapeHtml(n)}</label>\n      <div class="lp-image-url-input">\n        <input type="text" class="lp-inline-editor-input" placeholder="画像URLを入力..." value="${this.escapeHtml(a)}">\n      </div>\n      <div class="lp-image-presets">\n        <p class="lp-image-presets-label">プリセット画像:</p>\n        <div class="lp-image-presets-grid">\n          ${[{url:"https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=1200",name:"工場1"},{url:"https://images.unsplash.com/photo-1565043666747-69f6646db940?w=1200",name:"工場2"},{url:"https://images.unsplash.com/photo-1504917595217-d4dc5ebe6122?w=1200",name:"製造業"},{url:"https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=1200",name:"自動車"},{url:"https://images.unsplash.com/photo-1567789884554-0b844b597180?w=1200",name:"倉庫"},{url:"https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=1200",name:"ビル"}].map(e=>`\n            <div class="lp-image-preset-item" data-url="${this.escapeHtml(e.url)}">\n              <img src="${this.escapeHtml(e.url)}&h=80" alt="${this.escapeHtml(e.name)}">\n              <span>${this.escapeHtml(e.name)}</span>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n      <div class="lp-inline-editor-actions">\n        <button class="lp-inline-editor-cancel">キャンセル</button>\n        <button class="lp-inline-editor-clear">画像を削除</button>\n        <button class="lp-inline-editor-apply">適用</button>\n      </div>\n    `,s.style.position="fixed",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.minWidth="400px",s.style.maxWidth="500px",s.style.zIndex="10001",document.body.appendChild(s);const o=s.querySelector("input");s.querySelectorAll(".lp-image-preset-item").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.url;o.value=n,e.style.backgroundImage=`url('${n}')`})}),s.querySelector(".lp-inline-editor-cancel")?.addEventListener("click",()=>{e.style.backgroundImage=a?`url('${a}')`:"",s.remove()}),s.querySelector(".lp-inline-editor-clear")?.addEventListener("click",()=>{o.value="",e.style.backgroundImage=""}),s.querySelector(".lp-inline-editor-apply")?.addEventListener("click",()=>{const n=o?.value||"";this.applyImageEdit(e,t,n),s.remove()}),o?.addEventListener("input",()=>{const t=o.value;e.style.backgroundImage=t?`url('${t}')`:""}),o?.addEventListener("keydown",n=>{if("Enter"===n.key){const n=o?.value||"";this.applyImageEdit(e,t,n),s.remove()}else"Escape"===n.key&&(e.style.backgroundImage=a?`url('${a}')`:"",s.remove())}),o?.focus()},applyImageEdit(e,t,n){e.style.backgroundImage=n?`url('${n}')`:"",this.editedData[t]=n,e.classList.add("lp-edited")},applyEdit(e,t,n){n?(e.textContent=n,e.classList.remove("lp-placeholder")):(e.textContent=e.dataset.label+"を追加",e.classList.add("lp-placeholder")),this.editedData[t]=n,e.classList.add("lp-edited")},async saveEditedData(){const e=document.getElementById("lp-edit-save");e&&(e.disabled=!0,e.textContent="保存中...");try{const e=localStorage.getItem("gas_api_url");if(!e)return void alert("GAS API URLが設定されていません。管理画面で設定してください。");const t=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveLPSettings",companyDomain:this.currentCompanyDomain,settings:this.editedData})))),n=`${e}?action=post&data=${encodeURIComponent(t)}`,l=await fetch(n),i=await l.json();if(!i.success)throw new Error(i.error||"保存に失敗しました");{alert("保存しました！");const e=new URL(window.location.href);e.searchParams.delete("edit"),window.location.href=e.toString()}}catch(e){console.error("保存エラー:",e),alert("保存に失敗しました: "+e.message)}finally{e&&(e.disabled=!1,e.textContent="変更を保存")}},escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML},sanitizeHtml(e){if(!e)return"";if("<br>"===e||"<div><br></div>"===e)return"";const t=["b","strong","i","em","u","ul","ol","li","br","div","p"],n=document.createElement("div");n.innerHTML=e;return n.querySelectorAll("*").forEach(e=>{if(t.includes(e.tagName.toLowerCase()))for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name);else e.replaceWith(...e.childNodes)}),n.innerHTML}};document.addEventListener("DOMContentLoaded",()=>{CompanyLP.init()});