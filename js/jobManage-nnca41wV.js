import"./modulepreload-polyfill-YP0FEG5d.js";import{e}from"./utils-BE8OECDH.js";import{S as t,T as n,U as o,V as a,W as s,X as l,Y as i,Z as d,_ as c,$ as r,r as u,a0 as m,u as p,D as g,E as y,F as b,s as v,t as f,b as h,d as E,a1 as I,a2 as j,e as w,a3 as B,p as L}from"./job-feed-generator-CtMaETTX.js";import{p as $}from"./jobs-loader-Perrv3gz.js";import"./LPEditor-Cc2WBFCI.js";import"./image-uploader-CwR9OqLI.js";const x={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"};let k=null,S=[],T=[],D=1;let C=null,A=[];const M={new:"æ–°è¦",contacted:"é€£çµ¡æ¸ˆã¿",interviewing:"é¢æ¥èª¿æ•´ä¸­",interviewed:"é¢æ¥æ¸ˆã¿",hired:"æ¡ç”¨",rejected:"ä¸æ¡ç”¨",withdrawn:"è¾é€€"},H={apply:"å¿œå‹Ÿ",line:"LINEç›¸è«‡",consult:"ãŠå•ã„åˆã‚ã›"},_={immediate:"ã™ãã«ã§ã‚‚","within-week":"1é€±é–“ä»¥å†…","within-month":"1ãƒ¶æœˆä»¥å†…","within-2months":"2ãƒ¶æœˆä»¥å†…",undecided:"æœªå®šãƒ»ç›¸è«‡ã—ãŸã„"},P={first_contact:{subject:"åˆå›é€£çµ¡",body:"{applicantName}æ§˜\n\nã“ã®åº¦ã¯ã€Œ{jobTitle}ã€ã«ã”å¿œå‹Ÿã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\nã”å¿œå‹Ÿå†…å®¹ã‚’ç¢ºèªã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚\nã¤ãã¾ã—ã¦ã¯ã€ä¸€åº¦ãŠé›»è©±ã«ã¦ãŠè©±ã‚’ã•ã›ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚\n\nã”éƒ½åˆã®è‰¯ã„æ—¥æ™‚ã‚’ã„ãã¤ã‹ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚\nï¼ˆå¹³æ—¥10:00ã€œ18:00ã®é–“ã§ãŠé¡˜ã„ã§ãã¾ã™ã¨å¹¸ã„ã§ã™ï¼‰\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"},schedule_interview:{subject:"é¢æ¥æ—¥ç¨‹èª¿æ•´",body:"{applicantName}æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n\né¢æ¥ã®æ—¥ç¨‹èª¿æ•´ã«ã¤ã„ã¦ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚\n\nä¸‹è¨˜ã®æ—¥ç¨‹ã§ã”éƒ½åˆã®è‰¯ã„æ—¥æ™‚ã¯ã”ã–ã„ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚\n\nã€å€™è£œæ—¥ã€‘\nãƒ»â—¯æœˆâ—¯æ—¥ï¼ˆâ—¯ï¼‰â—¯â—¯:00ã€œ\nãƒ»â—¯æœˆâ—¯æ—¥ï¼ˆâ—¯ï¼‰â—¯â—¯:00ã€œ\nãƒ»â—¯æœˆâ—¯æ—¥ï¼ˆâ—¯ï¼‰â—¯â—¯:00ã€œ\n\nä¸Šè¨˜ä»¥å¤–ã§ã‚‚ã”èª¿æ•´å¯èƒ½ã§ã™ã®ã§ã€ã”å¸Œæœ›ã®æ—¥æ™‚ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"},interview_reminder:{subject:"é¢æ¥ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼",body:"{applicantName}æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n\né¢æ¥æ—¥ç¨‹ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚\n\nã€é¢æ¥æ—¥æ™‚ã€‘â—¯æœˆâ—¯æ—¥ï¼ˆâ—¯ï¼‰â—¯â—¯:00ã€œ\nã€å ´æ‰€ã€‘ã€’â—¯â—¯â—¯-â—¯â—¯â—¯â—¯ â—¯â—¯çœŒâ—¯â—¯å¸‚â—¯â—¯\nã€æŒã¡ç‰©ã€‘å±¥æ­´æ›¸ã€ç­†è¨˜ç”¨å…·\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\nå½“æ—¥ãŠä¼šã„ã§ãã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚"},document_request:{subject:"æ›¸é¡æå‡ºä¾é ¼",body:"{applicantName}æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n\né¸è€ƒã‚’é€²ã‚ã‚‹ã«ã‚ãŸã‚Šã€ä¸‹è¨˜ã®æ›¸é¡ã‚’ã”æå‡ºã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚\n\nã€æå‡ºæ›¸é¡ã€‘\nãƒ»å±¥æ­´æ›¸ï¼ˆå†™çœŸè²¼ä»˜ï¼‰\nãƒ»è·å‹™çµŒæ­´æ›¸\n\nã€æå‡ºæ–¹æ³•ã€‘\nãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã«ã¦ã”é€ä»˜ãã ã•ã„ã€‚\n\nã€æå‡ºæœŸé™ã€‘\nâ—¯æœˆâ—¯æ—¥ï¼ˆâ—¯ï¼‰ã¾ã§\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"},result_pending:{subject:"é¸è€ƒçµæœå¾…ã¡",body:"{applicantName}æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n\nå…ˆæ—¥ã¯é¢æ¥ã«ãŠè¶Šã—ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\n\nç¾åœ¨ã€ç¤¾å†…ã«ã¦é¸è€ƒã‚’é€²ã‚ã¦ãŠã‚Šã¾ã™ã€‚\nçµæœã«ã¤ãã¾ã—ã¦ã¯ã€â—¯æœˆâ—¯æ—¥é ƒã¾ã§ã«ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãäºˆå®šã§ã™ã€‚\n\nä»Šã—ã°ã‚‰ããŠå¾…ã¡ã„ãŸã ã‘ã¾ã™ã‚ˆã†ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚"},offer:{subject:"å†…å®šé€šçŸ¥",body:"{applicantName}æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n\nã“ã®åº¦ã¯ã€Œ{jobTitle}ã€ã®é¸è€ƒã«ã”å‚åŠ ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\n\næ…é‡ã«æ¤œè¨ã•ã›ã¦ã„ãŸã ã„ãŸçµæœã€{applicantName}æ§˜ã‚’æ¡ç”¨ã•ã›ã¦ã„ãŸã ãã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚\n\nã¤ãã¾ã—ã¦ã¯ã€å…¥ç¤¾ã«é–¢ã™ã‚‹è©³ç´°ã«ã¤ã„ã¦ã”èª¬æ˜ã•ã›ã¦ã„ãŸã ããŸãã€\nãŠé›»è©±ã«ã¦ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\n{applicantName}æ§˜ã¨ä¸€ç·’ã«åƒã‘ã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚"},rejection:{subject:"ä¸æ¡ç”¨é€šçŸ¥",body:"{applicantName}æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n\nã“ã®åº¦ã¯ã€Œ{jobTitle}ã€ã«ã”å¿œå‹Ÿã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\n\næ…é‡ã«æ¤œè¨ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸãŒã€èª ã«æ®‹å¿µãªãŒã‚‰ä»Šå›ã¯ã”æœŸå¾…ã«æ²¿ãˆãªã„çµæœã¨ãªã‚Šã¾ã—ãŸã€‚\n\nã”å¿œå‹Ÿã„ãŸã ã„ãŸã“ã¨ã«å¿ƒã‚ˆã‚Šæ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ã¨ã¨ã‚‚ã«ã€\n{applicantName}æ§˜ã®ä»Šå¾Œã®ã”æ´»èºã‚’ãŠç¥ˆã‚Šç”³ã—ä¸Šã’ã¾ã™ã€‚"}};function q(){return firebase.apps.length||firebase.initializeApp(x),firebase.firestore()}function U(){const t=document.getElementById("detail-assignee");if(t){const n=t.value;t.innerHTML='<option value="">æœªå‰²å½“</option>'+A.map(t=>`<option value="${e(t)}">${e(t)}</option>`).join(""),t.value=n}}async function O(){var e;const t=document.getElementById("new-assignee-name"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(n)if(A.includes(n))alert("ã“ã®æ‹…å½“è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™");else try{const e=q().collection("settings").doc(k||"global");A.push(n),await e.set({assignees:A,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),U(),F();const t=document.getElementById("detail-assignee");t&&(t.value=n)}catch(o){console.error("Failed to add assignee:",o),alert("æ‹…å½“è€…ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: "+o.message)}else alert("æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")}function X(){const e=document.getElementById("assignee-modal"),t=document.getElementById("new-assignee-name");e&&(e.style.display="flex"),t&&(t.value="",t.focus())}function F(){const e=document.getElementById("assignee-modal");e&&(e.style.display="none")}async function N(){const e=document.getElementById("applicants-list");e&&(e.innerHTML='<div class="loading-message">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>');try{let e=q().collection("applications");k&&(e=e.where("companyDomain","==",k)),e=e.orderBy("createdAt","desc");const t=await e.get();S=[],t.forEach(e=>{S.push({id:e.id,...e.data()})}),R(),V()}catch(t){console.error("Failed to load applicants:",t),e&&(e.innerHTML='<div class="empty-message">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>')}}function R(){var e,t,n,o;const a=(null==(e=document.getElementById("filter-status"))?void 0:e.value)||"",s=(null==(t=document.getElementById("filter-type"))?void 0:t.value)||"",l=(null==(o=null==(n=document.getElementById("filter-search"))?void 0:n.value)?void 0:o.toLowerCase())||"";T=S.filter(e=>{var t;if(a&&(e.status||"new")!==a)return!1;if(s&&e.type!==s)return!1;if(l){const n=(e.jobTitle||"").toLowerCase(),o=(e.applicantName||(null==(t=e.applicant)?void 0:t.name)||"").toLowerCase();if(!n.includes(l)&&!o.includes(l))return!1}return!0}),D=1,J(),G()}function V(){const e=S.length,t=S.filter(e=>!e.status||"new"===e.status).length,n=S.filter(e=>["contacted","interviewing","interviewed"].includes(e.status)).length,o=S.filter(e=>["hired","rejected","withdrawn"].includes(e.status)).length,a=document.getElementById("stat-total"),s=document.getElementById("stat-new"),l=document.getElementById("stat-progress"),i=document.getElementById("stat-complete");a&&(a.textContent=e),s&&(s.textContent=t),l&&(l.textContent=n),i&&(i.textContent=o)}function J(){const t=document.getElementById("applicants-list");if(!t)return;if(0===T.length)return void(t.innerHTML='<div class="empty-message">å¿œå‹Ÿãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>');const n=20*(D-1),o=n+20,a=T.slice(n,o);t.innerHTML=a.map(t=>{var n,o;const a=te((null==(n=t.createdAt)?void 0:n.toDate)?t.createdAt.toDate():new Date(t.timestamp||t.createdAt)),s=t.status||"new",l=H[t.type]||t.type||"-",i=M[s]||s,d=t.applicantName||(null==(o=t.applicant)?void 0:o.name)||"-",c=C===t.id;let r="type-apply";return"line"===t.type&&(r="type-line"),"consult"===t.type&&(r="type-consult"),`\n      <div class="applicant-card ${c?"selected":""}" data-id="${e(t.id)}">\n        <div class="applicant-card-main">\n          <div class="applicant-card-header">\n            <span class="applicant-card-name">${e(d)}</span>\n            <span class="applicant-card-type ${r}">${e(l)}</span>\n          </div>\n          <div class="applicant-card-job">${e(t.jobTitle||"-")}</div>\n          <div class="applicant-card-meta">\n            <span>${e(a)}</span>\n            ${t.assignee?`<span>æ‹…å½“: ${e(t.assignee)}</span>`:""}\n          </div>\n        </div>\n        <div class="applicant-card-status">\n          <span class="status-badge status-${e(s)}">${e(i)}</span>\n        </div>\n      </div>\n    `}).join(""),t.querySelectorAll(".applicant-card").forEach(e=>{e.addEventListener("click",()=>{!function(e){var t,n,o,a,s,l,i;const d=S.find(t=>t.id===e);if(!d)return;C=e,document.querySelectorAll(".applicant-card").forEach(t=>{t.classList.toggle("selected",t.dataset.id===e)});const c=document.getElementById("detail-empty"),r=document.getElementById("detail-content");c&&(c.style.display="none");r&&(r.style.display="flex");const u=d.applicantName||(null==(t=d.applicant)?void 0:t.name)||"-",m=d.applicantPhone||(null==(n=d.applicant)?void 0:n.phone)||"-",p=d.applicantEmail||(null==(o=d.applicant)?void 0:o.email)||"-",g=(null==(a=d.applicant)?void 0:a.age)||"-",y=(null==(s=d.applicant)?void 0:s.address)||"-",b=(null==(l=d.applicant)?void 0:l.startDate)||"-";document.getElementById("detail-name").textContent=u,document.getElementById("detail-job-title").textContent=d.jobTitle||"-",document.getElementById("detail-phone").textContent=m,document.getElementById("detail-email").textContent=p,document.getElementById("detail-age").textContent=g,document.getElementById("detail-address").textContent=y,document.getElementById("detail-start-date").textContent=_[b]||b;const v=(null==(i=d.createdAt)?void 0:i.toDate)?d.createdAt.toDate():new Date(d.timestamp||d.createdAt);document.getElementById("detail-datetime").textContent=te(v,!0),document.getElementById("detail-type").textContent=H[d.type]||d.type||"-",document.getElementById("detail-source").textContent=ne(d.source);const f=d.status||"new";document.querySelectorAll(".status-btn").forEach(e=>{e.classList.toggle("active",e.dataset.status===f)});const h=document.getElementById("detail-assignee");h&&(h.value=d.assignee||"");const E=document.getElementById("detail-notes");E&&(E.value=d.notes||"");Z(d.history||[]),Y(e)}(e.dataset.id)})})}function G(){const e=document.getElementById("pagination");if(!e)return;const t=Math.ceil(T.length/20);if(t<=1)return void(e.innerHTML="");let n="";n+=`<button class="page-btn" ${1===D?"disabled":""} data-page="${D-1}">å‰ã¸</button>`;for(let o=1;o<=t;o++)1===o||o===t||o>=D-2&&o<=D+2?n+=`<button class="page-btn ${o===D?"active":""}" data-page="${o}">${o}</button>`:o!==D-3&&o!==D+3||(n+='<span class="page-ellipsis">...</span>');n+=`<button class="page-btn" ${D===t?"disabled":""} data-page="${D+1}">æ¬¡ã¸</button>`,e.innerHTML=n,e.querySelectorAll(".page-btn").forEach(e=>{e.addEventListener("click",()=>{e.disabled||(D=parseInt(e.dataset.page),J(),G())})})}function z(){C=null,document.querySelectorAll(".applicant-card").forEach(e=>{e.classList.remove("selected")});const e=document.getElementById("detail-empty"),t=document.getElementById("detail-content");e&&(e.style.display="flex"),t&&(t.style.display="none")}async function Y(t){const n=document.getElementById("messages-container");if(n){n.innerHTML='<p class="no-data">èª­ã¿è¾¼ã¿ä¸­...</p>';try{const n=q(),o=await n.collection("messages").where("applicationId","==",t).orderBy("createdAt","asc").get(),a=[];o.forEach(e=>{a.push({id:e.id,...e.data()})}),function(t){const n=document.getElementById("messages-container");if(!n)return;if(!t||0===t.length)return void(n.innerHTML='<p class="no-data">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</p>');n.innerHTML=t.map(t=>{var n;const o=(null==(n=t.createdAt)?void 0:n.toDate)?t.createdAt.toDate():new Date(t.createdAt),a="company"===t.from;return`\n      <div class="message-item ${a?"message-company":"message-applicant"}">\n        <div class="message-header">\n          <span class="message-sender">${e(a?"ä¼šç¤¾":"å¿œå‹Ÿè€…")}</span>\n          <span class="message-date">${te(o,!0)}</span>\n        </div>\n        <div class="message-content">${e(t.content).replace(/\n/g,"<br>")}</div>\n      </div>\n    `}).join(""),n.scrollTop=n.scrollHeight}(a)}catch(o){console.error("Failed to load messages:",o),n.innerHTML='<p class="no-data">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>'}}}async function K(){var e;if(!C)return;const t=document.getElementById("new-message-text"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(!n)return void alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");const o=document.getElementById("btn-send-message");o&&(o.disabled=!0,o.textContent="é€ä¿¡ä¸­...");try{const e=q(),o=S.find(e=>e.id===C);await e.collection("messages").add({applicationId:C,companyDomain:(null==o?void 0:o.companyDomain)||k,from:"company",content:n,read:!1,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),t.value="",await Y(C)}catch(a){console.error("Failed to send message:",a),alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: "+a.message)}finally{o&&(o.disabled=!1,o.textContent="é€ä¿¡")}}function Z(t){const n=document.getElementById("detail-history");n&&(t&&0!==t.length?n.innerHTML=t.map(t=>{var n;return`\n      <div class="history-item">\n        <div class="history-date">${te((null==(n=t.date)?void 0:n.toDate)?t.date.toDate():new Date(t.date),!0)}</div>\n        <div class="history-text">${e(t.text)}</div>\n      </div>\n    `}).join(""):n.innerHTML='<p class="no-data">å¯¾å¿œå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>')}async function W(){var e,t;if(!C)return;const n=(null==(e=document.getElementById("detail-notes"))?void 0:e.value)||"",o=(null==(t=document.getElementById("detail-assignee"))?void 0:t.value)||"",a=document.getElementById("btn-save-notes");a&&(a.disabled=!0,a.textContent="ä¿å­˜ä¸­...");try{const e=q();await e.collection("applications").doc(C).update({notes:n,assignee:o,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const t=S.findIndex(e=>e.id===C);-1!==t&&(S[t].notes=n,S[t].assignee=o),J()}catch(s){console.error("Failed to save notes:",s),alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")}finally{a&&(a.disabled=!1,a.textContent="ä¿å­˜")}}async function Q(){var e;if(!C)return;const t=document.getElementById("new-history-text"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(n)try{const e=q(),o=S.find(e=>e.id===C),a=(null==o?void 0:o.history)||[];a.push({date:new Date,text:n}),await e.collection("applications").doc(C).update({history:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const s=S.findIndex(e=>e.id===C);-1!==s&&(S[s].history=a),Z(a),t.value=""}catch(o){console.error("Failed to add history:",o),alert("å±¥æ­´ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: "+o.message)}else alert("å¯¾å¿œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")}function ee(){if(0===T.length)return void alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");const e=T.map(e=>{var t,n,o,a,s,l,i;const d=(null==(t=e.createdAt)?void 0:t.toDate)?e.createdAt.toDate():new Date(e.timestamp||e.createdAt),c=e.applicantName||(null==(n=e.applicant)?void 0:n.name)||"",r=e.applicantPhone||(null==(o=e.applicant)?void 0:o.phone)||"",u=e.applicantEmail||(null==(a=e.applicant)?void 0:a.email)||"",m=(null==(s=e.applicant)?void 0:s.age)||"",p=(null==(l=e.applicant)?void 0:l.address)||"",g=(null==(i=e.applicant)?void 0:i.startDate)||"";return[te(d,!0),H[e.type]||e.type||"",c,r,u,m,p,_[g]||g,e.jobTitle||"",ne(e.source),M[e.status||"new"],e.assignee||"",(e.notes||"").replace(/"/g,'""')]}),t=[["æ—¥æ™‚","ç¨®åˆ¥","å¿œå‹Ÿè€…å","é›»è©±ç•ªå·","ãƒ¡ãƒ¼ãƒ«","å¹´é½¢","ç¾ä½æ‰€","å¸Œæœ›å‹¤å‹™é–‹å§‹æ—¥","æ±‚äººã‚¿ã‚¤ãƒˆãƒ«","æµå…¥å…ƒ","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æ‹…å½“è€…","ãƒ¡ãƒ¢"].join(","),...e.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),n=new Blob(["\ufeff"+t],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`applicants-${k||"all"}-${function(e){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}${n}${o}`}(new Date)}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o)}function te(e,t=!1){if(!e||isNaN(e.getTime()))return"-";const n=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");if(!t)return`${n}/${o}/${a}`;return`${n}/${o}/${a} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}function ne(e){if(!e||"direct"===e)return"ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹";try{const t=new URL(e).hostname;return t.includes("google")?"Googleæ¤œç´¢":t.includes("yahoo")?"Yahoo!æ¤œç´¢":t.includes("tiktok")?"TikTokåºƒå‘Š":t.includes("instagram")||t.includes("fb")||t.includes("facebook")?"Metaåºƒå‘Š":t.includes("twitter")||t.includes("x.com")?"X(Twitter)":t.includes("line")?"LINE":t}catch{return e||"ä¸æ˜"}}function oe(){var e,t,n,o,a,s,l,i,d,c,r,u,m,p,g,y,b,v,f;let h;null==(e=document.getElementById("btn-refresh"))||e.addEventListener("click",N),null==(t=document.getElementById("btn-refresh-applicants"))||t.addEventListener("click",N),null==(n=document.getElementById("btn-export-csv"))||n.addEventListener("click",ee),null==(o=document.getElementById("filter-status"))||o.addEventListener("change",R),null==(a=document.getElementById("filter-type"))||a.addEventListener("change",R),null==(s=document.getElementById("filter-search"))||s.addEventListener("input",()=>{clearTimeout(h),h=setTimeout(R,300)}),null==(l=document.getElementById("btn-close-detail"))||l.addEventListener("click",z),document.querySelectorAll(".status-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.status;t&&async function(e){if(C)try{const t=q();await t.collection("applications").doc(C).update({status:e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const n=S.findIndex(e=>e.id===C);-1!==n&&(S[n].status=e),document.querySelectorAll(".status-btn").forEach(t=>{t.classList.toggle("active",t.dataset.status===e)}),R(),V()}catch(t){console.error("Failed to update status:",t),alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ")}}(t)})}),null==(i=document.getElementById("btn-save-notes"))||i.addEventListener("click",W),null==(d=document.getElementById("btn-add-history"))||d.addEventListener("click",Q),null==(c=document.getElementById("new-history-text"))||c.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),Q())}),null==(r=document.getElementById("btn-send-message"))||r.addEventListener("click",K),null==(u=document.getElementById("new-message-text"))||u.addEventListener("keydown",e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),K())}),null==(m=document.getElementById("message-template-select"))||m.addEventListener("change",e=>{!function(e){var t;if(!e)return;const n=P[e];if(!n)return;const o=S.find(e=>e.id===C);if(!o)return;const a=o.applicantName||(null==(t=o.applicant)?void 0:t.name)||"ãŠå®¢æ§˜",s=o.jobTitle||"æ±‚äºº";let l=n.body.replace(/{applicantName}/g,a).replace(/{jobTitle}/g,s);const i=document.getElementById("new-message-text");i&&(i.value=l,i.focus());const d=document.getElementById("message-template-select");d&&(d.value="")}(e.target.value)}),null==(p=document.getElementById("btn-add-assignee"))||p.addEventListener("click",X),null==(g=document.getElementById("assignee-modal-close"))||g.addEventListener("click",F),null==(y=document.getElementById("assignee-modal-cancel"))||y.addEventListener("click",F),null==(b=document.getElementById("assignee-modal-save"))||b.addEventListener("click",O),null==(v=document.getElementById("assignee-modal"))||v.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&F()}),null==(f=document.getElementById("new-assignee-name"))||f.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),O())})}async function ae(e,t){k=e,oe(),await async function(){try{const e=q().collection("settings").doc(k||"global"),t=await e.get();A=t.exists&&t.data().assignees?t.data().assignees:[],U()}catch(e){console.error("Failed to load assignees:",e),A=[]}}(),await N()}const se="https://script.google.com/macros/s/AKfycbxj6CqSfY7jq04uDXURhewD_BAKx3csLKBpl1hdRBdNg-R-E6IuoaZGje22Gr9WYWY2/exec",le={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"},ie="rikueco_admin_session",de="rikueco_user_role",ce="rikueco_user_company",re="admin";function ue(){return sessionStorage.getItem(de)===re}function me(e){return!!ue()||sessionStorage.getItem(ce)===e}let pe=null,ge=null,ye=null,be=[],ve=null,fe=!1,he=null,Ee={},Ie={search:"",status:"",area:""},je=[],we=!1,Be=!1;function Le(e){ye=e}function $e(e){ve=e}function xe(e){fe=e}function ke(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function Se(e){return e.filter(e=>{if(Ie.search){const t=Ie.search.toLowerCase(),n=(e.title||"").toLowerCase(),o=(e.location||"").toLowerCase();if(!n.includes(t)&&!o.includes(t))return!1}if(Ie.status){const t=function(e){if("true"!==e.visible&&"TRUE"!==e.visible&&!0!==e.visible)return"draft";if(e.publishEndDate){const t=new Date(e.publishEndDate),n=new Date;if(n.setHours(0,0,0,0),t<n)return"expired"}return"published"}(e);if(t!==Ie.status)return!1}if(Ie.area){if(!(e.location||"").includes(Ie.area))return!1}return!0})}function Te(){const t=document.getElementById("jobs-list"),n=document.getElementById("jobs-count"),o=document.getElementById("jobs-filtered-count");if(document.getElementById("jobs-tbody")&&!t)return void function(){const t=document.getElementById("jobs-tbody");if(!t)return;const n=be||[];if(0===n.length)return void(t.innerHTML='<tr><td colspan="6" class="loading-cell">æ±‚äººãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>');t.innerHTML=n.map(t=>{const n=t.monthlySalary?`Â¥${Number(t.monthlySalary).toLocaleString()}`:"-",o="true"===t.visible||"TRUE"===t.visible||!0===t.visible;return`\n      <tr data-row="${t._rowIndex}">\n        <td>${e(t.id||"-")}</td>\n        <td>${e(t.title||"-")}</td>\n        <td>${e(t.location||"-")}</td>\n        <td>${n}</td>\n        <td>${o?'<span class="badge success">å…¬é–‹</span>':'<span class="badge">éå…¬é–‹</span>'}</td>\n        <td>\n          <div class="action-buttons">\n            <button class="btn-small btn-edit" data-row="${t._rowIndex}">ç·¨é›†</button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),t.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{Ae(parseInt(e.dataset.row,10))})})}();if(!t)return;const a=be||[],s=Se(a);if(n&&(n.textContent=a.length),o&&(s.length!==a.length?o.textContent=`ï¼ˆ${s.length}ä»¶è¡¨ç¤ºä¸­ï¼‰`:o.textContent=""),function(){const e=document.getElementById("job-filter-area");if(!e)return;const t=new Set;(be||[]).forEach(e=>{if(e.location){const n=e.location.match(/^(.+?[éƒ½é“åºœçœŒ])/);n?t.add(n[1]):t.add(e.location.split(/[å¸‚åŒºç”ºæ‘]/)[0])}});const n=e.value;e.innerHTML='<option value="">å…¨ã‚¨ãƒªã‚¢</option>',Array.from(t).sort().forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}),e.value=n}(),0===s.length){const e=Ie.search||Ie.status||Ie.area;return void(t.innerHTML=`<div class="job-cards-loading">${e?"æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“":"æ±‚äººãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"}</div>`)}t.innerHTML=s.map(t=>{var n;const o="true"===t.visible||"TRUE"===t.visible||!0===t.visible,a=(null==(n=t.imageUrl)?void 0:n.trim())||"",s=(t.badges?t.badges.split(",").map(e=>e.trim()).filter(e=>e):[]).map(t=>`<span class="job-card-tag${"æ€¥å‹Ÿ"===t?" urgent":""}">${e(t)}</span>`).join("");let l="-",i="";if(t.publishEndDate){const e=new Date(t.publishEndDate),n=new Date;n.setHours(0,0,0,0);const o=Math.ceil((e-n)/864e5);l=`${String(e.getFullYear()).slice(2)}/${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}`,o<0?i=" expired":o<=7&&(i=" soon")}let d="";d=o?" expired"===i?'<span class="badge expired">æ²è¼‰çµ‚äº†</span>':'<span class="badge published">å…¬é–‹ä¸­</span>':'<span class="badge draft">éå…¬é–‹</span>';const c=Ee[t.id]||{},r=c.applications||0,u=c.pv||0;return`\n      <div class="job-card-row" data-row="${t._rowIndex}">\n        <div class="job-card-image">\n          ${a?`<img src="${e(a)}" alt="" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'job-card-image-placeholder\\'>ğŸ“‹</div>'">`:'<div class="job-card-image-placeholder">ğŸ“‹</div>'}\n        </div>\n        <div class="job-card-info">\n          <div class="job-card-title">${e(t.title||"-")}</div>\n          <div class="job-card-tags">${s}</div>\n        </div>\n        <div class="job-card-type">${e(t.jobType||"-")}</div>\n        <div class="job-card-area">${e(t.location||"-")}</div>\n        <div class="job-card-deadline${i}">${l}</div>\n        <div class="job-card-stats">${r}</div>\n        <div class="job-card-stats">${u}</div>\n        <div class="job-card-status">${d}</div>\n        <div class="job-card-actions">\n          <button class="btn-icon btn-edit" data-row="${t._rowIndex}" title="ç·¨é›†">\n            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>\n          </button>\n          <button class="btn-icon btn-duplicate" data-row="${t._rowIndex}" title="è¤‡è£½">\n            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>\n          </button>\n        </div>\n      </div>\n    `}).join(""),t.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{Ae(parseInt(e.dataset.row,10))})}),t.querySelectorAll(".btn-duplicate").forEach(e=>{e.addEventListener("click",()=>{!function(e){const t=null==be?void 0:be.find(t=>t._rowIndex===e);if(!t)return void alert("æ±‚äººãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");$e(null),xe(!0);const n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};document.getElementById("job-modal-title").textContent="æ±‚äººã®è¤‡è£½",n("edit-job-title",`${t.title||""} (ã‚³ãƒ”ãƒ¼)`),n("edit-job-location",t.location),n("edit-job-salary",t.monthlySalary),n("edit-job-bonus",t.totalBonus),n("edit-job-order",t.order),n("edit-job-type",t.jobType),n("edit-job-features",t.features),n("edit-job-badges",t.badges),n("edit-job-description",t.jobDescription),n("edit-job-requirements",t.requirements),n("edit-job-benefits",t.benefits),n("edit-job-hours",t.workingHours),n("edit-job-holidays",t.holidays),n("edit-job-start-date",""),n("edit-job-end-date","");const o=document.getElementById("edit-job-visible");o&&(o.checked=!1);const a=document.getElementById("job-modal-delete");a&&(a.style.display="none");const s=document.getElementById("job-modal");s&&(s.style.display="flex")}(parseInt(e.dataset.row,10))})})}async function De(){const n=document.getElementById("jobs-list"),o=document.getElementById("jobs-tbody");if(!n&&!o)return;n&&(n.innerHTML='<div class="job-cards-loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>'),o&&(o.innerHTML='<tr><td colspan="6" class="loading-cell">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>');const a=se;try{const e=`${a}?action=getJobs&domain=${encodeURIComponent(pe)}`,l=await fetch(e);if(!l.ok)throw new Error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");const i=await l.json();if(!i.success)throw new Error(i.error||"æ±‚äººãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");if(s=i.jobs||[],be=s,i.sheetUrl&&!ye&&Le(i.sheetUrl),i.manageSheetUrl&&!ye&&Le(i.manageSheetUrl),0===be.length){n&&(n.innerHTML='<div class="job-cards-loading">æ±‚äººãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'),o&&(o.innerHTML='<tr><td colspan="6" class="loading-cell">æ±‚äººãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>');const e=document.getElementById("jobs-count");return void(e&&(e.textContent="0"))}Te(),async function(){if(!pe)return;try{const n=firebase.firestore(),o=await n.collection("applications").where("companyDomain","==",pe).get(),a={};o.docs.forEach(e=>{const t=e.data(),n=t.jobId||t.job_id||"";n&&(a[n]=(a[n]||0)+1)});let s={};try{const e=await t(pe,30);(null==e?void 0:e.jobs)?e.jobs.forEach(e=>{const t=(e.pagePath||"").match(/job=([^&]+)/);if(t){const n=decodeURIComponent(t[1]);s[n]=(s[n]||0)+(e.views||0)}e.jobId&&(s[e.jobId]=(s[e.jobId]||0)+(e.views||0))}):(null==e?void 0:e.jobStats)?e.jobStats.forEach(e=>{const t=e.jobId||e.id||"";t&&(s[t]=e.pageViews||e.views||0)}):(null==e?void 0:e.pages)&&e.pages.forEach(e=>{var t;const n=null==(t=e.pagePath)?void 0:t.match(/job=([^&]+)/);if(n){const t=decodeURIComponent(n[1]);s[t]=(s[t]||0)+(e.views||e.pageViews||0)}})}catch(e){console.warn("Analytics APIã‹ã‚‰ã®PVå–å¾—ã«å¤±æ•—:",e)}const l={};new Set([...Object.keys(a),...Object.keys(s)]).forEach(e=>{l[e]={applications:a[e]||0,pv:s[e]||0}}),Ee=l,Te()}catch(n){console.error("æ±‚äººçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:",n)}}()}catch(l){console.error("æ±‚äººãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",l);const t=`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e(l.message)}`;n&&(n.innerHTML=`<div class="job-cards-loading">${t}</div>`),o&&(o.innerHTML=`<tr><td colspan="6" class="loading-cell">${t}</td></tr>`)}var s}function Ce(){$e(null),xe(!0);const e=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t)};document.getElementById("job-modal-title").textContent="æ–°è¦æ±‚äººä½œæˆ",e("edit-job-title",""),e("edit-job-location",""),e("edit-job-salary",""),e("edit-job-bonus",""),e("edit-job-order",""),e("edit-job-type",""),e("edit-job-features",""),e("edit-job-badges",""),e("edit-job-description",""),e("edit-job-requirements",""),e("edit-job-benefits",""),e("edit-job-hours",""),e("edit-job-holidays",""),e("edit-job-start-date",""),e("edit-job-end-date","");const t=document.getElementById("edit-job-visible");t&&(t.checked=!0);const n=document.getElementById("job-modal-delete");n&&(n.style.display="none");const o=document.getElementById("job-modal");o&&(o.style.display="flex")}function Ae(e){const t=null==be?void 0:be.find(t=>t._rowIndex===e);if(!t)return void alert("æ±‚äººãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");$e(t),xe(!1);const n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};document.getElementById("job-modal-title").textContent="æ±‚äººæƒ…å ±ã®ç·¨é›†",n("edit-job-title",t.title),n("edit-job-location",t.location),n("edit-job-salary",t.monthlySalary),n("edit-job-bonus",t.totalBonus),n("edit-job-order",t.order),n("edit-job-type",t.jobType),n("edit-job-features",t.features),n("edit-job-badges",t.badges),n("edit-job-description",t.jobDescription),n("edit-job-requirements",t.requirements),n("edit-job-benefits",t.benefits),n("edit-job-hours",t.workingHours),n("edit-job-holidays",t.holidays),t.publishStartDate?n("edit-job-start-date",ke(t.publishStartDate)):n("edit-job-start-date",""),t.publishEndDate?n("edit-job-end-date",ke(t.publishEndDate)):n("edit-job-end-date","");const o=document.getElementById("edit-job-visible");o&&(o.checked="true"===t.visible||"TRUE"===t.visible||!0===t.visible);const a=document.getElementById("job-modal-delete");a&&(a.style.display="");const s=document.getElementById("job-modal");s&&(s.style.display="flex")}function Me(){const e=document.getElementById("job-modal");e&&(e.style.display="none"),$e(null),xe(!1)}async function He(){var e;if(!pe)return void alert("ä¼šç¤¾ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");const t=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},n={id:fe?"":(null==ve?void 0:ve.id)||"",title:t("edit-job-title"),location:t("edit-job-location"),monthlySalary:t("edit-job-salary"),totalBonus:t("edit-job-bonus"),order:t("edit-job-order"),jobType:t("edit-job-type"),features:t("edit-job-features"),badges:t("edit-job-badges"),jobDescription:t("edit-job-description"),requirements:t("edit-job-requirements"),benefits:t("edit-job-benefits"),workingHours:t("edit-job-hours"),holidays:t("edit-job-holidays"),publishStartDate:t("edit-job-start-date"),publishEndDate:t("edit-job-end-date"),visible:(null==(e=document.getElementById("edit-job-visible"))?void 0:e.checked)?"true":"false"};if(!n.title||!n.location)return void alert("å‹Ÿé›†ã‚¿ã‚¤ãƒˆãƒ«ã¨å‹¤å‹™åœ°ã¯å¿…é ˆã§ã™");const o=se,a=document.getElementById("job-modal-save");try{a&&(a.disabled=!0,a.textContent="ä¿å­˜ä¸­...");const e=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveJob",companyDomain:pe,job:n,rowIndex:fe?null:ve._rowIndex})))),t=`${o}?action=post&data=${encodeURIComponent(e)}`,l=await fetch(t,{method:"GET",redirect:"follow"}),i=await l.text();let d;try{d=JSON.parse(i)}catch(s){throw console.error("JSON parse error:",s),new Error(`GASã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™: ${i.substring(0,200)}`)}if(!d.success)return void alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: "+(d.error||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));Me(),await De(),alert(fe?"æ±‚äººã‚’ä½œæˆã—ã¾ã—ãŸ":"æ±‚äººæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ")}catch(l){console.error("æ±‚äººä¿å­˜ã‚¨ãƒ©ãƒ¼:",l),alert("ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: "+l.message)}finally{a&&(a.disabled=!1,a.textContent="ä¿å­˜")}}async function _e(){if(!ve||!pe)return void alert("å‰Šé™¤å¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");if(!confirm("ã“ã®æ±‚äººã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"))return;const e=se,t=document.getElementById("job-modal-delete");try{t&&(t.disabled=!0,t.textContent="å‰Šé™¤ä¸­...");const o=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteJob",companyDomain:pe,rowIndex:ve._rowIndex})))),a=`${e}?action=post&data=${encodeURIComponent(o)}`,s=await fetch(a,{method:"GET",redirect:"follow"}),l=await s.text();let i;try{i=JSON.parse(l)}catch(n){throw console.error("JSON parse error:",n),new Error("GASã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™")}if(!i.success)return void alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: "+(i.error||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));Me(),await De(),alert("æ±‚äººã‚’å‰Šé™¤ã—ã¾ã—ãŸ")}catch(o){console.error("æ±‚äººå‰Šé™¤ã‚¨ãƒ©ãƒ¼:",o),alert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: "+o.message)}finally{t&&(t.disabled=!1,t.textContent="å‰Šé™¤")}}function Pe(){return be.filter(e=>("true"===e.visible||"TRUE"===e.visible||!0===e.visible)&&e.title).map(e=>({...e,company:ge,companyDomain:pe,companyAddress:e.location||""}))}function qe(){const e=document.getElementById("feed-status");e&&(e.style.display="flex")}function Ue(){const e=document.getElementById("feed-status");e&&(e.style.display="none")}async function Oe(){const e=Pe();if(0!==e.length)try{qe();const t=n(e);o(t,`indeed-${pe}.xml`,"application/xml")}catch(t){alert("ãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "+t.message)}finally{Ue()}else alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“")}async function Xe(){const e=Pe();if(0!==e.length)try{qe();const t=a(e);o(t,`google-jobs-${pe}.json`,"application/json")}catch(t){alert("ãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "+t.message)}finally{Ue()}else alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“")}async function Fe(){const e=Pe();if(0!==e.length)try{qe();const t=s(e);o(t,`jobbox-${pe}.xml`,"application/xml")}catch(t){alert("ãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "+t.message)}finally{Ue()}else alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“")}async function Ne(){const e=Pe();if(0!==e.length)try{qe();const t=l(e);o(t,`jobs-${pe}.csv`,"text/csv;charset=utf-8")}catch(t){alert("ãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "+t.message)}finally{Ue()}else alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“")}async function Re(){const n=document.getElementById("analytics-period");let o=7;switch((null==n?void 0:n.value)||"7days"){case"7days":o=7;break;case"30days":case"last-month":o=30;break;case"month":o=(new Date).getDate();break}const a=document.getElementById("job-analytics-tbody"),s=document.getElementById("source-analytics-tbody"),l=document.getElementById("device-analytics-tbody");a&&(a.innerHTML='<tr><td colspan="5" class="loading-cell">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>'),s&&(s.innerHTML='<tr><td colspan="3" class="loading-cell">èª­ã¿è¾¼ã¿ä¸­...</td></tr>'),l&&(l.innerHTML='<tr><td colspan="3" class="loading-cell">èª­ã¿è¾¼ã¿ä¸­...</td></tr>');try{const[n,a]=await Promise.all([i(o),d(o)]);let s=null;pe&&(s=await t(pe,o));const l={overview:n,traffic:a,companyDetail:s};!function(t){const{overview:n,traffic:o,companyDetail:a}=t;if(pe&&a){const e=a.summary||{};document.getElementById("analytics-pv").textContent=(e.totalViews||0).toLocaleString(),document.getElementById("analytics-users").textContent=(e.totalUsers||0).toLocaleString(),document.getElementById("analytics-pages-per-session").textContent=e.avgJobsViewed||"-",document.getElementById("analytics-avg-time").textContent=c(e.avgSessionDuration||0)}else{document.getElementById("analytics-pv").textContent=((null==n?void 0:n.pageViews)||0).toLocaleString(),document.getElementById("analytics-users").textContent=((null==n?void 0:n.users)||0).toLocaleString();const e=(null==n?void 0:n.sessions)||0,t=(null==n?void 0:n.pageViews)||0,o=e>0?(t/e).toFixed(1):"-";document.getElementById("analytics-pages-per-session").textContent=o,document.getElementById("analytics-avg-time").textContent="-"}const s=document.getElementById("job-analytics-tbody");s&&((null==a?void 0:a.jobs)&&a.jobs.length>0?s.innerHTML=a.jobs.map(t=>`\n        <tr>\n          <td>${e(t.jobTitle||t.pagePath||"ä¸æ˜")}</td>\n          <td>${t.views||0}</td>\n          <td>${t.users||"-"}</td>\n          <td>-</td>\n          <td>-</td>\n        </tr>\n      `).join(""):s.innerHTML='\n        <tr>\n          <td colspan="5" class="loading-cell">\n            ã“ã®ä¼šç¤¾ã®æ±‚äººåˆ¥ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>\n            <small>â€» GA4ã§ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆview_job_detailï¼‰ã®è¨­å®šãŒå¿…è¦ã§ã™</small>\n          </td>\n        </tr>\n      ');const l=document.getElementById("source-analytics-tbody");if(l)if(pe&&(null==a?void 0:a.traffic)&&a.traffic.length>0){const t=a.traffic,n=t.reduce((e,t)=>e+(t.count||0),0);l.innerHTML=t.slice(0,10).map(t=>{const o=n>0?Math.round(t.count/n*100):0;return`\n          <tr>\n            <td>${e(t.channel||"ä¸æ˜")}</td>\n            <td>${t.count||0}</td>\n            <td>${o}%</td>\n          </tr>\n        `}).join("")}else{const t=(null==o?void 0:o.sources)||[];if(t.length>0){const n=t.reduce((e,t)=>e+(t.sessions||0),0);l.innerHTML=t.slice(0,10).map(t=>{const o=n>0?Math.round(t.sessions/n*100):0;return`\n            <tr>\n              <td>${e(t.source||"(direct)")}</td>\n              <td>${t.sessions||0}</td>\n              <td>${o}%</td>\n            </tr>\n          `}).join("")}else if((null==o?void 0:o.channels)&&o.channels.length>0){const t=o.channels.reduce((e,t)=>e+(t.sessions||0),0);l.innerHTML=o.channels.map(n=>{const o=t>0?Math.round(n.sessions/t*100):0;return`\n            <tr>\n              <td>${e(n.channel||"ä¸æ˜")}</td>\n              <td>${n.sessions||0}</td>\n              <td>${o}%</td>\n            </tr>\n          `}).join("")}else l.innerHTML='<tr><td colspan="3" class="loading-cell">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'}const i=document.getElementById("device-analytics-tbody");if(i){const t=pe&&(null==a?void 0:a.devices)?a.devices:(null==o?void 0:o.devices)||[];if(t.length>0){const n=t.reduce((e,t)=>e+(t.sessions||0),0);i.innerHTML=t.map(t=>{const o=n>0?Math.round(t.sessions/n*100):0;return`\n          <tr>\n            <td>${e(r(t.device))}</td>\n            <td>${t.sessions||0}</td>\n            <td>${o}%</td>\n          </tr>\n        `}).join("")}else i.innerHTML='<tr><td colspan="3" class="loading-cell">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'}const d=document.getElementById("analytics-demographics");d&&(pe&&a?(d.style.display="block",u(a.gender,a.age,{maleBarId:"gender-bar-male",femaleBarId:"gender-bar-female",malePercentId:"gender-male-percent",femalePercentId:"gender-female-percent",ageContainerId:"age-bars"})):d.style.display="none")}(l)}catch(m){console.error("ã‚¢ã‚¯ã‚»ã‚¹è§£æãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:",m),function(){document.getElementById("analytics-pv").textContent="- (æœªé€£æº)",document.getElementById("analytics-users").textContent="-",document.getElementById("analytics-pages-per-session").textContent="-",document.getElementById("analytics-avg-time").textContent="-";const e=document.getElementById("job-analytics-tbody");e&&(e.innerHTML='\n      <tr>\n        <td colspan="5" class="loading-cell">\n          ã‚¢ã‚¯ã‚»ã‚¹è§£æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>\n          Google Analyticsã¨ã®é€£æºã‚’è¨­å®šã™ã‚‹ã¨ã€è©³ç´°ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ã€‚\n        </td>\n      </tr>\n    ');const t=document.getElementById("source-analytics-tbody");t&&(t.innerHTML='<tr><td colspan="3" class="loading-cell">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>');const n=document.getElementById("device-analytics-tbody");n&&(n.innerHTML='<tr><td colspan="3" class="loading-cell">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>')}()}}async function Ve(e,t){if(!pe)return[];try{const n=firebase.firestore();return(await n.collection("applications").where("companyDomain","==",pe).where("createdAt",">=",e).where("createdAt","<=",t).orderBy("createdAt","desc").get()).docs.map(e=>{var t,n;return{id:e.id,...e.data(),createdAt:(null==(n=null==(t=e.data().createdAt)?void 0:t.toDate)?void 0:n.call(t))||new Date(e.data().createdAt)}})}catch(n){return console.error("å¿œå‹Ÿãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:",n),[]}}async function Je(e,t){const n=t.getTime()-e.getTime(),o=new Date(e.getTime()-1),a=new Date(o.getTime()-n);return await Ve(a,o)}function Ge(e){const t={new:"æ–°è¦",contacted:"é€£çµ¡æ¸ˆ",interviewing:"é¢æ¥ä¸­",hired:"æ¡ç”¨",rejected:"ä¸æ¡ç”¨",withdrawn:"è¾é€€"},n={};Object.values(t).forEach(e=>{n[e]=0}),e.forEach(e=>{const o=e.status||"new",a=t[o]||"æ–°è¦";n[a]=(n[a]||0)+1});const o=e.length;return Object.entries(n).map(([e,t])=>({status:e,count:t,percentage:o>0?Math.round(t/o*100):0}))}function ze(e){const t={google:"Googleæ¤œç´¢",indeed:"Indeed",jobbox:"æ±‚äººãƒœãƒƒã‚¯ã‚¹",direct:"ç›´æ¥æµå…¥",line:"LINE",other:"ãã®ä»–"},n={};e.forEach(e=>{let o=e.source||e.utmSource||"other";o=o.includes("google")?"google":o.includes("indeed")?"indeed":o.includes("jobbox")||o.includes("stanby")?"jobbox":o.includes("line")?"line":"direct"===o||"(direct)"===o?"direct":"other";const a=t[o]||"ãã®ä»–";n[a]=(n[a]||0)+1});const o=e.length;return Object.entries(n).map(([e,t])=>({source:e,count:t,percentage:o>0?Math.round(t/o*100):0})).sort((e,t)=>t.count-e.count)}function Ye(e){const t={};return e.forEach(e=>{const n=e.assignee||"æœªå‰²å½“";t[n]||(t[n]={assignee:n,handled:0,pending:0});"new"===(e.status||"new")?t[n].pending++:t[n].handled++}),Object.values(t).sort((e,t)=>t.handled-e.handled)}function Ke(t){const{applications:n,comparison:o,period:a}=t,s=n.length,l=o.length,i=l>0?Math.round((s-l)/l*100):0,d=i>=0?`+${i}%`:`${i}%`,c=n.filter(e=>"hired"===e.status).length,r=n.filter(e=>"new"===e.status||"contacted"===e.status).length;document.getElementById("summary-total").textContent=s,document.getElementById("summary-change").textContent=d,document.getElementById("summary-change").className="summary-value "+(i>=0?"positive":"negative"),document.getElementById("summary-hired").textContent=c,document.getElementById("summary-pending").textContent=r;const u=Ge(n);document.getElementById("status-breakdown").innerHTML=u.map(t=>`\n    <tr>\n      <td>${e(t.status)}</td>\n      <td>${t.count}</td>\n      <td>${t.percentage}%</td>\n    </tr>\n  `).join("");const m=function(e){const t={};return e.forEach(e=>{const n=e.jobId||"unknown",o=e.jobTitle||"ä¸æ˜ãªæ±‚äºº";t[n]||(t[n]={jobId:n,jobTitle:o,count:0}),t[n].count++}),Object.values(t).sort((e,t)=>t.count-e.count).slice(0,5)}(n),p=document.getElementById("job-performance");0===m.length?p.innerHTML='<tr><td colspan="4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>':p.innerHTML=m.map(t=>{const n=be.find(e=>e.id===t.jobId),o=(null==n?void 0:n.pageViews)||"-",a="-"!==o&&o>0?(t.count/o*100).toFixed(1)+"%":"-";return`\n        <tr>\n          <td>${e(t.jobTitle)}</td>\n          <td>${t.count}</td>\n          <td>${o}</td>\n          <td>${a}</td>\n        </tr>\n      `}).join("");const g=ze(n),y=document.getElementById("source-breakdown");0===g.length?y.innerHTML='<tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>':y.innerHTML=g.map(t=>`\n      <tr>\n        <td>${e(t.source)}</td>\n        <td>${t.count}</td>\n        <td>${t.percentage}%</td>\n      </tr>\n    `).join("");const b=Ye(n),v=document.getElementById("assignee-breakdown");0===b.length?v.innerHTML='<tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>':v.innerHTML=b.map(t=>`\n      <tr>\n        <td>${e(t.assignee)}</td>\n        <td>${t.handled}</td>\n        <td>${t.pending}</td>\n      </tr>\n    `).join(""),document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="block",document.getElementById("report-actions").style.display="flex"}async function Ze(){const e=document.getElementById("report-period").value;let t,n;if("custom"===e){const e=document.getElementById("report-from"),o=document.getElementById("report-to");if(!e.value||!o.value)return void alert("é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„");t=new Date(e.value),t.setHours(0,0,0,0),n=new Date(o.value),n.setHours(23,59,59,999)}else{const o=function(e){const t=new Date;let n,o;switch(e){case"week":{const e=t.getDay();n=new Date(t),n.setDate(t.getDate()-e),n.setHours(0,0,0,0),o=new Date(t),o.setHours(23,59,59,999);break}case"last-week":{const e=t.getDay();o=new Date(t),o.setDate(t.getDate()-e-1),o.setHours(23,59,59,999),n=new Date(o),n.setDate(o.getDate()-6),n.setHours(0,0,0,0);break}case"month":n=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t),o.setHours(23,59,59,999);break;case"last-month":n=new Date(t.getFullYear(),t.getMonth()-1,1),o=new Date(t.getFullYear(),t.getMonth(),0,23,59,59,999);break;default:n=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t)}return{start:n,end:o}}(e);t=o.start,n=o.end}document.getElementById("report-loading").style.display="flex",document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="none",document.getElementById("report-actions").style.display="none";try{const[e,o]=await Promise.all([Ve(t,n),Je(t,n)]);he={applications:e,comparison:o,period:{start:t,end:n}},Ke(he)}catch(o){console.error("ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:",o),alert("ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: "+o.message)}finally{document.getElementById("report-loading").style.display="none"}}function We(){if(!he||!he.applications.length)return void alert("ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");const{applications:e,period:t}=he,n=[["å¿œå‹Ÿæ—¥æ™‚","æ±‚äººã‚¿ã‚¤ãƒˆãƒ«","æ°å","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æµå…¥å…ƒ","æ‹…å½“è€…"],...e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""])].map(e=>e.map(e=>`"${String(e).replace(/"/g,'""')}"`).join(",")).join("\n"),o=new Blob(["\ufeff"+n],{type:"text/csv;charset=utf-8"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a;const l=t.start.toISOString().split("T")[0],i=t.end.toISOString().split("T")[0];s.download=`report-${pe}-${l}-${i}.csv`,s.click(),URL.revokeObjectURL(a)}function Qe(){if(!he||!he.applications.length)return void alert("ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");if("undefined"==typeof XLSX)return void alert("Excelãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");const{applications:e,period:t}=he,n=XLSX.utils.book_new(),o=[["ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“",`${t.start.toLocaleDateString("ja-JP")} ã€œ ${t.end.toLocaleDateString("ja-JP")}`],["ä¼šç¤¾",ge],[""],["ç·å¿œå‹Ÿæ•°",e.length],["æ¡ç”¨æ•°",e.filter(e=>"hired"===e.status).length],["å¯¾å¿œä¸­",e.filter(e=>"new"===e.status||"contacted"===e.status).length]],a=XLSX.utils.aoa_to_sheet(o);XLSX.utils.book_append_sheet(n,a,"ã‚µãƒãƒªãƒ¼");const s=e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.phone||"",e.email||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""]),l=XLSX.utils.aoa_to_sheet([["å¿œå‹Ÿæ—¥æ™‚","æ±‚äººã‚¿ã‚¤ãƒˆãƒ«","æ°å","é›»è©±ç•ªå·","ãƒ¡ãƒ¼ãƒ«","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æµå…¥å…ƒ","æ‹…å½“è€…"],...s]);XLSX.utils.book_append_sheet(n,l,"å¿œå‹Ÿä¸€è¦§");const i=Ge(e).map(e=>[e.status,e.count,`${e.percentage}%`]),d=XLSX.utils.aoa_to_sheet([["ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","ä»¶æ•°","å‰²åˆ"],...i]);XLSX.utils.book_append_sheet(n,d,"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥");const c=ze(e).map(e=>[e.source,e.count,`${e.percentage}%`]),r=XLSX.utils.aoa_to_sheet([["æµå…¥å…ƒ","ä»¶æ•°","å‰²åˆ"],...c]);XLSX.utils.book_append_sheet(n,r,"æµå…¥å…ƒåˆ¥");const u=Ye(e).map(e=>[e.assignee,e.handled,e.pending]),m=XLSX.utils.aoa_to_sheet([["æ‹…å½“è€…","å¯¾å¿œæ¸ˆ","æœªå¯¾å¿œ"],...u]);XLSX.utils.book_append_sheet(n,m,"æ‹…å½“è€…åˆ¥");const p=t.start.toISOString().split("T")[0],g=t.end.toISOString().split("T")[0];XLSX.writeFile(n,`report-${pe}-${p}-${g}.xlsx`)}function et(){console.log("[LPè¨­å®š] initCompanyLPSettings é–‹å§‹"),m(p,{getCompanyDomain:()=>pe}),g(),y(),b();const e=document.getElementById("btn-save-lp-settings");e&&e.addEventListener("click",()=>{v()});const t=document.getElementById("btn-reset-lp-settings");t&&t.addEventListener("click",()=>{confirm("LPè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")&&at()});const n=document.getElementById("btn-toggle-preview");n&&n.addEventListener("click",f);const o=document.getElementById("btn-close-preview");o&&o.addEventListener("click",h);const a=document.getElementById("lp-back-to-jobs");a&&a.addEventListener("click",()=>{const e=document.getElementById("lp-job-select-group"),t=document.getElementById("lp-editor");e&&(e.style.display="block"),t&&(t.style.display="none"),tt("job")}),document.querySelectorAll(".preview-device-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".preview-device-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.dataset.device,n=document.querySelector(".lp-preview-frame-wrapper");n&&n.setAttribute("data-device",t)})}),["lp-hero-title","lp-hero-subtitle","lp-hero-image","lp-cta-text","lp-faq","lp-tiktok-pixel","lp-google-ads-id","lp-google-ads-label","lp-ogp-title","lp-ogp-description","lp-ogp-image","lp-video-url"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>E())}),document.querySelectorAll('input[name="design-pattern"]').forEach(e=>{e.addEventListener("change",()=>E())}),document.querySelectorAll(".collapsible-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target,n=document.getElementById(t),o=e.querySelector(".collapse-icon");if(n){const e="none"!==n.style.display;n.style.display=e?"none":"block",o&&(o.textContent=e?"â–¶":"â–¼")}})}),Be=!0}function tt(e){const t=document.querySelectorAll(".lp-step"),n=["job","edit"],o=n.indexOf(e);t.forEach(e=>{const t=e.dataset.step,a=n.indexOf(t);e.classList.remove("active","completed"),a<o?e.classList.add("completed"):a===o&&e.classList.add("active")})}async function nt(){Be||et(),console.log("[LPè¨­å®š] loadCompanyLPSettings é–‹å§‹, companyDomain:",pe),await async function(){const t=document.getElementById("lp-job-grid"),n=document.getElementById("lp-job-select");t&&(t.innerHTML='<div class="lp-loading-placeholder">æ±‚äººã‚’èª­ã¿è¾¼ã¿ä¸­...</div>');try{if(be.length>0){const t=be.map(e=>({id:`${pe}_${e.jobId||e.id}`,jobId:e.jobId||e.id,title:e.title||e.å‹Ÿé›†ã‚¿ã‚¤ãƒˆãƒ«||"(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)",company:ge,companyDomain:pe,sheetUrl:ye,rawData:e}));if(je=t,function(t){const n=document.getElementById("lp-job-grid");if(!n)return;if(0===t.length)return void(n.innerHTML='<div class="lp-no-results"><p>æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“</p></div>');n.innerHTML=t.map(t=>`\n    <div class="lp-job-card" data-job-id="${e(t.id)}">\n      <div class="lp-job-title">${e(t.title)}</div>\n      <div class="lp-job-id">ID: ${e(t.jobId)}</div>\n      <div class="lp-job-actions">\n        <button type="button" class="lp-job-action-btn primary lp-select-job-btn">LPè¨­å®šã‚’ç·¨é›†</button>\n        <a href="lp.html?j=${encodeURIComponent(t.id)}" target="_blank" class="lp-job-action-btn secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>\n      </div>\n    </div>\n  `).join(""),n.querySelectorAll(".lp-select-job-btn").forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const o=e.closest(".lp-job-card"),a=o.dataset.jobId;n.querySelectorAll(".lp-job-card").forEach(e=>e.classList.remove("selected")),o.classList.add("selected");const s=document.getElementById("lp-job-select");s&&(s.value=a),je.find(e=>e.id===a),await async function(e){console.log("[LPè¨­å®š] loadLPSettingsForJob:",e);const n=document.getElementById("lp-preview-btn"),o=document.getElementById("lp-edit-mode-btn");if(!e)return;n&&(n.href=`lp.html?j=${encodeURIComponent(e)}`);o&&(o.href=`lp.html?j=${encodeURIComponent(e)}&edit`);w();const a=document.querySelector('input[name="design-pattern"][value="standard"]');a&&(a.checked=!0);try{if(await async function(){if(ye)return ye;try{let e=B();e&&0!==e.length||(await L(),e=B());const t=e.find(e=>e.companyDomain===pe);if(t){const e=t.manageSheetUrl||t.jobsSheet||null;Le(e),console.log("[LPè¨­å®š] company-managerã‹ã‚‰å–å¾—ã—ãŸsheetUrl:",e)}else console.warn("[LPè¨­å®š] ä¼šç¤¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:",pe)}catch(t){console.warn("[LPè¨­å®š] ä¼šç¤¾æƒ…å ±ã®å–å¾—ã«å¤±æ•—:",t)}return ye}(),!ye)return console.log("[LPè¨­å®š] ç®¡ç†ã‚·ãƒ¼ãƒˆURLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),void at();let n=null;const o=ye.match(/\/d\/([a-zA-Z0-9_-]+)/);if(o?n=o[1]:/^[a-zA-Z0-9_-]+$/.test(ye)&&(n=ye),!n)return console.log("[LPè¨­å®š] ç®¡ç†ã‚·ãƒ¼ãƒˆIDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“"),void at();const a=Date.now(),s=`https://docs.google.com/spreadsheets/d/${n}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent("LPè¨­å®š")}&_t=${a}`,l=await fetch(s,{cache:"no-store"});if(l.ok){const t=function(e,t){const n=function(e){const t=[];let n="",o=!1;for(let a=0;a<e.length;a++){const s=e[a];if('"'===s)'"'===e[a+1]?(n+='""',a++):(o=!o,n+=s);else if("\n"!==s||o){if("\r"===s)continue;n+=s}else n.trim()&&t.push(n),n=""}n.trim()&&t.push(n);return t}(e),o=$(n[0]||"");for(let a=1;a<n.length;a++){if(!n[a].trim())continue;const e=$(n[a]),s={};o.forEach((t,n)=>{const o=t.replace(/"/g,"").trim();s[o]=e[n]||""});if((s.jobId||s["æ±‚äººID"]||"")===t){const e={heroTitle:s.heroTitle||s["ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«"]||"",heroSubtitle:s.heroSubtitle||s["ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«"]||"",heroImage:s.heroImage||s["ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒ"]||"",ctaText:s.ctaText||s["CTAãƒ†ã‚­ã‚¹ãƒˆ"]||"",faq:s.faq||s.FAQ||"",designPattern:s.designPattern||s["ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³"]||"",layoutStyle:s.layoutStyle||s["ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¹ã‚¿ã‚¤ãƒ«"]||"default",sectionOrder:s.sectionOrder||s["ã‚»ã‚¯ã‚·ãƒ§ãƒ³é †åº"]||"",sectionVisibility:s.sectionVisibility||s["ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º"]||"",tiktokPixelId:s.tiktokPixelId||s["TikTok Pixel ID"]||"",googleAdsId:s.googleAdsId||s["Google Ads ID"]||"",googleAdsLabel:s.googleAdsLabel||s["Google Ads ãƒ©ãƒ™ãƒ«"]||"",ogpTitle:s.ogpTitle||s["OGPã‚¿ã‚¤ãƒˆãƒ«"]||"",ogpDescription:s.ogpDescription||s["OGPèª¬æ˜æ–‡"]||"",ogpImage:s.ogpImage||s["OGPç”»åƒ"]||"",showVideoButton:s.showVideoButton||s["å‹•ç”»ãƒœã‚¿ãƒ³è¡¨ç¤º"]||"",videoUrl:s.videoUrl||s["å‹•ç”»URL"]||"",lpContent:s.lpContent||s["LPæ§‹æˆ"]||""};for(let t=1;t<=6;t++)e[`pointTitle${t}`]=s[`pointTitle${t}`]||s[`ãƒã‚¤ãƒ³ãƒˆ${t}ã‚¿ã‚¤ãƒˆãƒ«`]||"",e[`pointDesc${t}`]=s[`pointDesc${t}`]||s[`ãƒã‚¤ãƒ³ãƒˆ${t}èª¬æ˜`]||"";return e}}return null}(await l.text(),e);if(t){ot("lp-hero-title",t.heroTitle),ot("lp-hero-subtitle",t.heroSubtitle),ot("lp-hero-image",t.heroImage),ot("lp-cta-text",t.ctaText||"ä»Šã™ãå¿œå‹Ÿã™ã‚‹"),ot("lp-faq",t.faq),ot("lp-tiktok-pixel",t.tiktokPixelId),ot("lp-google-ads-id",t.googleAdsId),ot("lp-google-ads-label",t.googleAdsLabel),ot("lp-ogp-title",t.ogpTitle),ot("lp-ogp-description",t.ogpDescription),ot("lp-ogp-image",t.ogpImage);const e=document.getElementById("lp-show-video-button"),n=document.getElementById("video-url-group");if(e&&(e.checked="true"===String(t.showVideoButton).toLowerCase()||!0===t.showVideoButton,n&&(n.style.display=e.checked?"block":"none")),ot("lp-video-url",t.videoUrl),t.designPattern){const e=document.querySelector(`input[name="design-pattern"][value="${t.designPattern}"]`);e&&(e.checked=!0)}return I(t.heroImage||""),void j(t)}}}catch(t){console.log("[LPè¨­å®š] LPè¨­å®šã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:",t)}at()}(a);const l=document.getElementById("lp-job-select-group"),i=document.getElementById("lp-editor");l&&(l.style.display="none"),i&&(i.style.display="block"),tt("edit")})})}(t),n){let o='<option value="">-- æ±‚äººã‚’é¸æŠ --</option>';for(const n of t)o+=`<option value="${e(n.id)}">${e(n.title)}</option>`;n.innerHTML=o}}else t&&(t.innerHTML='<div class="lp-no-results"><p>æ±‚äººãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšæ±‚äººã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p></div>')}catch(o){console.error("[LPè¨­å®š] æ±‚äººèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",o),t&&(t.innerHTML='<div class="lp-no-results"><p>æ±‚äººãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p></div>')}}()}function ot(e,t){const n=document.getElementById(e);n&&(n.value=t||"")}function at(){["lp-hero-title","lp-hero-subtitle","lp-hero-image","lp-faq","lp-tiktok-pixel","lp-google-ads-id","lp-google-ads-label","lp-ogp-title","lp-ogp-description","lp-ogp-image","lp-video-url"].forEach(e=>ot(e,"")),ot("lp-cta-text","ä»Šã™ãå¿œå‹Ÿã™ã‚‹");const e=document.getElementById("lp-show-video-button"),t=document.getElementById("video-url-group");e&&(e.checked=!1),t&&(t.style.display="none");const n=document.querySelector('input[name="design-pattern"][value="standard"]');n&&(n.checked=!0),I(""),j({})}function st(){const e=document.getElementById("password-change-form");e&&e.addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("current-password").value,o=document.getElementById("new-password").value,a=document.getElementById("confirm-password").value,s=document.getElementById("password-change-error"),l=document.getElementById("password-change-success");if(s.style.display="none",l.style.display="none",o!==a)return s.textContent="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“",void(s.style.display="block");if(o.length<8)return s.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„",void(s.style.display="block");try{const t=await async function(e,t){if("undefined"==typeof firebase||!firebase.firestore)return{success:!1,error:"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“"};const n=firebase.firestore(),o=sessionStorage.getItem("company_user_id");if(!o)try{const o=await n.collection("company_users").where("companyDomain","==",pe).limit(1).get();if(o.empty)return{success:!1,error:"ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"};const a=o.docs[0];return a.data().password!==e?{success:!1,error:"ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"}:(await n.collection("company_users").doc(a.id).update({password:t,passwordChangedAt:firebase.firestore.FieldValue.serverTimestamp()}),{success:!0})}catch(a){return console.error("Password change error:",a),{success:!1,error:a.message}}try{const a=await n.collection("company_users").where("username","==",o).limit(1).get();if(a.empty)return{success:!1,error:"ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"};const s=a.docs[0];return s.data().password!==e?{success:!1,error:"ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"}:(await n.collection("company_users").doc(s.id).update({password:t,passwordChangedAt:firebase.firestore.FieldValue.serverTimestamp()}),{success:!0})}catch(a){return console.error("Password change error:",a),{success:!1,error:a.message}}}(n,o);t.success?(l.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ",l.style.display="block",e.reset()):(s.textContent=t.error,s.style.display="block")}catch(i){console.error("Password change error:",i),s.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ",s.style.display="block"}})}function lt(){const t=document.querySelector(".feed-section");t&&(t.style.display="none");const n=document.querySelector('.sidebar-nav a[data-section="back"]');n&&(n.style.display="none");const o=document.getElementById("btn-back-admin");o&&(o.style.display="none");const a=document.getElementById("btn-logout");a&&(a.style.display="block",a.addEventListener("click",()=>{sessionStorage.removeItem(ie),sessionStorage.removeItem(de),sessionStorage.removeItem(ce),sessionStorage.removeItem("auth_method"),sessionStorage.removeItem("company_user_id"),"undefined"!=typeof firebase&&firebase.auth&&firebase.auth().signOut(),window.location.href="admin.html"}));const s=document.getElementById("nav-settings-item");s&&(s.style.display="block");const l=document.getElementById("nav-lp-settings-item");l&&(l.style.display="block"),et(),st();const i=document.getElementById("company-name");i&&(i.innerHTML=`${e(ge)} <span class="badge info">ä¼šç¤¾ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>`)}function it(e){document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".sidebar-nav li").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(`section-${e}`);t&&t.classList.add("active"),document.querySelectorAll(".sidebar-nav a").forEach(t=>{t.dataset.section===e&&t.closest("li").classList.add("active")});const n=document.getElementById("page-title"),o=document.querySelector(".header-actions");"jobs"===e?(n&&(n.textContent=`${ge} ã®æ±‚äººä¸€è¦§`),o&&(o.style.display="flex")):"analytics"===e?(n&&(n.textContent="ã‚¢ã‚¯ã‚»ã‚¹è§£æ"),o&&(o.style.display="none")):"reports"===e?(n&&(n.textContent="å¿œå‹Ÿãƒ¬ãƒãƒ¼ãƒˆ"),o&&(o.style.display="none")):"applicants"===e?(n&&(n.textContent="å¿œå‹Ÿè€…ç®¡ç†"),o&&(o.style.display="none"),we||(we=!0,ae(pe))):"lp-settings"===e?(n&&(n.textContent="LPè¨­å®š"),o&&(o.style.display="none"),nt()):"settings"===e&&(n&&(n.textContent="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š"),o&&(o.style.display="none"))}function dt(){var e,t,n,o,a,s,l,i,d,c,r,u,m,p,g,y;null==(e=document.getElementById("btn-add-job"))||e.addEventListener("click",Ce),null==(t=document.getElementById("btn-refresh"))||t.addEventListener("click",De),null==(n=document.getElementById("job-modal-close"))||n.addEventListener("click",Me),null==(o=document.getElementById("job-modal-cancel"))||o.addEventListener("click",Me),null==(a=document.getElementById("job-modal-delete"))||a.addEventListener("click",_e),null==(s=document.getElementById("job-edit-form"))||s.addEventListener("submit",e=>{e.preventDefault(),He()}),null==(l=document.getElementById("job-modal"))||l.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&Me()}),null==(i=document.getElementById("btn-download-indeed"))||i.addEventListener("click",Oe),null==(d=document.getElementById("btn-download-google"))||d.addEventListener("click",Xe),null==(c=document.getElementById("btn-download-jobbox"))||c.addEventListener("click",Fe),null==(r=document.getElementById("btn-download-csv"))||r.addEventListener("click",Ne);const b=document.getElementById("job-search"),v=document.getElementById("job-filter-status"),f=document.getElementById("job-filter-area"),h=document.getElementById("btn-clear-filters");if(b){let e;b.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(()=>{Ie.search=b.value.trim(),Te()},300)})}v&&v.addEventListener("change",()=>{Ie.status=v.value,Te()}),f&&f.addEventListener("change",()=>{Ie.area=f.value,Te()}),h&&h.addEventListener("click",()=>{Ie={search:"",status:"",area:""},b&&(b.value=""),v&&(v.value=""),f&&(f.value=""),Te()}),document.querySelectorAll(".sidebar-nav a[data-section]").forEach(e=>{e.addEventListener("click",t=>{const n=e.dataset.section;n&&"back"!==n&&(t.preventDefault(),it(n))})}),null==(u=document.getElementById("report-period"))||u.addEventListener("change",e=>{const t=document.getElementById("report-custom-dates");t&&(t.style.display="custom"===e.target.value?"flex":"none")}),null==(m=document.getElementById("btn-generate-report"))||m.addEventListener("click",Ze),null==(p=document.getElementById("btn-report-csv"))||p.addEventListener("click",We),null==(g=document.getElementById("btn-report-excel"))||g.addEventListener("click",Qe),null==(y=document.getElementById("btn-load-analytics"))||y.addEventListener("click",Re)}async function ct(){if("undefined"==typeof firebase?console.warn("[JobManager] Firebase not loaded"):firebase.apps.length||firebase.initializeApp(le),!sessionStorage.getItem(ie))return void(window.location.href="admin.html");const e=new URLSearchParams(window.location.search),t=e.get("domain");!function(e,t,n){pe=e,ge=t,ye=n}(t,e.get("company")||t,e.get("sheetUrl"));const n=e.get("section");if(n&&["analytics","reports","applicants"].includes(n)&&it(n),!pe)return alert("ä¼šç¤¾ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"),void(window.location.href="admin.html");if(!me(pe))return alert("ã“ã®ä¼šç¤¾ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"),void(window.location.href="admin.html");ue()||lt();const o=document.getElementById("page-title");o&&!n&&(o.textContent=`${ge} ã®æ±‚äººä¸€è¦§`);const a=document.getElementById("company-name");a&&(a.textContent=ge);const s=document.getElementById("btn-open-sheet");ye&&s?(s.href=ye,s.style.display=""):s&&(s.style.display="none"),dt(),await De()}"undefined"!=typeof window&&(window.JobManager={init:ct,loadJobsData:De,showJobModal:Ce,editJob:Ae,closeJobModal:Me,saveJobData:He,deleteJob:_e}),document.addEventListener("DOMContentLoaded",()=>{ct()});
