const AdminDashboard={config:{credentials:{username:"admin",password:"rikueco2025"},sessionKey:"rikueco_admin_session",gaPropertyId:"G-E1XC94EG05",gaApiKey:"AIzaSyAIC2WGg5dnvMh6TO4sivpbk4HtpYw4tbo",apiEndpoint:""},init(){this.checkSession(),this.bindEvents()},checkSession(){sessionStorage.getItem(this.config.sessionKey)?(this.showDashboard(),this.loadDashboardData()):this.showLogin()},bindEvents(){document.getElementById("login-form").addEventListener("submit",e=>{e.preventDefault(),this.handleLogin()}),document.getElementById("logout-btn").addEventListener("click",()=>{this.handleLogout()}),document.querySelectorAll(".sidebar-nav a").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();const t=e.currentTarget.dataset.section;this.switchSection(t)})}),document.getElementById("date-range").addEventListener("change",()=>{this.loadDashboardData()}),document.getElementById("refresh-btn").addEventListener("click",()=>{this.loadDashboardData()}),document.getElementById("company-search").addEventListener("input",e=>{this.filterCompanies(e.target.value)}),document.getElementById("sort-by").addEventListener("change",()=>{this.sortCompanies()}),document.getElementById("save-settings").addEventListener("click",()=>{this.saveSettings()}),document.getElementById("change-password").addEventListener("click",()=>{this.changePassword()})},handleLogin(){const e=document.getElementById("username").value,t=document.getElementById("password").value,a=document.getElementById("login-error");e===this.config.credentials.username&&t===this.config.credentials.password?(sessionStorage.setItem(this.config.sessionKey,"authenticated"),a.style.display="none",this.showDashboard(),this.loadDashboardData()):(a.textContent="ユーザー名またはパスワードが正しくありません",a.style.display="block")},handleLogout(){sessionStorage.removeItem(this.config.sessionKey),this.showLogin()},showLogin(){document.getElementById("login-screen").style.display="flex",document.getElementById("admin-dashboard").style.display="none"},showDashboard(){document.getElementById("login-screen").style.display="none",document.getElementById("admin-dashboard").style.display="flex"},switchSection(e){document.querySelectorAll(".sidebar-nav li").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-section="${e}"]`).parentElement.classList.add("active"),document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")}),document.getElementById(`section-${e}`).classList.add("active");document.getElementById("page-title").textContent={overview:"概要",companies:"企業別データ",applications:"応募データ",settings:"設定"}[e]},async loadDashboardData(){const e=document.getElementById("date-range").value,t=localStorage.getItem("api_endpoint")||this.config.apiEndpoint;t?await this.fetchGAData(e,t):this.loadMockData(e)},async fetchGAData(e,t){try{this.showLoading(!0);const a=await fetch(`${t}?days=${e}`);if(!a.ok)throw new Error(`API Error: ${a.status}`);const n=await a.json();if(!n.success)throw new Error(n.error||"Unknown error");const s=n.data;s.overview&&(document.getElementById("total-pageviews").textContent=this.formatNumber(s.overview.pageViews),document.getElementById("total-users").textContent=this.formatNumber(s.overview.users),document.getElementById("company-views").textContent=this.formatNumber(s.overview.companyViews),document.getElementById("apply-clicks").textContent=this.formatNumber(s.overview.applyClicks)),s.daily&&this.renderDailyChartFromAPI(s.daily),s.companies&&(this.companyData=s.companies.map(e=>({name:e.name,domain:e.domain,views:e.views,clicks:e.clicks,pattern:"standard"})),this.renderOverviewTable(),this.renderCompanyCards()),s.applications&&this.renderApplicationsDataFromAPI(s.applications),this.showLoading(!1)}catch(t){console.error("API fetch error:",t),this.showLoading(!1),this.loadMockData(e)}},showLoading(e){const t=document.getElementById("refresh-btn");t&&(t.textContent=e?"読み込み中...":"更新",t.disabled=e)},renderDailyChartFromAPI(e){const t=document.getElementById("daily-chart");if(!e||0===e.length)return void(t.innerHTML="<p>データがありません</p>");const a=Math.max(...e.map(e=>e.views));let n='<div class="simple-chart">';n+='<div class="chart-bars">';(e.length>30?e.filter((e,t)=>t%3==0):e).forEach(e=>{const t=a>0?e.views/a*100:0;n+=`\n        <div class="chart-bar-wrapper">\n          <div class="chart-bar" style="height: ${t}%">\n            <span class="bar-value">${e.views}</span>\n          </div>\n          <span class="bar-label">${e.date}</span>\n        </div>\n      `}),n+="</div></div>",t.innerHTML=n},renderApplicationsDataFromAPI(e){const t=document.querySelector("#applications-table tbody"),a={apply:"応募ボタン",line:"LINE相談",consult:"相談フォーム"};e&&0!==e.length?t.innerHTML=e.map(e=>`\n      <tr>\n        <td>${e.date}</td>\n        <td>${this.escapeHtml(e.company)}</td>\n        <td><span class="type-badge ${e.type}">${a[e.type]||e.type}</span></td>\n        <td>${e.source}</td>\n      </tr>\n    `).join(""):t.innerHTML='<tr><td colspan="4" class="loading-cell">応募データがありません</td></tr>'},loadMockData(e){const t=150*e,a=80*e,n=45*e,s=12*e;document.getElementById("total-pageviews").textContent=this.formatNumber(t+Math.floor(500*Math.random())),document.getElementById("total-users").textContent=this.formatNumber(a+Math.floor(200*Math.random())),document.getElementById("company-views").textContent=this.formatNumber(n+Math.floor(100*Math.random())),document.getElementById("apply-clicks").textContent=this.formatNumber(s+Math.floor(30*Math.random())),this.renderDailyChart(e),this.renderCompanyData(),this.renderApplicationsData()},renderDailyChart(e){const t=document.getElementById("daily-chart"),a=[],n=new Date;for(let t=e-1;t>=0;t--){const e=new Date(n);e.setDate(e.getDate()-t),a.push({date:`${e.getMonth()+1}/${e.getDate()}`,views:Math.floor(100+200*Math.random()),clicks:Math.floor(5+20*Math.random())})}const s=Math.max(...a.map(e=>e.views));let o='<div class="simple-chart">';o+='<div class="chart-bars">';(e>30?a.filter((e,t)=>t%3==0):a).forEach(e=>{const t=e.views/s*100;o+=`\n        <div class="chart-bar-wrapper">\n          <div class="chart-bar" style="height: ${t}%">\n            <span class="bar-value">${e.views}</span>\n          </div>\n          <span class="bar-label">${e.date}</span>\n        </div>\n      `}),o+="</div></div>",t.innerHTML=o},renderCompanyData(){this.companyData=[{name:"トヨタ自動車",domain:"toyota",views:1250,clicks:89,pattern:"modern"},{name:"日産自動車",domain:"nissan",views:980,clicks:67,pattern:"classic"},{name:"本田技研工業",domain:"honda",views:856,clicks:54,pattern:"colorful"},{name:"スバル",domain:"subaru",views:654,clicks:43,pattern:"minimal"},{name:"マツダ",domain:"mazda",views:523,clicks:32,pattern:"standard"},{name:"スズキ",domain:"suzuki",views:412,clicks:28,pattern:"modern"},{name:"ダイハツ",domain:"daihatsu",views:387,clicks:24,pattern:"classic"},{name:"三菱自動車",domain:"mitsubishi",views:298,clicks:18,pattern:"standard"}],this.renderOverviewTable(),this.renderCompanyCards()},renderOverviewTable(){const e=document.querySelector("#overview-company-table tbody"),t=[...this.companyData].sort((e,t)=>t.views-e.views);e.innerHTML=t.slice(0,5).map((e,t)=>{const a=(e.clicks/e.views*100).toFixed(1);return`\n        <tr>\n          <td>${t+1}</td>\n          <td>${this.escapeHtml(e.name)}</td>\n          <td>${this.formatNumber(e.views)}</td>\n          <td>${e.clicks}</td>\n          <td>${a}%</td>\n        </tr>\n      `}).join("")},renderCompanyCards(){document.getElementById("company-cards").innerHTML=this.companyData.map(e=>{const t=(e.clicks/e.views*100).toFixed(1),a=this.getPatternLabel(e.pattern);return`\n        <div class="company-card" data-domain="${e.domain}" data-name="${e.name}" data-views="${e.views}" data-clicks="${e.clicks}">\n          <div class="company-card-header">\n            <h4>${this.escapeHtml(e.name)}</h4>\n            <span class="pattern-badge ${e.pattern}">${a}</span>\n          </div>\n          <div class="company-card-stats">\n            <div class="card-stat">\n              <span class="stat-value">${this.formatNumber(e.views)}</span>\n              <span class="stat-label">ページビュー</span>\n            </div>\n            <div class="card-stat">\n              <span class="stat-value">${e.clicks}</span>\n              <span class="stat-label">応募クリック</span>\n            </div>\n            <div class="card-stat">\n              <span class="stat-value">${t}%</span>\n              <span class="stat-label">CVR</span>\n            </div>\n          </div>\n          <a href="company.html?c=${e.domain}" target="_blank" class="btn-view-page">ページを確認</a>\n        </div>\n      `}).join("")},getPatternLabel:e=>({standard:"スタンダード",modern:"モダン",classic:"クラシック",minimal:"ミニマル",colorful:"カラフル"}[e]||"スタンダード"),filterCompanies(e){const t=document.querySelectorAll(".company-card"),a=e.toLowerCase();t.forEach(e=>{const t=e.dataset.name.toLowerCase(),n=e.dataset.domain.toLowerCase();t.includes(a)||n.includes(a)?e.style.display="":e.style.display="none"})},sortCompanies(){const e=document.getElementById("sort-by").value,t=document.getElementById("company-cards"),a=Array.from(t.querySelectorAll(".company-card"));a.sort((t,a)=>{switch(e){case"views":return parseInt(a.dataset.views)-parseInt(t.dataset.views);case"clicks":return parseInt(a.dataset.clicks)-parseInt(t.dataset.clicks);case"cvr":const e=parseInt(t.dataset.clicks)/parseInt(t.dataset.views);return parseInt(a.dataset.clicks)/parseInt(a.dataset.views)-e;case"name":return t.dataset.name.localeCompare(a.dataset.name,"ja");default:return 0}}),a.forEach(e=>t.appendChild(e))},renderApplicationsData(){const e=document.querySelector("#applications-table tbody"),t={apply:"応募ボタン",line:"LINE相談",consult:"相談フォーム"};e.innerHTML=[{date:"2025/01/17 14:32",company:"トヨタ自動車",type:"apply",source:"Google検索"},{date:"2025/01/17 13:15",company:"日産自動車",type:"line",source:"直接アクセス"},{date:"2025/01/17 11:48",company:"トヨタ自動車",type:"apply",source:"Yahoo検索"},{date:"2025/01/17 10:22",company:"本田技研工業",type:"apply",source:"直接アクセス"},{date:"2025/01/16 18:45",company:"スバル",type:"line",source:"Google検索"},{date:"2025/01/16 16:30",company:"トヨタ自動車",type:"apply",source:"SNS"},{date:"2025/01/16 14:12",company:"マツダ",type:"apply",source:"Google検索"},{date:"2025/01/16 11:55",company:"日産自動車",type:"apply",source:"直接アクセス"}].map(e=>`\n      <tr>\n        <td>${e.date}</td>\n        <td>${this.escapeHtml(e.company)}</td>\n        <td><span class="type-badge ${e.type}">${t[e.type]}</span></td>\n        <td>${e.source}</td>\n      </tr>\n    `).join("")},saveSettings(){const e=document.getElementById("api-endpoint").value.trim();e?localStorage.setItem("api_endpoint",e):localStorage.removeItem("api_endpoint"),alert("設定を保存しました"),this.loadDashboardData()},changePassword(){const e=document.getElementById("new-password").value,t=document.getElementById("confirm-password").value;e&&t?e===t?e.length<8?alert("パスワードは8文字以上で設定してください"):(localStorage.setItem("admin_password",e),this.config.credentials.password=e,alert("パスワードを変更しました"),document.getElementById("new-password").value="",document.getElementById("confirm-password").value=""):alert("パスワードが一致しません"):alert("パスワードを入力してください")},formatNumber:e=>e.toLocaleString(),escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}};document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("admin_password");e&&(AdminDashboard.config.credentials.password=e);const t=document.getElementById("api-endpoint");t&&(t.value=localStorage.getItem("api_endpoint")||""),AdminDashboard.init()});