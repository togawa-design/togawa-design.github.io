const AdminDashboard={config:{credentials:{username:"admin",password:"receco2025"},sessionKey:"rikueco_admin_session",gaPropertyId:"G-E1XC94EG05",gaApiKey:"AIzaSyAIC2WGg5dnvMh6TO4sivpbk4HtpYw4tbo",apiEndpoint:"https://asia-northeast1-generated-area-484613-e3.cloudfunctions.net/getAnalyticsData",firebaseConfig:{apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"}},spreadsheetConfig:{sheetId:"1NVIDV3OiXbNrVI7EFdRrU2Ggn8dx7Q0rSnvJ6uaWvX0",companySheetName:"会社一覧",lpSettingsSheetName:"LP設定",gasApiUrl:localStorage.getItem("gas_api_url")||""},firebaseAuth:null,currentUser:null,idToken:null,init(){this.initFirebase(),this.checkSession(),this.bindEvents()},initFirebase(){"undefined"!=typeof firebase&&(firebase.initializeApp(this.config.firebaseConfig),this.firebaseAuth=firebase.auth(),this.firebaseAuth.onAuthStateChanged(async e=>{if(e){this.currentUser=e;try{this.idToken=await e.getIdToken(),console.log("[Admin] Firebase ID token obtained");sessionStorage.getItem(this.config.sessionKey)&&AdminAnalytics.loadDashboardData()}catch(e){console.error("[Admin] Failed to get ID token:",e)}}else this.currentUser=null,this.idToken=null}))},checkSession(){sessionStorage.getItem(this.config.sessionKey)?(this.showDashboard(),AdminAnalytics.loadDashboardData()):this.showLogin()},bindEvents(){const e=document.getElementById("login-form");e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleLogin()});const t=document.getElementById("logout-btn");t&&t.addEventListener("click",()=>this.handleLogout()),document.querySelectorAll(".sidebar-nav a").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();const t=e.currentTarget.dataset.section;this.switchSection(t)})});const n=document.getElementById("date-range");n&&n.addEventListener("change",()=>AdminAnalytics.loadDashboardData());const s=document.getElementById("refresh-btn");s&&s.addEventListener("click",()=>AdminAnalytics.loadDashboardData());const a=document.getElementById("company-search");a&&a.addEventListener("input",e=>AdminAnalytics.filterCompanies(e.target.value));const o=document.getElementById("sort-by");o&&o.addEventListener("change",()=>AdminAnalytics.sortCompanies());const i=document.getElementById("google-login-btn");i&&i.addEventListener("click",()=>this.handleGoogleLogin()),"undefined"!=typeof AdminSettings&&AdminSettings.bindEvents(),"undefined"!=typeof AdminCompany&&AdminCompany.bindEvents()},handleLogin(){const e=document.getElementById("username").value,t=document.getElementById("password").value,n=document.getElementById("login-error");e===this.config.credentials.username&&t===this.config.credentials.password?(sessionStorage.setItem(this.config.sessionKey,"authenticated"),n.style.display="none",this.showDashboard(),AdminAnalytics.loadDashboardData()):(n.textContent="ユーザー名またはパスワードが正しくありません",n.style.display="block")},async handleGoogleLogin(){if(!this.firebaseAuth)return void alert("Firebase認証が初期化されていません");const e=document.getElementById("login-error");try{const t=new firebase.auth.GoogleAuthProvider,n=await this.firebaseAuth.signInWithPopup(t);this.currentUser=n.user,this.idToken=await n.user.getIdToken(),sessionStorage.setItem(this.config.sessionKey,"authenticated"),sessionStorage.setItem("auth_method","google"),e.style.display="none",this.showDashboard(),AdminAnalytics.loadDashboardData()}catch(t){console.error("Google login error:",t),e.textContent="Googleログインに失敗しました: "+t.message,e.style.display="block"}},handleLogout(){sessionStorage.removeItem(this.config.sessionKey),sessionStorage.removeItem("auth_method"),this.firebaseAuth&&this.firebaseAuth.signOut(),this.showLogin()},showLogin(){document.getElementById("login-screen").style.display="flex",document.getElementById("admin-dashboard").style.display="none"},showDashboard(){document.getElementById("login-screen").style.display="none",document.getElementById("admin-dashboard").style.display="flex"},switchSection(e){document.querySelectorAll(".sidebar-nav li").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-section="${e}"]`);t&&t.parentElement.classList.add("active"),document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")});const n=document.getElementById(`section-${e}`);n&&n.classList.add("active");const s={overview:"概要",companies:"企業別データ","company-manage":"会社管理","lp-settings":"LP設定",applications:"応募データ",settings:"設定"},a=document.getElementById("page-title");a&&(a.textContent=s[e]||e),"company-manage"===e&&"undefined"!=typeof AdminCompany&&AdminCompany.loadCompanyManageData(),"lp-settings"===e&&"undefined"!=typeof AdminCompany&&(AdminCompany.loadCompanyListForLP(),AdminCompany.renderHeroImagePresets())}};document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("admin_password");e&&(AdminDashboard.config.credentials.password=e);const t=document.getElementById("api-endpoint");t&&(t.value=localStorage.getItem("api_endpoint")||"");const n=document.getElementById("gas-api-url");n&&(n.value=localStorage.getItem("gas_api_url")||""),AdminDashboard.spreadsheetConfig.gasApiUrl=localStorage.getItem("gas_api_url")||"",AdminDashboard.init()});