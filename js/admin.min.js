const AdminDashboard={config:{credentials:{username:"admin",password:"receco2025"},sessionKey:"rikueco_admin_session",gaPropertyId:"G-E1XC94EG05",gaApiKey:"AIzaSyAIC2WGg5dnvMh6TO4sivpbk4HtpYw4tbo",apiEndpoint:"https://asia-northeast1-generated-area-484613-e3.cloudfunctions.net/getAnalyticsData",firebaseConfig:{apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"}},heroImagePresets:[{id:"teamwork-1",name:"チームミーティング",url:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=400&q=60"},{id:"teamwork-2",name:"オフィスワーク",url:"https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=400&q=60"},{id:"teamwork-3",name:"コラボレーション",url:"https://images.unsplash.com/photo-1600880292203-757bb62b4baf?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1600880292203-757bb62b4baf?w=400&q=60"},{id:"teamwork-4",name:"ビジネス握手",url:"https://images.unsplash.com/photo-1521791136064-7986c2920216?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1521791136064-7986c2920216?w=400&q=60"},{id:"teamwork-5",name:"ワークショップ",url:"https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=400&q=60"},{id:"work-1",name:"製造ライン",url:"https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=400&q=60"},{id:"work-2",name:"倉庫作業",url:"https://images.unsplash.com/photo-1553413077-190dd305871c?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1553413077-190dd305871c?w=400&q=60"},{id:"work-3",name:"建設現場",url:"https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=400&q=60"},{id:"work-4",name:"工場作業",url:"https://images.unsplash.com/photo-1573164713988-8665fc963095?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1573164713988-8665fc963095?w=400&q=60"},{id:"work-5",name:"チームワーク",url:"https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1920&q=80",thumbnail:"https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=400&q=60"}],firebaseAuth:null,currentUser:null,idToken:null,init(){this.initFirebase(),this.checkSession(),this.bindEvents()},initFirebase(){"undefined"!=typeof firebase&&(firebase.initializeApp(this.config.firebaseConfig),this.firebaseAuth=firebase.auth(),this.firebaseAuth.onAuthStateChanged(async e=>{if(e){this.currentUser=e;try{this.idToken=await e.getIdToken(),console.log("[Admin] Firebase ID token obtained");sessionStorage.getItem(this.config.sessionKey)&&this.loadDashboardData()}catch(e){console.error("[Admin] Failed to get ID token:",e)}}else this.currentUser=null,this.idToken=null}))},checkSession(){sessionStorage.getItem(this.config.sessionKey)?(this.showDashboard(),this.loadDashboardData()):this.showLogin()},spreadsheetConfig:{sheetId:"1NVIDV3OiXbNrVI7EFdRrU2Ggn8dx7Q0rSnvJ6uaWvX0",companySheetName:"会社一覧",lpSettingsSheetName:"LP設定",gasApiUrl:localStorage.getItem("gas_api_url")||""},bindEvents(){document.getElementById("login-form").addEventListener("submit",e=>{e.preventDefault(),this.handleLogin()}),document.getElementById("logout-btn").addEventListener("click",()=>{this.handleLogout()}),document.querySelectorAll(".sidebar-nav a").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();const t=e.currentTarget.dataset.section;this.switchSection(t)})}),document.getElementById("date-range").addEventListener("change",()=>{this.loadDashboardData()}),document.getElementById("refresh-btn").addEventListener("click",()=>{this.loadDashboardData()}),document.getElementById("company-search").addEventListener("input",e=>{this.filterCompanies(e.target.value)}),document.getElementById("sort-by").addEventListener("change",()=>{this.sortCompanies()}),document.getElementById("save-settings").addEventListener("click",()=>{this.saveSettings()});const e=document.getElementById("save-gas-settings");e&&e.addEventListener("click",()=>{this.saveGasSettings()}),document.getElementById("change-password").addEventListener("click",()=>{this.changePassword()});const t=document.getElementById("google-login-btn");t&&t.addEventListener("click",()=>{this.handleGoogleLogin()});const n=document.getElementById("btn-add-company");n&&n.addEventListener("click",()=>{window.location.href="company-edit.html"});const a=document.getElementById("lp-company-select");a&&a.addEventListener("change",e=>{this.loadLPSettings(e.target.value)});const o=document.getElementById("btn-save-lp-settings");o&&o.addEventListener("click",()=>{this.saveLPSettings()});const s=document.getElementById("btn-reset-lp-settings");s&&s.addEventListener("click",()=>{const e=document.getElementById("lp-company-select").value;e&&this.loadLPSettings(e)});const i=document.getElementById("btn-toggle-preview");i&&i.addEventListener("click",()=>{this.toggleLPPreview()});const l=document.getElementById("btn-close-preview");l&&l.addEventListener("click",()=>{this.closeLPPreview()}),document.querySelectorAll(".preview-device-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.device;this.switchPreviewDevice(t)})});document.querySelectorAll("#lp-editor input, #lp-editor textarea").forEach(e=>{e.addEventListener("input",()=>{this.debouncedUpdatePreview()})}),document.querySelectorAll('input[name="design-pattern"]').forEach(e=>{e.addEventListener("change",()=>{this.updateLPPreview()})}),this.initSectionSortable(),document.querySelectorAll('#lp-section-order input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{this.updateLPPreview()})});const d=document.getElementById("preview-edit-mode");d&&d.addEventListener("change",e=>{this.togglePreviewEditMode(e.target.checked)});const c=document.getElementById("company-modal-close");c&&c.addEventListener("click",()=>{this.closeCompanyModal()});const r=document.getElementById("company-modal-cancel");r&&r.addEventListener("click",()=>{this.closeCompanyModal()});const m=document.getElementById("company-edit-form");m&&m.addEventListener("submit",e=>{e.preventDefault(),this.saveCompanyData()});const p=document.getElementById("company-modal");p&&p.addEventListener("click",e=>{e.target===p&&this.closeCompanyModal()});const h=document.getElementById("btn-add-job");h&&h.addEventListener("click",()=>{this.showJobModal()});const u=document.getElementById("btn-close-jobs");u&&u.addEventListener("click",()=>{this.closeJobsArea()});const g=document.getElementById("job-modal-close");g&&g.addEventListener("click",()=>{this.closeJobModal()});const y=document.getElementById("job-modal-cancel");y&&y.addEventListener("click",()=>{this.closeJobModal()});const v=document.getElementById("job-modal-delete");v&&v.addEventListener("click",()=>{this.deleteJob()});const b=document.getElementById("job-edit-form");b&&b.addEventListener("submit",e=>{e.preventDefault(),this.saveJobData()});const f=document.getElementById("job-modal");f&&f.addEventListener("click",e=>{e.target===f&&this.closeJobModal()})},handleLogin(){const e=document.getElementById("username").value,t=document.getElementById("password").value,n=document.getElementById("login-error");e===this.config.credentials.username&&t===this.config.credentials.password?(sessionStorage.setItem(this.config.sessionKey,"authenticated"),n.style.display="none",this.showDashboard(),this.loadDashboardData()):(n.textContent="ユーザー名またはパスワードが正しくありません",n.style.display="block")},async handleGoogleLogin(){if(!this.firebaseAuth)return void alert("Firebase認証が初期化されていません");const e=document.getElementById("login-error");try{const t=new firebase.auth.GoogleAuthProvider,n=await this.firebaseAuth.signInWithPopup(t);this.currentUser=n.user,this.idToken=await n.user.getIdToken(),sessionStorage.setItem(this.config.sessionKey,"authenticated"),sessionStorage.setItem("auth_method","google"),e.style.display="none",this.showDashboard(),this.loadDashboardData()}catch(t){console.error("Google login error:",t),e.textContent="Googleログインに失敗しました: "+t.message,e.style.display="block"}},handleLogout(){sessionStorage.removeItem(this.config.sessionKey),sessionStorage.removeItem("auth_method"),this.firebaseAuth&&this.firebaseAuth.signOut(),this.showLogin()},showLogin(){document.getElementById("login-screen").style.display="flex",document.getElementById("admin-dashboard").style.display="none"},showDashboard(){document.getElementById("login-screen").style.display="none",document.getElementById("admin-dashboard").style.display="flex"},switchSection(e){document.querySelectorAll(".sidebar-nav li").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-section="${e}"]`).parentElement.classList.add("active"),document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")}),document.getElementById(`section-${e}`).classList.add("active");document.getElementById("page-title").textContent={overview:"概要",companies:"企業別データ","company-manage":"会社管理","lp-settings":"LP設定",applications:"応募データ",settings:"設定"}[e],"company-manage"===e&&this.loadCompanyManageData(),"lp-settings"===e&&(this.loadCompanyListForLP(),this.renderHeroImagePresets())},async loadDashboardData(){const e=document.getElementById("date-range").value,t=localStorage.getItem("api_endpoint")||this.config.apiEndpoint;if(t&&this.idToken)await this.fetchGAData(e,t);else if(t&&!this.idToken)try{await this.fetchGAData(e,t)}catch(t){this.loadMockData(e)}else this.loadMockData(e)},async fetchGAData(e,t){try{this.showLoading(!0),this.showSectionLoading(!0);const n={};this.idToken&&(n.Authorization=`Bearer ${this.idToken}`);const a=await fetch(`${t}?days=${e}`,{headers:n});if(!a.ok)throw new Error(`API Error: ${a.status}`);const o=await a.json();if(!o.success)throw new Error(o.error||"Unknown error");const s=o.data;s.overview&&(document.getElementById("total-pageviews").textContent=this.formatNumber(s.overview.pageViews),document.getElementById("total-users").textContent=this.formatNumber(s.overview.users),document.getElementById("company-views").textContent=this.formatNumber(s.overview.companyViews),document.getElementById("apply-clicks").textContent=this.formatNumber(s.overview.applyClicks)),s.daily&&this.renderDailyChartFromAPI(s.daily),s.companies&&(this.companyData=s.companies.filter(e=>e.domain&&"(not set)"!==e.domain&&e.name&&"(not set)"!==e.name).map(e=>({name:e.name,domain:e.domain,views:e.views,clicks:e.clicks,pattern:"standard"})),this.renderOverviewTable(),this.renderCompanyCards()),s.applications&&this.renderApplicationsDataFromAPI(s.applications),this.showLoading(!1)}catch(t){console.error("[Admin] API fetch error:",t),console.error("[Admin] idToken available:",!!this.idToken),this.showLoading(!1),this.loadMockData(e)}},showLoading(e){const t=document.getElementById("refresh-btn");t&&(t.textContent=e?"読み込み中...":"更新",t.disabled=e)},showSectionLoading(e){const t='<div class="section-loading"><div class="loading-spinner"></div><span>データを読み込み中...</span></div>';document.querySelectorAll(".stat-value").forEach(t=>{e&&(t.dataset.originalText=t.textContent,t.innerHTML='<span class="loading-dots">...</span>')});const n=document.getElementById("daily-chart");n&&e&&(n.innerHTML=t);const a=document.querySelector(".data-table tbody");a&&e&&(a.innerHTML=`<tr><td colspan="5" style="text-align:center;padding:2rem;">${t}</td></tr>`);const o=document.getElementById("company-cards");o&&e&&(o.innerHTML=t);const s=document.querySelector("#applications-section .data-table tbody");s&&e&&(s.innerHTML=`<tr><td colspan="4" style="text-align:center;padding:2rem;">${t}</td></tr>`)},renderDailyChartFromAPI(e){const t=document.getElementById("daily-chart");if(!e||0===e.length)return void(t.innerHTML="<p>データがありません</p>");const n=Math.max(...e.map(e=>e.views));let a='<div class="simple-chart">';a+='<div class="chart-bars">';(e.length>30?e.filter((e,t)=>t%3==0):e).forEach(e=>{const t=n>0?e.views/n*100:0;a+=`\n        <div class="chart-bar-wrapper">\n          <div class="chart-bar" style="height: ${t}%">\n            <span class="bar-value">${e.views}</span>\n          </div>\n          <span class="bar-label">${e.date}</span>\n        </div>\n      `}),a+="</div></div>",t.innerHTML=a},renderApplicationsDataFromAPI(e){const t=document.querySelector("#applications-table tbody"),n={apply:"応募ボタン",line:"LINE相談",consult:"相談フォーム"};e&&0!==e.length?t.innerHTML=e.map(e=>`\n      <tr>\n        <td>${e.date}</td>\n        <td>${this.escapeHtml(e.company)}</td>\n        <td><span class="type-badge ${e.type}">${n[e.type]||e.type}</span></td>\n        <td>${e.source}</td>\n      </tr>\n    `).join(""):t.innerHTML='<tr><td colspan="4" class="loading-cell">応募データがありません</td></tr>'},loadMockData(e){const t=150*e,n=80*e,a=45*e,o=12*e;document.getElementById("total-pageviews").textContent=this.formatNumber(t+Math.floor(500*Math.random())),document.getElementById("total-users").textContent=this.formatNumber(n+Math.floor(200*Math.random())),document.getElementById("company-views").textContent=this.formatNumber(a+Math.floor(100*Math.random())),document.getElementById("apply-clicks").textContent=this.formatNumber(o+Math.floor(30*Math.random())),this.renderDailyChart(e),this.renderCompanyData(),this.renderApplicationsData()},renderDailyChart(e){const t=document.getElementById("daily-chart"),n=[],a=new Date;for(let t=e-1;t>=0;t--){const e=new Date(a);e.setDate(e.getDate()-t),n.push({date:`${e.getMonth()+1}/${e.getDate()}`,views:Math.floor(100+200*Math.random()),clicks:Math.floor(5+20*Math.random())})}const o=Math.max(...n.map(e=>e.views));let s='<div class="simple-chart">';s+='<div class="chart-bars">';(e>30?n.filter((e,t)=>t%3==0):n).forEach(e=>{const t=e.views/o*100;s+=`\n        <div class="chart-bar-wrapper">\n          <div class="chart-bar" style="height: ${t}%">\n            <span class="bar-value">${e.views}</span>\n          </div>\n          <span class="bar-label">${e.date}</span>\n        </div>\n      `}),s+="</div></div>",t.innerHTML=s},renderCompanyData(){this.companyData=[{name:"トヨタ自動車",domain:"toyota",views:1250,clicks:89,pattern:"modern"},{name:"日産自動車",domain:"nissan",views:980,clicks:67,pattern:"classic"},{name:"本田技研工業",domain:"honda",views:856,clicks:54,pattern:"colorful"},{name:"スバル",domain:"subaru",views:654,clicks:43,pattern:"minimal"},{name:"マツダ",domain:"mazda",views:523,clicks:32,pattern:"standard"},{name:"スズキ",domain:"suzuki",views:412,clicks:28,pattern:"modern"},{name:"ダイハツ",domain:"daihatsu",views:387,clicks:24,pattern:"classic"},{name:"三菱自動車",domain:"mitsubishi",views:298,clicks:18,pattern:"standard"}],this.renderOverviewTable(),this.renderCompanyCards()},renderOverviewTable(){const e=document.querySelector("#overview-company-table tbody"),t=[...this.companyData].sort((e,t)=>t.views-e.views);e.innerHTML=t.slice(0,5).map((e,t)=>{const n=(e.clicks/e.views*100).toFixed(1);return`\n        <tr>\n          <td>${t+1}</td>\n          <td>${this.escapeHtml(e.name)}</td>\n          <td>${this.formatNumber(e.views)}</td>\n          <td>${e.clicks}</td>\n          <td>${n}%</td>\n        </tr>\n      `}).join("")},renderCompanyCards(){document.getElementById("company-cards").innerHTML=this.companyData.map(e=>{const t=(e.clicks/e.views*100).toFixed(1),n=this.getPatternLabel(e.pattern);return`\n        <div class="company-card" data-domain="${e.domain}" data-name="${e.name}" data-views="${e.views}" data-clicks="${e.clicks}">\n          <div class="company-card-header">\n            <h4>${this.escapeHtml(e.name)}</h4>\n            <span class="pattern-badge ${e.pattern}">${n}</span>\n          </div>\n          <div class="company-card-stats">\n            <div class="card-stat">\n              <span class="stat-value">${this.formatNumber(e.views)}</span>\n              <span class="stat-label">ページビュー</span>\n            </div>\n            <div class="card-stat">\n              <span class="stat-value">${e.clicks}</span>\n              <span class="stat-label">応募クリック</span>\n            </div>\n            <div class="card-stat">\n              <span class="stat-value">${t}%</span>\n              <span class="stat-label">CVR</span>\n            </div>\n          </div>\n          <a href="company.html?c=${e.domain}" target="_blank" class="btn-view-page">ページを確認</a>\n        </div>\n      `}).join("")},getPatternLabel:e=>({standard:"スタンダード",modern:"モダン",classic:"クラシック",minimal:"ミニマル",colorful:"カラフル"}[e]||"スタンダード"),filterCompanies(e){const t=document.querySelectorAll(".company-card"),n=e.toLowerCase();t.forEach(e=>{const t=e.dataset.name.toLowerCase(),a=e.dataset.domain.toLowerCase();t.includes(n)||a.includes(n)?e.style.display="":e.style.display="none"})},sortCompanies(){const e=document.getElementById("sort-by").value,t=document.getElementById("company-cards"),n=Array.from(t.querySelectorAll(".company-card"));n.sort((t,n)=>{switch(e){case"views":return parseInt(n.dataset.views)-parseInt(t.dataset.views);case"clicks":return parseInt(n.dataset.clicks)-parseInt(t.dataset.clicks);case"cvr":const e=parseInt(t.dataset.clicks)/parseInt(t.dataset.views);return parseInt(n.dataset.clicks)/parseInt(n.dataset.views)-e;case"name":return t.dataset.name.localeCompare(n.dataset.name,"ja");default:return 0}}),n.forEach(e=>t.appendChild(e))},renderApplicationsData(){const e=document.querySelector("#applications-table tbody"),t={apply:"応募ボタン",line:"LINE相談",consult:"相談フォーム"};e.innerHTML=[{date:"2025/01/17 14:32",company:"トヨタ自動車",type:"apply",source:"Google検索"},{date:"2025/01/17 13:15",company:"日産自動車",type:"line",source:"直接アクセス"},{date:"2025/01/17 11:48",company:"トヨタ自動車",type:"apply",source:"Yahoo検索"},{date:"2025/01/17 10:22",company:"本田技研工業",type:"apply",source:"直接アクセス"},{date:"2025/01/16 18:45",company:"スバル",type:"line",source:"Google検索"},{date:"2025/01/16 16:30",company:"トヨタ自動車",type:"apply",source:"SNS"},{date:"2025/01/16 14:12",company:"マツダ",type:"apply",source:"Google検索"},{date:"2025/01/16 11:55",company:"日産自動車",type:"apply",source:"直接アクセス"}].map(e=>`\n      <tr>\n        <td>${e.date}</td>\n        <td>${this.escapeHtml(e.company)}</td>\n        <td><span class="type-badge ${e.type}">${t[e.type]}</span></td>\n        <td>${e.source}</td>\n      </tr>\n    `).join("")},saveSettings(){const e=document.getElementById("api-endpoint").value.trim();e?localStorage.setItem("api_endpoint",e):localStorage.removeItem("api_endpoint"),alert("設定を保存しました"),this.loadDashboardData()},saveGasSettings(){const e=document.getElementById("gas-api-url").value.trim();e?(localStorage.setItem("gas_api_url",e),this.spreadsheetConfig.gasApiUrl=e):(localStorage.removeItem("gas_api_url"),this.spreadsheetConfig.gasApiUrl=""),alert("GAS設定を保存しました。\n\n"+(e?"会社情報・LP設定はスプレッドシートに直接保存されます。":"GAS APIが未設定のため、データはローカルストレージに保存されます。"))},changePassword(){const e=document.getElementById("new-password").value,t=document.getElementById("confirm-password").value;e&&t?e===t?e.length<8?alert("パスワードは8文字以上で設定してください"):(localStorage.setItem("admin_password",e),this.config.credentials.password=e,alert("パスワードを変更しました"),document.getElementById("new-password").value="",document.getElementById("confirm-password").value=""):alert("パスワードが一致しません"):alert("パスワードを入力してください")},formatNumber:e=>e.toLocaleString(),escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},async loadCompanyManageData(){const e=document.getElementById("company-manage-tbody");if(e){e.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';try{const t=`https://docs.google.com/spreadsheets/d/${this.spreadsheetConfig.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(this.spreadsheetConfig.companySheetName)}`,n=await fetch(t);if(!n.ok)throw new Error("データの取得に失敗しました");const a=await n.text();let o=this.parseCompanyCSV(a);if(o=o.map(e=>{if(e.companyDomain){const t=localStorage.getItem(`company_data_${e.companyDomain}`);if(t)try{const n=JSON.parse(t);return{...e,...n}}catch(e){console.error("ローカルストレージのパースエラー:",e)}}return e}),0===o.length)return void(e.innerHTML='<tr><td colspan="6" class="loading-cell">会社データがありません</td></tr>');this.companiesCache=o,this.renderCompanyTable()}catch(t){console.error("会社データの読み込みエラー:",t),e.innerHTML='<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました</td></tr>'}}},parseCompanyCSV(e){const t=e.split("\n"),n=this.parseCSVLine(t[0]||""),a=[];for(let e=1;e<t.length;e++){if(!t[e].trim())continue;const o=this.parseCSVLine(t[e]),s={};n.forEach((e,t)=>{const n=this.normalizeHeader(e);s[n]=o[t]||""}),a.push(s)}return a},parseCSVLine(e){const t=[];let n="",a=!1;for(let o=0;o<e.length;o++){const s=e[o];'"'===s?a&&'"'===e[o+1]?(n+='"',o++):a=!a:","!==s||a?n+=s:(t.push(n.trim()),n="")}return t.push(n.trim()),t},normalizeHeader(e){const t=e.replace(/"/g,"").trim();return{"会社名":"company",company:"company","会社ドメイン":"companyDomain",companyDomain:"companyDomain",company_domain:"companyDomain","デザインパターン":"designPattern",designPattern:"designPattern",design_pattern:"designPattern","表示する":"showCompany",showCompany:"showCompany",visible:"showCompany","画像URL":"imageUrl",imageUrl:"imageUrl",image_url:"imageUrl","説明":"description",description:"description","並び順":"order",order:"order","管理シート":"manageSheetUrl","管理シートURL":"manageSheetUrl",manageSheetUrl:"manageSheetUrl"}[t]||t},editCompany(e){window.location.href=`company-edit.html?domain=${encodeURIComponent(e)}`},showCompanyModal(){window.location.href="company-edit.html"},closeCompanyModal(){const e=document.getElementById("company-modal");e&&(e.style.display="none"),this.currentEditingCompany=null,this.isNewCompany=!1},async saveCompanyData(){const e=document.getElementById("edit-company-domain").value.trim().toLowerCase(),t={company:document.getElementById("edit-company-name").value.trim(),company_domain:e,companyDomain:e,designPattern:document.getElementById("edit-design-pattern").value,imageUrl:document.getElementById("edit-image-url").value.trim(),order:document.getElementById("edit-order").value||"",description:document.getElementById("edit-description").value.trim(),showCompany:document.getElementById("edit-show-company").checked?"○":"",visible:document.getElementById("edit-show-company").checked?"○":""};if(!t.company||!t.companyDomain)return void alert("会社名と会社ドメインは必須です");if(!/^[a-z0-9-]+$/.test(t.companyDomain))return void alert("会社ドメインは半角英数字とハイフンのみ使用できます");if(this.isNewCompany){const e=this.companiesCache?.find(e=>e.companyDomain===t.companyDomain);if(e)return void alert("このドメインは既に使用されています")}const n=this.spreadsheetConfig.gasApiUrl;if(n)try{const e=document.getElementById("company-modal-save");e&&(e.disabled=!0,e.textContent="保存中...");const a=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveCompany",company:t})))),o=`${n}?action=post&data=${encodeURIComponent(a)}`,s=await fetch(o,{method:"GET",redirect:"follow"}),i=await s.json();if(e&&(e.disabled=!1,e.textContent="保存"),!i.success)return void alert("スプレッドシートへの保存に失敗しました: "+(i.error||"不明なエラー"));if(localStorage.removeItem(`company_data_${t.companyDomain}`),this.isNewCompany)this.companiesCache||(this.companiesCache=[]),this.companiesCache.push(t);else{const e=this.companiesCache?.findIndex(e=>e.companyDomain===t.companyDomain);-1!==e&&(this.companiesCache[e]=t)}this.closeCompanyModal(),this.renderCompanyTable(),alert(`会社情報をスプレッドシートに保存しました。\n\n会社名: ${t.company}\nドメイン: ${t.companyDomain}`)}catch(e){console.error("GAS API呼び出しエラー:",e),alert("スプレッドシートへの保存中にエラーが発生しました。ローカルに保存します。"),this.saveCompanyDataLocal(t)}else this.saveCompanyDataLocal(t)},saveCompanyDataLocal(e){const t=`company_data_${e.companyDomain}`;if(localStorage.setItem(t,JSON.stringify(e)),this.isNewCompany)this.companiesCache||(this.companiesCache=[]),this.companiesCache.push(e);else{const t=this.companiesCache?.findIndex(t=>t.companyDomain===e.companyDomain);-1!==t&&(this.companiesCache[t]=e)}this.closeCompanyModal(),this.renderCompanyTable(),alert(`会社情報をローカルに保存しました。\n\n注意: スプレッドシートに自動保存するには、設定画面でGAS API URLを設定してください。\n\n会社名: ${e.company}\nドメイン: ${e.companyDomain}`)},renderCompanyTable(){const e=document.getElementById("company-manage-tbody");if(!e)return;const t=this.companiesCache||[];0!==t.length?e.innerHTML=t.map(e=>`\n      <tr data-domain="${this.escapeHtml(e.companyDomain||"")}">\n        <td>${this.escapeHtml(e.company||"")}</td>\n        <td><code>${this.escapeHtml(e.companyDomain||"")}</code></td>\n        <td><span class="badge ${e.designPattern||"standard"}">${this.getPatternLabel(e.designPattern||"standard")}</span></td>\n        <td>${"○"===e.showCompany||"◯"===e.showCompany?'<span class="badge success">表示</span>':'<span class="badge">非表示</span>'}</td>\n        <td>\n          <div class="action-buttons">\n            <button class="btn-small btn-edit" onclick="AdminDashboard.editCompany('${this.escapeHtml(e.companyDomain||"")}')">編集</button>\n            <button class="btn-small btn-primary" onclick="AdminDashboard.openJobsArea('${this.escapeHtml(e.companyDomain||"")}')">求人管理</button>\n            <a href="lp.html?c=${this.escapeHtml(e.companyDomain||"")}" target="_blank" class="btn-small btn-view">LP確認</a>\n          </div>\n        </td>\n      </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="5" class="loading-cell">会社データがありません</td></tr>'},async loadCompanyListForLP(){const e=document.getElementById("lp-company-select");if(!e)return;this.companiesCache||await this.loadCompanyManageData();const t=(this.companiesCache||[]).filter(e=>e.companyDomain&&("○"===e.showCompany||"◯"===e.showCompany));e.innerHTML='<option value="">-- 会社を選択 --</option>'+t.map(e=>`<option value="${this.escapeHtml(e.companyDomain)}">${this.escapeHtml(e.company)}</option>`).join("")},async loadLPSettings(e){const t=document.getElementById("lp-editor"),n=document.getElementById("lp-preview-btn"),a=document.getElementById("lp-edit-mode-btn");if(!e)return void(t&&(t.style.display="none"));t&&(t.style.display="block"),n&&(n.href=`lp.html?c=${encodeURIComponent(e)}`),a&&(a.href=`lp.html?c=${encodeURIComponent(e)}&edit`),this.renderHeroImagePresets();const o=this.companiesCache?.find(t=>t.companyDomain===e);if(o){const e=document.querySelector(`input[name="design-pattern"][value="${o.designPattern||"standard"}"]`);e&&(e.checked=!0)}try{const t=`https://docs.google.com/spreadsheets/d/${this.spreadsheetConfig.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(this.spreadsheetConfig.lpSettingsSheetName)}`,n=await fetch(t);if(n.ok){const t=await n.text(),a=this.parseLPSettingsCSV(t,e);if(a){if(document.getElementById("lp-hero-title").value=a.heroTitle||"",document.getElementById("lp-hero-subtitle").value=a.heroSubtitle||"",document.getElementById("lp-hero-image").value=a.heroImage||"",document.getElementById("lp-point-title-1").value=a.pointTitle1||"",document.getElementById("lp-point-desc-1").value=a.pointDesc1||"",document.getElementById("lp-point-title-2").value=a.pointTitle2||"",document.getElementById("lp-point-desc-2").value=a.pointDesc2||"",document.getElementById("lp-point-title-3").value=a.pointTitle3||"",document.getElementById("lp-point-desc-3").value=a.pointDesc3||"",document.getElementById("lp-cta-text").value=a.ctaText||"今すぐ応募する",document.getElementById("lp-faq").value=a.faq||"",a.designPattern){const e=document.querySelector(`input[name="design-pattern"][value="${a.designPattern}"]`);e&&(e.checked=!0)}return void this.updateHeroImagePresetSelection(a.heroImage||"")}}}catch(e){console.log("LP設定シートが見つかりません")}this.clearLPForm()},parseLPSettingsCSV(e,t){const n=e.split("\n"),a=this.parseCSVLine(n[0]||"");for(let e=1;e<n.length;e++){if(!n[e].trim())continue;const o=this.parseCSVLine(n[e]),s={};if(a.forEach((e,t)=>{const n=e.replace(/"/g,"").trim();s[n]=o[t]||""}),s.companyDomain===t||s["会社ドメイン"]===t)return{heroTitle:s.heroTitle||s["ヒーロータイトル"]||"",heroSubtitle:s.heroSubtitle||s["ヒーローサブタイトル"]||"",heroImage:s.heroImage||s["ヒーロー画像"]||"",pointTitle1:s.pointTitle1||s["ポイント1タイトル"]||"",pointDesc1:s.pointDesc1||s["ポイント1説明"]||"",pointTitle2:s.pointTitle2||s["ポイント2タイトル"]||"",pointDesc2:s.pointDesc2||s["ポイント2説明"]||"",pointTitle3:s.pointTitle3||s["ポイント3タイトル"]||"",pointDesc3:s.pointDesc3||s["ポイント3説明"]||"",ctaText:s.ctaText||s["CTAテキスト"]||"",faq:s.faq||s.FAQ||"",designPattern:s.designPattern||s["デザインパターン"]||""}}return null},clearLPForm(){document.getElementById("lp-hero-title").value="",document.getElementById("lp-hero-subtitle").value="",document.getElementById("lp-hero-image").value="",document.getElementById("lp-point-title-1").value="",document.getElementById("lp-point-desc-1").value="",document.getElementById("lp-point-title-2").value="",document.getElementById("lp-point-desc-2").value="",document.getElementById("lp-point-title-3").value="",document.getElementById("lp-point-desc-3").value="",document.getElementById("lp-cta-text").value="今すぐ応募する",document.getElementById("lp-faq").value="",document.querySelector('input[name="design-pattern"][value="standard"]').checked=!0,this.updateHeroImagePresetSelection("")},renderHeroImagePresets(){const e=document.getElementById("hero-image-presets");e&&(e.innerHTML=this.heroImagePresets.map(e=>`\n      <div class="hero-image-preset" data-url="${this.escapeHtml(e.url)}" title="${this.escapeHtml(e.name)}">\n        <img src="${this.escapeHtml(e.thumbnail)}" alt="${this.escapeHtml(e.name)}" loading="lazy">\n        <span class="preset-name">${this.escapeHtml(e.name)}</span>\n        <span class="preset-check">✓</span>\n      </div>\n    `).join(""),e.querySelectorAll(".hero-image-preset").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.url;this.selectHeroImagePreset(t)})}))},selectHeroImagePreset(e){const t=document.getElementById("lp-hero-image");t&&(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0}))),this.updateHeroImagePresetSelection(e)},updateHeroImagePresetSelection(e){const t=document.getElementById("hero-image-presets");t&&t.querySelectorAll(".hero-image-preset").forEach(t=>{const n=t.dataset.url,a=e?.split("?")[0]||"",o=n?.split("?")[0]||"";a&&o&&a===o?t.classList.add("selected"):t.classList.remove("selected")})},async saveLPSettings(){const e=document.getElementById("lp-company-select").value;if(!e)return void alert("会社を選択してください");const t={companyDomain:e,designPattern:document.querySelector('input[name="design-pattern"]:checked')?.value||"standard",heroTitle:document.getElementById("lp-hero-title").value,heroSubtitle:document.getElementById("lp-hero-subtitle").value,heroImage:document.getElementById("lp-hero-image").value,pointTitle1:document.getElementById("lp-point-title-1").value,pointDesc1:document.getElementById("lp-point-desc-1").value,pointTitle2:document.getElementById("lp-point-title-2").value,pointDesc2:document.getElementById("lp-point-desc-2").value,pointTitle3:document.getElementById("lp-point-title-3").value,pointDesc3:document.getElementById("lp-point-desc-3").value,ctaText:document.getElementById("lp-cta-text").value,faq:document.getElementById("lp-faq").value},n=this.spreadsheetConfig.gasApiUrl;if(n)try{const a=document.getElementById("btn-save-lp-settings");a&&(a.disabled=!0,a.textContent="保存中...");const o=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveLPSettings",settings:t})))),s=`${n}?action=post&data=${encodeURIComponent(o)}`;console.log("[LP Save] Sending request to:",s);const i=await fetch(s,{method:"GET",redirect:"follow"}),l=await i.text();let d;console.log("[LP Save] Response status:",i.status),console.log("[LP Save] Response text:",l);try{d=JSON.parse(l)}catch(e){throw console.error("[LP Save] JSON parse error:",e),a&&(a.disabled=!1,a.textContent="LP設定を保存"),new Error(`GASからの応答が不正です: ${l.substring(0,200)}`)}if(a&&(a.disabled=!1,a.textContent="LP設定を保存"),!d.success)return void alert("スプレッドシートへの保存に失敗しました: "+(d.error||"不明なエラー"));localStorage.removeItem(`lp_settings_${e}`),alert(`LP設定をスプレッドシートに保存しました。\n\n会社: ${e}\nデザインパターン: ${t.designPattern}`)}catch(n){console.error("GAS API呼び出しエラー:",n),alert("スプレッドシートへの保存中にエラーが発生しました。ローカルに保存します。"),this.saveLPSettingsLocal(t,e)}else this.saveLPSettingsLocal(t,e)},saveLPSettingsLocal(e,t){const n=`lp_settings_${t}`;localStorage.setItem(n,JSON.stringify(e)),alert(`LP設定をローカルに保存しました。\n\n注意: スプレッドシートに自動保存するには、設定画面でGAS API URLを設定してください。\n\n会社: ${t}\nデザインパターン: ${e.designPattern}`)},previewUpdateTimer:null,debouncedUpdatePreview(){this.previewUpdateTimer&&clearTimeout(this.previewUpdateTimer),this.previewUpdateTimer=setTimeout(()=>{this.updateLPPreview()},300)},toggleLPPreview(){const e=document.getElementById("lp-preview-container"),t=document.getElementById("btn-toggle-preview");e&&("none"===e.style.display?(e.style.display="flex",t&&(t.textContent="プレビューを隠す"),this.updateLPPreview()):(e.style.display="none",t&&(t.textContent="プレビュー表示")))},closeLPPreview(){const e=document.getElementById("lp-preview-container"),t=document.getElementById("btn-toggle-preview");e&&(e.style.display="none"),t&&(t.textContent="プレビュー表示")},switchPreviewDevice(e){const t=document.querySelector(".lp-preview-frame-wrapper");document.querySelectorAll(".preview-device-btn").forEach(t=>{t.classList.toggle("active",t.dataset.device===e)}),t&&t.setAttribute("data-device",e)},updateLPPreview(){const e=document.getElementById("lp-preview-container"),t=document.getElementById("lp-preview-frame"),n=document.getElementById("lp-company-select")?.value;if(!e||"none"===e.style.display||!t||!n)return;const a=this.getCurrentLPSettings(),o=this.companiesCache?.find(e=>e.companyDomain===n)||{company:n,companyDomain:n},s=this.generatePreviewHTML(o,a),i=t.contentDocument||t.contentWindow.document;i.open(),i.write(s),i.close()},getCurrentLPSettings:()=>({designPattern:document.querySelector('input[name="design-pattern"]:checked')?.value||"standard",heroTitle:document.getElementById("lp-hero-title")?.value||"",heroSubtitle:document.getElementById("lp-hero-subtitle")?.value||"",heroImage:document.getElementById("lp-hero-image")?.value||"",pointTitle1:document.getElementById("lp-point-title-1")?.value||"",pointDesc1:document.getElementById("lp-point-desc-1")?.value||"",pointTitle2:document.getElementById("lp-point-title-2")?.value||"",pointDesc2:document.getElementById("lp-point-desc-2")?.value||"",pointTitle3:document.getElementById("lp-point-title-3")?.value||"",pointDesc3:document.getElementById("lp-point-desc-3")?.value||"",ctaText:document.getElementById("lp-cta-text")?.value||"今すぐ応募する",faq:document.getElementById("lp-faq")?.value||""}),generatePreviewHTML(e,t){const n=t.designPattern||"standard",a=t.heroTitle||`${e.company}で働こう`,o=t.heroSubtitle||"",s=t.heroImage||"",i=t.ctaText||"今すぐ応募する",l=document.getElementById("preview-edit-mode")?.checked||!1,d=[];t.pointTitle1&&d.push({title:t.pointTitle1,desc:t.pointDesc1||""}),t.pointTitle2&&d.push({title:t.pointTitle2,desc:t.pointDesc2||""}),t.pointTitle3&&d.push({title:t.pointTitle3,desc:t.pointDesc3||""});const c=t.faq?t.faq.split("||").map(e=>{const t=e.split("|");return{q:t.find(e=>e.startsWith("Q:"))?.replace("Q:","").trim()||"",a:t.find(e=>e.startsWith("A:"))?.replace("A:","").trim()||""}}).filter(e=>e.q&&e.a):[],r=this.getSectionOrder(),m=this.getSectionVisibility(),p={hero:`\n        <section class="lp-hero preview-section" data-section="hero">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">ヒーロー</span></div>':""}\n          ${s?`<div class="lp-hero-bg" style="background-image: url('${this.escapeHtml(s)}')"></div>`:'<div class="lp-hero-bg"></div>'}\n          <div class="lp-hero-overlay"></div>\n          <div class="lp-hero-content">\n            <p class="lp-hero-company">${this.escapeHtml(e.company)}</p>\n            <h1 class="lp-hero-title">${this.escapeHtml(a)}</h1>\n            ${o?`<p class="lp-hero-subtitle">${this.escapeHtml(o)}</p>`:""}\n            <div class="lp-hero-cta">\n              <a href="#" class="lp-btn-apply-hero">${this.escapeHtml(i)}</a>\n            </div>\n          </div>\n        </section>`,points:d.length>0&&m.points?`\n        <section class="lp-points preview-section" data-section="points">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">ポイント</span><button class="section-edit-btn" onclick="parent.AdminDashboard.focusSection(\'points\')">編集</button></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">この求人のポイント</h2>\n            <div class="lp-points-grid">\n              ${d.map((e,t)=>`\n                <div class="lp-point-card">\n                  <div class="lp-point-number">${t+1}</div>\n                  <h3 class="lp-point-title">${this.escapeHtml(e.title)}</h3>\n                  <p class="lp-point-desc">${this.escapeHtml(e.desc)}</p>\n                </div>\n              `).join("")}\n            </div>\n          </div>\n        </section>`:"",jobs:m.jobs?`\n        <section class="lp-jobs preview-section" data-section="jobs">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">求人一覧</span><span class="section-note">実際のデータから表示</span></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">募集中の求人</h2>\n            <div class="lp-jobs-list">\n              <div class="lp-job-card" style="opacity: 0.5;">\n                <div class="lp-job-card-header"><h3 class="lp-job-title">求人データはスプレッドシートから読み込まれます</h3></div>\n                <div class="lp-job-card-body"><p>プレビューでは表示されません</p></div>\n              </div>\n            </div>\n          </div>\n        </section>`:"",details:m.details?`\n        <section class="lp-details preview-section" data-section="details">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">募集要項</span><span class="section-note">実際のデータから表示</span></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">募集要項</h2>\n            <div class="lp-details-table">\n              <div class="lp-detail-row"><div class="lp-detail-label">仕事内容</div><div class="lp-detail-value" style="opacity: 0.5;">スプレッドシートから読み込み</div></div>\n              <div class="lp-detail-row"><div class="lp-detail-label">勤務地</div><div class="lp-detail-value" style="opacity: 0.5;">スプレッドシートから読み込み</div></div>\n            </div>\n          </div>\n        </section>`:"",faq:c.length>0&&m.faq?`\n        <section class="lp-faq preview-section" data-section="faq">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">FAQ</span><button class="section-edit-btn" onclick="parent.AdminDashboard.focusSection(\'faq\')">編集</button></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-section-title">よくある質問</h2>\n            <div class="lp-faq-list">\n              ${c.map(e=>`\n                <div class="lp-faq-item">\n                  <div class="lp-faq-question">\n                    <span class="lp-faq-icon">Q</span>\n                    <span>${this.escapeHtml(e.q)}</span>\n                  </div>\n                  <div class="lp-faq-answer">\n                    <span class="lp-faq-icon">A</span>\n                    <span>${this.escapeHtml(e.a)}</span>\n                  </div>\n                </div>\n              `).join("")}\n            </div>\n          </div>\n        </section>`:"",apply:`\n        <section class="lp-apply preview-section" id="lp-apply" data-section="apply">\n          ${l?'<div class="section-edit-overlay"><span class="section-label">応募</span><button class="section-edit-btn" onclick="parent.AdminDashboard.focusSection(\'cta\')">編集</button></div>':""}\n          <div class="lp-section-inner">\n            <h2 class="lp-apply-title">まずはお気軽にご応募ください</h2>\n            <p class="lp-apply-text">経験・学歴不問！${this.escapeHtml(e.company)}であなたのご応募をお待ちしています。</p>\n            <div class="lp-apply-buttons">\n              <a href="#" class="lp-btn-apply-main">${this.escapeHtml(i)}</a>\n              <a href="#" class="lp-btn-tel-main">\n                <span class="tel-number">0120-000-000</span>\n                <span class="tel-note">（平日9:00〜18:00）</span>\n              </a>\n            </div>\n          </div>\n        </section>`},h=r.map(e=>p[e]||"").join("");return`\n<!DOCTYPE html>\n<html lang="ja">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>プレビュー</title>\n  <link rel="stylesheet" href="css/style.min.css">\n  <link rel="stylesheet" href="css/lp.css">\n  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">\n  <style>\n    body { margin: 0; padding: 0; }\n    .lp-hero { min-height: 50vh; }\n    .preview-note {\n      background: #fef3c7;\n      color: #92400e;\n      padding: 8px 16px;\n      text-align: center;\n      font-size: 12px;\n      position: sticky;\n      top: 0;\n      z-index: 1000;\n    }\n    /* 編集モードスタイル */\n    .edit-mode .preview-section {\n      position: relative;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n    .edit-mode .preview-section:hover {\n      outline: 3px solid #6366f1;\n      outline-offset: -3px;\n    }\n    .section-edit-overlay {\n      position: absolute;\n      top: 8px;\n      right: 8px;\n      background: rgba(99, 102, 241, 0.95);\n      color: white;\n      padding: 6px 12px;\n      border-radius: 6px;\n      font-size: 12px;\n      z-index: 100;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n    }\n    .section-label {\n      font-weight: 600;\n    }\n    .section-note {\n      opacity: 0.8;\n      font-size: 11px;\n    }\n    .section-edit-btn {\n      background: white;\n      color: #6366f1;\n      border: none;\n      padding: 4px 10px;\n      border-radius: 4px;\n      font-size: 11px;\n      cursor: pointer;\n      font-weight: 600;\n    }\n    .section-edit-btn:hover {\n      background: #f0f0ff;\n    }\n  </style>\n</head>\n<body class="lp-body lp-pattern-${this.escapeHtml(n)}${l?" edit-mode":""}">\n  <div class="preview-note">${l?"編集モード - セクションをクリックして編集":"プレビューモード"}</div>\n  ${h}\n</body>\n</html>`},getSectionOrder(){const e=document.getElementById("lp-section-order");return e?Array.from(e.querySelectorAll("li")).map(e=>e.dataset.section):["hero","points","jobs","details","faq","apply"]},getSectionVisibility:()=>({points:document.getElementById("section-points-visible")?.checked??!0,jobs:document.getElementById("section-jobs-visible")?.checked??!0,details:document.getElementById("section-details-visible")?.checked??!0,faq:document.getElementById("section-faq-visible")?.checked??!0}),initSectionSortable(){const e=document.getElementById("lp-section-order");if(!e)return;let t=null;e.querySelectorAll(".section-order-item").forEach(n=>{n.setAttribute("draggable","true"),n.addEventListener("dragstart",e=>{t=n,n.classList.add("dragging"),e.dataTransfer.effectAllowed="move"}),n.addEventListener("dragend",()=>{n.classList.remove("dragging"),t=null,this.updateLPPreview()}),n.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="move";const a=this.getDragAfterElement(e,n.clientY);null==a?e.appendChild(t):e.insertBefore(t,a)})})},getDragAfterElement:(e,t)=>[...e.querySelectorAll(".section-order-item:not(.dragging)")].reduce((e,n)=>{const a=n.getBoundingClientRect(),o=t-a.top-a.height/2;return o<0&&o>e.offset?{offset:o,element:n}:e},{offset:Number.NEGATIVE_INFINITY}).element,togglePreviewEditMode(e){this.updateLPPreview()},focusSection(e){const t={points:"lp-point-title-1",faq:"lp-faq",cta:"lp-cta-text",hero:"lp-hero-title"}[e];if(t){const e=document.getElementById(t);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus())}},currentJobCompanyDomain:null,currentJobSheetUrl:null,jobsCache:[],currentEditingJob:null,isNewJob:!1,openJobsArea(e){const t=this.companiesCache?.find(t=>t.companyDomain===e);if(!t)return void alert("会社情報が見つかりません");const n=new URLSearchParams;n.set("domain",e),n.set("company",t.company||e),t.manageSheetUrl&&n.set("sheetUrl",t.manageSheetUrl),window.location.href=`job-manage.html?${n.toString()}`},closeJobsArea(){const e=document.getElementById("jobs-manage-area");e&&(e.style.display="none"),this.currentJobCompanyDomain=null,this.currentJobSheetUrl=null,this.jobsCache=[]},async loadJobsData(e){const t=document.getElementById("jobs-tbody");if(!t)return;t.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';const n=this.companiesCache?.find(t=>t.companyDomain===e);if(console.log("[loadJobsData] companyDomain:",e),console.log("[loadJobsData] company:",n),console.log("[loadJobsData] manageSheetUrl:",n?.manageSheetUrl),n&&n.manageSheetUrl)try{const n=this.spreadsheetConfig.gasApiUrl;if(console.log("[loadJobsData] gasApiUrl:",n),!n)throw new Error("GAS API URLが設定されていません");const a=`${n}?action=getJobs&domain=${encodeURIComponent(e)}`;console.log("[loadJobsData] request URL:",a);const o=await fetch(a);if(!o.ok)throw new Error("データの取得に失敗しました");const s=await o.json();if(!s.success)throw new Error(s.error||"求人データの取得に失敗しました");if(this.jobsCache=s.jobs||[],0===this.jobsCache.length)return void(t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>');this.renderJobsTable()}catch(e){console.error("求人データの読み込みエラー:",e),t.innerHTML=`<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました: ${this.escapeHtml(e.message)}</td></tr>`}else t.innerHTML='<tr><td colspan="6" class="loading-cell">管理シートが設定されていません</td></tr>'},parseJobsCSV(e){const t=e.split("\n");if(t.length<3)return[];const n=this.parseCSVLine(t[0]||""),a=[];for(let e=2;e<t.length;e++){if(!t[e].trim())continue;const o=this.parseCSVLine(t[e]),s={_rowIndex:e+1};n.forEach((e,t)=>{const n=e.replace(/"/g,"").trim();s[n]=o[t]||""}),(s.id||s.title)&&a.push(s)}return a},renderJobsTable(){const e=document.getElementById("jobs-tbody");if(!e)return;const t=this.jobsCache||[];0!==t.length?e.innerHTML=t.map(e=>{const t=e.monthlySalary?`¥${Number(e.monthlySalary).toLocaleString()}`:"-",n="true"===e.visible||"TRUE"===e.visible||!0===e.visible;return`\n        <tr data-row="${e._rowIndex}">\n          <td>${this.escapeHtml(e.id||"-")}</td>\n          <td>${this.escapeHtml(e.title||"-")}</td>\n          <td>${this.escapeHtml(e.location||"-")}</td>\n          <td>${t}</td>\n          <td>${n?'<span class="badge success">公開</span>':'<span class="badge">非公開</span>'}</td>\n          <td>\n            <div class="action-buttons">\n              <button class="btn-small btn-edit" onclick="AdminDashboard.editJob(${e._rowIndex})">編集</button>\n            </div>\n          </td>\n        </tr>\n      `}).join(""):e.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>'},showJobModal(){this.currentEditingJob=null,this.isNewJob=!0,document.getElementById("job-modal-title").textContent="新規求人作成",document.getElementById("edit-job-title").value="",document.getElementById("edit-job-location").value="",document.getElementById("edit-job-salary").value="",document.getElementById("edit-job-bonus").value="",document.getElementById("edit-job-order").value="",document.getElementById("edit-job-features").value="",document.getElementById("edit-job-badges").value="",document.getElementById("edit-job-description").value="",document.getElementById("edit-job-requirements").value="",document.getElementById("edit-job-benefits").value="",document.getElementById("edit-job-hours").value="",document.getElementById("edit-job-holidays").value="",document.getElementById("edit-job-start-date").value="",document.getElementById("edit-job-end-date").value="",document.getElementById("edit-job-visible").checked=!0,document.getElementById("job-modal-delete").style.display="none",document.getElementById("job-modal").style.display="flex"},editJob(e){const t=this.jobsCache?.find(t=>t._rowIndex===e);if(t){if(this.currentEditingJob=t,this.isNewJob=!1,document.getElementById("job-modal-title").textContent="求人情報の編集",document.getElementById("edit-job-title").value=t.title||"",document.getElementById("edit-job-location").value=t.location||"",document.getElementById("edit-job-salary").value=t.monthlySalary||"",document.getElementById("edit-job-bonus").value=t.totalBonus||"",document.getElementById("edit-job-order").value=t.order||"",document.getElementById("edit-job-features").value=t.features||"",document.getElementById("edit-job-badges").value=t.badges||"",document.getElementById("edit-job-description").value=t.jobDescription||"",document.getElementById("edit-job-requirements").value=t.requirements||"",document.getElementById("edit-job-benefits").value=t.benefits||"",document.getElementById("edit-job-hours").value=t.workingHours||"",document.getElementById("edit-job-holidays").value=t.holidays||"",t.publishStartDate){const e=this.formatDateForInput(t.publishStartDate);document.getElementById("edit-job-start-date").value=e}else document.getElementById("edit-job-start-date").value="";if(t.publishEndDate){const e=this.formatDateForInput(t.publishEndDate);document.getElementById("edit-job-end-date").value=e}else document.getElementById("edit-job-end-date").value="";document.getElementById("edit-job-visible").checked="true"===t.visible||"TRUE"===t.visible||!0===t.visible,document.getElementById("job-modal-delete").style.display="",document.getElementById("job-modal").style.display="flex"}else alert("求人データが見つかりません")},formatDateForInput(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},closeJobModal(){document.getElementById("job-modal").style.display="none",this.currentEditingJob=null,this.isNewJob=!1},async saveJobData(){if(!this.currentJobCompanyDomain)return void alert("会社が選択されていません");const e={title:document.getElementById("edit-job-title").value.trim(),location:document.getElementById("edit-job-location").value.trim(),monthlySalary:document.getElementById("edit-job-salary").value||"",totalBonus:document.getElementById("edit-job-bonus").value||"",order:document.getElementById("edit-job-order").value||"",features:document.getElementById("edit-job-features").value.trim(),badges:document.getElementById("edit-job-badges").value.trim(),jobDescription:document.getElementById("edit-job-description").value.trim(),requirements:document.getElementById("edit-job-requirements").value.trim(),benefits:document.getElementById("edit-job-benefits").value.trim(),workingHours:document.getElementById("edit-job-hours").value.trim(),holidays:document.getElementById("edit-job-holidays").value.trim(),publishStartDate:document.getElementById("edit-job-start-date").value||"",publishEndDate:document.getElementById("edit-job-end-date").value||"",visible:document.getElementById("edit-job-visible").checked?"true":"false"};if(!e.title||!e.location)return void alert("募集タイトルと勤務地は必須です");const t=this.spreadsheetConfig.gasApiUrl;if(t)try{const n=document.getElementById("job-modal-save");n&&(n.disabled=!0,n.textContent="保存中...");const a=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveJob",companyDomain:this.currentJobCompanyDomain,job:e,rowIndex:this.isNewJob?null:this.currentEditingJob._rowIndex})))),o=`${t}?action=post&data=${encodeURIComponent(a)}`,s=await fetch(o,{method:"GET",redirect:"follow"}),i=await s.text();let l;try{l=JSON.parse(i)}catch(e){throw console.error("JSON parse error:",e),n&&(n.disabled=!1,n.textContent="保存"),new Error(`GASからの応答が不正です: ${i.substring(0,200)}`)}if(n&&(n.disabled=!1,n.textContent="保存"),!l.success)return void alert("保存に失敗しました: "+(l.error||"不明なエラー"));this.closeJobModal(),await this.loadJobsData(this.currentJobCompanyDomain),alert(this.isNewJob?"求人を作成しました":"求人情報を更新しました")}catch(e){console.error("求人保存エラー:",e),alert("保存中にエラーが発生しました: "+e.message)}else alert("GAS API URLが設定されていません。設定画面でURLを設定してください。")},async deleteJob(){if(!this.currentEditingJob||!this.currentJobCompanyDomain)return void alert("削除対象が選択されていません");if(!confirm("この求人を削除してもよろしいですか？"))return;const e=this.spreadsheetConfig.gasApiUrl;if(e)try{const t=document.getElementById("job-modal-delete");t&&(t.disabled=!0,t.textContent="削除中...");const n=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteJob",companyDomain:this.currentJobCompanyDomain,rowIndex:this.currentEditingJob._rowIndex})))),a=`${e}?action=post&data=${encodeURIComponent(n)}`,o=await fetch(a,{method:"GET",redirect:"follow"}),s=await o.text();let i;try{i=JSON.parse(s)}catch(e){throw console.error("JSON parse error:",e),t&&(t.disabled=!1,t.textContent="削除"),new Error("GASからの応答が不正です")}if(t&&(t.disabled=!1,t.textContent="削除"),!i.success)return void alert("削除に失敗しました: "+(i.error||"不明なエラー"));this.closeJobModal(),await this.loadJobsData(this.currentJobCompanyDomain),alert("求人を削除しました")}catch(e){console.error("求人削除エラー:",e),alert("削除中にエラーが発生しました: "+e.message)}else alert("GAS API URLが設定されていません")}};document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("admin_password");e&&(AdminDashboard.config.credentials.password=e);const t=document.getElementById("api-endpoint");t&&(t.value=localStorage.getItem("api_endpoint")||"");const n=document.getElementById("gas-api-url");n&&(n.value=localStorage.getItem("gas_api_url")||""),AdminDashboard.spreadsheetConfig.gasApiUrl=localStorage.getItem("gas_api_url")||"",AdminDashboard.init()});