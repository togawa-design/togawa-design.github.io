import"./modulepreload-polyfill-YP0FEG5d.js";import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";import{getAuth as t,onAuthStateChanged as o}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";const a=t(e({apiKey:"AIzaSyAwu1j__Vp4fgAJP0BPZhLEMw3lVuLpywk",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4",storageBucket:"generated-area-484613-e3-90bd4.firebasestorage.app",messagingSenderId:"901344407156",appId:"1:901344407156:web:81de9efbc30fd44ab16649"}));function n(e){document.getElementById("loading").style.display="none",document.getElementById("error").style.display="block",document.getElementById("error-message").textContent=e,document.querySelector("#error .close-btn").style.display="inline-block"}!async function(){const e=new URLSearchParams(window.location.search),t=e.get("code"),r=e.get("state"),s=e.get("error");if(s)return void n("Googleからのエラー: "+s);if(!t||!r)return void n("認可コードまたはステートが見つかりません");let c;try{c=JSON.parse(atob(r))}catch(m){return void n("ステートの解析に失敗しました")}const{companyDomain:i,companyUserId:d,staffName:l,csrf:p}=c;o(a,async e=>{if(e)try{const o=await e.getIdToken(),a=await fetch("https://asia-northeast1-generated-area-484613-e3-90bd4.cloudfunctions.net/exchangeCalendarToken",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({code:t,companyDomain:i,companyUserId:d,staffName:l})});if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(e.error||"トークン交換に失敗しました")}document.getElementById("loading").style.display="none",document.getElementById("success").style.display="block",document.querySelector("#success .close-btn").style.display="inline-block",window.opener&&window.opener.postMessage({type:"CALENDAR_CONNECTED"},"*"),setTimeout(()=>{window.close()},3e3)}catch(o){console.error("Token exchange error:",o),n(o.message||"連携処理中にエラーが発生しました")}else n("ログインが必要です。メイン画面からやり直してください。")})}();
