import"./modulepreload-polyfill-YP0FEG5d.js";import{e}from"./utils-BE8OECDH.js";import{Q as t,u as n,C as o,D as a,s,t as l,b as i,R as d,S as c,T as r,U as u,V as m,d as p,r as g,W as y,X as b,Y as f,n as v}from"./job-feed-generator-BBEmU1ix.js";import"./LPEditor-Cg7IJGVU.js";import"./image-uploader-CwR9OqLI.js";import"./jobs-loader-CIZMoLrM.js";const h={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"};let E=null,I=[],w=[],j=1;let B=null,L=[];const $={new:"新規",contacted:"連絡済み",interviewing:"面接調整中",interviewed:"面接済み",hired:"採用",rejected:"不採用",withdrawn:"辞退"},x={apply:"応募",line:"LINE相談",consult:"お問い合わせ"},k={immediate:"すぐにでも","within-week":"1週間以内","within-month":"1ヶ月以内","within-2months":"2ヶ月以内",undecided:"未定・相談したい"},S={first_contact:{subject:"初回連絡",body:"{applicantName}様\n\nこの度は「{jobTitle}」にご応募いただき、誠にありがとうございます。\n\nご応募内容を確認させていただきました。\nつきましては、一度お電話にてお話をさせていただければと思います。\n\nご都合の良い日時をいくつかお知らせいただけますでしょうか。\n（平日10:00〜18:00の間でお願いできますと幸いです）\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n何卒よろしくお願いいたします。"},schedule_interview:{subject:"面接日程調整",body:"{applicantName}様\n\nお世話になっております。\n\n面接の日程調整についてご連絡いたします。\n\n下記の日程でご都合の良い日時はございますでしょうか。\n\n【候補日】\n・◯月◯日（◯）◯◯:00〜\n・◯月◯日（◯）◯◯:00〜\n・◯月◯日（◯）◯◯:00〜\n\n上記以外でもご調整可能ですので、ご希望の日時がございましたらお知らせください。\n\n何卒よろしくお願いいたします。"},interview_reminder:{subject:"面接リマインダー",body:"{applicantName}様\n\nお世話になっております。\n\n面接日程のリマインドをお送りいたします。\n\n【面接日時】◯月◯日（◯）◯◯:00〜\n【場所】〒◯◯◯-◯◯◯◯ ◯◯県◯◯市◯◯\n【持ち物】履歴書、筆記用具\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n当日お会いできることを楽しみにしております。"},document_request:{subject:"書類提出依頼",body:"{applicantName}様\n\nお世話になっております。\n\n選考を進めるにあたり、下記の書類をご提出いただけますでしょうか。\n\n【提出書類】\n・履歴書（写真貼付）\n・職務経歴書\n\n【提出方法】\nマイページからアップロード、またはメールにてご送付ください。\n\n【提出期限】\n◯月◯日（◯）まで\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n何卒よろしくお願いいたします。"},result_pending:{subject:"選考結果待ち",body:"{applicantName}様\n\nお世話になっております。\n\n先日は面接にお越しいただき、誠にありがとうございました。\n\n現在、社内にて選考を進めております。\n結果につきましては、◯月◯日頃までにご連絡させていただく予定です。\n\n今しばらくお待ちいただけますようお願い申し上げます。"},offer:{subject:"内定通知",body:"{applicantName}様\n\nお世話になっております。\n\nこの度は「{jobTitle}」の選考にご参加いただき、誠にありがとうございました。\n\n慎重に検討させていただいた結果、{applicantName}様を採用させていただくことになりました。\n\nつきましては、入社に関する詳細についてご説明させていただきたく、\nお電話にてご連絡させていただきます。\n\nご不明な点がございましたら、お気軽にお問い合わせください。\n{applicantName}様と一緒に働けることを楽しみにしております。"},rejection:{subject:"不採用通知",body:"{applicantName}様\n\nお世話になっております。\n\nこの度は「{jobTitle}」にご応募いただき、誠にありがとうございました。\n\n慎重に検討させていただきましたが、誠に残念ながら今回はご期待に沿えない結果となりました。\n\nご応募いただいたことに心より感謝申し上げますとともに、\n{applicantName}様の今後のご活躍をお祈り申し上げます。"}};function T(){return firebase.apps.length||firebase.initializeApp(h),firebase.firestore()}function D(){const t=document.getElementById("detail-assignee");if(t){const n=t.value;t.innerHTML='<option value="">未割当</option>'+L.map(t=>`<option value="${e(t)}">${e(t)}</option>`).join(""),t.value=n}}async function C(){var e;const t=document.getElementById("new-assignee-name"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(n)if(L.includes(n))alert("この担当者は既に登録されています");else try{const e=T().collection("settings").doc(E||"global");L.push(n),await e.set({assignees:L,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),D(),M();const t=document.getElementById("detail-assignee");t&&(t.value=n)}catch(o){console.error("Failed to add assignee:",o),alert("担当者の追加に失敗しました: "+o.message)}else alert("担当者名を入力してください")}function A(){const e=document.getElementById("assignee-modal"),t=document.getElementById("new-assignee-name");e&&(e.style.display="flex"),t&&(t.value="",t.focus())}function M(){const e=document.getElementById("assignee-modal");e&&(e.style.display="none")}async function H(){const e=document.getElementById("applicants-list");e&&(e.innerHTML='<div class="loading-message">データを読み込み中...</div>');try{let e=T().collection("applications");E&&(e=e.where("companyDomain","==",E)),e=e.orderBy("createdAt","desc");const t=await e.get();I=[],t.forEach(e=>{I.push({id:e.id,...e.data()})}),_(),P()}catch(t){console.error("Failed to load applicants:",t),e&&(e.innerHTML='<div class="empty-message">データの読み込みに失敗しました</div>')}}function _(){var e,t,n,o;const a=(null==(e=document.getElementById("filter-status"))?void 0:e.value)||"",s=(null==(t=document.getElementById("filter-type"))?void 0:t.value)||"",l=(null==(o=null==(n=document.getElementById("filter-search"))?void 0:n.value)?void 0:o.toLowerCase())||"";w=I.filter(e=>{var t;if(a&&(e.status||"new")!==a)return!1;if(s&&e.type!==s)return!1;if(l){const n=(e.jobTitle||"").toLowerCase(),o=(e.applicantName||(null==(t=e.applicant)?void 0:t.name)||"").toLowerCase();if(!n.includes(l)&&!o.includes(l))return!1}return!0}),j=1,q(),U()}function P(){const e=I.length,t=I.filter(e=>!e.status||"new"===e.status).length,n=I.filter(e=>["contacted","interviewing","interviewed"].includes(e.status)).length,o=I.filter(e=>["hired","rejected","withdrawn"].includes(e.status)).length,a=document.getElementById("stat-total"),s=document.getElementById("stat-new"),l=document.getElementById("stat-progress"),i=document.getElementById("stat-complete");a&&(a.textContent=e),s&&(s.textContent=t),l&&(l.textContent=n),i&&(i.textContent=o)}function q(){const t=document.getElementById("applicants-list");if(!t)return;if(0===w.length)return void(t.innerHTML='<div class="empty-message">応募データがありません</div>');const n=20*(j-1),o=n+20,a=w.slice(n,o);t.innerHTML=a.map(t=>{var n,o;const a=V((null==(n=t.createdAt)?void 0:n.toDate)?t.createdAt.toDate():new Date(t.timestamp||t.createdAt)),s=t.status||"new",l=x[t.type]||t.type||"-",i=$[s]||s,d=t.applicantName||(null==(o=t.applicant)?void 0:o.name)||"-",c=B===t.id;let r="type-apply";return"line"===t.type&&(r="type-line"),"consult"===t.type&&(r="type-consult"),`\n      <div class="applicant-card ${c?"selected":""}" data-id="${e(t.id)}">\n        <div class="applicant-card-main">\n          <div class="applicant-card-header">\n            <span class="applicant-card-name">${e(d)}</span>\n            <span class="applicant-card-type ${r}">${e(l)}</span>\n          </div>\n          <div class="applicant-card-job">${e(t.jobTitle||"-")}</div>\n          <div class="applicant-card-meta">\n            <span>${e(a)}</span>\n            ${t.assignee?`<span>担当: ${e(t.assignee)}</span>`:""}\n          </div>\n        </div>\n        <div class="applicant-card-status">\n          <span class="status-badge status-${e(s)}">${e(i)}</span>\n        </div>\n      </div>\n    `}).join(""),t.querySelectorAll(".applicant-card").forEach(e=>{e.addEventListener("click",()=>{!function(e){var t,n,o,a,s,l,i;const d=I.find(t=>t.id===e);if(!d)return;B=e,document.querySelectorAll(".applicant-card").forEach(t=>{t.classList.toggle("selected",t.dataset.id===e)});const c=document.getElementById("detail-empty"),r=document.getElementById("detail-content");c&&(c.style.display="none");r&&(r.style.display="flex");const u=d.applicantName||(null==(t=d.applicant)?void 0:t.name)||"-",m=d.applicantPhone||(null==(n=d.applicant)?void 0:n.phone)||"-",p=d.applicantEmail||(null==(o=d.applicant)?void 0:o.email)||"-",g=(null==(a=d.applicant)?void 0:a.age)||"-",y=(null==(s=d.applicant)?void 0:s.address)||"-",b=(null==(l=d.applicant)?void 0:l.startDate)||"-";document.getElementById("detail-name").textContent=u,document.getElementById("detail-job-title").textContent=d.jobTitle||"-",document.getElementById("detail-phone").textContent=m,document.getElementById("detail-email").textContent=p,document.getElementById("detail-age").textContent=g,document.getElementById("detail-address").textContent=y,document.getElementById("detail-start-date").textContent=k[b]||b;const f=(null==(i=d.createdAt)?void 0:i.toDate)?d.createdAt.toDate():new Date(d.timestamp||d.createdAt);document.getElementById("detail-datetime").textContent=V(f,!0),document.getElementById("detail-type").textContent=x[d.type]||d.type||"-",document.getElementById("detail-source").textContent=Y(d.source);const v=d.status||"new";document.querySelectorAll(".status-btn").forEach(e=>{e.classList.toggle("active",e.dataset.status===v)});const h=document.getElementById("detail-assignee");h&&(h.value=d.assignee||"");const E=document.getElementById("detail-notes");E&&(E.value=d.notes||"");F(d.history||[]),O(e)}(e.dataset.id)})})}function U(){const e=document.getElementById("pagination");if(!e)return;const t=Math.ceil(w.length/20);if(t<=1)return void(e.innerHTML="");let n="";n+=`<button class="page-btn" ${1===j?"disabled":""} data-page="${j-1}">前へ</button>`;for(let o=1;o<=t;o++)1===o||o===t||o>=j-2&&o<=j+2?n+=`<button class="page-btn ${o===j?"active":""}" data-page="${o}">${o}</button>`:o!==j-3&&o!==j+3||(n+='<span class="page-ellipsis">...</span>');n+=`<button class="page-btn" ${j===t?"disabled":""} data-page="${j+1}">次へ</button>`,e.innerHTML=n,e.querySelectorAll(".page-btn").forEach(e=>{e.addEventListener("click",()=>{e.disabled||(j=parseInt(e.dataset.page),q(),U())})})}function N(){B=null,document.querySelectorAll(".applicant-card").forEach(e=>{e.classList.remove("selected")});const e=document.getElementById("detail-empty"),t=document.getElementById("detail-content");e&&(e.style.display="flex"),t&&(t.style.display="none")}async function O(t){const n=document.getElementById("messages-container");if(n){n.innerHTML='<p class="no-data">読み込み中...</p>';try{const n=T(),o=await n.collection("messages").where("applicationId","==",t).orderBy("createdAt","asc").get(),a=[];o.forEach(e=>{a.push({id:e.id,...e.data()})}),function(t){const n=document.getElementById("messages-container");if(!n)return;if(!t||0===t.length)return void(n.innerHTML='<p class="no-data">メッセージはありません</p>');n.innerHTML=t.map(t=>{var n;const o=(null==(n=t.createdAt)?void 0:n.toDate)?t.createdAt.toDate():new Date(t.createdAt),a="company"===t.from;return`\n      <div class="message-item ${a?"message-company":"message-applicant"}">\n        <div class="message-header">\n          <span class="message-sender">${e(a?"会社":"応募者")}</span>\n          <span class="message-date">${V(o,!0)}</span>\n        </div>\n        <div class="message-content">${e(t.content).replace(/\n/g,"<br>")}</div>\n      </div>\n    `}).join(""),n.scrollTop=n.scrollHeight}(a)}catch(o){console.error("Failed to load messages:",o),n.innerHTML='<p class="no-data">メッセージの読み込みに失敗しました</p>'}}}async function X(){var e;if(!B)return;const t=document.getElementById("new-message-text"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(!n)return void alert("メッセージを入力してください");const o=document.getElementById("btn-send-message");o&&(o.disabled=!0,o.textContent="送信中...");try{const e=T(),o=I.find(e=>e.id===B);await e.collection("messages").add({applicationId:B,companyDomain:(null==o?void 0:o.companyDomain)||E,from:"company",content:n,read:!1,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),t.value="",await O(B)}catch(a){console.error("Failed to send message:",a),alert("メッセージの送信に失敗しました: "+a.message)}finally{o&&(o.disabled=!1,o.textContent="送信")}}function F(t){const n=document.getElementById("detail-history");n&&(t&&0!==t.length?n.innerHTML=t.map(t=>{var n;return`\n      <div class="history-item">\n        <div class="history-date">${V((null==(n=t.date)?void 0:n.toDate)?t.date.toDate():new Date(t.date),!0)}</div>\n        <div class="history-text">${e(t.text)}</div>\n      </div>\n    `}).join(""):n.innerHTML='<p class="no-data">対応履歴はありません</p>')}async function R(){var e,t;if(!B)return;const n=(null==(e=document.getElementById("detail-notes"))?void 0:e.value)||"",o=(null==(t=document.getElementById("detail-assignee"))?void 0:t.value)||"",a=document.getElementById("btn-save-notes");a&&(a.disabled=!0,a.textContent="保存中...");try{const e=T();await e.collection("applications").doc(B).update({notes:n,assignee:o,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const t=I.findIndex(e=>e.id===B);-1!==t&&(I[t].notes=n,I[t].assignee=o),q()}catch(s){console.error("Failed to save notes:",s),alert("保存に失敗しました")}finally{a&&(a.disabled=!1,a.textContent="保存")}}async function J(){var e;if(!B)return;const t=document.getElementById("new-history-text"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(n)try{const e=T(),o=I.find(e=>e.id===B),a=(null==o?void 0:o.history)||[];a.push({date:new Date,text:n}),await e.collection("applications").doc(B).update({history:a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const s=I.findIndex(e=>e.id===B);-1!==s&&(I[s].history=a),F(a),t.value=""}catch(o){console.error("Failed to add history:",o),alert("履歴の追加に失敗しました: "+o.message)}else alert("対応内容を入力してください")}function G(){if(0===w.length)return void alert("エクスポートするデータがありません");const e=w.map(e=>{var t,n,o,a,s,l,i;const d=(null==(t=e.createdAt)?void 0:t.toDate)?e.createdAt.toDate():new Date(e.timestamp||e.createdAt),c=e.applicantName||(null==(n=e.applicant)?void 0:n.name)||"",r=e.applicantPhone||(null==(o=e.applicant)?void 0:o.phone)||"",u=e.applicantEmail||(null==(a=e.applicant)?void 0:a.email)||"",m=(null==(s=e.applicant)?void 0:s.age)||"",p=(null==(l=e.applicant)?void 0:l.address)||"",g=(null==(i=e.applicant)?void 0:i.startDate)||"";return[V(d,!0),x[e.type]||e.type||"",c,r,u,m,p,k[g]||g,e.jobTitle||"",Y(e.source),$[e.status||"new"],e.assignee||"",(e.notes||"").replace(/"/g,'""')]}),t=[["日時","種別","応募者名","電話番号","メール","年齢","現住所","希望勤務開始日","求人タイトル","流入元","ステータス","担当者","メモ"].join(","),...e.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),n=new Blob(["\ufeff"+t],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`applicants-${E||"all"}-${function(e){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}${n}${o}`}(new Date)}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o)}function V(e,t=!1){if(!e||isNaN(e.getTime()))return"-";const n=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");if(!t)return`${n}/${o}/${a}`;return`${n}/${o}/${a} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}function Y(e){if(!e||"direct"===e)return"直接アクセス";try{const t=new URL(e).hostname;return t.includes("google")?"Google検索":t.includes("yahoo")?"Yahoo!検索":t.includes("tiktok")?"TikTok広告":t.includes("instagram")||t.includes("fb")||t.includes("facebook")?"Meta広告":t.includes("twitter")||t.includes("x.com")?"X(Twitter)":t.includes("line")?"LINE":t}catch{return e||"不明"}}function K(){var e,t,n,o,a,s,l,i,d,c,r,u,m,p,g,y,b,f,v;let h;null==(e=document.getElementById("btn-refresh"))||e.addEventListener("click",H),null==(t=document.getElementById("btn-refresh-applicants"))||t.addEventListener("click",H),null==(n=document.getElementById("btn-export-csv"))||n.addEventListener("click",G),null==(o=document.getElementById("filter-status"))||o.addEventListener("change",_),null==(a=document.getElementById("filter-type"))||a.addEventListener("change",_),null==(s=document.getElementById("filter-search"))||s.addEventListener("input",()=>{clearTimeout(h),h=setTimeout(_,300)}),null==(l=document.getElementById("btn-close-detail"))||l.addEventListener("click",N),document.querySelectorAll(".status-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.status;t&&async function(e){if(B)try{const t=T();await t.collection("applications").doc(B).update({status:e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const n=I.findIndex(e=>e.id===B);-1!==n&&(I[n].status=e),document.querySelectorAll(".status-btn").forEach(t=>{t.classList.toggle("active",t.dataset.status===e)}),_(),P()}catch(t){console.error("Failed to update status:",t),alert("ステータスの更新に失敗しました")}}(t)})}),null==(i=document.getElementById("btn-save-notes"))||i.addEventListener("click",R),null==(d=document.getElementById("btn-add-history"))||d.addEventListener("click",J),null==(c=document.getElementById("new-history-text"))||c.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),J())}),null==(r=document.getElementById("btn-send-message"))||r.addEventListener("click",X),null==(u=document.getElementById("new-message-text"))||u.addEventListener("keydown",e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),X())}),null==(m=document.getElementById("message-template-select"))||m.addEventListener("change",e=>{!function(e){var t;if(!e)return;const n=S[e];if(!n)return;const o=I.find(e=>e.id===B);if(!o)return;const a=o.applicantName||(null==(t=o.applicant)?void 0:t.name)||"お客様",s=o.jobTitle||"求人";let l=n.body.replace(/{applicantName}/g,a).replace(/{jobTitle}/g,s);const i=document.getElementById("new-message-text");i&&(i.value=l,i.focus());const d=document.getElementById("message-template-select");d&&(d.value="")}(e.target.value)}),null==(p=document.getElementById("btn-add-assignee"))||p.addEventListener("click",A),null==(g=document.getElementById("assignee-modal-close"))||g.addEventListener("click",M),null==(y=document.getElementById("assignee-modal-cancel"))||y.addEventListener("click",M),null==(b=document.getElementById("assignee-modal-save"))||b.addEventListener("click",C),null==(f=document.getElementById("assignee-modal"))||f.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&M()}),null==(v=document.getElementById("new-assignee-name"))||v.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),C())})}async function z(e,t){E=e,K(),await async function(){try{const e=T().collection("settings").doc(E||"global"),t=await e.get();L=t.exists&&t.data().assignees?t.data().assignees:[],D()}catch(e){console.error("Failed to load assignees:",e),L=[]}}(),await H()}const Z="https://script.google.com/macros/s/AKfycbxj6CqSfY7jq04uDXURhewD_BAKx3csLKBpl1hdRBdNg-R-E6IuoaZGje22Gr9WYWY2/exec",W={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"},Q="rikueco_admin_session",ee="rikueco_user_role",te="rikueco_user_company",ne="admin";function oe(){return sessionStorage.getItem(ee)===ne}function ae(e){return!!oe()||sessionStorage.getItem(te)===e}let se=null,le=null,ie=null,de=[],ce=null,re=!1,ue=[],me=null,pe=null;function ge(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async function ye(){const t=document.getElementById("jobs-tbody");if(!t)return;t.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';const n=Z;try{const o=`${n}?action=getJobs&domain=${encodeURIComponent(se)}`,a=await fetch(o);if(!a.ok)throw new Error("データの取得に失敗しました");const s=await a.json();if(!s.success)throw new Error(s.error||"求人データの取得に失敗しました");if(de=s.jobs||[],s.sheetUrl&&!ie&&(ie=s.sheetUrl),s.manageSheetUrl&&!ie&&(ie=s.manageSheetUrl),0===de.length)return void(t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>');!function(){const t=document.getElementById("jobs-tbody");if(!t)return;const n=de||[];0!==n.length?(t.innerHTML=n.map(t=>{const n=t.monthlySalary?`¥${Number(t.monthlySalary).toLocaleString()}`:"-",o="true"===t.visible||"TRUE"===t.visible||!0===t.visible;return`\n      <tr data-row="${t._rowIndex}">\n        <td>${e(t.id||"-")}</td>\n        <td>${e(t.title||"-")}</td>\n        <td>${e(t.location||"-")}</td>\n        <td>${n}</td>\n        <td>${o?'<span class="badge success">公開</span>':'<span class="badge">非公開</span>'}</td>\n        <td>\n          <div class="action-buttons">\n            <button class="btn-small btn-edit" data-row="${t._rowIndex}">編集</button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),t.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{fe(parseInt(e.dataset.row,10))})})):t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>'}()}catch(o){console.error("求人データの読み込みエラー:",o),t.innerHTML=`<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました: ${e(o.message)}</td></tr>`}}function be(){ce=null,re=!0;const e=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t)};document.getElementById("job-modal-title").textContent="新規求人作成",e("edit-job-title",""),e("edit-job-location",""),e("edit-job-salary",""),e("edit-job-bonus",""),e("edit-job-order",""),e("edit-job-type",""),e("edit-job-features",""),e("edit-job-badges",""),e("edit-job-description",""),e("edit-job-requirements",""),e("edit-job-benefits",""),e("edit-job-hours",""),e("edit-job-holidays",""),e("edit-job-start-date",""),e("edit-job-end-date","");const t=document.getElementById("edit-job-visible");t&&(t.checked=!0);const n=document.getElementById("job-modal-delete");n&&(n.style.display="none");const o=document.getElementById("job-modal");o&&(o.style.display="flex")}function fe(e){const t=null==de?void 0:de.find(t=>t._rowIndex===e);if(!t)return void alert("求人データが見つかりません");ce=t,re=!1;const n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};document.getElementById("job-modal-title").textContent="求人情報の編集",n("edit-job-title",t.title),n("edit-job-location",t.location),n("edit-job-salary",t.monthlySalary),n("edit-job-bonus",t.totalBonus),n("edit-job-order",t.order),n("edit-job-type",t.jobType),n("edit-job-features",t.features),n("edit-job-badges",t.badges),n("edit-job-description",t.jobDescription),n("edit-job-requirements",t.requirements),n("edit-job-benefits",t.benefits),n("edit-job-hours",t.workingHours),n("edit-job-holidays",t.holidays),t.publishStartDate?n("edit-job-start-date",ge(t.publishStartDate)):n("edit-job-start-date",""),t.publishEndDate?n("edit-job-end-date",ge(t.publishEndDate)):n("edit-job-end-date","");const o=document.getElementById("edit-job-visible");o&&(o.checked="true"===t.visible||"TRUE"===t.visible||!0===t.visible);const a=document.getElementById("job-modal-delete");a&&(a.style.display="");const s=document.getElementById("job-modal");s&&(s.style.display="flex")}function ve(){const e=document.getElementById("job-modal");e&&(e.style.display="none"),ce=null,re=!1}async function he(){var e;if(!se)return void alert("会社が選択されていません");const t=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},n={id:re?"":(null==ce?void 0:ce.id)||"",title:t("edit-job-title"),location:t("edit-job-location"),monthlySalary:t("edit-job-salary"),totalBonus:t("edit-job-bonus"),order:t("edit-job-order"),jobType:t("edit-job-type"),features:t("edit-job-features"),badges:t("edit-job-badges"),jobDescription:t("edit-job-description"),requirements:t("edit-job-requirements"),benefits:t("edit-job-benefits"),workingHours:t("edit-job-hours"),holidays:t("edit-job-holidays"),publishStartDate:t("edit-job-start-date"),publishEndDate:t("edit-job-end-date"),visible:(null==(e=document.getElementById("edit-job-visible"))?void 0:e.checked)?"true":"false"};if(!n.title||!n.location)return void alert("募集タイトルと勤務地は必須です");const o=Z,a=document.getElementById("job-modal-save");try{a&&(a.disabled=!0,a.textContent="保存中...");const e=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveJob",companyDomain:se,job:n,rowIndex:re?null:ce._rowIndex})))),t=`${o}?action=post&data=${encodeURIComponent(e)}`,l=await fetch(t,{method:"GET",redirect:"follow"}),i=await l.text();let d;try{d=JSON.parse(i)}catch(s){throw console.error("JSON parse error:",s),new Error(`GASからの応答が不正です: ${i.substring(0,200)}`)}if(!d.success)return void alert("保存に失敗しました: "+(d.error||"不明なエラー"));ve(),await ye(),alert(re?"求人を作成しました":"求人情報を更新しました")}catch(l){console.error("求人保存エラー:",l),alert("保存中にエラーが発生しました: "+l.message)}finally{a&&(a.disabled=!1,a.textContent="保存")}}async function Ee(){if(!ce||!se)return void alert("削除対象が選択されていません");if(!confirm("この求人を削除してもよろしいですか？"))return;const e=Z,t=document.getElementById("job-modal-delete");try{t&&(t.disabled=!0,t.textContent="削除中...");const o=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteJob",companyDomain:se,rowIndex:ce._rowIndex})))),a=`${e}?action=post&data=${encodeURIComponent(o)}`,s=await fetch(a,{method:"GET",redirect:"follow"}),l=await s.text();let i;try{i=JSON.parse(l)}catch(n){throw console.error("JSON parse error:",n),new Error("GASからの応答が不正です")}if(!i.success)return void alert("削除に失敗しました: "+(i.error||"不明なエラー"));ve(),await ye(),alert("求人を削除しました")}catch(o){console.error("求人削除エラー:",o),alert("削除中にエラーが発生しました: "+o.message)}finally{t&&(t.disabled=!1,t.textContent="削除")}}function Ie(){return de.filter(e=>("true"===e.visible||"TRUE"===e.visible||!0===e.visible)&&e.title).map(e=>({...e,company:le,companyDomain:se,companyAddress:e.location||""}))}function we(){const e=document.getElementById("feed-status");e&&(e.style.display="flex")}function je(){const e=document.getElementById("feed-status");e&&(e.style.display="none")}async function Be(){const e=Ie();if(0!==e.length)try{we();const t=d(e);c(t,`indeed-${se}.xml`,"application/xml")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{je()}else alert("ダウンロードできる求人がありません")}async function Le(){const e=Ie();if(0!==e.length)try{we();const t=r(e);c(t,`google-jobs-${se}.json`,"application/json")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{je()}else alert("ダウンロードできる求人がありません")}async function $e(){const e=Ie();if(0!==e.length)try{we();const t=u(e);c(t,`jobbox-${se}.xml`,"application/xml")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{je()}else alert("ダウンロードできる求人がありません")}async function xe(){const e=Ie();if(0!==e.length)try{we();const t=m(e);c(t,`jobs-${se}.csv`,"text/csv;charset=utf-8")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{je()}else alert("ダウンロードできる求人がありません")}async function ke(){const t=document.getElementById("analytics-period");let n=7;switch((null==t?void 0:t.value)||"7days"){case"7days":n=7;break;case"30days":case"last-month":n=30;break;case"month":n=(new Date).getDate();break}const o=document.getElementById("job-analytics-tbody"),a=document.getElementById("source-analytics-tbody"),s=document.getElementById("device-analytics-tbody");o&&(o.innerHTML='<tr><td colspan="5" class="loading-cell">データを読み込み中...</td></tr>'),a&&(a.innerHTML='<tr><td colspan="3" class="loading-cell">読み込み中...</td></tr>'),s&&(s.innerHTML='<tr><td colspan="3" class="loading-cell">読み込み中...</td></tr>');try{const t="https://asia-northeast1-generated-area-484613-e3.cloudfunctions.net/getAnalyticsData",o=await fetch(`${t}?type=overview&days=${n}`),a=await o.json(),s=await fetch(`${t}?type=traffic&days=${n}`),l=await s.json();let i=null;if(se){const e=await fetch(`${t}?type=company-detail&days=${n}&domain=${encodeURIComponent(se)}`);i=await e.json()}if(!a.success)throw new Error(a.error||"データ取得エラー");pe={overview:a.data,traffic:l.data,companyDetail:null==i?void 0:i.data},function(t){const{overview:n,traffic:o,companyDetail:a}=t;if(se&&a){const e=a.summary||{};document.getElementById("analytics-pv").textContent=(e.totalViews||0).toLocaleString(),document.getElementById("analytics-users").textContent=(e.totalUsers||0).toLocaleString(),document.getElementById("analytics-pages-per-session").textContent=e.avgJobsViewed||"-",document.getElementById("analytics-avg-time").textContent=function(e){if(!e||isNaN(e))return"-";const t=Math.floor(e/60),n=Math.floor(e%60);return t>0?`${t}分${n}秒`:`${n}秒`}(e.avgSessionDuration||0)}else{document.getElementById("analytics-pv").textContent=((null==n?void 0:n.pageViews)||0).toLocaleString(),document.getElementById("analytics-users").textContent=((null==n?void 0:n.users)||0).toLocaleString();const e=(null==n?void 0:n.sessions)||0,t=(null==n?void 0:n.pageViews)||0,o=e>0?(t/e).toFixed(1):"-";document.getElementById("analytics-pages-per-session").textContent=o,document.getElementById("analytics-avg-time").textContent="-"}const s=document.getElementById("job-analytics-tbody");s&&((null==a?void 0:a.jobs)&&a.jobs.length>0?s.innerHTML=a.jobs.map(t=>`\n        <tr>\n          <td>${e(t.jobTitle||t.pagePath||"不明")}</td>\n          <td>${t.views||0}</td>\n          <td>${t.users||"-"}</td>\n          <td>-</td>\n          <td>-</td>\n        </tr>\n      `).join(""):s.innerHTML='\n        <tr>\n          <td colspan="5" class="loading-cell">\n            この会社の求人別データはまだありません。<br>\n            <small>※ GA4でカスタムイベント（view_job_detail）の設定が必要です</small>\n          </td>\n        </tr>\n      ');const l=document.getElementById("source-analytics-tbody");if(l)if(se&&(null==a?void 0:a.traffic)&&a.traffic.length>0){const t=a.traffic,n=t.reduce((e,t)=>e+(t.count||0),0);l.innerHTML=t.slice(0,10).map(t=>{const o=n>0?Math.round(t.count/n*100):0;return`\n          <tr>\n            <td>${e(t.channel||"不明")}</td>\n            <td>${t.count||0}</td>\n            <td>${o}%</td>\n          </tr>\n        `}).join("")}else{const t=(null==o?void 0:o.sources)||[];if(t.length>0){const n=t.reduce((e,t)=>e+(t.sessions||0),0);l.innerHTML=t.slice(0,10).map(t=>{const o=n>0?Math.round(t.sessions/n*100):0;return`\n            <tr>\n              <td>${e(t.source||"(direct)")}</td>\n              <td>${t.sessions||0}</td>\n              <td>${o}%</td>\n            </tr>\n          `}).join("")}else if((null==o?void 0:o.channels)&&o.channels.length>0){const t=o.channels.reduce((e,t)=>e+(t.sessions||0),0);l.innerHTML=o.channels.map(n=>{const o=t>0?Math.round(n.sessions/t*100):0;return`\n            <tr>\n              <td>${e(n.channel||"不明")}</td>\n              <td>${n.sessions||0}</td>\n              <td>${o}%</td>\n            </tr>\n          `}).join("")}else l.innerHTML='<tr><td colspan="3" class="loading-cell">データがありません</td></tr>'}const i=document.getElementById("device-analytics-tbody");if(i){const t=se&&(null==a?void 0:a.devices)?a.devices:(null==o?void 0:o.devices)||[];if(t.length>0){const n=t.reduce((e,t)=>e+(t.sessions||0),0);i.innerHTML=t.map(t=>{const o="mobile"===t.device?"モバイル":"desktop"===t.device?"デスクトップ":"tablet"===t.device?"タブレット":t.device,a=n>0?Math.round(t.sessions/n*100):0;return`\n          <tr>\n            <td>${e(o)}</td>\n            <td>${t.sessions||0}</td>\n            <td>${a}%</td>\n          </tr>\n        `}).join("")}else i.innerHTML='<tr><td colspan="3" class="loading-cell">データがありません</td></tr>'}const d=document.getElementById("analytics-demographics");if(d)if(se&&a){d.style.display="block";const e=a.gender||{},t=e.male||0,n=t+(e.female||0);if(n>0){const e=Math.round(t/n*100),o=100-e,a=document.getElementById("gender-bar-male"),s=document.getElementById("gender-bar-female");a&&(a.style.width=`${e}%`),s&&(s.style.width=`${o}%`);const l=document.getElementById("gender-male-percent"),i=document.getElementById("gender-female-percent");l&&(l.textContent=`${e}%`),i&&(i.textContent=`${o}%`)}else document.getElementById("gender-male-percent").textContent="-",document.getElementById("gender-female-percent").textContent="-";const o=a.age||{},s=document.getElementById("age-bars");if(s){const e=Object.entries(o);if(e.length>0){const t=Math.max(...e.map(([,e])=>e));s.innerHTML=e.map(([e,n])=>`\n              <div class="age-bar-wrapper">\n                <span class="age-bar-value">${n}</span>\n                <div class="age-bar" style="height: ${t>0?Math.max(10,n/t*80):10}px;"></div>\n                <span class="age-bar-label">${e}</span>\n              </div>\n            `).join("")}else s.innerHTML='<p style="color: #94a3b8; font-size: 13px; text-align: center;">データがありません</p>'}}else d.style.display="none"}(pe)}catch(l){console.error("アクセス解析データ取得エラー:",l),function(){document.getElementById("analytics-pv").textContent="- (未連携)",document.getElementById("analytics-users").textContent="-",document.getElementById("analytics-pages-per-session").textContent="-",document.getElementById("analytics-avg-time").textContent="-";const e=document.getElementById("job-analytics-tbody");e&&(e.innerHTML='\n      <tr>\n        <td colspan="5" class="loading-cell">\n          アクセス解析データがありません。<br>\n          Google Analyticsとの連携を設定すると、詳細なアクセスデータを確認できます。\n        </td>\n      </tr>\n    ');const t=document.getElementById("source-analytics-tbody");t&&(t.innerHTML='<tr><td colspan="3" class="loading-cell">データなし</td></tr>');const n=document.getElementById("device-analytics-tbody");n&&(n.innerHTML='<tr><td colspan="3" class="loading-cell">データなし</td></tr>')}()}}async function Se(e,t){if(!se)return[];try{const n=firebase.firestore();return(await n.collection("applications").where("companyDomain","==",se).where("createdAt",">=",e).where("createdAt","<=",t).orderBy("createdAt","desc").get()).docs.map(e=>{var t,n;return{id:e.id,...e.data(),createdAt:(null==(n=null==(t=e.data().createdAt)?void 0:t.toDate)?void 0:n.call(t))||new Date(e.data().createdAt)}})}catch(n){return console.error("応募データ取得エラー:",n),[]}}async function Te(e,t){const n=t.getTime()-e.getTime(),o=new Date(e.getTime()-1),a=new Date(o.getTime()-n);return await Se(a,o)}function De(e){const t={new:"新規",contacted:"連絡済",interviewing:"面接中",hired:"採用",rejected:"不採用",withdrawn:"辞退"},n={};Object.values(t).forEach(e=>{n[e]=0}),e.forEach(e=>{const o=e.status||"new",a=t[o]||"新規";n[a]=(n[a]||0)+1});const o=e.length;return Object.entries(n).map(([e,t])=>({status:e,count:t,percentage:o>0?Math.round(t/o*100):0}))}function Ce(e){const t={google:"Google検索",indeed:"Indeed",jobbox:"求人ボックス",direct:"直接流入",line:"LINE",other:"その他"},n={};e.forEach(e=>{let o=e.source||e.utmSource||"other";o=o.includes("google")?"google":o.includes("indeed")?"indeed":o.includes("jobbox")||o.includes("stanby")?"jobbox":o.includes("line")?"line":"direct"===o||"(direct)"===o?"direct":"other";const a=t[o]||"その他";n[a]=(n[a]||0)+1});const o=e.length;return Object.entries(n).map(([e,t])=>({source:e,count:t,percentage:o>0?Math.round(t/o*100):0})).sort((e,t)=>t.count-e.count)}function Ae(e){const t={};return e.forEach(e=>{const n=e.assignee||"未割当";t[n]||(t[n]={assignee:n,handled:0,pending:0});"new"===(e.status||"new")?t[n].pending++:t[n].handled++}),Object.values(t).sort((e,t)=>t.handled-e.handled)}function Me(t){const{applications:n,comparison:o,period:a}=t,s=n.length,l=o.length,i=l>0?Math.round((s-l)/l*100):0,d=i>=0?`+${i}%`:`${i}%`,c=n.filter(e=>"hired"===e.status).length,r=n.filter(e=>"new"===e.status||"contacted"===e.status).length;document.getElementById("summary-total").textContent=s,document.getElementById("summary-change").textContent=d,document.getElementById("summary-change").className="summary-value "+(i>=0?"positive":"negative"),document.getElementById("summary-hired").textContent=c,document.getElementById("summary-pending").textContent=r;const u=De(n);document.getElementById("status-breakdown").innerHTML=u.map(t=>`\n    <tr>\n      <td>${e(t.status)}</td>\n      <td>${t.count}</td>\n      <td>${t.percentage}%</td>\n    </tr>\n  `).join("");const m=function(e){const t={};return e.forEach(e=>{const n=e.jobId||"unknown",o=e.jobTitle||"不明な求人";t[n]||(t[n]={jobId:n,jobTitle:o,count:0}),t[n].count++}),Object.values(t).sort((e,t)=>t.count-e.count).slice(0,5)}(n),p=document.getElementById("job-performance");0===m.length?p.innerHTML='<tr><td colspan="4">データがありません</td></tr>':p.innerHTML=m.map(t=>{const n=de.find(e=>e.id===t.jobId),o=(null==n?void 0:n.pageViews)||"-",a="-"!==o&&o>0?(t.count/o*100).toFixed(1)+"%":"-";return`\n        <tr>\n          <td>${e(t.jobTitle)}</td>\n          <td>${t.count}</td>\n          <td>${o}</td>\n          <td>${a}</td>\n        </tr>\n      `}).join("");const g=Ce(n),y=document.getElementById("source-breakdown");0===g.length?y.innerHTML='<tr><td colspan="3">データがありません</td></tr>':y.innerHTML=g.map(t=>`\n      <tr>\n        <td>${e(t.source)}</td>\n        <td>${t.count}</td>\n        <td>${t.percentage}%</td>\n      </tr>\n    `).join("");const b=Ae(n),f=document.getElementById("assignee-breakdown");0===b.length?f.innerHTML='<tr><td colspan="3">データがありません</td></tr>':f.innerHTML=b.map(t=>`\n      <tr>\n        <td>${e(t.assignee)}</td>\n        <td>${t.handled}</td>\n        <td>${t.pending}</td>\n      </tr>\n    `).join(""),document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="block",document.getElementById("report-actions").style.display="flex"}async function He(){const e=document.getElementById("report-period").value;let t,n;if("custom"===e){const e=document.getElementById("report-from"),o=document.getElementById("report-to");if(!e.value||!o.value)return void alert("開始日と終了日を指定してください");t=new Date(e.value),t.setHours(0,0,0,0),n=new Date(o.value),n.setHours(23,59,59,999)}else{const o=function(e){const t=new Date;let n,o;switch(e){case"week":{const e=t.getDay();n=new Date(t),n.setDate(t.getDate()-e),n.setHours(0,0,0,0),o=new Date(t),o.setHours(23,59,59,999);break}case"last-week":{const e=t.getDay();o=new Date(t),o.setDate(t.getDate()-e-1),o.setHours(23,59,59,999),n=new Date(o),n.setDate(o.getDate()-6),n.setHours(0,0,0,0);break}case"month":n=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t),o.setHours(23,59,59,999);break;case"last-month":n=new Date(t.getFullYear(),t.getMonth()-1,1),o=new Date(t.getFullYear(),t.getMonth(),0,23,59,59,999);break;default:n=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t)}return{start:n,end:o}}(e);t=o.start,n=o.end}document.getElementById("report-loading").style.display="flex",document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="none",document.getElementById("report-actions").style.display="none";try{const[e,o]=await Promise.all([Se(t,n),Te(t,n)]);ue=e,me={applications:e,comparison:o,period:{start:t,end:n}},Me(me)}catch(o){console.error("レポート生成エラー:",o),alert("レポートの生成に失敗しました: "+o.message)}finally{document.getElementById("report-loading").style.display="none"}}function _e(){if(!me||!me.applications.length)return void alert("レポートデータがありません");const{applications:e,period:t}=me,n=[["応募日時","求人タイトル","氏名","ステータス","流入元","担当者"],...e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""])].map(e=>e.map(e=>`"${String(e).replace(/"/g,'""')}"`).join(",")).join("\n"),o=new Blob(["\ufeff"+n],{type:"text/csv;charset=utf-8"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a;const l=t.start.toISOString().split("T")[0],i=t.end.toISOString().split("T")[0];s.download=`report-${se}-${l}-${i}.csv`,s.click(),URL.revokeObjectURL(a)}function Pe(){if(!me||!me.applications.length)return void alert("レポートデータがありません");if("undefined"==typeof XLSX)return void alert("Excelライブラリが読み込まれていません");const{applications:e,period:t}=me,n=XLSX.utils.book_new(),o=[["レポート期間",`${t.start.toLocaleDateString("ja-JP")} 〜 ${t.end.toLocaleDateString("ja-JP")}`],["会社",le],[""],["総応募数",e.length],["採用数",e.filter(e=>"hired"===e.status).length],["対応中",e.filter(e=>"new"===e.status||"contacted"===e.status).length]],a=XLSX.utils.aoa_to_sheet(o);XLSX.utils.book_append_sheet(n,a,"サマリー");const s=e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.phone||"",e.email||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""]),l=XLSX.utils.aoa_to_sheet([["応募日時","求人タイトル","氏名","電話番号","メール","ステータス","流入元","担当者"],...s]);XLSX.utils.book_append_sheet(n,l,"応募一覧");const i=De(e).map(e=>[e.status,e.count,`${e.percentage}%`]),d=XLSX.utils.aoa_to_sheet([["ステータス","件数","割合"],...i]);XLSX.utils.book_append_sheet(n,d,"ステータス別");const c=Ce(e).map(e=>[e.source,e.count,`${e.percentage}%`]),r=XLSX.utils.aoa_to_sheet([["流入元","件数","割合"],...c]);XLSX.utils.book_append_sheet(n,r,"流入元別");const u=Ae(e).map(e=>[e.assignee,e.handled,e.pending]),m=XLSX.utils.aoa_to_sheet([["担当者","対応済","未対応"],...u]);XLSX.utils.book_append_sheet(n,m,"担当者別");const p=t.start.toISOString().split("T")[0],g=t.end.toISOString().split("T")[0];XLSX.writeFile(n,`report-${se}-${p}-${g}.xlsx`)}function qe(t){document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".sidebar-nav li").forEach(e=>{e.classList.remove("active")});const n=document.getElementById(`section-${t}`);n&&n.classList.add("active"),document.querySelectorAll(".sidebar-nav a").forEach(e=>{e.dataset.section===t&&e.closest("li").classList.add("active")});const o=document.getElementById("page-title"),a=document.querySelector(".header-actions");"jobs"===t?(o&&(o.textContent=`${le} の求人一覧`),a&&(a.style.display="flex")):"analytics"===t?(o&&(o.textContent="アクセス解析"),a&&(a.style.display="none")):"reports"===t?(o&&(o.textContent="応募レポート"),a&&(a.style.display="none")):"applicants"===t?(o&&(o.textContent="応募者管理"),a&&(a.style.display="none"),Ue||(Ue=!0,z(se))):"lp-settings"===t?(o&&(o.textContent="LP設定"),a&&(a.style.display="none"),async function(){Ne||Xe();console.log("[LP設定] loadCompanyLPSettings 開始, companyDomain:",se),await async function(){const t=document.getElementById("lp-job-grid"),n=document.getElementById("lp-job-select");t&&(t.innerHTML='<div class="lp-loading-placeholder">求人を読み込み中...</div>');try{if(de.length>0){if(Oe=de.map(e=>({id:`${se}_${e.jobId||e.id}`,jobId:e.jobId||e.id,title:e.title||e.募集タイトル||"(タイトルなし)",company:le,companyDomain:se,sheetUrl:ie,rawData:e})),function(t){const n=document.getElementById("lp-job-grid");if(!n)return;if(0===t.length)return void(n.innerHTML='<div class="lp-no-results"><p>求人がありません</p></div>');n.innerHTML=t.map(t=>`\n    <div class="lp-job-card" data-job-id="${e(t.id)}">\n      <div class="lp-job-title">${e(t.title)}</div>\n      <div class="lp-job-id">ID: ${e(t.jobId)}</div>\n      <div class="lp-job-actions">\n        <button type="button" class="lp-job-action-btn primary lp-select-job-btn">LP設定を編集</button>\n        <a href="lp.html?j=${encodeURIComponent(t.id)}" target="_blank" class="lp-job-action-btn secondary">プレビュー</a>\n      </div>\n    </div>\n  `).join(""),n.querySelectorAll(".lp-select-job-btn").forEach(e=>{e.addEventListener("click",async t=>{t.stopPropagation();const o=e.closest(".lp-job-card"),a=o.dataset.jobId;n.querySelectorAll(".lp-job-card").forEach(e=>e.classList.remove("selected")),o.classList.add("selected");const s=document.getElementById("lp-job-select");s&&(s.value=a),Oe.find(e=>e.id===a),await async function(e){console.log("[LP設定] loadLPSettingsForJob:",e);const n=document.getElementById("lp-preview-btn"),o=document.getElementById("lp-edit-mode-btn");if(!e)return;n&&(n.href=`lp.html?j=${encodeURIComponent(e)}`);o&&(o.href=`lp.html?j=${encodeURIComponent(e)}&edit`);g();const a=document.querySelector('input[name="design-pattern"][value="standard"]');a&&(a.checked=!0);try{if(await async function(){if(ie)return ie;try{let e=f();e&&0!==e.length||(await v(),e=f());const t=e.find(e=>e.companyDomain===se);t?(ie=t.manageSheetUrl||t.jobsSheet||null,console.log("[LP設定] company-managerから取得したsheetUrl:",ie),console.log("[LP設定] company:",t)):console.warn("[LP設定] 会社が見つかりません:",se)}catch(t){console.warn("[LP設定] 会社情報の取得に失敗:",t)}return ie}(),!ie)return console.log("[LP設定] 管理シートURLが見つかりません"),void Ge();let n=null;const o=ie.match(/\/d\/([a-zA-Z0-9_-]+)/);if(o?n=o[1]:/^[a-zA-Z0-9_-]+$/.test(ie)&&(n=ie),!n)return console.log("[LP設定] 管理シートIDを抽出できません"),void Ge();const a=Date.now(),s=`https://docs.google.com/spreadsheets/d/${n}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent("LP設定")}&_t=${a}`,l=await fetch(s,{cache:"no-store"});if(l.ok){const t=function(e,t){const n=function(e){const t=[];let n="",o=!1;for(let a=0;a<e.length;a++){const s=e[a];if('"'===s)'"'===e[a+1]?(n+='""',a++):(o=!o,n+=s);else if("\n"!==s||o){if("\r"===s)continue;n+=s}else n.trim()&&t.push(n),n=""}n.trim()&&t.push(n);return t}(e),o=Je(n[0]||"");for(let a=1;a<n.length;a++){if(!n[a].trim())continue;const e=Je(n[a]),s={};o.forEach((t,n)=>{const o=t.replace(/"/g,"").trim();s[o]=e[n]||""});if((s.jobId||s["求人ID"]||"")===t){const e={heroTitle:s.heroTitle||s["ヒーロータイトル"]||"",heroSubtitle:s.heroSubtitle||s["ヒーローサブタイトル"]||"",heroImage:s.heroImage||s["ヒーロー画像"]||"",ctaText:s.ctaText||s["CTAテキスト"]||"",faq:s.faq||s.FAQ||"",designPattern:s.designPattern||s["デザインパターン"]||"",layoutStyle:s.layoutStyle||s["レイアウトスタイル"]||"default",sectionOrder:s.sectionOrder||s["セクション順序"]||"",sectionVisibility:s.sectionVisibility||s["セクション表示"]||"",tiktokPixelId:s.tiktokPixelId||s["TikTok Pixel ID"]||"",googleAdsId:s.googleAdsId||s["Google Ads ID"]||"",googleAdsLabel:s.googleAdsLabel||s["Google Ads ラベル"]||"",ogpTitle:s.ogpTitle||s["OGPタイトル"]||"",ogpDescription:s.ogpDescription||s["OGP説明文"]||"",ogpImage:s.ogpImage||s["OGP画像"]||"",lpContent:s.lpContent||s["LP構成"]||""};for(let t=1;t<=6;t++)e[`pointTitle${t}`]=s[`pointTitle${t}`]||s[`ポイント${t}タイトル`]||"",e[`pointDesc${t}`]=s[`pointDesc${t}`]||s[`ポイント${t}説明`]||"";return e}}return null}(await l.text(),e);if(t){if(Re("lp-hero-title",t.heroTitle),Re("lp-hero-subtitle",t.heroSubtitle),Re("lp-hero-image",t.heroImage),Re("lp-cta-text",t.ctaText||"今すぐ応募する"),Re("lp-faq",t.faq),Re("lp-tiktok-pixel",t.tiktokPixelId),Re("lp-google-ads-id",t.googleAdsId),Re("lp-google-ads-label",t.googleAdsLabel),Re("lp-ogp-title",t.ogpTitle),Re("lp-ogp-description",t.ogpDescription),Re("lp-ogp-image",t.ogpImage),t.designPattern){const e=document.querySelector(`input[name="design-pattern"][value="${t.designPattern}"]`);e&&(e.checked=!0)}return y(t.heroImage||""),void b(t)}}}catch(t){console.log("[LP設定] LP設定シートが見つかりません:",t)}Ge()}(a);const l=document.getElementById("lp-job-select-group"),i=document.getElementById("lp-editor");l&&(l.style.display="none"),i&&(i.style.display="block"),Fe("edit")})})}(Oe),n){let t='<option value="">-- 求人を選択 --</option>';for(const n of Oe)t+=`<option value="${e(n.id)}">${e(n.title)}</option>`;n.innerHTML=t}}else t&&(t.innerHTML='<div class="lp-no-results"><p>求人が見つかりません。まず求人を登録してください。</p></div>')}catch(o){console.error("[LP設定] 求人読み込みエラー:",o),t&&(t.innerHTML='<div class="lp-no-results"><p>求人データの読み込み中にエラーが発生しました</p></div>')}}()}()):"settings"===t&&(o&&(o.textContent="アカウント設定"),a&&(a.style.display="none"))}let Ue=!1,Ne=!1,Oe=[];function Xe(){console.log("[LP設定] initCompanyLPSettings 開始"),t(n,{getCompanyDomain:()=>se}),o(),a();const e=document.getElementById("btn-save-lp-settings");e&&e.addEventListener("click",()=>{s()});const d=document.getElementById("btn-reset-lp-settings");d&&d.addEventListener("click",()=>{confirm("LP設定をリセットしますか？")&&clearLPForm()});const c=document.getElementById("btn-toggle-preview");c&&c.addEventListener("click",l);const r=document.getElementById("btn-close-preview");r&&r.addEventListener("click",i);const u=document.getElementById("lp-back-to-jobs");u&&u.addEventListener("click",()=>{const e=document.getElementById("lp-job-select-group"),t=document.getElementById("lp-editor");e&&(e.style.display="block"),t&&(t.style.display="none"),Fe("job")}),document.querySelectorAll(".preview-device-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".preview-device-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.dataset.device,n=document.querySelector(".lp-preview-frame-wrapper");n&&n.setAttribute("data-device",t)})}),["lp-hero-title","lp-hero-subtitle","lp-hero-image","lp-cta-text","lp-faq","lp-tiktok-pixel","lp-google-ads-id","lp-google-ads-label","lp-ogp-title","lp-ogp-description","lp-ogp-image"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>p())}),document.querySelectorAll('input[name="design-pattern"]').forEach(e=>{e.addEventListener("change",()=>p())}),document.querySelectorAll(".collapsible-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target,n=document.getElementById(t),o=e.querySelector(".collapse-icon");if(n){const e="none"!==n.style.display;n.style.display=e?"none":"block",o&&(o.textContent=e?"▶":"▼")}})}),Ne=!0}function Fe(e){const t=document.querySelectorAll(".lp-step"),n=["job","edit"],o=n.indexOf(e);t.forEach(e=>{const t=e.dataset.step,a=n.indexOf(t);e.classList.remove("active","completed"),a<o?e.classList.add("completed"):a===o&&e.classList.add("active")})}function Re(e,t){const n=document.getElementById(e);n&&(n.value=t||"")}function Je(e){const t=[];let n="",o=!1;for(let a=0;a<e.length;a++){const s=e[a];'"'===s?o&&'"'===e[a+1]?(n+='"',a++):o=!o:","!==s||o?n+=s:(t.push(n.replace(/^"|"$/g,"").trim()),n="")}return t.push(n.replace(/^"|"$/g,"").trim()),t}function Ge(){["lp-hero-title","lp-hero-subtitle","lp-hero-image","lp-faq","lp-tiktok-pixel","lp-google-ads-id","lp-google-ads-label","lp-ogp-title","lp-ogp-description","lp-ogp-image"].forEach(e=>Re(e,"")),Re("lp-cta-text","今すぐ応募する");const e=document.querySelector('input[name="design-pattern"][value="standard"]');e&&(e.checked=!0),y(""),b({})}function Ve(){const e=document.getElementById("password-change-form");e&&e.addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("current-password").value,o=document.getElementById("new-password").value,a=document.getElementById("confirm-password").value,s=document.getElementById("password-change-error"),l=document.getElementById("password-change-success");if(s.style.display="none",l.style.display="none",o!==a)return s.textContent="新しいパスワードが一致しません",void(s.style.display="block");if(o.length<8)return s.textContent="パスワードは8文字以上で設定してください",void(s.style.display="block");try{const t=await async function(e,t){if("undefined"==typeof firebase||!firebase.firestore)return{success:!1,error:"データベースが初期化されていません"};const n=firebase.firestore(),o=sessionStorage.getItem("company_user_id");if(!o)try{const o=await n.collection("company_users").where("companyDomain","==",se).limit(1).get();if(o.empty)return{success:!1,error:"ユーザー情報が見つかりません"};const a=o.docs[0];return a.data().password!==e?{success:!1,error:"現在のパスワードが正しくありません"}:(await n.collection("company_users").doc(a.id).update({password:t,passwordChangedAt:firebase.firestore.FieldValue.serverTimestamp()}),{success:!0})}catch(a){return console.error("Password change error:",a),{success:!1,error:a.message}}try{const a=await n.collection("company_users").where("username","==",o).limit(1).get();if(a.empty)return{success:!1,error:"ユーザー情報が見つかりません"};const s=a.docs[0];return s.data().password!==e?{success:!1,error:"現在のパスワードが正しくありません"}:(await n.collection("company_users").doc(s.id).update({password:t,passwordChangedAt:firebase.firestore.FieldValue.serverTimestamp()}),{success:!0})}catch(a){return console.error("Password change error:",a),{success:!1,error:a.message}}}(n,o);t.success?(l.textContent="パスワードを変更しました",l.style.display="block",e.reset()):(s.textContent=t.error,s.style.display="block")}catch(i){console.error("Password change error:",i),s.textContent="パスワードの変更に失敗しました",s.style.display="block"}})}function Ye(){const t=document.querySelector(".feed-section");t&&(t.style.display="none");const n=document.querySelector('.sidebar-nav a[data-section="back"]');n&&(n.style.display="none");const o=document.getElementById("btn-back-admin");o&&(o.style.display="none");const a=document.getElementById("btn-logout");a&&(a.style.display="block",a.addEventListener("click",()=>{sessionStorage.removeItem(Q),sessionStorage.removeItem(ee),sessionStorage.removeItem(te),sessionStorage.removeItem("auth_method"),sessionStorage.removeItem("company_user_id"),"undefined"!=typeof firebase&&firebase.auth&&firebase.auth().signOut(),window.location.href="admin.html"}));const s=document.getElementById("nav-settings-item");s&&(s.style.display="block");const l=document.getElementById("nav-lp-settings-item");l&&(l.style.display="block"),Xe(),Ve();const i=document.getElementById("company-name");i&&(i.innerHTML=`${e(le)} <span class="badge info">会社ユーザー</span>`)}async function Ke(){if("undefined"==typeof firebase?console.warn("[JobManager] Firebase not loaded"):firebase.apps.length||firebase.initializeApp(W),!sessionStorage.getItem(Q))return void(window.location.href="admin.html");const e=new URLSearchParams(window.location.search);se=e.get("domain"),le=e.get("company")||se,ie=e.get("sheetUrl");const t=e.get("section");if(t&&["analytics","reports","applicants"].includes(t)&&qe(t),!se)return alert("会社ドメインが指定されていません"),void(window.location.href="admin.html");if(!ae(se))return alert("この会社へのアクセス権限がありません"),void(window.location.href="admin.html");oe()||Ye();const n=document.getElementById("page-title");n&&!t&&(n.textContent=`${le} の求人一覧`);const o=document.getElementById("company-name");o&&(o.textContent=le);const a=document.getElementById("btn-open-sheet");var s,l,i,d,c,r,u,m,p,g,y,b,f,v,h,E;ie&&a?(a.href=ie,a.style.display=""):a&&(a.style.display="none"),null==(s=document.getElementById("btn-add-job"))||s.addEventListener("click",be),null==(l=document.getElementById("btn-refresh"))||l.addEventListener("click",ye),null==(i=document.getElementById("job-modal-close"))||i.addEventListener("click",ve),null==(d=document.getElementById("job-modal-cancel"))||d.addEventListener("click",ve),null==(c=document.getElementById("job-modal-delete"))||c.addEventListener("click",Ee),null==(r=document.getElementById("job-edit-form"))||r.addEventListener("submit",e=>{e.preventDefault(),he()}),null==(u=document.getElementById("job-modal"))||u.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&ve()}),null==(m=document.getElementById("btn-download-indeed"))||m.addEventListener("click",Be),null==(p=document.getElementById("btn-download-google"))||p.addEventListener("click",Le),null==(g=document.getElementById("btn-download-jobbox"))||g.addEventListener("click",$e),null==(y=document.getElementById("btn-download-csv"))||y.addEventListener("click",xe),document.querySelectorAll(".sidebar-nav a[data-section]").forEach(e=>{e.addEventListener("click",t=>{const n=e.dataset.section;n&&"back"!==n&&(t.preventDefault(),qe(n))})}),null==(b=document.getElementById("report-period"))||b.addEventListener("change",e=>{const t=document.getElementById("report-custom-dates");t&&(t.style.display="custom"===e.target.value?"flex":"none")}),null==(f=document.getElementById("btn-generate-report"))||f.addEventListener("click",He),null==(v=document.getElementById("btn-report-csv"))||v.addEventListener("click",_e),null==(h=document.getElementById("btn-report-excel"))||h.addEventListener("click",Pe),null==(E=document.getElementById("btn-load-analytics"))||E.addEventListener("click",ke),await ye()}"undefined"!=typeof window&&(window.JobManager={init:Ke,loadJobsData:ye,showJobModal:be,editJob:fe,closeJobModal:ve,saveJobData:he,deleteJob:Ee}),document.addEventListener("DOMContentLoaded",()=>{Ke()});
