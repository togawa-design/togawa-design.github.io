import{e}from"./utils-C4oNoj7k.js";import{g as t,e as n,f as o,h as a,i as d}from"./job-feed-generator-BbzggbON.js";import"./jobs-loader-CErzUEmq.js";const s="https://script.google.com/macros/s/AKfycbxj6CqSfY7jq04uDXURhewD_BAKx3csLKBpl1hdRBdNg-R-E6IuoaZGje22Gr9WYWY2/exec";let l=null,r=null,i=null,c=[],u=null,m=!1,b=[],g=null;function y(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async function p(){const t=document.getElementById("jobs-tbody");if(!t)return;t.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';const n=s;try{const o=`${n}?action=getJobs&domain=${encodeURIComponent(l)}`,a=await fetch(o);if(!a.ok)throw new Error("データの取得に失敗しました");const d=await a.json();if(!d.success)throw new Error(d.error||"求人データの取得に失敗しました");if(c=d.jobs||[],0===c.length)return void(t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>');!function(){const t=document.getElementById("jobs-tbody");if(!t)return;const n=c||[];0!==n.length?(t.innerHTML=n.map(t=>{const n=t.monthlySalary?`¥${Number(t.monthlySalary).toLocaleString()}`:"-",o="true"===t.visible||"TRUE"===t.visible||!0===t.visible;return`\n      <tr data-row="${t._rowIndex}">\n        <td>${e(t.id||"-")}</td>\n        <td>${e(t.title||"-")}</td>\n        <td>${e(t.location||"-")}</td>\n        <td>${n}</td>\n        <td>${o?'<span class="badge success">公開</span>':'<span class="badge">非公開</span>'}</td>\n        <td>\n          <div class="action-buttons">\n            <button class="btn-small btn-edit" data-row="${t._rowIndex}">編集</button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),t.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{h(parseInt(e.dataset.row,10))})})):t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>'}()}catch(o){console.error("求人データの読み込みエラー:",o),t.innerHTML=`<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました: ${e(o.message)}</td></tr>`}}function f(){u=null,m=!0;const e=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t)};document.getElementById("job-modal-title").textContent="新規求人作成",e("edit-job-title",""),e("edit-job-location",""),e("edit-job-salary",""),e("edit-job-bonus",""),e("edit-job-order",""),e("edit-job-features",""),e("edit-job-badges",""),e("edit-job-description",""),e("edit-job-requirements",""),e("edit-job-benefits",""),e("edit-job-hours",""),e("edit-job-holidays",""),e("edit-job-start-date",""),e("edit-job-end-date","");const t=document.getElementById("edit-job-visible");t&&(t.checked=!0);const n=document.getElementById("job-modal-delete");n&&(n.style.display="none");const o=document.getElementById("job-modal");o&&(o.style.display="flex")}function h(e){const t=null==c?void 0:c.find(t=>t._rowIndex===e);if(!t)return void alert("求人データが見つかりません");u=t,m=!1;const n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};document.getElementById("job-modal-title").textContent="求人情報の編集",n("edit-job-title",t.title),n("edit-job-location",t.location),n("edit-job-salary",t.monthlySalary),n("edit-job-bonus",t.totalBonus),n("edit-job-order",t.order),n("edit-job-features",t.features),n("edit-job-badges",t.badges),n("edit-job-description",t.jobDescription),n("edit-job-requirements",t.requirements),n("edit-job-benefits",t.benefits),n("edit-job-hours",t.workingHours),n("edit-job-holidays",t.holidays),t.publishStartDate?n("edit-job-start-date",y(t.publishStartDate)):n("edit-job-start-date",""),t.publishEndDate?n("edit-job-end-date",y(t.publishEndDate)):n("edit-job-end-date","");const o=document.getElementById("edit-job-visible");o&&(o.checked="true"===t.visible||"TRUE"===t.visible||!0===t.visible);const a=document.getElementById("job-modal-delete");a&&(a.style.display="");const d=document.getElementById("job-modal");d&&(d.style.display="flex")}function j(){const e=document.getElementById("job-modal");e&&(e.style.display="none"),u=null,m=!1}async function E(){var e;if(!l)return void alert("会社が選択されていません");const t=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},n={title:t("edit-job-title"),location:t("edit-job-location"),monthlySalary:t("edit-job-salary"),totalBonus:t("edit-job-bonus"),order:t("edit-job-order"),features:t("edit-job-features"),badges:t("edit-job-badges"),jobDescription:t("edit-job-description"),requirements:t("edit-job-requirements"),benefits:t("edit-job-benefits"),workingHours:t("edit-job-hours"),holidays:t("edit-job-holidays"),publishStartDate:t("edit-job-start-date"),publishEndDate:t("edit-job-end-date"),visible:(null==(e=document.getElementById("edit-job-visible"))?void 0:e.checked)?"true":"false"};if(!n.title||!n.location)return void alert("募集タイトルと勤務地は必須です");const o=s,a=document.getElementById("job-modal-save");try{a&&(a.disabled=!0,a.textContent="保存中...");const e=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveJob",companyDomain:l,job:n,rowIndex:m?null:u._rowIndex})))),t=`${o}?action=post&data=${encodeURIComponent(e)}`,s=await fetch(t,{method:"GET",redirect:"follow"}),r=await s.text();let i;try{i=JSON.parse(r)}catch(d){throw console.error("JSON parse error:",d),new Error(`GASからの応答が不正です: ${r.substring(0,200)}`)}if(!i.success)return void alert("保存に失敗しました: "+(i.error||"不明なエラー"));j(),await p(),alert(m?"求人を作成しました":"求人情報を更新しました")}catch(r){console.error("求人保存エラー:",r),alert("保存中にエラーが発生しました: "+r.message)}finally{a&&(a.disabled=!1,a.textContent="保存")}}async function v(){if(!u||!l)return void alert("削除対象が選択されていません");if(!confirm("この求人を削除してもよろしいですか？"))return;const e=s,t=document.getElementById("job-modal-delete");try{t&&(t.disabled=!0,t.textContent="削除中...");const o=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteJob",companyDomain:l,rowIndex:u._rowIndex})))),a=`${e}?action=post&data=${encodeURIComponent(o)}`,d=await fetch(a,{method:"GET",redirect:"follow"}),s=await d.text();let r;try{r=JSON.parse(s)}catch(n){throw console.error("JSON parse error:",n),new Error("GASからの応答が不正です")}if(!r.success)return void alert("削除に失敗しました: "+(r.error||"不明なエラー"));j(),await p(),alert("求人を削除しました")}catch(o){console.error("求人削除エラー:",o),alert("削除中にエラーが発生しました: "+o.message)}finally{t&&(t.disabled=!1,t.textContent="削除")}}function w(){return c.filter(e=>("true"===e.visible||"TRUE"===e.visible||!0===e.visible)&&e.title).map(e=>({...e,company:r,companyDomain:l,companyAddress:e.location||""}))}function I(){const e=document.getElementById("feed-status");e&&(e.style.display="flex")}function B(){const e=document.getElementById("feed-status");e&&(e.style.display="none")}async function L(){const e=w();if(0!==e.length)try{I();const o=t(e);n(o,`indeed-${l}.xml`,"application/xml")}catch(o){alert("フィード生成に失敗しました: "+o.message)}finally{B()}else alert("ダウンロードできる求人がありません")}async function S(){const e=w();if(0!==e.length)try{I();const t=o(e);n(t,`google-jobs-${l}.json`,"application/json")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{B()}else alert("ダウンロードできる求人がありません")}async function $(){const e=w();if(0!==e.length)try{I();const t=a(e);n(t,`jobbox-${l}.xml`,"application/xml")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{B()}else alert("ダウンロードできる求人がありません")}async function D(){const e=w();if(0!==e.length)try{I();const t=d(e);n(t,`jobs-${l}.csv`,"text/csv;charset=utf-8")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{B()}else alert("ダウンロードできる求人がありません")}async function x(e,t){if(!l)return[];try{const n=firebase.firestore();return(await n.collection("applications").where("companyDomain","==",l).where("createdAt",">=",e).where("createdAt","<=",t).orderBy("createdAt","desc").get()).docs.map(e=>{var t,n;return{id:e.id,...e.data(),createdAt:(null==(n=null==(t=e.data().createdAt)?void 0:t.toDate)?void 0:n.call(t))||new Date(e.data().createdAt)}})}catch(n){return console.error("応募データ取得エラー:",n),[]}}async function k(e,t){const n=t.getTime()-e.getTime(),o=new Date(e.getTime()-1),a=new Date(o.getTime()-n);return await x(a,o)}function T(e){const t={new:"新規",contacted:"連絡済",interviewing:"面接中",hired:"採用",rejected:"不採用",withdrawn:"辞退"},n={};Object.values(t).forEach(e=>{n[e]=0}),e.forEach(e=>{const o=e.status||"new",a=t[o]||"新規";n[a]=(n[a]||0)+1});const o=e.length;return Object.entries(n).map(([e,t])=>({status:e,count:t,percentage:o>0?Math.round(t/o*100):0}))}function X(e){const t={google:"Google検索",indeed:"Indeed",jobbox:"求人ボックス",direct:"直接流入",line:"LINE",other:"その他"},n={};e.forEach(e=>{let o=e.source||e.utmSource||"other";o=o.includes("google")?"google":o.includes("indeed")?"indeed":o.includes("jobbox")||o.includes("stanby")?"jobbox":o.includes("line")?"line":"direct"===o||"(direct)"===o?"direct":"other";const a=t[o]||"その他";n[a]=(n[a]||0)+1});const o=e.length;return Object.entries(n).map(([e,t])=>({source:e,count:t,percentage:o>0?Math.round(t/o*100):0})).sort((e,t)=>t.count-e.count)}function _(e){const t={};return e.forEach(e=>{const n=e.assignee||"未割当";t[n]||(t[n]={assignee:n,handled:0,pending:0});"new"===(e.status||"new")?t[n].pending++:t[n].handled++}),Object.values(t).sort((e,t)=>t.handled-e.handled)}function M(t){const{applications:n,comparison:o,period:a}=t,d=n.length,s=o.length,l=s>0?Math.round((d-s)/s*100):0,r=l>=0?`+${l}%`:`${l}%`,i=n.filter(e=>"hired"===e.status).length,u=n.filter(e=>"new"===e.status||"contacted"===e.status).length;document.getElementById("summary-total").textContent=d,document.getElementById("summary-change").textContent=r,document.getElementById("summary-change").className="summary-value "+(l>=0?"positive":"negative"),document.getElementById("summary-hired").textContent=i,document.getElementById("summary-pending").textContent=u;const m=T(n);document.getElementById("status-breakdown").innerHTML=m.map(t=>`\n    <tr>\n      <td>${e(t.status)}</td>\n      <td>${t.count}</td>\n      <td>${t.percentage}%</td>\n    </tr>\n  `).join("");const b=function(e){const t={};return e.forEach(e=>{const n=e.jobId||"unknown",o=e.jobTitle||"不明な求人";t[n]||(t[n]={jobId:n,jobTitle:o,count:0}),t[n].count++}),Object.values(t).sort((e,t)=>t.count-e.count).slice(0,5)}(n),g=document.getElementById("job-performance");0===b.length?g.innerHTML='<tr><td colspan="4">データがありません</td></tr>':g.innerHTML=b.map(t=>{const n=c.find(e=>e.id===t.jobId),o=(null==n?void 0:n.pageViews)||"-",a="-"!==o&&o>0?(t.count/o*100).toFixed(1)+"%":"-";return`\n        <tr>\n          <td>${e(t.jobTitle)}</td>\n          <td>${t.count}</td>\n          <td>${o}</td>\n          <td>${a}</td>\n        </tr>\n      `}).join("");const y=X(n),p=document.getElementById("source-breakdown");0===y.length?p.innerHTML='<tr><td colspan="3">データがありません</td></tr>':p.innerHTML=y.map(t=>`\n      <tr>\n        <td>${e(t.source)}</td>\n        <td>${t.count}</td>\n        <td>${t.percentage}%</td>\n      </tr>\n    `).join("");const f=_(n),h=document.getElementById("assignee-breakdown");0===f.length?h.innerHTML='<tr><td colspan="3">データがありません</td></tr>':h.innerHTML=f.map(t=>`\n      <tr>\n        <td>${e(t.assignee)}</td>\n        <td>${t.handled}</td>\n        <td>${t.pending}</td>\n      </tr>\n    `).join(""),document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="block",document.getElementById("report-actions").style.display="flex"}async function C(){const e=document.getElementById("report-period").value;let t,n;if("custom"===e){const e=document.getElementById("report-from"),o=document.getElementById("report-to");if(!e.value||!o.value)return void alert("開始日と終了日を指定してください");t=new Date(e.value),t.setHours(0,0,0,0),n=new Date(o.value),n.setHours(23,59,59,999)}else{const o=function(e){const t=new Date;let n,o;switch(e){case"week":{const e=t.getDay();n=new Date(t),n.setDate(t.getDate()-e),n.setHours(0,0,0,0),o=new Date(t),o.setHours(23,59,59,999);break}case"last-week":{const e=t.getDay();o=new Date(t),o.setDate(t.getDate()-e-1),o.setHours(23,59,59,999),n=new Date(o),n.setDate(o.getDate()-6),n.setHours(0,0,0,0);break}case"month":n=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t),o.setHours(23,59,59,999);break;case"last-month":n=new Date(t.getFullYear(),t.getMonth()-1,1),o=new Date(t.getFullYear(),t.getMonth(),0,23,59,59,999);break;default:n=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t)}return{start:n,end:o}}(e);t=o.start,n=o.end}document.getElementById("report-loading").style.display="flex",document.getElementById("report-empty").style.display="none",document.getElementById("report-content").style.display="none",document.getElementById("report-actions").style.display="none";try{const[e,o]=await Promise.all([x(t,n),k(t,n)]);b=e,g={applications:e,comparison:o,period:{start:t,end:n}},M(g)}catch(o){console.error("レポート生成エラー:",o),alert("レポートの生成に失敗しました: "+o.message)}finally{document.getElementById("report-loading").style.display="none"}}function H(){if(!g||!g.applications.length)return void alert("レポートデータがありません");const{applications:e,period:t}=g,n=[["応募日時","求人タイトル","氏名","ステータス","流入元","担当者"],...e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""])].map(e=>e.map(e=>`"${String(e).replace(/"/g,'""')}"`).join(",")).join("\n"),o=new Blob(["\ufeff"+n],{type:"text/csv;charset=utf-8"}),a=URL.createObjectURL(o),d=document.createElement("a");d.href=a;const s=t.start.toISOString().split("T")[0],r=t.end.toISOString().split("T")[0];d.download=`report-${l}-${s}-${r}.csv`,d.click(),URL.revokeObjectURL(a)}function A(){if(!g||!g.applications.length)return void alert("レポートデータがありません");if("undefined"==typeof XLSX)return void alert("Excelライブラリが読み込まれていません");const{applications:e,period:t}=g,n=XLSX.utils.book_new(),o=[["レポート期間",`${t.start.toLocaleDateString("ja-JP")} 〜 ${t.end.toLocaleDateString("ja-JP")}`],["会社",r],[""],["総応募数",e.length],["採用数",e.filter(e=>"hired"===e.status).length],["対応中",e.filter(e=>"new"===e.status||"contacted"===e.status).length]],a=XLSX.utils.aoa_to_sheet(o);XLSX.utils.book_append_sheet(n,a,"サマリー");const d=e.map(e=>[e.createdAt?new Date(e.createdAt).toLocaleString("ja-JP"):"",e.jobTitle||"",e.name||"",e.phone||"",e.email||"",e.status||"new",e.source||e.utmSource||"",e.assignee||""]),s=XLSX.utils.aoa_to_sheet([["応募日時","求人タイトル","氏名","電話番号","メール","ステータス","流入元","担当者"],...d]);XLSX.utils.book_append_sheet(n,s,"応募一覧");const i=T(e).map(e=>[e.status,e.count,`${e.percentage}%`]),c=XLSX.utils.aoa_to_sheet([["ステータス","件数","割合"],...i]);XLSX.utils.book_append_sheet(n,c,"ステータス別");const u=X(e).map(e=>[e.source,e.count,`${e.percentage}%`]),m=XLSX.utils.aoa_to_sheet([["流入元","件数","割合"],...u]);XLSX.utils.book_append_sheet(n,m,"流入元別");const b=_(e).map(e=>[e.assignee,e.handled,e.pending]),y=XLSX.utils.aoa_to_sheet([["担当者","対応済","未対応"],...b]);XLSX.utils.book_append_sheet(n,y,"担当者別");const p=t.start.toISOString().split("T")[0],f=t.end.toISOString().split("T")[0];XLSX.writeFile(n,`report-${l}-${p}-${f}.xlsx`)}function J(){var e,t,n,o,a,d,s,l,i,c,u,m,b,g,y;null==(e=document.getElementById("btn-add-job"))||e.addEventListener("click",f),null==(t=document.getElementById("btn-refresh"))||t.addEventListener("click",p),null==(n=document.getElementById("job-modal-close"))||n.addEventListener("click",j),null==(o=document.getElementById("job-modal-cancel"))||o.addEventListener("click",j),null==(a=document.getElementById("job-modal-delete"))||a.addEventListener("click",v),null==(d=document.getElementById("job-edit-form"))||d.addEventListener("submit",e=>{e.preventDefault(),E()}),null==(s=document.getElementById("job-modal"))||s.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&j()}),null==(l=document.getElementById("btn-download-indeed"))||l.addEventListener("click",L),null==(i=document.getElementById("btn-download-google"))||i.addEventListener("click",S),null==(c=document.getElementById("btn-download-jobbox"))||c.addEventListener("click",$),null==(u=document.getElementById("btn-download-csv"))||u.addEventListener("click",D),document.querySelectorAll(".sidebar-nav a[data-section]").forEach(e=>{e.addEventListener("click",t=>{const n=e.dataset.section;n&&"back"!==n&&(t.preventDefault(),function(e){document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".sidebar-nav li").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(`section-${e}`);t&&t.classList.add("active"),document.querySelectorAll(".sidebar-nav a").forEach(t=>{t.dataset.section===e&&t.closest("li").classList.add("active")});const n=document.getElementById("page-title"),o=document.querySelector(".header-actions");"jobs"===e?(n&&(n.textContent=`${r} の求人一覧`),o&&(o.style.display="flex")):"reports"===e&&(n&&(n.textContent="応募レポート"),o&&(o.style.display="none"))}(n))})}),null==(m=document.getElementById("report-period"))||m.addEventListener("change",e=>{const t=document.getElementById("report-custom-dates");t&&(t.style.display="custom"===e.target.value?"flex":"none")}),null==(b=document.getElementById("btn-generate-report"))||b.addEventListener("click",C),null==(g=document.getElementById("btn-report-csv"))||g.addEventListener("click",H),null==(y=document.getElementById("btn-report-excel"))||y.addEventListener("click",A)}async function O(){const e=new URLSearchParams(window.location.search);if(l=e.get("domain"),r=e.get("company")||l,i=e.get("sheetUrl"),!l)return alert("会社ドメインが指定されていません"),void(window.location.href="admin.html");const t=document.getElementById("page-title");t&&(t.textContent=`${r} の求人一覧`);const n=document.getElementById("company-name");n&&(n.textContent=r);const o=document.getElementById("btn-open-sheet");i&&o?(o.href=i,o.style.display=""):o&&(o.style.display="none"),J(),await p()}"undefined"!=typeof window&&(window.JobManager={init:O,loadJobsData:p,showJobModal:f,editJob:h,closeJobModal:j,saveJobData:E,deleteJob:v}),document.addEventListener("DOMContentLoaded",()=>{O()});
