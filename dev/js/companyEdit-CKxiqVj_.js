import"./modulepreload-polyfill-YP0FEG5d.js";import{escapeHtml as e}from"./utils-BNVq905i.js";import{a as t,b as n}from"./image-uploader-CMmi_cQM.js";import{i as o,j as a,h as l,f as r}from"./firestore-service-BDwyai-n.js";import"./env-config-DknF4WGE.js";let i=!0,d=null,c=null;function s(e){if(!e||"<br>"===e||"<div><br></div>"===e)return"";const t=["b","strong","i","em","u","ul","ol","li","br","div","p","img"],n=["src","alt","style"],o=document.createElement("div");o.innerHTML=e;return o.querySelectorAll("*").forEach(e=>{if(t.includes(e.tagName.toLowerCase())){Array.from(e.attributes).forEach(t=>{n.includes(t.name)||e.removeAttribute(t.name)}),"img"!==e.tagName.toLowerCase()||e.style.maxWidth||(e.style.maxWidth="100%")}else e.replaceWith(...e.childNodes)}),o.innerHTML}function m(e,t){if(t){const n=s(e.innerHTML);t.value=n}}function u(e,t){const n=document.getElementById(e),o=null==n?void 0:n.closest(".rich-editor-container"),a=null==o?void 0:o.querySelector('input[type="hidden"]');n&&(n.innerHTML=t||"",a&&(a.value=t||""))}function y(e){const t=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};t("company-name",e.company),t("company-domain",e.companyDomain||e.company_domain),t("design-pattern",e.designPattern||"modern"),t("order",e.order),t("company-address",e.companyAddress||e.location);const n=e.logoUrl||e.imageUrl||"";t("logo-url",n),p(n);const o=document.getElementById("show-company");if(o&&(o.checked="○"===e.showCompany||!0===e.showCompany||"true"===e.showCompany||!0===e.visible),u("description-editor",e.description||""),u("job-content-editor",e.jobDescription||e.jobContent||""),u("working-hours-editor",e.workingHours||""),u("work-location-editor",e.workLocation||""),e.company){const t=document.getElementById("page-title");t&&(t.textContent=`${e.company} の編集`)}}function p(t){const n=document.getElementById("logo-preview"),o=document.getElementById("logo-remove-btn");n&&(t?(n.innerHTML=`<img src="${e(t)}" alt="会社ロゴ">`,o&&(o.style.display="")):(n.innerHTML='<span class="upload-placeholder">ロゴをアップロード</span>',o&&(o.style.display="none")))}async function g(){var e,t,n,a,r,d,c;document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=null==t?void 0:t.querySelector('input[type="hidden"]');n&&(n.value=s(e.innerHTML))});const m=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},u=m("logo-url"),y={company:m("company-name"),companyDomain:m("company-domain"),designPattern:(null==(e=document.getElementById("design-pattern"))?void 0:e.value)||"modern",logoUrl:u,imageUrl:u,order:m("order"),companyAddress:m("company-address"),description:(null==(t=document.getElementById("description"))?void 0:t.value)||"",jobDescription:(null==(n=document.getElementById("job-content"))?void 0:n.value)||"",workingHours:(null==(a=document.getElementById("working-hours"))?void 0:a.value)||"",workLocation:(null==(r=document.getElementById("work-location"))?void 0:r.value)||"",showCompany:(null==(d=document.getElementById("show-company"))?void 0:d.checked)?"○":"",visible:(null==(c=document.getElementById("show-company"))?void 0:c.checked)||!1};if(!y.company||!y.companyDomain)return void alert("会社名と会社ドメインは必須です");if(!/^[a-z0-9-]+$/.test(y.companyDomain))return void alert("会社ドメインは半角英小文字・数字・ハイフンのみ使用できます");const p=document.getElementById("btn-save");p&&(p.disabled=!0,p.innerHTML='<span class="loading-spinner-small"></span> 保存中...');try{o();const e={company:y.company,companyAddress:y.companyAddress||"",description:y.description,jobDescription:y.jobDescription,workingHours:y.workingHours,workLocation:y.workLocation,logoUrl:y.logoUrl,imageUrl:y.imageUrl,designPattern:y.designPattern,order:parseInt(y.order)||0,showCompany:"○"===y.showCompany||"◯"===y.showCompany},t=await l(y.companyDomain,e);if(!t.success)throw new Error(t.error||"保存に失敗しました");alert(i?"会社を登録しました":"会社情報を更新しました"),window.location.href="admin.html"}catch(g){console.error("保存エラー:",g),alert("保存中にエラーが発生しました: "+g.message)}finally{p&&(p.disabled=!1,p.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> 保存')}}function v(){var e;const t=document.getElementById("delete-confirm-modal"),n=(null==(e=document.getElementById("company-name"))?void 0:e.value)||"",o=document.getElementById("delete-company-name");o&&(o.textContent=n),t&&(t.style.display="flex")}function f(){const e=document.getElementById("delete-confirm-modal");e&&(e.style.display="none")}async function E(){const e=document.getElementById("delete-confirm");e&&(e.disabled=!0,e.textContent="削除中...");try{o();const e=await a(d);if(!e.success)throw new Error(e.error||"削除に失敗しました");alert("会社を削除しました"),window.location.href="admin.html"}catch(t){console.error("削除エラー:",t),alert("削除中にエラーが発生しました: "+t.message)}finally{e&&(e.disabled=!1,e.textContent="削除する")}}function h(){var e,n,o,a,l,r,d;null==(e=document.getElementById("company-edit-form"))||e.addEventListener("submit",e=>{e.preventDefault(),g()}),null==(n=document.getElementById("btn-delete"))||n.addEventListener("click",()=>{v()}),null==(o=document.getElementById("delete-modal-close"))||o.addEventListener("click",f),null==(a=document.getElementById("delete-cancel"))||a.addEventListener("click",f),null==(l=document.getElementById("delete-confirm"))||l.addEventListener("click",E),null==(r=document.getElementById("delete-confirm-modal"))||r.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&f()}),null==(d=document.getElementById("company-domain"))||d.addEventListener("input",e=>{i&&(e.target.value=e.target.value.toLowerCase().replace(/[^a-z0-9-]/g,""))}),function(){const e=document.getElementById("logo-upload-btn"),n=document.getElementById("logo-file-input"),o=document.getElementById("logo-remove-btn"),a=document.getElementById("logo-preview"),l=document.getElementById("logo-url");if(!e||!n)return;e.addEventListener("click",()=>{n.click()}),null==a||a.addEventListener("click",()=>{n.click()}),n.addEventListener("change",async e=>{var o,r;const i=e.target.files[0];if(!i)return;const d=null==(r=null==(o=document.getElementById("company-domain"))?void 0:o.value)?void 0:r.trim();if(d)try{a.classList.add("uploading"),a.innerHTML='<span class="upload-placeholder">アップロード中...</span>';const e=await t(i,d);l.value=e,p(e)}catch(c){console.error("ロゴアップロードエラー:",c),alert("ロゴのアップロードに失敗しました: "+c.message),p(l.value)}finally{a.classList.remove("uploading"),n.value=""}else alert("先に会社ドメインを入力してください")}),null==o||o.addEventListener("click",()=>{l.value="",p("")}),null==a||a.addEventListener("dragover",e=>{e.preventDefault(),a.classList.add("drag-over")}),null==a||a.addEventListener("dragleave",e=>{e.preventDefault(),a.classList.remove("drag-over")}),null==a||a.addEventListener("drop",async e=>{var n,o;e.preventDefault(),a.classList.remove("drag-over");const r=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/"));if(0===r.length)return;const i=null==(o=null==(n=document.getElementById("company-domain"))?void 0:n.value)?void 0:o.trim();if(i)try{a.classList.add("uploading"),a.innerHTML='<span class="upload-placeholder">アップロード中...</span>';const e=await t(r[0],i);l.value=e,p(e)}catch(d){console.error("ロゴアップロードエラー:",d),alert("ロゴのアップロードに失敗しました: "+d.message),p(l.value)}finally{a.classList.remove("uploading")}else alert("先に会社ドメインを入力してください")})}(),w("description-insert-image","description-image-input","description-editor"),w("job-content-insert-image","job-content-image-input","job-content-editor")}function w(e,t,o){const a=document.getElementById(e),l=document.getElementById(t),r=document.getElementById(o);a&&l&&r&&(a.addEventListener("click",()=>{l.click()}),l.addEventListener("change",async e=>{var t,o;const a=e.target.files[0];if(!a)return;const i=null==(o=null==(t=document.getElementById("company-domain"))?void 0:t.value)?void 0:o.trim();if(i)try{const e=`img-placeholder-${Date.now()}`,t=document.createElement("img");t.id=e,t.src=URL.createObjectURL(a),t.alt="アップロード中...",t.className="uploading",t.style.maxWidth="100%",t.style.opacity="0.5",r.focus();const o=window.getSelection();if(o.rangeCount>0){const e=o.getRangeAt(0);e.insertNode(t),e.setStartAfter(t),e.collapse(!0),o.removeAllRanges(),o.addRange(e)}else r.appendChild(t);const l=await n(a,i),d=document.getElementById(e);d&&(d.src=l,d.alt="",d.className="",d.style.opacity="1",d.removeAttribute("id"));const c=r.closest(".rich-editor-container"),m=null==c?void 0:c.querySelector('input[type="hidden"]');m&&(m.value=s(r.innerHTML))}catch(d){console.error("画像アップロードエラー:",d),alert("画像のアップロードに失敗しました: "+d.message);const e=r.querySelector("img.uploading");e&&e.remove()}finally{l.value=""}else alert("先に会社ドメインを入力してください")}))}async function L(){const e=new URLSearchParams(window.location.search);d=e.get("domain"),i=!d,function(){const e=document.getElementById("page-title"),t=document.getElementById("edit-mode-badge"),n=document.getElementById("btn-delete"),o=document.getElementById("company-domain");i?(e&&(e.textContent="新規会社登録"),t&&(t.textContent="新規作成",t.classList.remove("edit")),n&&(n.style.display="none")):(e&&(e.textContent="会社情報の編集"),t&&(t.textContent="編集中",t.classList.add("edit")),n&&(n.style.display=""),o&&(o.readOnly=!0,o.classList.add("readonly")))}(),h(),document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=t.querySelector(".rich-editor-toolbar"),o=t.querySelector('input[type="hidden"]');null==n||n.querySelectorAll(".toolbar-btn").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const a=t.dataset.command;document.execCommand(a,!1,null),e.focus(),m(e,o)})}),e.addEventListener("input",()=>{m(e,o)}),e.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)}),e.addEventListener("keydown",t=>{if(t.ctrlKey||t.metaKey){switch(t.key.toLowerCase()){case"b":t.preventDefault(),document.execCommand("bold",!1,null);break;case"i":t.preventDefault(),document.execCommand("italic",!1,null);break;case"u":t.preventDefault(),document.execCommand("underline",!1,null)}m(e,o)}})}),i||await async function(){const e=sessionStorage.getItem("editing_company_data");if(e){try{const t=JSON.parse(e);if(t.companyDomain===d||t.company_domain===d)return c=t,y(t),void sessionStorage.removeItem("editing_company_data")}catch(t){console.error("sessionStorageデータのパースエラー:",t)}sessionStorage.removeItem("editing_company_data")}try{o();const e=await r(d);if(!e.success||!e.company)return alert("会社データが見つかりません"),void(window.location.href="admin.html");c=e.company,y(e.company)}catch(n){console.error("Firestore読み込みエラー:",n),alert("データの読み込みに失敗しました: "+n.message)}}()}"undefined"!=typeof window&&(window.CompanyEditor={init:L,saveCompany:g,deleteCompany:E,showDeleteConfirm:v,hideDeleteConfirm:f}),document.addEventListener("DOMContentLoaded",()=>{L()});
