import"./modulepreload-polyfill-YP0FEG5d.js";import{escapeHtml as e}from"./utils-BB91om2o.js";import{a as t,b as n}from"./image-uploader-BjWWejqS.js";import{u as o,i as a,k as l,h as r,l as i}from"./firestore-service-N2MxWdK_.js";const c="https://script.google.com/macros/s/AKfycbxj6CqSfY7jq04uDXURhewD_BAKx3csLKBpl1hdRBdNg-R-E6IuoaZGje22Gr9WYWY2/exec";let d=!0,s=null,m=null;function u(e){if(!e||"<br>"===e||"<div><br></div>"===e)return"";const t=["b","strong","i","em","u","ul","ol","li","br","div","p","img"],n=["src","alt","style"],o=document.createElement("div");o.innerHTML=e;return o.querySelectorAll("*").forEach(e=>{if(t.includes(e.tagName.toLowerCase())){Array.from(e.attributes).forEach(t=>{n.includes(t.name)||e.removeAttribute(t.name)}),"img"!==e.tagName.toLowerCase()||e.style.maxWidth||(e.style.maxWidth="100%")}else e.replaceWith(...e.childNodes)}),o.innerHTML}function y(e,t){if(t){const n=u(e.innerHTML);t.value=n}}function p(e,t){const n=document.getElementById(e),o=null==n?void 0:n.closest(".rich-editor-container"),a=null==o?void 0:o.querySelector('input[type="hidden"]');n&&(n.innerHTML=t||"",a&&(a.value=t||""))}function g(e){const t=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};t("company-name",e.company),t("company-domain",e.companyDomain||e.company_domain),t("design-pattern",e.designPattern||"standard"),t("order",e.order),t("company-address",e.companyAddress||e.location);const n=e.logoUrl||e.imageUrl||"";t("logo-url",n),v(n);const o=document.getElementById("show-company");if(o&&(o.checked="○"===e.showCompany||!0===e.showCompany||"true"===e.showCompany||!0===e.visible),p("description-editor",e.description||""),p("job-content-editor",e.jobDescription||e.jobContent||""),p("working-hours-editor",e.workingHours||""),p("work-location-editor",e.workLocation||""),e.company){const t=document.getElementById("page-title");t&&(t.textContent=`${e.company} の編集`)}}function v(t){const n=document.getElementById("logo-preview"),o=document.getElementById("logo-remove-btn");n&&(t?(n.innerHTML=`<img src="${e(t)}" alt="会社ロゴ">`,o&&(o.style.display="")):(n.innerHTML='<span class="upload-placeholder">ロゴをアップロード</span>',o&&(o.style.display="none")))}async function f(){var e,t,n,l,i,s,m;document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=null==t?void 0:t.querySelector('input[type="hidden"]');n&&(n.value=u(e.innerHTML))});const y=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},p=y("logo-url"),g={company:y("company-name"),companyDomain:y("company-domain"),designPattern:(null==(e=document.getElementById("design-pattern"))?void 0:e.value)||"standard",logoUrl:p,imageUrl:p,order:y("order"),companyAddress:y("company-address"),description:(null==(t=document.getElementById("description"))?void 0:t.value)||"",jobDescription:(null==(n=document.getElementById("job-content"))?void 0:n.value)||"",workingHours:(null==(l=document.getElementById("working-hours"))?void 0:l.value)||"",workLocation:(null==(i=document.getElementById("work-location"))?void 0:i.value)||"",showCompany:(null==(s=document.getElementById("show-company"))?void 0:s.checked)?"○":"",visible:(null==(m=document.getElementById("show-company"))?void 0:m.checked)||!1};if(!g.company||!g.companyDomain)return void alert("会社名と会社ドメインは必須です");if(!/^[a-z0-9-]+$/.test(g.companyDomain))return void alert("会社ドメインは半角英小文字・数字・ハイフンのみ使用できます");const v=document.getElementById("btn-save");v&&(v.disabled=!0,v.innerHTML='<span class="loading-spinner-small"></span> 保存中...');try{if(o){a();const e={company:g.company,companyAddress:g.companyAddress||"",description:g.description,jobDescription:g.jobDescription,workingHours:g.workingHours,workLocation:g.workLocation,logoUrl:g.logoUrl,imageUrl:g.imageUrl,designPattern:g.designPattern,order:parseInt(g.order)||0,showCompany:"○"===g.showCompany||"◯"===g.showCompany},t=await r(g.companyDomain,e);if(!t.success)throw new Error(t.error||"保存に失敗しました");return alert(d?"会社を登録しました":"会社情報を更新しました"),void(window.location.href="admin.html")}const e=c;if(e){const t=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveCompany",company:g})))),n=`${e}?action=post&data=${encodeURIComponent(t)}`,o=await fetch(n),a=await o.json();if(!a.success)throw new Error(a.error||"保存に失敗しました")}localStorage.setItem(`company_data_${g.companyDomain}`,JSON.stringify(g)),alert(d?"会社を登録しました":"会社情報を更新しました"),window.location.href="admin.html"}catch(f){console.error("保存エラー:",f),alert("保存中にエラーが発生しました: "+f.message)}finally{v&&(v.disabled=!1,v.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> 保存')}}function h(){var e;const t=document.getElementById("delete-confirm-modal"),n=(null==(e=document.getElementById("company-name"))?void 0:e.value)||"",o=document.getElementById("delete-company-name");o&&(o.textContent=n),t&&(t.style.display="flex")}function w(){const e=document.getElementById("delete-confirm-modal");e&&(e.style.display="none")}async function E(){const e=document.getElementById("delete-confirm");e&&(e.disabled=!0,e.textContent="削除中...");try{if(o){a();const e=await l(s);if(!e.success)throw new Error(e.error||"削除に失敗しました");return alert("会社を削除しました"),void(window.location.href="admin.html")}const e=c;if(e){const t=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteCompany",domain:s})))),n=`${e}?action=post&data=${encodeURIComponent(t)}`,o=await fetch(n),a=await o.json();if(!a.success)throw new Error(a.error||"削除に失敗しました")}localStorage.removeItem(`company_data_${s}`),alert("会社を削除しました"),window.location.href="admin.html"}catch(t){console.error("削除エラー:",t),alert("削除中にエラーが発生しました: "+t.message)}finally{e&&(e.disabled=!1,e.textContent="削除する")}}function L(){var e,n,o,a,l,r,i;null==(e=document.getElementById("company-edit-form"))||e.addEventListener("submit",e=>{e.preventDefault(),f()}),null==(n=document.getElementById("btn-delete"))||n.addEventListener("click",()=>{h()}),null==(o=document.getElementById("delete-modal-close"))||o.addEventListener("click",w),null==(a=document.getElementById("delete-cancel"))||a.addEventListener("click",w),null==(l=document.getElementById("delete-confirm"))||l.addEventListener("click",E),null==(r=document.getElementById("delete-confirm-modal"))||r.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&w()}),null==(i=document.getElementById("company-domain"))||i.addEventListener("input",e=>{d&&(e.target.value=e.target.value.toLowerCase().replace(/[^a-z0-9-]/g,""))}),function(){const e=document.getElementById("logo-upload-btn"),n=document.getElementById("logo-file-input"),o=document.getElementById("logo-remove-btn"),a=document.getElementById("logo-preview"),l=document.getElementById("logo-url");if(!e||!n)return;e.addEventListener("click",()=>{n.click()}),null==a||a.addEventListener("click",()=>{n.click()}),n.addEventListener("change",async e=>{var o,r;const i=e.target.files[0];if(!i)return;const c=null==(r=null==(o=document.getElementById("company-domain"))?void 0:o.value)?void 0:r.trim();if(c)try{a.classList.add("uploading"),a.innerHTML='<span class="upload-placeholder">アップロード中...</span>';const e=await t(i,c);l.value=e,v(e)}catch(d){console.error("ロゴアップロードエラー:",d),alert("ロゴのアップロードに失敗しました: "+d.message),v(l.value)}finally{a.classList.remove("uploading"),n.value=""}else alert("先に会社ドメインを入力してください")}),null==o||o.addEventListener("click",()=>{l.value="",v("")}),null==a||a.addEventListener("dragover",e=>{e.preventDefault(),a.classList.add("drag-over")}),null==a||a.addEventListener("dragleave",e=>{e.preventDefault(),a.classList.remove("drag-over")}),null==a||a.addEventListener("drop",async e=>{var n,o;e.preventDefault(),a.classList.remove("drag-over");const r=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/"));if(0===r.length)return;const i=null==(o=null==(n=document.getElementById("company-domain"))?void 0:n.value)?void 0:o.trim();if(i)try{a.classList.add("uploading"),a.innerHTML='<span class="upload-placeholder">アップロード中...</span>';const e=await t(r[0],i);l.value=e,v(e)}catch(c){console.error("ロゴアップロードエラー:",c),alert("ロゴのアップロードに失敗しました: "+c.message),v(l.value)}finally{a.classList.remove("uploading")}else alert("先に会社ドメインを入力してください")})}(),I("description-insert-image","description-image-input","description-editor"),I("job-content-insert-image","job-content-image-input","job-content-editor")}function I(e,t,o){const a=document.getElementById(e),l=document.getElementById(t),r=document.getElementById(o);a&&l&&r&&(a.addEventListener("click",()=>{l.click()}),l.addEventListener("change",async e=>{var t,o;const a=e.target.files[0];if(!a)return;const i=null==(o=null==(t=document.getElementById("company-domain"))?void 0:t.value)?void 0:o.trim();if(i)try{const e=`img-placeholder-${Date.now()}`,t=document.createElement("img");t.id=e,t.src=URL.createObjectURL(a),t.alt="アップロード中...",t.className="uploading",t.style.maxWidth="100%",t.style.opacity="0.5",r.focus();const o=window.getSelection();if(o.rangeCount>0){const e=o.getRangeAt(0);e.insertNode(t),e.setStartAfter(t),e.collapse(!0),o.removeAllRanges(),o.addRange(e)}else r.appendChild(t);const l=await n(a,i),c=document.getElementById(e);c&&(c.src=l,c.alt="",c.className="",c.style.opacity="1",c.removeAttribute("id"));const d=r.closest(".rich-editor-container"),s=null==d?void 0:d.querySelector('input[type="hidden"]');s&&(s.value=u(r.innerHTML))}catch(c){console.error("画像アップロードエラー:",c),alert("画像のアップロードに失敗しました: "+c.message);const e=r.querySelector("img.uploading");e&&e.remove()}finally{l.value=""}else alert("先に会社ドメインを入力してください")}))}async function B(){const e=new URLSearchParams(window.location.search);s=e.get("domain"),d=!s,function(){const e=document.getElementById("page-title"),t=document.getElementById("edit-mode-badge"),n=document.getElementById("btn-delete"),o=document.getElementById("company-domain");d?(e&&(e.textContent="新規会社登録"),t&&(t.textContent="新規作成",t.classList.remove("edit")),n&&(n.style.display="none")):(e&&(e.textContent="会社情報の編集"),t&&(t.textContent="編集中",t.classList.add("edit")),n&&(n.style.display=""),o&&(o.readOnly=!0,o.classList.add("readonly")))}(),L(),document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=t.querySelector(".rich-editor-toolbar"),o=t.querySelector('input[type="hidden"]');null==n||n.querySelectorAll(".toolbar-btn").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const a=t.dataset.command;document.execCommand(a,!1,null),e.focus(),y(e,o)})}),e.addEventListener("input",()=>{y(e,o)}),e.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)}),e.addEventListener("keydown",t=>{if(t.ctrlKey||t.metaKey){switch(t.key.toLowerCase()){case"b":t.preventDefault(),document.execCommand("bold",!1,null);break;case"i":t.preventDefault(),document.execCommand("italic",!1,null);break;case"u":t.preventDefault(),document.execCommand("underline",!1,null)}y(e,o)}})}),d||await async function(){const e=sessionStorage.getItem("editing_company_data");if(e){try{const t=JSON.parse(e);if(t.companyDomain===s||t.company_domain===s)return m=t,g(t),void sessionStorage.removeItem("editing_company_data")}catch(n){console.error("sessionStorageデータのパースエラー:",n)}sessionStorage.removeItem("editing_company_data")}try{a();const e=await i(s);return e.success&&e.company?(m=e.company,void g(e.company)):(alert("会社データが見つかりません"),void(window.location.href="admin.html"))}catch(o){return console.error("Firestore読み込みエラー:",o),void alert("データの読み込みに失敗しました: "+o.message)}const t=c;try{const e=`${t}?action=getCompany&domain=${encodeURIComponent(s)}`,n=await fetch(e),o=await n.json();if(!o.success||!o.company)return alert("会社データが見つかりません"),void(window.location.href="admin.html");m=o.company,g(o.company)}catch(o){console.error("会社データ読み込みエラー:",o),alert("データの読み込みに失敗しました: "+o.message)}}()}"undefined"!=typeof window&&(window.CompanyEditor={init:B,saveCompany:f,deleteCompany:E,showDeleteConfirm:h,hideDeleteConfirm:w}),document.addEventListener("DOMContentLoaded",()=>{B()});
