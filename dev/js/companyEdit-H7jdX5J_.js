import{e}from"./utils-C4oNoj7k.js";const t={cloudName:"dnvtqyhuw",uploadPreset:"rikueko_unsigned"};async function n(e,t={}){const{maxWidth:n=1200,maxHeight:o=1200,quality:a=.8,outputType:l="image/webp"}=t;return new Promise((t,c)=>{const i=new Image,d=document.createElement("canvas"),r=d.getContext("2d");i.onload=()=>{let{width:e,height:s}=i;e>n&&(s=s*n/e,e=n),s>o&&(e=e*o/s,s=o),d.width=e,d.height=s,r.drawImage(i,0,0,e,s),d.toBlob(e=>{e?t(e):c(new Error("画像の変換に失敗しました"))},l,a)},i.onerror=()=>c(new Error("画像の読み込みに失敗しました")),i.src=URL.createObjectURL(e)})}async function o(e,n,o=null){var a;const{cloudName:l,uploadPreset:c}=t,i=new FormData;i.append("file",e),i.append("upload_preset",c),i.append("folder",n),o&&i.append("public_id",o);const d=await fetch(`https://api.cloudinary.com/v1_1/${l}/image/upload`,{method:"POST",body:i});if(!d.ok){const e=await d.json();throw new Error((null==(a=e.error)?void 0:a.message)||"アップロードに失敗しました")}return(await d.json()).secure_url}async function a(e,t){const a=await async function(e){return n(e,{maxWidth:400,maxHeight:400,quality:.85,outputType:"image/webp"})}(e),l=`companies/${t}`,c=await o(a,l,"logo");return console.log("[ImageUploader] Logo uploaded:",c),c}async function l(e,t){const a=await async function(e){return n(e,{maxWidth:1200,maxHeight:800,quality:.8,outputType:"image/webp"})}(e),l=`companies/${t}/images`,c=await o(a,l);return console.log("[ImageUploader] Company image uploaded:",c),c}const c="https://script.google.com/macros/s/AKfycbxj6CqSfY7jq04uDXURhewD_BAKx3csLKBpl1hdRBdNg-R-E6IuoaZGje22Gr9WYWY2/exec";let i=!0,d=null,r=null;function s(e){if(!e||"<br>"===e||"<div><br></div>"===e)return"";const t=["b","strong","i","em","u","ul","ol","li","br","div","p","img"],n=["src","alt","style"],o=document.createElement("div");o.innerHTML=e;return o.querySelectorAll("*").forEach(e=>{if(t.includes(e.tagName.toLowerCase())){Array.from(e.attributes).forEach(t=>{n.includes(t.name)||e.removeAttribute(t.name)}),"img"!==e.tagName.toLowerCase()||e.style.maxWidth||(e.style.maxWidth="100%")}else e.replaceWith(...e.childNodes)}),o.innerHTML}function m(e,t){if(t){const n=s(e.innerHTML);t.value=n}}function u(e,t){const n=document.getElementById(e),o=null==n?void 0:n.closest(".rich-editor-container"),a=null==o?void 0:o.querySelector('input[type="hidden"]');n&&(n.innerHTML=t||"",a&&(a.value=t||""))}function p(e){const t=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};t("company-name",e.company),t("company-domain",e.companyDomain||e.company_domain),t("design-pattern",e.designPattern||"standard"),t("order",e.order),t("company-address",e.companyAddress||e.location);const n=e.logoUrl||e.imageUrl||"";t("logo-url",n),y(n);const o=document.getElementById("show-company");if(o&&(o.checked="○"===e.showCompany||!0===e.showCompany||"true"===e.showCompany||!0===e.visible),u("description-editor",e.description||""),u("job-content-editor",e.jobDescription||e.jobContent||""),u("working-hours-editor",e.workingHours||""),u("work-location-editor",e.workLocation||""),e.company){const t=document.getElementById("page-title");t&&(t.textContent=`${e.company} の編集`)}}function y(t){const n=document.getElementById("logo-preview"),o=document.getElementById("logo-remove-btn");n&&(t?(n.innerHTML=`<img src="${e(t)}" alt="会社ロゴ">`,o&&(o.style.display="")):(n.innerHTML='<span class="upload-placeholder">ロゴをアップロード</span>',o&&(o.style.display="none")))}async function g(){var e,t,n,o,a,l,d;document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=null==t?void 0:t.querySelector('input[type="hidden"]');n&&(n.value=s(e.innerHTML))});const r=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},m=r("logo-url"),u={company:r("company-name"),companyDomain:r("company-domain"),designPattern:(null==(e=document.getElementById("design-pattern"))?void 0:e.value)||"standard",logoUrl:m,imageUrl:m,order:r("order"),companyAddress:r("company-address"),description:(null==(t=document.getElementById("description"))?void 0:t.value)||"",jobDescription:(null==(n=document.getElementById("job-content"))?void 0:n.value)||"",workingHours:(null==(o=document.getElementById("working-hours"))?void 0:o.value)||"",workLocation:(null==(a=document.getElementById("work-location"))?void 0:a.value)||"",showCompany:(null==(l=document.getElementById("show-company"))?void 0:l.checked)?"○":"",visible:(null==(d=document.getElementById("show-company"))?void 0:d.checked)||!1};if(!u.company||!u.companyDomain)return void alert("会社名と会社ドメインは必須です");if(!/^[a-z0-9-]+$/.test(u.companyDomain))return void alert("会社ドメインは半角英小文字・数字・ハイフンのみ使用できます");const p=document.getElementById("btn-save");p&&(p.disabled=!0,p.innerHTML='<span class="loading-spinner-small"></span> 保存中...');const y=c;try{if(y){const e=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveCompany",company:u})))),t=`${y}?action=post&data=${encodeURIComponent(e)}`,n=await fetch(t),o=await n.json();if(!o.success)throw new Error(o.error||"保存に失敗しました")}localStorage.setItem(`company_data_${u.companyDomain}`,JSON.stringify(u)),alert(i?"会社を登録しました":"会社情報を更新しました"),window.location.href="admin.html"}catch(g){console.error("保存エラー:",g),alert("保存中にエラーが発生しました: "+g.message)}finally{p&&(p.disabled=!1,p.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> 保存')}}function v(){var e;const t=document.getElementById("delete-confirm-modal"),n=(null==(e=document.getElementById("company-name"))?void 0:e.value)||"",o=document.getElementById("delete-company-name");o&&(o.textContent=n),t&&(t.style.display="flex")}function f(){const e=document.getElementById("delete-confirm-modal");e&&(e.style.display="none")}async function h(){const e=c,t=document.getElementById("delete-confirm");t&&(t.disabled=!0,t.textContent="削除中...");try{if(e){const t=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteCompany",domain:d})))),n=`${e}?action=post&data=${encodeURIComponent(t)}`,o=await fetch(n),a=await o.json();if(!a.success)throw new Error(a.error||"削除に失敗しました")}localStorage.removeItem(`company_data_${d}`),alert("会社を削除しました"),window.location.href="admin.html"}catch(n){console.error("削除エラー:",n),alert("削除中にエラーが発生しました: "+n.message)}finally{t&&(t.disabled=!1,t.textContent="削除する")}}function w(){var e,t,n,o,l,c,d;null==(e=document.getElementById("company-edit-form"))||e.addEventListener("submit",e=>{e.preventDefault(),g()}),null==(t=document.getElementById("btn-delete"))||t.addEventListener("click",()=>{v()}),null==(n=document.getElementById("delete-modal-close"))||n.addEventListener("click",f),null==(o=document.getElementById("delete-cancel"))||o.addEventListener("click",f),null==(l=document.getElementById("delete-confirm"))||l.addEventListener("click",h),null==(c=document.getElementById("delete-confirm-modal"))||c.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&f()}),null==(d=document.getElementById("company-domain"))||d.addEventListener("input",e=>{i&&(e.target.value=e.target.value.toLowerCase().replace(/[^a-z0-9-]/g,""))}),function(){const e=document.getElementById("logo-upload-btn"),t=document.getElementById("logo-file-input"),n=document.getElementById("logo-remove-btn"),o=document.getElementById("logo-preview"),l=document.getElementById("logo-url");if(!e||!t)return;e.addEventListener("click",()=>{t.click()}),null==o||o.addEventListener("click",()=>{t.click()}),t.addEventListener("change",async e=>{var n,c;const i=e.target.files[0];if(!i)return;const d=null==(c=null==(n=document.getElementById("company-domain"))?void 0:n.value)?void 0:c.trim();if(d)try{o.classList.add("uploading"),o.innerHTML='<span class="upload-placeholder">アップロード中...</span>';const e=await a(i,d);l.value=e,y(e)}catch(r){console.error("ロゴアップロードエラー:",r),alert("ロゴのアップロードに失敗しました: "+r.message),y(l.value)}finally{o.classList.remove("uploading"),t.value=""}else alert("先に会社ドメインを入力してください")}),null==n||n.addEventListener("click",()=>{l.value="",y("")}),null==o||o.addEventListener("dragover",e=>{e.preventDefault(),o.classList.add("drag-over")}),null==o||o.addEventListener("dragleave",e=>{e.preventDefault(),o.classList.remove("drag-over")}),null==o||o.addEventListener("drop",async e=>{var t,n;e.preventDefault(),o.classList.remove("drag-over");const c=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/"));if(0===c.length)return;const i=null==(n=null==(t=document.getElementById("company-domain"))?void 0:t.value)?void 0:n.trim();if(i)try{o.classList.add("uploading"),o.innerHTML='<span class="upload-placeholder">アップロード中...</span>';const e=await a(c[0],i);l.value=e,y(e)}catch(d){console.error("ロゴアップロードエラー:",d),alert("ロゴのアップロードに失敗しました: "+d.message),y(l.value)}finally{o.classList.remove("uploading")}else alert("先に会社ドメインを入力してください")})}(),E("description-insert-image","description-image-input","description-editor"),E("job-content-insert-image","job-content-image-input","job-content-editor")}function E(e,t,n){const o=document.getElementById(e),a=document.getElementById(t),c=document.getElementById(n);o&&a&&c&&(o.addEventListener("click",()=>{a.click()}),a.addEventListener("change",async e=>{var t,n;const o=e.target.files[0];if(!o)return;const i=null==(n=null==(t=document.getElementById("company-domain"))?void 0:t.value)?void 0:n.trim();if(i)try{const e=`img-placeholder-${Date.now()}`,t=document.createElement("img");t.id=e,t.src=URL.createObjectURL(o),t.alt="アップロード中...",t.className="uploading",t.style.maxWidth="100%",t.style.opacity="0.5",c.focus();const n=window.getSelection();if(n.rangeCount>0){const e=n.getRangeAt(0);e.insertNode(t),e.setStartAfter(t),e.collapse(!0),n.removeAllRanges(),n.addRange(e)}else c.appendChild(t);const a=await l(o,i),d=document.getElementById(e);d&&(d.src=a,d.alt="",d.className="",d.style.opacity="1",d.removeAttribute("id"));const r=c.closest(".rich-editor-container"),m=null==r?void 0:r.querySelector('input[type="hidden"]');m&&(m.value=s(c.innerHTML))}catch(d){console.error("画像アップロードエラー:",d),alert("画像のアップロードに失敗しました: "+d.message);const e=c.querySelector("img.uploading");e&&e.remove()}finally{a.value=""}else alert("先に会社ドメインを入力してください")}))}async function L(){const e=new URLSearchParams(window.location.search);d=e.get("domain"),i=!d,function(){const e=document.getElementById("page-title"),t=document.getElementById("edit-mode-badge"),n=document.getElementById("btn-delete"),o=document.getElementById("company-domain");i?(e&&(e.textContent="新規会社登録"),t&&(t.textContent="新規作成",t.classList.remove("edit")),n&&(n.style.display="none")):(e&&(e.textContent="会社情報の編集"),t&&(t.textContent="編集中",t.classList.add("edit")),n&&(n.style.display=""),o&&(o.readOnly=!0,o.classList.add("readonly")))}(),w(),document.querySelectorAll(".rich-editor").forEach(e=>{const t=e.closest(".rich-editor-container"),n=t.querySelector(".rich-editor-toolbar"),o=t.querySelector('input[type="hidden"]');null==n||n.querySelectorAll(".toolbar-btn").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const a=t.dataset.command;document.execCommand(a,!1,null),e.focus(),m(e,o)})}),e.addEventListener("input",()=>{m(e,o)}),e.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)}),e.addEventListener("keydown",t=>{if(t.ctrlKey||t.metaKey){switch(t.key.toLowerCase()){case"b":t.preventDefault(),document.execCommand("bold",!1,null);break;case"i":t.preventDefault(),document.execCommand("italic",!1,null);break;case"u":t.preventDefault(),document.execCommand("underline",!1,null)}m(e,o)}})}),i||await async function(){var e;const t=c;try{const n=`${t}?action=getCompanies`,o=await fetch(n),a=await o.json();if(!a.success)throw new Error(a.error||"会社データの取得に失敗しました");const l=null==(e=a.companies)?void 0:e.find(e=>e.companyDomain===d||e.company_domain===d);if(!l){const e=localStorage.getItem(`company_data_${d}`);return void(e?p(JSON.parse(e)):(alert("会社データが見つかりません"),window.location.href="admin.html"))}r=l,p(l)}catch(n){console.error("会社データ読み込みエラー:",n);const e=localStorage.getItem(`company_data_${d}`);e?p(JSON.parse(e)):alert("データの読み込みに失敗しました: "+n.message)}}()}"undefined"!=typeof window&&(window.CompanyEditor={init:L,saveCompany:g,deleteCompany:h,showDeleteConfirm:v,hideDeleteConfirm:f}),document.addEventListener("DOMContentLoaded",()=>{L()});
