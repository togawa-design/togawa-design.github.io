import"./modulepreload-polyfill-YP0FEG5d.js";import{s as e}from"./modal-gG-182nw.js";import"./utils-BB91om2o.js";const t={apiKey:"AIzaSyB3eXZoFkXOwnHxPvaHiWO7csmZK4KGqAQ",authDomain:"generated-area-484613-e3-90bd4.firebaseapp.com",projectId:"generated-area-484613-e3-90bd4"},n="rikueko_user_session";let a=null,o=null,r=null,i=null,s=[];function l(){return"undefined"==typeof firebase?(console.warn("[UserAuth] Firebase SDK not loaded"),!1):(firebase.apps.length||firebase.initializeApp(t),a=firebase.auth(),o=firebase.firestore(),a.onAuthStateChanged(async e=>{if(e){r=e;try{i=await e.getIdToken(),sessionStorage.setItem(n,"authenticated"),await async function(e){var t;if(!o)return;const n=o.collection("users").doc(e.uid);if(!(await n.get()).exists){const a={uid:e.uid,email:e.email,displayName:e.displayName||"",photoURL:e.photoURL||null,profile:{name:e.displayName||"",phone:"",age:"",address:""},authProvider:"google.com"===(null==(t=e.providerData[0])?void 0:t.providerId)?"google":"email",createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};await n.set(a),console.log("[UserAuth] Created user document")}}(e),c(e)}catch(t){console.error("[UserAuth] Failed to get ID token:",t)}}else r=null,i=null,sessionStorage.removeItem(n),c(null)}),!0)}function d(e){return s.push(e),null===r&&void 0===(null==a?void 0:a.currentUser)||e(r),()=>{s=s.filter(t=>t!==e)}}function c(e){s.forEach(t=>{try{t(e)}catch(n){console.error("[UserAuth] Listener error:",n)}})}async function u(){if(!r||!o)return null;try{const e=await o.collection("users").doc(r.uid).get();return e.exists?e.data():null}catch(e){return console.error("[UserAuth] Get profile error:",e),null}}function m(){return r}function p(){return o}function g(e){return{"auth/email-already-in-use":"このメールアドレスは既に登録されています","auth/invalid-email":"メールアドレスの形式が正しくありません","auth/operation-not-allowed":"この操作は許可されていません","auth/weak-password":"パスワードは6文字以上で設定してください","auth/user-disabled":"このアカウントは無効になっています","auth/user-not-found":"アカウントが見つかりません","auth/wrong-password":"パスワードが正しくありません","auth/invalid-credential":"メールアドレスまたはパスワードが正しくありません","auth/too-many-requests":"リクエストが多すぎます。しばらくしてからお試しください","auth/popup-closed-by-user":"ログインがキャンセルされました","auth/requires-recent-login":"再度ログインしてください"}[e]||"エラーが発生しました。もう一度お試しください"}let f="login";function v(){var e,t,n,a,o,r,i,s,l,d,c;document.getElementById("user-auth-modal")||function(){const e='\n    <div id="user-auth-modal" class="auth-modal-overlay" style="display: none;">\n      <div class="auth-modal-content">\n        <button class="auth-modal-close" id="auth-modal-close" aria-label="閉じる">&times;</button>\n\n        \x3c!-- ログインフォーム --\x3e\n        <div id="auth-login-view" class="auth-view">\n          <div class="auth-modal-header">\n            <h2>ログイン</h2>\n            <p>L-SETにログイン</p>\n          </div>\n\n          <form id="login-form" class="auth-form">\n            <div class="auth-form-group">\n              <label for="login-email">メールアドレス</label>\n              <input type="email" id="login-email" name="email" required placeholder="example@mail.com">\n            </div>\n            <div class="auth-form-group">\n              <label for="login-password">パスワード</label>\n              <input type="password" id="login-password" name="password" required placeholder="パスワード">\n            </div>\n            <div class="auth-form-error" id="login-error"></div>\n            <button type="submit" class="auth-btn-submit" id="login-submit">ログイン</button>\n          </form>\n\n          <div class="auth-divider"><span>または</span></div>\n\n          <button type="button" id="google-login-btn" class="auth-btn-google">\n            <svg width="18" height="18" viewBox="0 0 18 18">\n              <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>\n              <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>\n              <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>\n              <path fill="#EA4335" d="M8.98 3.58c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.9z"/>\n            </svg>\n            Googleでログイン\n          </button>\n\n          <div class="auth-links">\n            <a href="#" id="show-register-link">アカウントを作成</a>\n            <a href="#" id="show-forgot-link">パスワードを忘れた方</a>\n          </div>\n        </div>\n\n        \x3c!-- 新規登録フォーム --\x3e\n        <div id="auth-register-view" class="auth-view" style="display: none;">\n          <div class="auth-modal-header">\n            <h2>新規登録</h2>\n            <p>L-SETに登録</p>\n          </div>\n\n          <form id="register-form" class="auth-form">\n            <div class="auth-form-group">\n              <label for="register-name">お名前</label>\n              <input type="text" id="register-name" name="name" required placeholder="山田 太郎">\n            </div>\n            <div class="auth-form-group">\n              <label for="register-email">メールアドレス</label>\n              <input type="email" id="register-email" name="email" required placeholder="example@mail.com">\n            </div>\n            <div class="auth-form-group">\n              <label for="register-password">パスワード</label>\n              <input type="password" id="register-password" name="password" required placeholder="6文字以上" minlength="6">\n            </div>\n            <div class="auth-form-group">\n              <label for="register-password-confirm">パスワード（確認）</label>\n              <input type="password" id="register-password-confirm" name="passwordConfirm" required placeholder="パスワードを再入力">\n            </div>\n            <div class="auth-form-agreement">\n              <label class="auth-checkbox-label">\n                <input type="checkbox" id="register-agreement" required>\n                <span><a href="#" target="_blank">利用規約</a>と<a href="#" target="_blank">プライバシーポリシー</a>に同意する</span>\n              </label>\n            </div>\n            <div class="auth-form-error" id="register-error"></div>\n            <button type="submit" class="auth-btn-submit" id="register-submit">登録する</button>\n          </form>\n\n          <div class="auth-divider"><span>または</span></div>\n\n          <button type="button" id="google-register-btn" class="auth-btn-google">\n            <svg width="18" height="18" viewBox="0 0 18 18">\n              <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>\n              <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>\n              <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>\n              <path fill="#EA4335" d="M8.98 3.58c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.9z"/>\n            </svg>\n            Googleで登録\n          </button>\n\n          <div class="auth-links">\n            <a href="#" id="show-login-link">すでにアカウントをお持ちの方</a>\n          </div>\n        </div>\n\n        \x3c!-- パスワードリセットフォーム --\x3e\n        <div id="auth-forgot-view" class="auth-view" style="display: none;">\n          <div class="auth-modal-header">\n            <h2>パスワードをリセット</h2>\n            <p>登録済みのメールアドレスを入力してください</p>\n          </div>\n\n          <form id="forgot-form" class="auth-form">\n            <div class="auth-form-group">\n              <label for="forgot-email">メールアドレス</label>\n              <input type="email" id="forgot-email" name="email" required placeholder="example@mail.com">\n            </div>\n            <div class="auth-form-error" id="forgot-error"></div>\n            <div class="auth-form-success" id="forgot-success"></div>\n            <button type="submit" class="auth-btn-submit" id="forgot-submit">リセットメールを送信</button>\n          </form>\n\n          <div class="auth-links">\n            <a href="#" id="back-to-login-link">ログインに戻る</a>\n          </div>\n        </div>\n      </div>\n    </div>\n  ';document.body.insertAdjacentHTML("beforeend",e)}(),null==(e=document.getElementById("auth-modal-close"))||e.addEventListener("click",h),null==(t=document.getElementById("user-auth-modal"))||t.addEventListener("click",e=>{e.target.classList.contains("auth-modal-overlay")&&h()}),document.addEventListener("keydown",e=>{var t;"Escape"===e.key&&"none"!==(null==(t=document.getElementById("user-auth-modal"))?void 0:t.style.display)&&h()}),null==(n=document.getElementById("show-register-link"))||n.addEventListener("click",e=>{e.preventDefault(),w("register")}),null==(a=document.getElementById("show-login-link"))||a.addEventListener("click",e=>{e.preventDefault(),w("login")}),null==(o=document.getElementById("show-forgot-link"))||o.addEventListener("click",e=>{e.preventDefault(),w("forgot")}),null==(r=document.getElementById("back-to-login-link"))||r.addEventListener("click",e=>{e.preventDefault(),w("login")}),null==(i=document.getElementById("login-form"))||i.addEventListener("submit",C),null==(s=document.getElementById("register-form"))||s.addEventListener("submit",I),null==(l=document.getElementById("forgot-form"))||l.addEventListener("submit",B),null==(d=document.getElementById("google-login-btn"))||d.addEventListener("click",x),null==(c=document.getElementById("google-register-btn"))||c.addEventListener("click",x),document.addEventListener("openAuthModal",e=>{var t;y((null==(t=e.detail)?void 0:t.mode)||"login")})}function y(e="login"){const t=document.getElementById("user-auth-modal");t&&(b(),w(e),t.style.display="flex",document.body.style.overflow="hidden",setTimeout(()=>{const e=t.querySelector('.auth-view:not([style*="display: none"]) input');null==e||e.focus()},100))}function h(){var e,t,n;const a=document.getElementById("user-auth-modal");a&&(a.style.display="none",document.body.style.overflow=""),null==(e=document.getElementById("login-form"))||e.reset(),null==(t=document.getElementById("register-form"))||t.reset(),null==(n=document.getElementById("forgot-form"))||n.reset(),b()}function w(e){f=e;const t={login:document.getElementById("auth-login-view"),register:document.getElementById("auth-register-view"),forgot:document.getElementById("auth-forgot-view")};Object.entries(t).forEach(([t,n])=>{n&&(n.style.display=t===e?"block":"none")}),b()}function b(){document.querySelectorAll(".auth-form-error").forEach(e=>e.textContent=""),document.querySelectorAll(".auth-form-success").forEach(e=>e.textContent="")}function E(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}async function C(e){var t,n,o;e.preventDefault();const s=document.getElementById("login-submit"),l=null==(n=null==(t=document.getElementById("login-email"))?void 0:t.value)?void 0:n.trim(),d=null==(o=document.getElementById("login-password"))?void 0:o.value;if(l&&d){s.disabled=!0,s.textContent="ログイン中...";try{const e=await async function(e,t){if(!a)return{success:!1,error:"Firebase認証が初期化されていません"};try{const n=await a.signInWithEmailAndPassword(e,t);return r=n.user,i=await n.user.getIdToken(),{success:!0,user:n.user}}catch(n){return console.error("[UserAuth] Sign in error:",n),{success:!1,error:g(n.code)}}}(l,d);e.success?(h(),window.location.reload()):E("login-error",e.error)}catch(c){E("login-error","ログインに失敗しました")}finally{s.disabled=!1,s.textContent="ログイン"}}else E("login-error","メールアドレスとパスワードを入力してください")}async function I(e){var t,n,o,r,i,s,l;e.preventDefault();const d=document.getElementById("register-submit"),c=null==(n=null==(t=document.getElementById("register-name"))?void 0:t.value)?void 0:n.trim(),u=null==(r=null==(o=document.getElementById("register-email"))?void 0:o.value)?void 0:r.trim(),m=null==(i=document.getElementById("register-password"))?void 0:i.value,p=null==(s=document.getElementById("register-password-confirm"))?void 0:s.value,f=null==(l=document.getElementById("register-agreement"))?void 0:l.checked;if(c&&u&&m&&p)if(m===p)if(m.length<6)E("register-error","パスワードは6文字以上で設定してください");else if(f){d.disabled=!0,d.textContent="登録中...";try{const e=await async function(e,t,n){if(!a)return{success:!1,error:"Firebase認証が初期化されていません"};try{const o=await a.createUserWithEmailAndPassword(e,t);return n&&await o.user.updateProfile({displayName:n}),await o.user.sendEmailVerification(),{success:!0,user:o.user,message:"確認メールを送信しました。メールを確認してください。"}}catch(o){return console.error("[UserAuth] Sign up error:",o),{success:!1,error:g(o.code)}}}(u,m,c);e.success?(h(),alert(e.message||"登録が完了しました"),window.location.reload()):E("register-error",e.error)}catch(v){E("register-error","登録に失敗しました")}finally{d.disabled=!1,d.textContent="登録する"}}else E("register-error","利用規約への同意が必要です");else E("register-error","パスワードが一致しません");else E("register-error","すべての項目を入力してください")}async function B(e){var t,n,o;e.preventDefault();const r=document.getElementById("forgot-submit"),i=null==(n=null==(t=document.getElementById("forgot-email"))?void 0:t.value)?void 0:n.trim();if(i){r.disabled=!0,r.textContent="送信中...";try{const e=await async function(e){if(!a)return{success:!1,error:"Firebase認証が初期化されていません"};try{return await a.sendPasswordResetEmail(e),{success:!0,message:"パスワードリセットメールを送信しました"}}catch(t){return console.error("[UserAuth] Password reset error:",t),{success:!1,error:g(t.code)}}}(i);e.success?(!function(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}("forgot-success",e.message),null==(o=document.getElementById("forgot-form"))||o.reset()):E("forgot-error",e.error)}catch(s){E("forgot-error","送信に失敗しました")}finally{r.disabled=!1,r.textContent="リセットメールを送信"}}else E("forgot-error","メールアドレスを入力してください")}async function x(){try{const e=await async function(){if(!a)return{success:!1,error:"Firebase認証が初期化されていません"};try{const e=new firebase.auth.GoogleAuthProvider,t=await a.signInWithPopup(e);r=t.user,i=await t.user.getIdToken();const n=function(e){var t,n;if(!e)return!1;const a=(null==(t=e.profile)?void 0:t.name)||e.displayName||"",o=(null==(n=e.profile)?void 0:n.phone)||"",r=e.email||"";return!!(a.trim()&&o.trim()&&r.trim())}(await u());return{success:!0,user:t.user,isProfileComplete:n,needsProfileSetup:!n}}catch(e){return console.error("[UserAuth] Google sign in error:",e),{success:!1,error:g(e.code)}}}();if(e.success)h(),e.needsProfileSetup?(alert("プロフィール情報を入力してください"),window.location.href="mypage.html#profile"):window.location.reload();else{E("login"===f?"login-error":"register-error",e.error)}}catch(e){E("login"===f?"login-error":"register-error","Googleログインに失敗しました")}}let L="profile",M=null,A=null,k=[];const H={"18-24":"18〜24歳","25-29":"25〜29歳","30-34":"30〜34歳","35-39":"35〜39歳","40-44":"40〜44歳","45-49":"45〜49歳","50+":"50歳以上"},S={new:"新規",contacted:"連絡済み",interviewing:"面接調整中",interviewed:"面接済み",hired:"採用",rejected:"不採用",withdrawn:"辞退"};function $(){const e=window.location.hash.slice(1);var t,n,a,o,r,i;e&&["profile","applications","messages","favorites","settings"].includes(e)&&(L=e),d(async e=>{!function(){const e=document.getElementById("mypage-loading");e&&(e.style.display="none")}(),e?(document.getElementById("mypage-not-logged-in").style.display="none",document.querySelectorAll(".mypage-section").forEach(e=>{e.style.display="none"}),M=await u(),T(e,M),V(L)):(document.getElementById("mypage-not-logged-in").style.display="flex",document.querySelectorAll(".mypage-section").forEach(e=>{e.style.display="none"}))}),document.querySelectorAll(".mypage-nav-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.dataset.section;n&&V(n)})}),null==(t=document.getElementById("mypage-login-btn"))||t.addEventListener("click",()=>{y("login")}),null==(n=document.getElementById("btn-edit-profile"))||n.addEventListener("click",q),null==(a=document.getElementById("btn-cancel-profile"))||a.addEventListener("click",P),null==(o=document.getElementById("profile-edit-form"))||o.addEventListener("submit",N),null==(r=document.getElementById("password-form"))||r.addEventListener("submit",U),null==(i=document.getElementById("btn-delete-account"))||i.addEventListener("click",j)}function T(e,t){var n;const a=(null==t?void 0:t.displayName)||(null==(n=null==t?void 0:t.profile)?void 0:n.name)||e.displayName||"ユーザー",o=e.email,r=e.photoURL,i=document.getElementById("mypage-user-avatar"),s=document.getElementById("mypage-user-name"),l=document.getElementById("mypage-user-email");i&&(i.innerHTML=r?`<img src="${r}" alt="">`:`<span class="mypage-user-avatar-placeholder">${a.charAt(0)}</span>`),s&&(s.textContent=a),l&&(l.textContent=o)}function V(t){L=t,document.querySelectorAll(".mypage-nav-item").forEach(e=>{e.classList.toggle("active",e.dataset.section===t)}),document.querySelectorAll(".mypage-section").forEach(e=>{e.style.display="none"});const n=document.getElementById(`section-${t}`);n&&(n.style.display="block"),history.replaceState(null,"",`#${t}`),"profile"===t?D():"applications"===t?async function(){const e=m();if(!e)return;const t=document.getElementById("applications-list");if(!t)return;t.innerHTML='<div class="mypage-loading"><div class="loading-spinner"></div><p>読み込み中...</p></div>';try{const n=p();if(!n)return void K(t);const a=await n.collection("applications").where("applicant.email","==",e.email).orderBy("createdAt","desc").limit(50).get();if(a.empty)return void K(t);const o=[];a.forEach(e=>{o.push({id:e.id,...e.data()})}),function(e,t){e.innerHTML=t.map(e=>{var t;const n=W((null==(t=e.createdAt)?void 0:t.toDate)?e.createdAt.toDate():new Date(e.timestamp||e.createdAt)),a=e.status||"new",o=S[a]||a;return`\n      <div class="application-card">\n        <div class="application-card-body">\n          <h3 class="application-card-title">${_(e.jobTitle||"-")}</h3>\n          <p class="application-card-company">${_(e.companyName||"-")}</p>\n          <div class="application-card-meta">\n            <span>応募日: ${_(n)}</span>\n          </div>\n        </div>\n        <div class="application-card-status">\n          <span class="status-badge status-${a}">${_(o)}</span>\n        </div>\n      </div>\n    `}).join("")}(t,o)}catch(n){console.error("[MyPage] Load applications error:",n),"failed-precondition"===n.code?K(t):t.innerHTML='<p style="text-align: center; color: #ef4444; padding: 40px;">応募履歴の読み込みに失敗しました</p>'}}():"messages"===t?async function(){const e=m();if(!e)return;const t=document.getElementById("message-threads-list");if(!t)return;t.innerHTML='<div class="mypage-loading"><div class="loading-spinner"></div><p>読み込み中...</p></div>';try{const n=p();if(!n)return void F(t);const a=await n.collection("applications").where("applicant.email","==",e.email).orderBy("createdAt","desc").limit(50).get();if(a.empty)return void F(t);k=[],a.forEach(e=>{k.push({id:e.id,...e.data()})}),await Z(),z(t)}catch(n){console.error("[MyPage] Load message threads error:",n),"failed-precondition"===n.code?F(t):t.innerHTML='<p style="text-align: center; color: #ef4444; padding: 40px;">読み込みに失敗しました</p>'}}():"favorites"===t&&async function(){const t=m();if(!t)return;const n=document.getElementById("favorites-list");if(!n)return;n.innerHTML='<div class="mypage-loading"><div class="loading-spinner"></div><p>読み込み中...</p></div>';try{const a=p();if(!a)return void O(n);const o=await a.collection("favorites").where("userId","==",t.uid).orderBy("createdAt","desc").limit(50).get();if(o.empty)return void O(n);const r=[];o.forEach(e=>{r.push({id:e.id,...e.data()})}),function(t,n){t.innerHTML=n.map(e=>{const t=`job-detail.html?company=${encodeURIComponent(e.companyDomain)}&job=${encodeURIComponent(e.jobId)}`;return`\n      <div class="favorite-card" data-favorite-id="${_(e.id)}">\n        <div class="favorite-card-body">\n          <a href="${t}" class="favorite-card-title">${_(e.jobTitle||"-")}</a>\n          <p class="favorite-card-company">${_(e.companyName||"-")}</p>\n          <div class="favorite-card-meta">\n            ${e.location?`<span>${_(e.location)}</span>`:""}\n            ${e.monthlySalary?`<span>${_(e.monthlySalary)}</span>`:""}\n          </div>\n        </div>\n        <div class="favorite-card-actions">\n          <a href="${t}" class="btn-secondary-small">詳細を見る</a>\n          <button class="btn-remove-favorite" data-favorite-id="${_(e.id)}" title="お気に入りから削除">\n            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n    `}).join(""),t.querySelectorAll(".btn-remove-favorite").forEach(t=>{t.addEventListener("click",async()=>{const n=t.dataset.favoriteId;await e({title:"お気に入りの削除",message:"お気に入りから削除しますか？",confirmText:"削除する",cancelText:"キャンセル",danger:!0})&&await async function(e){try{const t=p();if(!t)return;await t.collection("favorites").doc(e).delete();const n=document.querySelector(`[data-favorite-id="${e}"]`);n&&n.remove();const a=document.getElementById("favorites-list");a&&0===a.children.length&&O(a)}catch(t){console.error("[MyPage] Remove favorite error:",t),alert("削除に失敗しました")}}(n)})})}(n,r)}catch(a){console.error("[MyPage] Load favorites error:",a),"failed-precondition"===a.code?O(n):n.innerHTML='<p style="text-align: center; color: #ef4444; padding: 40px;">お気に入りの読み込みに失敗しました</p>'}}()}function D(){const e=m();if(!e||!M)return;const t=M.profile||{};document.getElementById("profile-name").textContent=t.name||M.displayName||"-",document.getElementById("profile-email").textContent=e.email||"-",document.getElementById("profile-phone").textContent=t.phone||"-",document.getElementById("profile-age").textContent=H[t.age]||t.age||"-",document.getElementById("profile-address").textContent=t.address||"-"}function q(){const e=(null==M?void 0:M.profile)||{};document.getElementById("edit-name").value=e.name||(null==M?void 0:M.displayName)||"",document.getElementById("edit-phone").value=e.phone||"",document.getElementById("edit-age").value=e.age||"",document.getElementById("edit-address").value=e.address||"",document.getElementById("profile-view").style.display="none",document.getElementById("profile-edit-form").style.display="block",document.getElementById("btn-edit-profile").style.display="none"}function P(){document.getElementById("profile-view").style.display="block",document.getElementById("profile-edit-form").style.display="none",document.getElementById("btn-edit-profile").style.display="inline-flex"}async function N(e){var t,n,a,i,s,l,d;e.preventDefault();const c=(null==(n=null==(t=document.getElementById("edit-name"))?void 0:t.value)?void 0:n.trim())||"",p=(null==(i=null==(a=document.getElementById("edit-phone"))?void 0:a.value)?void 0:i.trim())||"",g=(null==(s=document.getElementById("edit-age"))?void 0:s.value)||"",f=(null==(d=null==(l=document.getElementById("edit-address"))?void 0:l.value)?void 0:d.trim())||"",v=e.target.querySelector('button[type="submit"]');v.disabled=!0,v.textContent="保存中...";try{const e=await async function(e){var t,n;if(!r||!o)return{success:!1,error:"ログインしていません"};try{const a=o.collection("users").doc(r.uid);return await a.update({...e,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),(e.displayName||(null==(t=e.profile)?void 0:t.name))&&await r.updateProfile({displayName:e.displayName||(null==(n=e.profile)?void 0:n.name)}),{success:!0}}catch(a){return console.error("[UserAuth] Update profile error:",a),{success:!1,error:a.message}}}({displayName:c,profile:{name:c,phone:p,age:g,address:f}});e.success?(M=await u(),D(),P(),T(m(),M)):alert("保存に失敗しました: "+e.error)}catch(y){alert("保存に失敗しました"),console.error("[MyPage] Profile save error:",y)}finally{v.disabled=!1,v.textContent="保存"}}async function U(e){var t,n;e.preventDefault();const a=null==(t=document.getElementById("new-password"))?void 0:t.value,o=null==(n=document.getElementById("confirm-password"))?void 0:n.value,i=document.getElementById("password-error"),s=document.getElementById("password-success");if(i.textContent="",s.textContent="",!a||!o)return void(i.textContent="すべての項目を入力してください");if(a!==o)return void(i.textContent="パスワードが一致しません");if(a.length<6)return void(i.textContent="パスワードは6文字以上で設定してください");const l=e.target.querySelector('button[type="submit"]');l.disabled=!0,l.textContent="変更中...";try{const t=await async function(e){if(!r)return{success:!1,error:"ログインしていません"};try{return await r.updatePassword(e),{success:!0,message:"パスワードを変更しました"}}catch(t){return console.error("[UserAuth] Update password error:",t),{success:!1,error:g(t.code)}}}(a);t.success?(s.textContent=t.message,e.target.reset()):i.textContent=t.error}catch(d){i.textContent="パスワードの変更に失敗しました",console.error("[MyPage] Password change error:",d)}finally{l.disabled=!1,l.textContent="パスワードを変更"}}async function j(){if(!(await e({title:"アカウントの削除",message:"アカウントを削除すると、すべてのデータが削除されます。\nこの操作は取り消せません。\n\n本当に削除しますか？",confirmText:"削除する",cancelText:"キャンセル",danger:!0})))return;if(await e({title:"最終確認",message:"本当に削除してよろしいですか？",confirmText:"削除する",cancelText:"キャンセル",danger:!0}))try{const e=m();if(e){const t=p();t&&await t.collection("users").doc(e.uid).delete(),await e.delete(),alert("アカウントを削除しました"),window.location.href="/"}}catch(t){"auth/requires-recent-login"===t.code?alert("セキュリティのため、再度ログインしてからお試しください"):alert("アカウントの削除に失敗しました"),console.error("[MyPage] Delete account error:",t)}}async function Z(){const e=p();if(!e)return;let t=0;for(const o of k)try{const n=await e.collection("messages").where("applicationId","==",o.id).where("from","==","company").where("read","==",!1).get();o.unreadCount=n.size,t+=n.size}catch(a){o.unreadCount=0}const n=document.getElementById("unread-badge");n&&(t>0?(n.textContent=t>99?"99+":t,n.style.display="inline-flex"):n.style.display="none")}function F(e){e.innerHTML='\n    <div class="mypage-empty-state" style="padding: 40px 20px;">\n      <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n        <path d="M43.2 0H4.8C2.16 0 0 2.16 0 4.8V33.6C0 36.24 2.16 38.4 4.8 38.4H38.4L48 48V4.8C48 2.16 45.84 0 43.2 0Z" fill="#e2e8f0"/>\n      </svg>\n      <h3>メッセージはありません</h3>\n      <p>応募すると企業からのメッセージがここに届きます</p>\n    </div>\n  ';const t=document.getElementById("message-detail");t&&(t.innerHTML='\n      <div class="message-detail-empty">\n        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n          <path d="M43.2 0H4.8C2.16 0 0 2.16 0 4.8V33.6C0 36.24 2.16 38.4 4.8 38.4H38.4L48 48V4.8C48 2.16 45.84 0 43.2 0ZM38.4 28.8H9.6V24H38.4V28.8ZM38.4 21.6H9.6V16.8H38.4V21.6ZM38.4 14.4H9.6V9.6H38.4V14.4Z" fill="#e2e8f0"/>\n        </svg>\n        <p>応募すると企業とメッセージのやり取りができます</p>\n      </div>\n    ')}function z(e){e.innerHTML=k.map(e=>{var t;const n=W((null==(t=e.createdAt)?void 0:t.toDate)?e.createdAt.toDate():new Date(e.timestamp||e.createdAt));return`\n      <div class="message-thread-item ${A===e.id?"active":""}" data-application-id="${_(e.id)}">\n        <div class="message-thread-content">\n          <div class="message-thread-title">${_(e.jobTitle||"-")}</div>\n          <div class="message-thread-company">${_(e.companyName||"-")}</div>\n          <div class="message-thread-date">応募日: ${_(n)}</div>\n        </div>\n        ${e.unreadCount>0?`<span class="message-thread-unread">${e.unreadCount}</span>`:""}\n      </div>\n    `}).join(""),e.querySelectorAll(".message-thread-item").forEach(e=>{e.addEventListener("click",()=>{!async function(e){A=e,document.querySelectorAll(".message-thread-item").forEach(t=>{t.classList.toggle("active",t.dataset.applicationId===e)}),await R(e)}(e.dataset.applicationId)})})}async function R(e){const t=document.getElementById("message-detail");if(!t)return;const n=k.find(t=>t.id===e);if(n){t.innerHTML='<div class="mypage-loading"><div class="loading-spinner"></div><p>読み込み中...</p></div>';try{const a=p();if(!a)return void(t.innerHTML='<p style="text-align: center; color: #ef4444; padding: 40px;">読み込みに失敗しました</p>');const o=await a.collection("messages").where("applicationId","==",e).orderBy("createdAt","asc").get(),r=[];o.forEach(e=>{r.push({id:e.id,...e.data()})}),await async function(e,t){const n=e.filter(e=>"company"===e.from&&!e.read);for(const r of n)try{await t.collection("messages").doc(r.id).update({read:!0})}catch(o){console.error("[MyPage] Mark as read error:",o)}const a=k.find(e=>e.id===A);if(a){a.unreadCount=0;const e=document.getElementById("message-threads-list");e&&z(e),await Z()}}(r,a),function(e,t,n){var a,o;const r=S[t.status]||t.status||"新規";e.innerHTML=`\n    <div class="message-detail-header">\n      <div class="message-detail-title">${_(t.jobTitle||"-")}</div>\n      <div class="message-detail-meta">\n        <span>${_(t.companyName||"-")}</span>\n        <span class="status-badge status-${t.status||"new"}">${_(r)}</span>\n      </div>\n    </div>\n    <div class="message-list" id="message-list">\n      ${0===n.length?'\n        <div class="message-empty">\n          <p>まだメッセージはありません</p>\n        </div>\n      ':n.map(e=>{var n;const a=(null==(n=e.createdAt)?void 0:n.toDate)?e.createdAt.toDate():new Date(e.createdAt),o="company"===e.from;return`\n          <div class="message-bubble ${o?"message-from-company":"message-from-user"}">\n            <div class="message-bubble-header">\n              <span class="message-sender">${_(o?t.companyName||"企業":"あなた")}</span>\n              <span class="message-time">${function(e){if(!e)return"-";const t=new Date(e),n=(t.getMonth()+1).toString().padStart(2,"0"),a=t.getDate().toString().padStart(2,"0"),o=t.getHours().toString().padStart(2,"0"),r=t.getMinutes().toString().padStart(2,"0");return`${n}/${a} ${o}:${r}`}(a)}</span>\n            </div>\n            <div class="message-bubble-content">${_(e.content).replace(/\n/g,"<br>")}</div>\n          </div>\n        `}).join("")}\n    </div>\n    <div class="message-input-area">\n      <textarea id="reply-message-text" rows="3" placeholder="メッセージを入力..."></textarea>\n      <button id="btn-send-reply" class="btn-primary">送信</button>\n    </div>\n  `;const i=document.getElementById("message-list");i&&(i.scrollTop=i.scrollHeight);null==(a=document.getElementById("btn-send-reply"))||a.addEventListener("click",G),null==(o=document.getElementById("reply-message-text"))||o.addEventListener("keydown",e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),G())})}(t,n,r)}catch(a){console.error("[MyPage] Load messages error:",a),t.innerHTML='<p style="text-align: center; color: #ef4444; padding: 40px;">メッセージの読み込みに失敗しました</p>'}}}async function G(){var e;if(!A)return;const t=document.getElementById("reply-message-text"),n=null==(e=null==t?void 0:t.value)?void 0:e.trim();if(!n)return void alert("メッセージを入力してください");const a=document.getElementById("btn-send-reply");a&&(a.disabled=!0,a.textContent="送信中...");try{const e=p();if(!e)throw new Error("Firestore not available");const a=k.find(e=>e.id===A);await e.collection("messages").add({applicationId:A,companyDomain:(null==a?void 0:a.companyDomain)||"",from:"applicant",content:n,read:!1,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),t.value="",await R(A)}catch(o){console.error("[MyPage] Send message error:",o),alert("メッセージの送信に失敗しました")}finally{a&&(a.disabled=!1,a.textContent="送信")}}function K(e){e.innerHTML='\n    <div class="mypage-empty-state">\n      <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n        <path d="M42 6H30.33C29.45 3.15 26.79 1 23.67 1C20.55 1 17.89 3.15 17.01 6H6C3.79 6 2 7.79 2 10V42C2 44.21 3.79 46 6 46H42C44.21 46 46 44.21 46 42V10C46 7.79 44.21 6 42 6ZM24 6C25.1 6 26 6.9 26 8C26 9.1 25.1 10 24 10C22.9 10 22 9.1 22 8C22 6.9 22.9 6 24 6Z" fill="#e2e8f0"/>\n      </svg>\n      <h3>応募履歴がありません</h3>\n      <p>求人に応募すると、ここに履歴が表示されます</p>\n      <a href="jobs.html" class="btn-primary">求人を探す</a>\n    </div>\n  '}function O(e){e.innerHTML='\n    <div class="mypage-empty-state">\n      <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n        <path d="M24 42L20.55 38.925C8.4 27.9 0 20.4 0 11.4C0 3.9 5.85 -2 13.2 -2C17.4 -2 21.42 -0.02 24 3.18C26.58 -0.02 30.6 -2 34.8 -2C42.15 -2 48 3.9 48 11.4C48 20.4 39.6 27.9 27.45 38.925L24 42Z" fill="#e2e8f0" transform="translate(0, 5)"/>\n      </svg>\n      <h3>お気に入りがありません</h3>\n      <p>気になる求人をお気に入りに追加すると、ここに表示されます</p>\n      <a href="jobs.html" class="btn-primary">求人を探す</a>\n    </div>\n  '}function W(e){if(!e)return"-";const t=new Date(e);return`${t.getFullYear()}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getDate().toString().padStart(2,"0")}`}function _(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}const X={user:null,profile:null,isAuthenticated:!1,isLoading:!0};function Q(){l()?d(async e=>{X.user=e,X.isAuthenticated=!!e,X.isLoading=!1,X.profile=e?await u():null,function(){const e=document.querySelector(".header-actions");if(!e)return;const t=e.querySelector(".user-menu"),o=e.querySelector(".btn-user-login");t&&t.remove();o&&o.remove();if(X.isAuthenticated&&X.user){const t=function(e,t){var o;const s=(null==t?void 0:t.displayName)||(null==(o=null==t?void 0:t.profile)?void 0:o.name)||e.displayName||"ユーザー",l=e.photoURL||null,d=document.createElement("div");d.className="user-menu",d.innerHTML=`\n    <button class="user-menu-trigger" aria-expanded="false" aria-haspopup="true">\n      ${l?`<img src="${l}" alt="" class="user-avatar">`:`<span class="user-avatar-placeholder">${s.charAt(0)}</span>`}\n      <span class="user-name">${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(s)}</span>\n      <svg class="user-menu-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none">\n        <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n      </svg>\n    </button>\n    <div class="user-dropdown" role="menu">\n      <a href="mypage.html" class="user-dropdown-item" role="menuitem">\n        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n          <path d="M8 8C10.21 8 12 6.21 12 4C12 1.79 10.21 0 8 0C5.79 0 4 1.79 4 4C4 6.21 5.79 8 8 8ZM8 10C5.33 10 0 11.34 0 14V16H16V14C16 11.34 10.67 10 8 10Z" fill="currentColor"/>\n        </svg>\n        マイページ\n      </a>\n      <a href="mypage.html#favorites" class="user-dropdown-item" role="menuitem">\n        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n          <path d="M8 14L6.84 12.94C2.72 9.18 0 6.72 0 3.72C0 1.26 1.98 -0.72 4.44 -0.72C5.82 -0.72 7.14 -0.08 8 0.9C8.86 -0.08 10.18 -0.72 11.56 -0.72C14.02 -0.72 16 1.26 16 3.72C16 6.72 13.28 9.18 9.16 12.94L8 14Z" fill="currentColor" transform="translate(0, 1.72)"/>\n        </svg>\n        お気に入り\n      </a>\n      <a href="mypage.html#applications" class="user-dropdown-item" role="menuitem">\n        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n          <path d="M14 2H10.82C10.4 0.84 9.3 0 8 0C6.7 0 5.6 0.84 5.18 2H2C0.9 2 0 2.9 0 4V14C0 15.1 0.9 16 2 16H14C15.1 16 16 15.1 16 14V4C16 2.9 15.1 2 14 2ZM8 2C8.55 2 9 2.45 9 3C9 3.55 8.55 4 8 4C7.45 4 7 3.55 7 3C7 2.45 7.45 2 8 2ZM10 12H4V10H10V12ZM12 8H4V6H12V8Z" fill="currentColor"/>\n        </svg>\n        応募履歴\n      </a>\n      <div class="user-dropdown-divider"></div>\n      <button class="user-dropdown-item user-dropdown-logout" id="btn-user-logout" role="menuitem">\n        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">\n          <path d="M12 10.67L14.67 8L12 5.33V8H6V10H12V10.67ZM14 0H2C0.89 0 0 0.9 0 2V6H2V2H14V14H2V10H0V14C0 15.1 0.89 16 2 16H14C15.1 16 16 15.1 16 14V2C16 0.9 15.1 0 14 0Z" fill="currentColor"/>\n        </svg>\n        ログアウト\n      </button>\n    </div>\n  `;const c=d.querySelector(".user-menu-trigger"),u=d.querySelector(".user-dropdown");c.addEventListener("click",e=>{e.stopPropagation();const t=u.classList.contains("is-open");u.classList.toggle("is-open"),c.setAttribute("aria-expanded",!t)}),document.addEventListener("click",()=>{u.classList.remove("is-open"),c.setAttribute("aria-expanded","false")});return d.querySelector("#btn-user-logout").addEventListener("click",async()=>{await async function(){if(a)try{return await a.signOut(),r=null,i=null,sessionStorage.removeItem(n),{success:!0}}catch(e){return console.error("[UserAuth] Sign out error:",e),{success:!1,error:e.message}}}(),window.location.reload()}),d}(X.user,X.profile);e.appendChild(t)}else{const t=document.createElement("button");t.id="btn-user-login",t.className="btn-user-login",t.textContent="ログイン",t.addEventListener("click",()=>{const e=new CustomEvent("openAuthModal",{detail:{mode:"login"}});document.dispatchEvent(e)}),e.appendChild(t)}}()}):X.isLoading=!1}document.addEventListener("DOMContentLoaded",()=>{Q(),v(),$()});
