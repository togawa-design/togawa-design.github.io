import{e}from"./utils-C4oNoj7k.js";import{g as t,e as n,f as o,h as d,i as l}from"./job-feed-generator-BbzggbON.js";import"./jobs-loader-CErzUEmq.js";const a="https://script.google.com/macros/s/AKfycbxj6CqSfY7jq04uDXURhewD_BAKx3csLKBpl1hdRBdNg-R-E6IuoaZGje22Gr9WYWY2/exec";let i=null,s=null,r=null,c=[],b=null,u=!1;function m(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async function y(){const t=document.getElementById("jobs-tbody");if(!t)return;t.innerHTML='<tr><td colspan="6" class="loading-cell">データを読み込み中...</td></tr>';const n=a;try{const o=`${n}?action=getJobs&domain=${encodeURIComponent(i)}`,d=await fetch(o);if(!d.ok)throw new Error("データの取得に失敗しました");const l=await d.json();if(!l.success)throw new Error(l.error||"求人データの取得に失敗しました");if(c=l.jobs||[],0===c.length)return void(t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>');!function(){const t=document.getElementById("jobs-tbody");if(!t)return;const n=c||[];0!==n.length?(t.innerHTML=n.map(t=>{const n=t.monthlySalary?`¥${Number(t.monthlySalary).toLocaleString()}`:"-",o="true"===t.visible||"TRUE"===t.visible||!0===t.visible;return`\n      <tr data-row="${t._rowIndex}">\n        <td>${e(t.id||"-")}</td>\n        <td>${e(t.title||"-")}</td>\n        <td>${e(t.location||"-")}</td>\n        <td>${n}</td>\n        <td>${o?'<span class="badge success">公開</span>':'<span class="badge">非公開</span>'}</td>\n        <td>\n          <div class="action-buttons">\n            <button class="btn-small btn-edit" data-row="${t._rowIndex}">編集</button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),t.querySelectorAll(".btn-edit").forEach(e=>{e.addEventListener("click",()=>{j(parseInt(e.dataset.row,10))})})):t.innerHTML='<tr><td colspan="6" class="loading-cell">求人データがありません</td></tr>'}()}catch(o){console.error("求人データの読み込みエラー:",o),t.innerHTML=`<tr><td colspan="6" class="loading-cell">データの読み込みに失敗しました: ${e(o.message)}</td></tr>`}}function g(){b=null,u=!0;const e=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t)};document.getElementById("job-modal-title").textContent="新規求人作成",e("edit-job-title",""),e("edit-job-location",""),e("edit-job-salary",""),e("edit-job-bonus",""),e("edit-job-order",""),e("edit-job-features",""),e("edit-job-badges",""),e("edit-job-description",""),e("edit-job-requirements",""),e("edit-job-benefits",""),e("edit-job-hours",""),e("edit-job-holidays",""),e("edit-job-start-date",""),e("edit-job-end-date","");const t=document.getElementById("edit-job-visible");t&&(t.checked=!0);const n=document.getElementById("job-modal-delete");n&&(n.style.display="none");const o=document.getElementById("job-modal");o&&(o.style.display="flex")}function j(e){const t=null==c?void 0:c.find(t=>t._rowIndex===e);if(!t)return void alert("求人データが見つかりません");b=t,u=!1;const n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};document.getElementById("job-modal-title").textContent="求人情報の編集",n("edit-job-title",t.title),n("edit-job-location",t.location),n("edit-job-salary",t.monthlySalary),n("edit-job-bonus",t.totalBonus),n("edit-job-order",t.order),n("edit-job-features",t.features),n("edit-job-badges",t.badges),n("edit-job-description",t.jobDescription),n("edit-job-requirements",t.requirements),n("edit-job-benefits",t.benefits),n("edit-job-hours",t.workingHours),n("edit-job-holidays",t.holidays),t.publishStartDate?n("edit-job-start-date",m(t.publishStartDate)):n("edit-job-start-date",""),t.publishEndDate?n("edit-job-end-date",m(t.publishEndDate)):n("edit-job-end-date","");const o=document.getElementById("edit-job-visible");o&&(o.checked="true"===t.visible||"TRUE"===t.visible||!0===t.visible);const d=document.getElementById("job-modal-delete");d&&(d.style.display="");const l=document.getElementById("job-modal");l&&(l.style.display="flex")}function f(){const e=document.getElementById("job-modal");e&&(e.style.display="none"),b=null,u=!1}async function p(){var e;if(!i)return void alert("会社が選択されていません");const t=e=>{var t,n;return(null==(n=null==(t=document.getElementById(e))?void 0:t.value)?void 0:n.trim())||""},n={title:t("edit-job-title"),location:t("edit-job-location"),monthlySalary:t("edit-job-salary"),totalBonus:t("edit-job-bonus"),order:t("edit-job-order"),features:t("edit-job-features"),badges:t("edit-job-badges"),jobDescription:t("edit-job-description"),requirements:t("edit-job-requirements"),benefits:t("edit-job-benefits"),workingHours:t("edit-job-hours"),holidays:t("edit-job-holidays"),publishStartDate:t("edit-job-start-date"),publishEndDate:t("edit-job-end-date"),visible:(null==(e=document.getElementById("edit-job-visible"))?void 0:e.checked)?"true":"false"};if(!n.title||!n.location)return void alert("募集タイトルと勤務地は必須です");const o=a,d=document.getElementById("job-modal-save");try{d&&(d.disabled=!0,d.textContent="保存中...");const e=btoa(unescape(encodeURIComponent(JSON.stringify({action:"saveJob",companyDomain:i,job:n,rowIndex:u?null:b._rowIndex})))),t=`${o}?action=post&data=${encodeURIComponent(e)}`,a=await fetch(t,{method:"GET",redirect:"follow"}),s=await a.text();let r;try{r=JSON.parse(s)}catch(l){throw console.error("JSON parse error:",l),new Error(`GASからの応答が不正です: ${s.substring(0,200)}`)}if(!r.success)return void alert("保存に失敗しました: "+(r.error||"不明なエラー"));f(),await y(),alert(u?"求人を作成しました":"求人情報を更新しました")}catch(s){console.error("求人保存エラー:",s),alert("保存中にエラーが発生しました: "+s.message)}finally{d&&(d.disabled=!1,d.textContent="保存")}}async function h(){if(!b||!i)return void alert("削除対象が選択されていません");if(!confirm("この求人を削除してもよろしいですか？"))return;const e=a,t=document.getElementById("job-modal-delete");try{t&&(t.disabled=!0,t.textContent="削除中...");const o=btoa(unescape(encodeURIComponent(JSON.stringify({action:"deleteJob",companyDomain:i,rowIndex:b._rowIndex})))),d=`${e}?action=post&data=${encodeURIComponent(o)}`,l=await fetch(d,{method:"GET",redirect:"follow"}),a=await l.text();let s;try{s=JSON.parse(a)}catch(n){throw console.error("JSON parse error:",n),new Error("GASからの応答が不正です")}if(!s.success)return void alert("削除に失敗しました: "+(s.error||"不明なエラー"));f(),await y(),alert("求人を削除しました")}catch(o){console.error("求人削除エラー:",o),alert("削除中にエラーが発生しました: "+o.message)}finally{t&&(t.disabled=!1,t.textContent="削除")}}function E(){return c.filter(e=>("true"===e.visible||"TRUE"===e.visible||!0===e.visible)&&e.title).map(e=>({...e,company:s,companyDomain:i,companyAddress:e.location||""}))}function v(){const e=document.getElementById("feed-status");e&&(e.style.display="flex")}function w(){const e=document.getElementById("feed-status");e&&(e.style.display="none")}async function I(){const e=E();if(0!==e.length)try{v();const o=t(e);n(o,`indeed-${i}.xml`,"application/xml")}catch(o){alert("フィード生成に失敗しました: "+o.message)}finally{w()}else alert("ダウンロードできる求人がありません")}async function B(){const e=E();if(0!==e.length)try{v();const t=o(e);n(t,`google-jobs-${i}.json`,"application/json")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{w()}else alert("ダウンロードできる求人がありません")}async function x(){const e=E();if(0!==e.length)try{v();const t=d(e);n(t,`jobbox-${i}.xml`,"application/xml")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{w()}else alert("ダウンロードできる求人がありません")}async function $(){const e=E();if(0!==e.length)try{v();const t=l(e);n(t,`jobs-${i}.csv`,"text/csv;charset=utf-8")}catch(t){alert("フィード生成に失敗しました: "+t.message)}finally{w()}else alert("ダウンロードできる求人がありません")}async function L(){const e=new URLSearchParams(window.location.search);if(i=e.get("domain"),s=e.get("company")||i,r=e.get("sheetUrl"),!i)return alert("会社ドメインが指定されていません"),void(window.location.href="admin.html");const t=document.getElementById("page-title");t&&(t.textContent=`${s} の求人一覧`);const n=document.getElementById("company-name");n&&(n.textContent=s);const o=document.getElementById("btn-open-sheet");var d,l,a,c,b,u,m,j,E,v,w;r&&o?(o.href=r,o.style.display=""):o&&(o.style.display="none"),null==(d=document.getElementById("btn-add-job"))||d.addEventListener("click",g),null==(l=document.getElementById("btn-refresh"))||l.addEventListener("click",y),null==(a=document.getElementById("job-modal-close"))||a.addEventListener("click",f),null==(c=document.getElementById("job-modal-cancel"))||c.addEventListener("click",f),null==(b=document.getElementById("job-modal-delete"))||b.addEventListener("click",h),null==(u=document.getElementById("job-edit-form"))||u.addEventListener("submit",e=>{e.preventDefault(),p()}),null==(m=document.getElementById("job-modal"))||m.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&f()}),null==(j=document.getElementById("btn-download-indeed"))||j.addEventListener("click",I),null==(E=document.getElementById("btn-download-google"))||E.addEventListener("click",B),null==(v=document.getElementById("btn-download-jobbox"))||v.addEventListener("click",x),null==(w=document.getElementById("btn-download-csv"))||w.addEventListener("click",$),await y()}"undefined"!=typeof window&&(window.JobManager={init:L,loadJobsData:y,showJobModal:g,editJob:j,closeJobModal:f,saveJobData:p,deleteJob:h}),document.addEventListener("DOMContentLoaded",()=>{L()});
